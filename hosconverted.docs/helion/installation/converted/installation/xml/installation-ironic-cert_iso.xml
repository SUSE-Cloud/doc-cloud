<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><!--Edit status: not edited-->
<section id="cert-iso">
   <title>Adding a certificate into an ISO image</title>
        <para>As root, proceed with the following steps to disassemble the ISO image, and insert a new Certificate Authority or 
        Signing Certificate into the provided image.
    </para>
   <orderedlist>
      <listitem>
         <para>Download the deployment ISO image from glance and place it in <literal>/tmp/</literal> as <literal>ironic-deploy.iso</literal>.
    </para>
      </listitem>
    
      <listitem>
         <para>Make a temporary folder to mount the <literal>ironic-deploy.iso</literal> image to in order to extract itâ€™s contents.
        </para>
         <screen>mkdir /mnt/deploy_iso</screen>
      </listitem>
    
      <listitem>
         <para>Mount the <literal>ironic-deploy.iso</literal> image file to a the folder you just create.  
        </para>
         <screen>mount -o loop /tmp/ironic-deploy.iso /mnt/deploy_iso/</screen>
      </listitem>
    
      <listitem>
         <para>Make a temporary location to stage the new image.
        </para>
         <screen>mkdir /tmp/new_deploy_iso</screen>
      </listitem>
    
      <listitem>
         <para>Copy the contents from the previous image into the new temporary staging location.
        </para>
         <screen>cp -ra /mnt/deploy_iso/. /tmp/new_deploy_iso/</screen>
      </listitem>
    
      <listitem>
         <para>Make a folder to house the ramdisk that will need to be extracted from the ISO image.
        </para>
         <screen>mkdir /tmp/new_deploy_ramdisk</screen>
      </listitem>
    
      <listitem>
         <para>Change your working directory to <literal>/tmp/new_deploy_ramdisk</literal>
        </para>
         <screen>cd /tmp/new_deploy_ramdisk</screen>
      </listitem>
    
      <listitem>
         <para>Unpack the ramdisk image.
        </para>
         <screen>zcat /tmp/new_deploy_iso/initrd | cpio --extract --make-directories</screen>
      </listitem>
    
      <listitem>
         <para>Append your CA certificate to the file located at <literal>/tmp/new_deploy_ramdisk/usr/local/lib/python2.7/dist-packages/requests/cacert.pem</literal>, example below:
        </para>
         <screen>cat your_ca_certificate.pem &gt;&gt; /tmp/new_deploy_ramdisk/usr/local/lib/python2.7/dist-packages/requests/cacert.pem</screen>
      </listitem>
    
      <listitem>
         <para>Replace the pre-existing initial ramdisk in the extracted disk image.
        </para>
         <screen>find . | cpio --create --format='newc' | gzip -c -9 &gt; /tmp/new_deploy_iso/initrd</screen>
      </listitem>
    
      <listitem>
         <para>Change directory back to the new deployment ISO image folder.
        </para>
         <screen>cd /tmp/new_deploy_iso</screen>
      </listitem>
    
      <listitem>
         <para>Ensure that the program <literal>xorriso</literal> is available, you may need to execute <literal>apt-get install xorriso</literal> to install it.
    </para>
      </listitem>
    
      <listitem>
         <para>Create the new ISO deployment image utilizing the following command.
        </para>
         <screen>xorriso -as mkisofs -b isolinux/isolinux.bin -c boot.cat -V VMEDIA_BOOT_ISO -r -J -no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot --efi-boot boot/grub/efi.img -isohybrid-gpt-basdat -isohybrid-apm-hfsplus -o /tmp/new_ironic_deploy.iso ./</screen>
      </listitem>
    
   </orderedlist>
   <para>        
Once completed, the new image can be found at <literal>/tmp/new_ironic_deploy.iso</literal>, and will need to be uploaded to Glance. 
        New Glance IDs will need to be recorded for any instances requiring this new image, as noted in the parent paragraph

    </para>
    </section>
