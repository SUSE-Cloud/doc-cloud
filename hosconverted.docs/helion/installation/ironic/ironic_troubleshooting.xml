<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: not edited-->
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="ironic-toubleshooting">
    <title><ph conkeyref="HOS-conrefs/product-title"/>Troubleshooting Ironic Installation</title>
    <body>
        <!--not tested-->
        <p conkeyref="HOS-conrefs/applies-to"/>



        <p>Sometimes the <codeph>nova boot</codeph> command does not succeed and when you do a
                <codeph>nova list</codeph>, you will see output like the following: </p>

        <codeblock>
nova list

+--------------------------------------+--------+--------+------------+-------------+----------------------+
| ID                                   | Name   | Status | Task State | Power State | Networks             |
+--------------------------------------+--------+--------+------------+-------------+----------------------+
| ee08f82e-8920-4360-be51-a3f995624e5f | ubuntu | ERROR  | -          | NOSTATE     |                      |
+--------------------------------------+--------+--------+------------+-------------+----------------------+           
</codeblock>

        <p>You should execute the <codeph>nova show &lt;nova-node-id></codeph> and <codeph>ironic
                node-show &lt;ironic-node-id></codeph> commands to get more information about the
            error.</p>


        <section>
            <title>No valid host was found. There are not enough hosts available.</title>
            <p>This error is typically seen when performing the <codeph>nova boot</codeph> where
                there is a mismatch between the properties set on the node and the flavor used. For
                example, the output from a <codeph>nova show</codeph> command may look like
                this:</p>
            <codeblock>    
nova show  ee08f82e-8920-4360-be51-a3f995624e5f

+--------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Property                             | Value                                                                                                                                                                                                                                       |
+--------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| OS-EXT-AZ:availability_zone          |                                                                                                                                                                                                                                             |
| OS-EXT-SRV-ATTR:host                 | -                                                                                                                                                                                                                                           |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                                                                                                                                                                                                           |
| OS-EXT-SRV-ATTR:instance_name        | instance-00000001                                                                                                                                                                                                                           |
| OS-EXT-STS:power_state               | 0                                                                                                                                                                                                                                           |
| OS-EXT-STS:task_state                | -                                                                                                                                                                                                                                           |
| OS-EXT-STS:vm_state                  | error                                                                                                                                                                                                                                       |
| OS-SRV-USG:launched_at               | -                                                                                                                                                                                                                                           |
| OS-SRV-USG:terminated_at             | -                                                                                                                                                                                                                                           |
| accessIPv4                           |                                                                                                                                                                                                                                             |
| accessIPv6                           |                                                                                                                                                                                                                                             |
| config_drive                         |                                                                                                                                                                                                                                             |
| created                              | 2016-03-11T11:00:28Z                                                                                                                                                                                                                        |
| fault                                | {"message": "<b>No valid host was found. There are not enough hosts available.</b>", "code": 500, "details": "  File \<b>"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/nova/conductor/manager.py\"</b>, line 739, in build_instances |
|                                      |     request_spec, filter_properties)                                                                                                                                                                                                        |
|                                      |   File \<b>"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/nova/scheduler/utils.py\"</b>, line 343, in wrapped                                                                                                                  |
|                                      |     return func(*args, **kwargs)                                                                                                                                                                                                            |
|                                      |   File \<b>"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/nova/scheduler/client/__init__.py\"</b>, line 52, in select_destinations                                                                                             |
|                                      |     context, request_spec, filter_properties)                                                                                                                                                                                               |
|                                      |   File \"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/nova/scheduler/client/__init__.py\", line 37, in __run_method                                                                                                    |
|                                      |     return getattr(self.instance, __name)(*args, **kwargs)                                                                                                                                                                                  |
|                                      |   File \"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/nova/scheduler/client/query.py\", line 34, in select_destinations                                                                                                |
|                                      |     context, request_spec, filter_properties)                                                                                                                                                                                               |
|                                      |   File \"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/nova/scheduler/rpcapi.py\", line 120, in select_destinations                                                                                                     |
|                                      |     request_spec=request_spec, filter_properties=filter_properties)                                                                                                                                                                         |
|                                      |   File \"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/oslo_messaging/rpc/client.py\", line 158, in call                                                                                                                |
|                                      |     retry=self.retry)                                                                                                                                                                                                                       |
|                                      |   File \"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/oslo_messaging/transport.py\", line 90, in _send                                                                                                                 |
|                                      |     timeout=timeout, retry=retry)                                                                                                                                                                                                           |
|                                      |   File \"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 462, in send                                                                                                       |
|                                      |     retry=retry)                                                                                                                                                                                                                            |
|                                      |   File \"/opt/stack/venv/nova-20160308T002421Z/lib/python2.7/site-packages/oslo_messaging/_drivers/amqpdriver.py\", line 453, in _send                                                                                                      |
|                                      |     raise result                                                                                                                                                                                                                            |
|                                      | ", "created": "2016-03-11T11:00:29Z"}                                                                                                                                                                                                       |
| flavor                               | bmtest (645de08d-2bc6-43f1-8a5f-2315a75b1348)                                                                                                                                                                                               |
| hostId                               |                                                                                                                                                                                                                                             |
| id                                   | ee08f82e-8920-4360-be51-a3f995624e5f                                                                                                                                                                                                        |
| image                                | ubuntu (17e4915a-ada0-4b95-bacf-ba67133f39a7)                                                                                                                                                                                               |
| key_name                             | ironic_kp                                                                                                                                                                                                                                   |
| metadata                             | {}                                                                                                                                                                                                                                          |
| name                                 | ubuntu                                                                                                                                                                                                                                      |
| os-extended-volumes:volumes_attached | []                                                                                                                                                                                                                                          |
| status                               | ERROR                                                                                                                                                                                                                                       |
| tenant_id                            | d53bcaf15afb4cb5aea3adaedbaa60dd                                                                                                                                                                                                            |
| updated                              | 2016-03-11T11:00:28Z                                                                                                                                                                                                                        |
| user_id                              | e580c645bfec4faeadef7dbd24aaf990                                                                                                                                                                                                            |
+--------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</codeblock>
            <p>You can find more information about the error by inspecting the log file at
                    <codeph>/var/log/nova/nova-scheduler.log</codeph> or alternatively by viewing
                the error location in the source files listed in the stack-trace (in bold
                above).</p>
            <p>To find the mis-match, compare the properties of the ironic node:</p>
            <codeblock>
+------------------------+---------------------------------------------------------------------+
| Property               | Value                                                               |
+------------------------+---------------------------------------------------------------------+
| target_power_state     | None                                                                |
| extra                  | {}                                                                  |
| last_error             | None                                                                |
| updated_at             | None                                                                |
| maintenance_reason     | None                                                                |
| provision_state        | available                                                           |
| clean_step             | {}                                                                  |
| uuid                   | ea7246fd-e1d6-4637-9699-0b7c59c22e67                                |
| console_enabled        | False                                                               |
| target_provision_state | None                                                                |
| provision_updated_at   | None                                                                |
| maintenance            | False                                                               |
| inspection_started_at  | None                                                                |
| inspection_finished_at | None                                                                |
| power_state            | None                                                                |
| driver                 | agent_ilo                                                           |
| reservation            | None                                                                |
| properties             | <b>{u'memory_mb': 64000, u'local_gb': 99, u'cpus': 2, u'capabilities':</b> |
|                        | <b>u'boot_mode:bios,boot_option:local'} </b>                               |
| instance_uuid          | None                                                                |
| name                   | None                                                                |
| driver_info            | {u'ilo_address': u'10.1.196.117', u'ilo_password': u'******',       |
|                        | u'ilo_deploy_iso': u'b9499494-7db3-4448-b67f-233b86489c1f',         |
|                        | u'ilo_username': u'Administrator'}                                  |
| created_at             | 2016-03-11T10:17:10+00:00                                           |
| driver_internal_info   | {}                                                                  |
| chassis_uuid           |                                                                     |
| instance_info          | {}                                                                  |
+------------------------+---------------------------------------------------------------------+    
</codeblock>
            <p>with the flavor characteristics:</p>
            <codeblock>
nova flavor-show 

+----------------------------+-----------------------------------------------------------------------------------------------+
| Property                   | Value                                                                                         |
+----------------------------+-----------------------------------------------------------------------------------------------+
| OS-FLV-DISABLED:disabled   | False                                                                                         |
| OS-FLV-EXT-DATA:ephemeral  | 0                                                                                             |
| disk                       | <b>99 </b>                                                                                           |
| extra_specs                | <b>{"capabilities:boot_option": "local", "cpu_arch": "x86_64", "capabilities:boot_mode": "bios"}</b> |
| id                         | 645de08d-2bc6-43f1-8a5f-2315a75b1348                                                          |
| name                       | bmtest                                                                                        |
| os-flavor-access:is_public | True                                                                                          |
| ram                        | <b>64000</b>                                                                                         |
| rxtx_factor                | 1.0                                                                                           |
| swap                       |                                                                                               |
| vcpus                      | <b>2</b>                                                                                             |
+----------------------------+-----------------------------------------------------------------------------------------------+        
</codeblock>
            <p>In this instance, the problem is caused by the absence of the <b>"cpu_arch":
                    "x86_64"</b> property on the ironic node. This can be resolved by updating the
                ironic node, adding the missing property: </p>
            <codeblock>
ironic node-update ea7246fd-e1d6-4637-9699-0b7c59c22e67 <b>add properties/cpu_arch=x86_64</b>    
</codeblock>
            <p>and then re-running the <codeph>nova boot</codeph> command.</p>
        </section>


        <section id="IRONIC-450-power_state">
            <!-- IRONIC-450 -->
            <title>Deployment to a node fails and in "ironic node-list" command, the power_state
                column for the node is shown as "None"</title>
            <p><b>Possible cause: </b> The IPMI commands to the node take longer to change the power
                state of the server.</p>
            <p><b>Resolution: </b> Check if the node power state can be changed using the following
                command <codeblock>ironic node-set-power-state $NODEUUID on</codeblock> If the above
                command succeeds and the power_state column is updated correctly, then the following
                steps are required to increase the power sync interval time.</p>
            <p> On the first controller, reconfigure Ironic to increase the power sync interval
                time. In the example below, it is set to 120 seconds. This value may have to be
                tuned based on the setup.</p>
            <ol>
                <li> Go to the <codeph>~/helion/my_cloud/config/ironic/</codeph> directory and edit
                        <codeph>ironic-conductor.conf.j2</codeph> to set the
                        <codeph>sync_power_state_interval</codeph> value:
                    <codeblock>[conductor]
sync_power_state_interval = 120</codeblock>
                </li>
                <li> Save the file and then run the following playbooks:
                    <codeblock>
cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml 
ansible-playbook -i hosts/localhost ready-deployment.yml 
cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts ironic-reconfigure.yml    
 </codeblock>
                </li>

            </ol>
        </section>

        <section id="IRONIC-360-iLO-SSO">
            <!-- IRONIC-360 -->
            <title>Error Downloading Image</title>
            <p>If you encounter the error below during the deployment:
                <codeblock>              
"u'message': u'Error downloading image: Download of image id 77700b53-9e15-406c-b2d5-13e7d9b96551 failed: Image download failed for all URLs.', 
u'code': 500, 
u'type': u'ImageDownloadError', 
u'details': u'Download of image id 77700b53-9e15-406c-b2d5-13e7d9b96551 failed: Image download failed for all URLs.'"
</codeblock>
                you should visit the Single Sign-On Settings in the Security page of iLO and change
                the Single Sign-On Trust Mode setting from the default of "Trust None (SSO
                disabled)" to "Trust by Certificate". </p>
        </section>



        <section id="IRONIC-450">
            <!-- IRONIC-450 -->
            <title>Using <codeph>node-inspection</codeph> can cause temporary claim of IP
                addresses</title>
            <p><b>Possible cause: </b> Running <codeph>node-inspection</codeph> on a node discovers
                all the NIC ports including the NICs that don’t have any connectivity. This causes a
                temporary consumption of the network IPs and increased usage of the allocated quota.
                As a result, other nodes are deprived of IP addresses and deployments can fail.</p>
            <p><b>Resolution: </b>You can add node properties manually added instead of using the
                inspection tool. </p>
            <p>Note: Upgrade <codeph>ipmitool</codeph> to a version >= 1.8.15 or it may not return
                detailed information about the NIC interface for <codeph>node-inspection</codeph>.
            </p>
        </section>

        <section id="IRONIC-450-deploying-state">
            <title>Node permanently stuck in deploying state</title>
            <p><b>Possible causes: </b>
                <ul>
                    <li>Ironic conductor service associated with the node could go down.</li>
                    <li>There might be a properties mismatch. MAC address registered for the node
                        could be incorrect.</li>

                </ul>
            </p>
            <p><b>Resolution: </b> To recover from this condition, set the provision state of the
                node to <codeph>Error</codeph> and maintenance to <codeph>True</codeph>. Delete the
                node and re-register again. </p>
        </section>



        <section id="NIC-boot-order">
            <title>The NICs in the baremetal node should come first in boot order</title>
            <p><b>Possible causes: </b> By default, the boot order of baremetal node is set as NIC1,
                HDD and NIC2. If NIC1 fails, the nodes starts booting from HDD and the provisioning
                fails. </p>
            <p><b>Resolution: </b> Set boot order so that all the NICs appear before the hard disk of the baremetal as
                NIC1, NIC2…, HDD. </p>
        </section>

        <section id="NIC-boot-order2">
            <title>Increase in the number of nodes can cause power commands to fail</title>
            <p><b>Possible causes: </b>Ironic periodically performs a power state sync with all the
                baremetal nodes. When the number of nodes increase, ironic does not get sufficient
                time to perform power operations.</p>
            <p><b>Resolution:</b> The following procedure gives a way to increase
                        <codeph>sync_power_state_interval</codeph>:
            </p>
            <ul>
                <li>Edit the file
                        <codeph>~/helion/my_cloud/config/ironic/ironic-conductor.conf.j2</codeph>
                    and navigate to the section for <codeph>[conductor]</codeph></li>
                
                <li>Increase the <codeph>sync_power_state_interval</codeph>. For example, for 100 nodes, 
                    set  <codeph>sync_power_state_interval = 90</codeph> and save the file. </li>
                <li>Execute the following set of commands to reconfigure Ironic:
                    <codeblock>
cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml 
ansible-playbook -i hosts/localhost ready-deployment.yml 
cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts ironic-reconfigure.yml    
 </codeblock>
                </li>


            </ul>
        </section>
        
        <section id="pxe_ipxe">
            <title>DHCP succeeds with PXE but times out with iPXE</title>
            <p>If you see DHCP error "No configuration methods succeeded" in iPXE, right after
                successful DHCP performed by embedded NIC firmware (please refer to screenshot
                below), there may be an issue with Spanning Tree Protocol on the switch.</p>
            <p><image href="../../../media/ironic/DHCP-pxe-ipxe.png" id="image_dbf_g5d_k1b"/></p>
            <p>To avoid this error, Rapid Spanning Tree Protocol needs to be enabled on the switch.
                If this is not an option due to conservative loop detection strategies, use the
                steps outlined below to install the iPXE binary with increased DHCP timeouts. <ol>
                    <li>Clone iPXE source code
                        <codeblock>$ git clone git://git.ipxe.org/ipxe.git
$ cd ipxe/src</codeblock>
                    </li>
                    <li>Modify lines 22-25 in file <codeph>config/dhcp.h</codeph>, which declare
                        reduced DHCP timeouts (1-10 secs). Comment out lines with reduced timeouts
                        and uncomment normal PXE timeouts (4-32)
                        <codeblock>//#define DHCP_DISC_START_TIMEOUT_SEC     1
//#define DHCP_DISC_END_TIMEOUT_SEC       10
#define DHCP_DISC_START_TIMEOUT_SEC   4       /* as per PXE spec */
#define DHCP_DISC_END_TIMEOUT_SEC     32      /* as per PXE spec */</codeblock>
                    </li>
                    <li>Make <codeph>undionly.kpxe</codeph> (BIOS) and <codeph>ipxe.efi</codeph>
                        (UEFI) images
                        <codeblock>$ make bin/undionly.kpxe
$ make bin-x86_64-efi/ipxe.efi</codeblock>
                    </li>
                    <li>Copy iPXE images to lifecycle manager
                        <codeblock>$ scp bin/undionly.kpxe bin-x86_64-efi/ipxe.efi stack@10.0.0.4:
stack@10.0.0.4's password:  
undionly.kpxe                                                           100%   66KB  65.6KB/s   00:00
ipxe.efi                                                                100%  918KB 918.2KB/s   00:00</codeblock>
                    </li>
                    <li>From deployer, distribute image files onto all 3 controllers
                        <codeblock>stack@helion-cp1-c1-m1-mgmt:~$ cd ~/scratch/ansible/next/hos/ansible/
                        
stack@helion-cp1-c1-m1-mgmt:~/scratch/ansible/next/hos/ansible$ ansible -i hosts/verb_hosts IRN-CND -m copy -b -a 'src=/home/stack/ipxe.efi dest=/tftpboot'
...
stack@helion-cp1-c1-m1-mgmt:~/scratch/ansible/next/hos/ansible$ ansible -i hosts/verb_hosts IRN-CND -m copy -b -a 'src=/home/stack/undionly.kpxe dest=/tftpboot'
...</codeblock>
                    </li>
                </ol> There is no need to restart services. With next PXE boot attempt, iPXE binary
                with the increased timeout will be downloaded to the target node via TFTP. </p>
        </section>
        


    </body>

</topic>
