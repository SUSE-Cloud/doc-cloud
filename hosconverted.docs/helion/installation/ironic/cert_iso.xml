<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: not edited-->
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="cert-iso">
    <title>Adding a certificate into an ISO image</title>
    
    <body><!--not tested-->
        <section>
    <p>As root, proceed with the following steps to disassemble the ISO image, and insert a new Certificate Authority or 
        Signing Certificate into the provided image.
    </p>

<ol>
    <li>Download the deployment ISO image from glance and place it in <codeph>/tmp/</codeph> as <codeph>ironic-deploy.iso</codeph>.
    </li>
    
    <li>Make a temporary folder to mount the <codeph>ironic-deploy.iso</codeph> image to in order to extract itâ€™s contents.
        <codeblock>mkdir /mnt/deploy_iso</codeblock>
    </li>
    
    <li>Mount the <codeph>ironic-deploy.iso</codeph> image file to a the folder you just create.  
        <codeblock>mount -o loop /tmp/ironic-deploy.iso /mnt/deploy_iso/</codeblock>
    </li>
    
    <li>Make a temporary location to stage the new image.
        <codeblock>mkdir /tmp/new_deploy_iso</codeblock>
    </li>
    
    <li>Copy the contents from the previous image into the new temporary staging location.
        <codeblock>cp -ra /mnt/deploy_iso/. /tmp/new_deploy_iso/</codeblock>
    </li>
    
    <li>Make a folder to house the ramdisk that will need to be extracted from the ISO image.
        <codeblock>mkdir /tmp/new_deploy_ramdisk</codeblock>
    </li>
    
    <li>Change your working directory to <codeph>/tmp/new_deploy_ramdisk</codeph>
        <codeblock>cd /tmp/new_deploy_ramdisk</codeblock>
    </li>
    
    <li>Unpack the ramdisk image.
        <codeblock>zcat /tmp/new_deploy_iso/initrd | cpio --extract --make-directories</codeblock>
    </li>
    
    <li>Append your CA certificate to the file located at <codeph>/tmp/new_deploy_ramdisk/usr/local/lib/python2.7/dist-packages/requests/cacert.pem</codeph>, example below:
        <codeblock>cat your_ca_certificate.pem >> /tmp/new_deploy_ramdisk/usr/local/lib/python2.7/dist-packages/requests/cacert.pem</codeblock>
    </li>
    
    <li>Replace the pre-existing initial ramdisk in the extracted disk image.
        <codeblock>find . | cpio --create --format='newc' | gzip -c -9 > /tmp/new_deploy_iso/initrd</codeblock>
    </li>
    
    <li>Change directory back to the new deployment ISO image folder.
        <codeblock>cd /tmp/new_deploy_iso</codeblock>
    </li>
    
    <li>Ensure that the program <codeph>xorriso</codeph> is available, you may need to execute <codeph>apt-get install xorriso</codeph> to install it.
    </li>
    
    <li>Create the new ISO deployment image utilizing the following command.
        <codeblock>xorriso -as mkisofs -b isolinux/isolinux.bin -c boot.cat -V VMEDIA_BOOT_ISO -r -J -no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot --efi-boot boot/grub/efi.img -isohybrid-gpt-basdat -isohybrid-apm-hfsplus -o /tmp/new_ironic_deploy.iso ./</codeblock>
    </li>
    
</ol>
            
    <p>        
Once completed, the new image can be found at <codeph>/tmp/new_ironic_deploy.iso</codeph>, and will need to be uploaded to Glance. 
        New Glance IDs will need to be recorded for any instances requiring this new image, as noted in the parent paragraph

    </p>
            
        </section>
    </body>
</topic>

