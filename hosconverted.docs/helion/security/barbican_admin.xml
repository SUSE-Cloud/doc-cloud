<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: ready for edit (Nancy)-->
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="barbicanAdmin">
  <title><ph conkeyref="HOS-conrefs/product-title"/>Key Management Service Administration</title>
  <body>
    <!--not tested-->
    <p conkeyref="HOS-conrefs/applies-to"/>


    <section id="post_installation"><title>Post-installation verification and administration</title>
      <p>In a production environment, you can verify your installation of the Barbican key
        management service by running the <codeph>barbican-status.yml</codeph> Ansible playbook on
        the lifecycle manager node.
        <codeblock>ansible-playbook -i hosts/verb_hosts barbican-status.yml</codeblock>In any
        non-production environment, along with the playbook, you may also verify the service by
        storing and retrieving the secret from Barbican, if you like. </p>
      <p id="config"><b>Updating the Barbican key management service</b></p><p>Some Barbican features and service configurations can be changed. This is done using the HLM
        reconfigure Ansible playbook. For example, the log level can be changed from INFO to DEBUG
        and vice-versa. If needed, this change can be restricted to a set of nodes via the
        playbook's host limit option. Note that Barbican administration tasks should be performed by
        an admin user with a token scoped to the default domain via the Keystone v3 identity API.
        These settings are preconfigured in the barbican.osrc file. By default, barbican.osrc is
        configured with the admin endpoint. If the admin endpoint is not accessible from your
        network, change OS_AUTH_URL to point to the public endpoint.</p>
    </section>
    <section id="updating">
      <p>The following Barbican configuration settings can be changed:</p>
      <ul>
        <li>Anything in the main Barbican configuration file:
            <codeph>/etc/barbican/barbican.conf</codeph></li>
        <li>Anything in the main Barbican worker configuration file:
            <codeph>/etc/barbican/barbican-worker.conf</codeph></li>
      </ul>
      <p>You can also update the following configuration options and enable the following features.
        For example, you can:</p>
      <ul>
        <li>Change the verbosity of logs written to Barbican log files
            (<codeph>var/log/barbican/</codeph>). </li>
        <li>Enable and disable auditing of the Barbican key management service</li>
        <li>Edit <codeph>barbican_secret_store</codeph> plug-ins. The two options are:<ul>
            <li><codeph>store_crypto</codeph> used to store the secrets in the database </li>
            <li><codeph>kmip_plugin</codeph> used to store the secrets into KMIP enabled external
              devices like Atalla ESKM</li>
          </ul></li>
      </ul></section>
    <section>
      <title> Enable or disable auditing of Barbican events</title> Auditing of Barbican key manager
      events can be disabled or enabled by following steps on deployer node. <ol>
        <li> Edit the file <codeph>~/helion/my_cloud/definition/cloudConfig.yml </codeph><p>All
            audit related configuration is defined under audit-settings section. Note that valid
            yaml syntax is required when specifying values.</p>
          <p>Service name defined under <codeph>enabled-services</codeph> or
              <codeph>disabled-services</codeph> override the default setting (i.e. <codeph>default:
              enabled</codeph> or <codeph>default: disabled</codeph>)</p>
        </li>
        <li>To enable auditing, make sure that the barbican service name is listed in the
            <codeph>enabled-services</codeph> list of <codeph>audit-settings</codeph> section or is
          not listed in the <codeph>disabled-services</codeph> list when default: is set to
            <codeph>enabled</codeph>.</li>
        <li>To disable auditing for the Barbican service specifically, make sure that barbican
          service name is in <codeph>disabled-services</codeph> list of the<codeph>
            audit-settings</codeph> section or is not present in the
            <codeph>enabled-services</codeph> list when default: is set to
          <codeph>disabled</codeph>. You should not specify the service name in both lists. If it is
          specified in both, the enabled-services list takes precedence. </li>
        <li>Commit the change in git
          repository.<codeblock>cd ~/helion/hos/ansible
git add -A
git commit -m "My config" </codeblock></li>
        <li>Run the configuration-processor-run and ready-deployment playbooks, followed by the
          barbican-reconfigure
          playbook:<codeblock>cd ~/helion/hos/ansible/
ansible-playbook -i hosts/localhost config-processor-run.yml
ansible-playbook -i hosts/localhost ready-deployment.yml
cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts barbican-reconfigure.yml</codeblock>
        </li>
      </ol>
    </section>
    <section>
      <p id="configFile"><b>Updating the Barbican API service configuration file</b></p>
      <ul>
        <li>The Barbican API service configuration file
            (<codeph>/etc/barbican/barbican.conf</codeph>), located on each control plane server
          (controller node) is generated from the following template file located on the lifecycle
          manager node:
            <codeph>/home/stack/helion/my_cloud/config/barbican/barbican.conf.j2</codeph>. Modify
          this template file as appropriate. This is a Jinja2 template, which expects certain
          template variables to be set. Do not change values inside double curly braces: {{ }}. </li>
        <li>Once the template is modified, copy the files to
            <codeph>~/helion/my_cloud/definition/</codeph>, and commit the change to the local git
          repository:
          <codeblock>cp -r ~/hp-ci/padawan/* ~/helion/my_cloud/definition/
cd ~/helion/hos/ansible
git add -A
git commit -m "My config"</codeblock></li>

        <li>Then rerun the configuration processor and ready-deployment playbooks:
          <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml
ansible-playbook -i hosts/localhost ready-deployment.yml</codeblock>
        </li>
        <li>Finally, run the barbican-reconfigure playbook in the deployment area:
          <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts barbican-reconfigure.yml</codeblock>
        </li>
      </ul>
    </section>
    <section><title>Starting and stopping the Barbican service</title>
      <p>You can start or stop the Barbican service from the deployer nodes by running the
        appropriate Ansible playbooks: </p>To stop the Barbican service:
      <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts barbican-stop.yml</codeblock>
      To start the Barbican service:
      <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts barbican-start.yml</codeblock>
    </section>
    
    <section><title>Changing or resetting a password</title> To change the password for the Barbican
      administrator, first copy the file
      below:<codeblock>cp ~/helion/my_cloud/info/private_data_metadata.yml to ~/helion/change_credentials/ </codeblock>
      Then edit private_data_metadata.yml found
      here:<codeblock>~/helion/change_credentials/private_data_metadata.yml</codeblock>Next, change
      credentials for the barbican admin user and /or barbican service user. Remove everything else.
      The file will look similar to this:
      <codeblock>barbican_admin_password:
    value: <b>'testing_123'</b>
    metadata:
    - clusters:
        - cluster1
        component: barbican-api
        cp: ccp
    version: '2.0'
barbican_service_password:
    value:<b> 'testing_123'</b>
    metadata:
    - clusters:
        - cluster1
        component: barbican-api
        cp: ccp
    version: '2.0'
  </codeblock>Note
      that the value (shown in bold) is optional; it is used to set a user-chosen password. If left
      blank, the playbook will generate a random password. </section>
    <section>Next, execute the following playbooks from
      helion/hos/ansible/:<codeblock>cd ~/helion/hos/ansible/
ansible-playbook -i hosts/localhost config-processor-run.yml -e encrypt="" -e rekey=""
ansible-playbook -i hosts/localhost ready-deployment.yml
cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts barbican-reconfigure-credentials-change.yml</codeblock>Finally,
      ssh to the controller and make sure the password ha been properly updated in </section>
    <section><codeblock>/etc/barbican# vi barbican-api-paste.ini </codeblock>You can verify Barbican
      status by running the <codeph>barbican-status.yml</codeph> Ansible playbook on the lifecycle
      manager node.
      <codeblock>ansible-playbook -i hosts/verb_hosts barbican-status.yml</codeblock></section>
    <section>
      <note>Make sure you remove/delete ~/helion/change_credentials/private_data_metadata.yml after
        successfully changing the password. </note>
    </section>
    
    <section><title>Updating Logging Configuration</title> All of the Barbican logging is set to
      INFO by default. To change the level from the lifecycle manager, there are two options
      available <ol>
        <li> Edit the Barbican configuration file by going into the following directory and editing
          the file called
          <codeph>/barbican_deploy_config.yml</codeph><codeblock>~/helion/my_cloud/config/barbican/</codeblock>To
          change log level entry (<codeph>barbican_loglevel</codeph>) to DEBUG, edit the entry like
          so:<codeblock>barbican_loglevel = {{ helion_loglevel | default('DEBUG') }} </codeblock>To
          change the log level to INFO, edit like
          so:<codeblock>barbican_loglevel = {{ helion_loglevel | default('INFO') }} </codeblock></li>
        <li>Edit file <codeph>~/helion/hos/ansible/roles/KEYMGR-API/templates/api-logging.conf.j2
          </codeph>and update the log level accordingly. </li>
      </ol> Once the change is made, commit the change to the local git repository:
      <codeblock>cd ~/helion/hos/ansible
git add -A
git commit -m "My config" </codeblock>Run the
      configuration-processor-run and ready-deployment playbooks, followed by the
      barbican-reconfigure
      playbook:<codeblock>ansible-playbook -i hosts/localhost config-processor-run.yml
ansible-playbook -i hosts/localhost ready-deployment.yml
cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts barbican-reconfigure.yml</codeblock>
    </section>
  </body>
</topic>
