<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: ready for edit (Nancy)-->
<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd" >
<topic xml:lang="en-us" id="neutron_provider_networks">
  <title><ph conkeyref="HOS-conrefs/product-title"/>Neutron Provider Networks</title>

  <body>
    <!--not tested-->
    <section>
      <p>This topic explains how to create a Neutron provider network. </p>
      <title>Provider networks overview</title>
      <p id="provider_network_summary">A provider network is a virtual network created in the
          <keyword keyref="kw-hos"/> cloud that is consumed by Helion services. The distinctive
        element of a provider network is that it does not create a virtual router; rather, it
        depends on L3 routing that is provided by the infrastructure. </p>
      <p>A provider network is created by adding the specification to the <keyword keyref="kw-hos"/>
        input model. It consists of at least one network and one or more subnets. </p>
    </section>
    <section>
      <title><keyword keyref="kw-hos"/> input model</title>
      <p>The input model is the primary mechanism a cloud admin uses in defining a Helion
        installation. It exists as a directory with a data subdirectory that contains YAML files. By
        convention, any service that creates a Neutron provider network will create a subdirectory
        under the data directory and the name of the subdirectory shall be the project name. For
        example, the Octavia project will use Neutron provider networks so it will have a
        subdirectory named 'octavia' and the config file that specifies the neutron network will
        exist in that subdirectory.</p>
      <codeblock>├── cloudConfig.yml
    ├── data
    │   ├── control_plane.yml
    │   ├── disks_compute.yml
    │   ├── disks_controller_1TB.yml
    │   ├── disks_controller.yml
    │   ├── disks_vsa.yml
    │   ├── firewall_rules.yml
    │   ├── net_interfaces.yml
    │   ├── network_groups.yml
    │   ├── networks.yml
    │   ├── neutron
    │   │   └── neutron_config.yml
    │   ├── nic_mappings.yml
    │   ├── server_groups.yml
    │   ├── server_roles.yml
    │   ├── servers.yml
    │   ├── swift
    │   │   └── rings.yml
    │   └── octavia
    │       └── octavia_config.yml
    ├── README.html
    └── README.md</codeblock>
    </section>
    <section><title>Network/Subnet specification</title>
      <p>The elements required in the input model for you to define a network are: </p><ul>
        <li>name </li>
        <li>network_type </li>
        <li>physical_network</li>
      </ul> Elements that are optional when defining a network are: <ul>
        <li>segmentation_id </li>
        <li>shared </li>
      </ul> Required elements for the subnet definition are: <ul>
        <li>cidr</li>
      </ul> Optional elements for the subnet definition are: <ul>
        <li>allocation_pools which will require start and end addresses </li>
        <li>host_routes which will require a destination and nexthop </li>
        <li>gateway_ip </li>
        <li>no_gateway </li>
        <li>enable-dhcp </li>
      </ul> NOTE: Only IPv4 is supported at the present time. </section>
    <section>
      <title>Network details</title>
      <p>The following table outlines the network values to be set, and what they represent.</p>
      <table frame="all" rowsep="1" colsep="1" id="table_lnv_y5n_2v">
        <tgroup cols="4">
          <colspec colname="c1" colnum="1" colwidth="1.02*"/>
          <colspec colname="c2" colnum="2" colwidth="1*"/>
          <colspec colname="c3" colnum="3" colwidth="1.05*"/>
          <colspec colname="c4" colnum="4" colwidth="1.72*"/>
          <thead>
            <row>
              <entry>Attribute</entry>
              <entry>Required/optional</entry>
              <entry>Allowed Values</entry>
              <entry>Usage</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>name</entry>
              <entry>Required</entry>
              <entry/>
              <entry/>
            </row>
            <row>
              <entry>network_type</entry>
              <entry>Required</entry>
              <entry>flat, vlan, vxlan</entry>
              <entry>The type of desired network</entry>
            </row>
            <row>
              <entry>physical_network</entry>
              <entry>Required</entry>
              <entry>Valid</entry>
              <entry>Name of physical network that is overlayed with the virtual network</entry>
            </row>
            <row>
              <entry>segmentation_id</entry>
              <entry>Optional</entry>
              <entry>vlan or vxlan ranges</entry>
              <entry>VLAN id for vlan or tunnel id for vxlan</entry>
            </row>
            <row>
              <entry>shared</entry>
              <entry>Optional</entry>
              <entry>True</entry>
              <entry>Shared by all projects or private to a single project</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
    </section>
    <section>
      <p>The following table outlines the subnet values to be set, and what they represent. </p>
      <title>Subnet details</title>
      <table frame="all" rowsep="1" colsep="1" id="table_pzw_3wn_2v">
        <tgroup cols="4">
          <colspec colnum="1" colname="col1"/>
          <colspec colnum="2" colname="col2"/>
          <colspec colnum="3" colname="col3"/>
          <colspec colnum="4" colname="col4"/>
          <thead>
            <row>
              <entry>Attribute</entry>
              <entry>Req/Opt</entry>
              <entry>Allowed Values</entry>
              <entry>Usage</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>cidr</entry>
              <entry>Required</entry>
              <entry>Valid CIDR range</entry>
              <entry>e.g. 172.30.0.0/24</entry>
            </row>
            <row>
              <entry>allocation_pools</entry>
              <entry>Optional</entry>
              <entry>See allocation_pools table below</entry>
              <entry> </entry>
            </row>
            <row>
              <entry>host_routes</entry>
              <entry>Optional</entry>
              <entry>See host_routes table below</entry>
              <entry> </entry>
            </row>
            <row>
              <entry>gateway_ip</entry>
              <entry>Optional</entry>
              <entry>Valid IP addr</entry>
              <entry>Subnet gateway to other nets</entry>
            </row>
            <row>
              <entry>no_gateway</entry>
              <entry>Optional</entry>
              <entry>True</entry>
              <entry>No distribution of gateway</entry>
            </row>
            <row>
              <entry>enable-dhcp</entry>
              <entry>Optional</entry>
              <entry>True</entry>
              <entry>Enable dhcp for this subnet</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
    </section>
    <section>
      <title>ALLOCATION_POOLS details</title>
      <p>The following table explains allocation pool settings.</p>
      <table frame="all" rowsep="1" colsep="1" id="table_h5p_5wn_2v">
        <tgroup cols="4">
          <colspec colnum="1" colname="col1"/>
          <colspec colnum="2" colname="col2"/>
          <colspec colnum="3" colname="col3"/>
          <colspec colnum="4" colname="col4"/>
          <thead>
            <row>
              <entry>Attribute</entry>
              <entry>Req/Opt</entry>
              <entry>Allowed Values</entry>
              <entry>Usage</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>start</entry>
              <entry>Required</entry>
              <entry>Valid IP addr</entry>
              <entry>First ip address in pool</entry>
            </row>
            <row>
              <entry>end</entry>
              <entry>Required</entry>
              <entry>Valid IP addr</entry>
              <entry>Last ip address in pool</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
    </section>
    <section>
      <title>HOST_ROUTES details</title>
      <p>The following table explains host route settings.</p>
      <table frame="all" rowsep="1" colsep="1" id="table_gfj_dxn_2v">
        <tgroup cols="4">
          <colspec colnum="1" colname="col1"/>
          <colspec colnum="2" colname="col2"/>
          <colspec colnum="3" colname="col3"/>
          <colspec colnum="4" colname="col4"/>
          <thead>
            <row>
              <entry>Attribute</entry>
              <entry>Req/Opt</entry>
              <entry>Allowed Values</entry>
              <entry>Usage</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>destination</entry>
              <entry>Required</entry>
              <entry>Valid CIDR</entry>
              <entry>Destination subnet</entry>
            </row>
            <row>
              <entry>nexthop</entry>
              <entry>Required</entry>
              <entry>Valid IP addr</entry>
              <entry>Hop to take to destination subnet</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
      <note>Multiple destination/nexthop may be used</note>
    </section>
    <section><title>Examples</title><p>The following examples show the configuration file settings
        for Neutron and Octavia.</p><p><b>Octavia configuration</b></p><p>This file defines the
        mapping. It doesn't need to be edited unless you want to change the name of your
        VLAN.</p><p>Path:
          <codeph>~/helion/my_cloud/definition/data/octavia/octavia_config.yml</codeph></p><codeblock>---
  product:
    version: 2

  configuration-data:
    - name: OCTAVIA-CONFIG-CP1
      services:
        - octavia
      data:
        amp_network_name: OCTAVIA-MGMT-NET</codeblock><p><b>Neutron
          configuration</b></p><p>Input your network configuration information for your provider
        VLANs in <codeph>neutron_config.yml</codeph> found here:
        </p><codeph>~/helion/my_cloud/definition/data/neutron/</codeph>.<codeblock>---
  product:
    version: 2

  configuration-data:
    - name:  NEUTRON-CONFIG-CP1
      services:
        - neutron
      data:
        neutron_provider_networks:
        - name: OCTAVIA-MGMT-NET
          provider:
            - network_type: vlan
              physical_network: physnet1
              segmentation_id: 2754
          cidr: 10.13.189.0/24
          no_gateway:  True
          enable_dhcp: True
          allocation_pools:
            - start: 10.13.189.4
              end: 10.13.189.252
          host_routes:
            # route to MANAGEMENT-NET
            - destination: 10.13.111.128/26
              nexthop:  10.13.189.5</codeblock>
    </section>
    <section>
      <title>Implementing your changes</title>
      <ol>
        <li>Commit the changes to git:
          <codeblock>git add -A
git commit -a -m "configuring provider network"</codeblock></li>
        <li>Run the configuration processor:
          <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</codeblock></li>
        <li>Update your deployment directory:
          <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</codeblock></li>
        <li>Then continue with your clean cloud installation.</li>
        <li>If you are only adding a Neutron Provider network to an existing model, then run the
          neutron-reconfigure.yml
          playbook:<codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts neutron-deploy.yml</codeblock></li>
      </ol>
    </section>

    <section id="MultipleProviderNetworks">
      <title>Multiple Provider Networks</title>
      <p>The physical network infrastructure must be configured to convey the provider VLAN traffic
        as tagged VLANs to the cloud compute nodes and network service network nodes. Configuration
        of the physical network infrastructure is outside the scope of the <keyword
          keyref="kw-hos-phrase"/> software.</p>
      <p><keyword keyref="kw-hos-phrase"/> automates the server networking configuration and the
        Network Service configuration based on information in the cloud definition. To configure the
        system for provider VLANs, specify the<i> neutron.networks.vlan</i> tag with a
          <i>provider-physical-network</i> attribute on one or more network groups. For example
        (some attributes omitted for brevity):</p>
      <codeblock>network-groups:
        
        - name: NET_GROUP_A
        tags:
        - neutron.networks.vlan:
        provider-physical-network: physnet1
        
        - name: NET_GROUP_B
        tags:
        - neutron.networks.vlan:
        provider-physical-network: physnet2</codeblock>
      <p>A network group is associated with a server network interface via an interface model. For
        example (some attributes omitted for brevity):</p>
      <codeblock>interface-models:
        - name: INTERFACE_SET_X
        network-interfaces:
        - device:
        name: bond0
        network-groups:
        - NET_GROUP_A
        - device:
        name: eth3
        network-groups:
        - NET_GROUP_B
      </codeblock>
      <p>A network group used for provider VLANs may contain only a single <keyword keyref="kw-hos"
        /> network, because that VLAN must span all compute nodes and any Network Service network
        nodes/controllers (i.e. it is a single L2 segment). The <keyword keyref="kw-hos"/> network
        must be defined with tagged-vlan false, otherwise a linux vlan network interface will be
        created. For example:</p>
      <codeblock>networks:
        
        - name: NET_A
        tagged-vlan: false
        network-group: NET_GROUP_A
        
        - name: NET_B
        tagged-vlan: false
        network-group: NET_GROUP_B</codeblock>
      <p>When the cloud is deployed, <keyword keyref="kw-hos-phrase"/> will create the appropriate
        bridges on the servers, and set the appropriate attributes in the Neutron configuration
        files (e.g. bridge_mappings).</p>
      <p>After the cloud has been deployed, create Network Service network objects for each provider
        VLAN. For example, using the Network Service CLI:</p>
      <codeblock>neutron net-create --provider:network_type vlan --provider:physical_network physnet1 --provider:segmentation_id 101 mynet101
neutron net-create --provider:network_type vlan --provider:physical_network physnet2 --provider:segmentation_id 234 mynet234</codeblock>
    </section>


    <section id="MoreInfo">
      <title>More Information</title>
      <p>For more information on the Network Service command-line interface (CLI), see the OpenStack
        networking command-line client reference: <xref
          href="http://docs.openstack.org/cli-reference/content/neutronclient_commands.html"
          scope="external" format="html"/></p>
    </section>
  </body>
</topic>
