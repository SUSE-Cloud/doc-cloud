<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><!--Edit status: not edited-->
<section id="upgrade_ironic">
   <title>
      <phrase/>Ironic Post-Upgrade Procedures</title>
    
    
    
      <bridgehead renderas="sect4">Glance Container Name Change Requires Update of Driver Information</bridgehead>
      <para>If you have Ironic nodes in your existing  <phrase/> cloud, with perhaps some
        nodes running provisioned instances and some in the available state, you will need to update the driver
        information after upgrade to <phrase/> to point at  new deploy images.
      
      </para>

      <para>After upgrade, a registered ironic node  could be in <literal>Available</literal>, <literal>Active</literal> 
        (with running instances) or <literal>clean_failed</literal> provisioning states. Use the information in the
      following sections to update the driver information appropriately.</para>

   
    
    
      <bridgehead renderas="sect4">Node has  provisioning state  <literal>Available</literal> or <literal>Active</literal>
      </bridgehead>
      <para>
       Update node <literal>driver-info</literal> to use latest version of the deployed image, for example:
          </para>
<itemizedlist>
            <listitem>
               <para>Extract <literal>glance_ramdisk_uuid</literal> using  <literal>glance image-list | grep ir-deploy-ramdisk-HOS4.0 </literal></para>
            </listitem>
            <listitem>
               <para>Extract <literal>glance_kernel_uuid</literal> using  <literal>glance image-list | grep ir-deploy-kernel-HOS4.0 </literal></para>
            </listitem>
            <listitem>
               <para><literal>ironic node-update $node_id add driver_info/deploy_kernel=$glance_kernel_uuid driver_info/deploy_ramdisk=$glance_ramdisk_uuid</literal></para>
            </listitem>
          </itemizedlist>

   
    
    
      <bridgehead renderas="sect4">Node Enters clean_failed State after Upgrade</bridgehead>
      <para>If you have  provisioned a node in <phrase/><phrase/> and you try to delete the node after upgrade
        to <phrase/>, 
        then node enters the  <literal>clean_failed</literal> state. Execute the following steps to fix the problem:</para>

      <itemizedlist>
        <listitem>
            <para><literal>ironic node-set-provision-state $node_id manage</literal></para>

         </listitem>
        <listitem>
            <para>Update node <literal>driver-info</literal> to use latest version of the deployed image, for example:
          </para>

            <itemizedlist>
               <listitem>
                  <para>Extract <literal>glance_ramdisk_uuid</literal> using  <literal>glance image-list | grep ir-deploy-ramdisk-HOS4.0 </literal></para>

               </listitem>
               <listitem>
                  <para>Extract <literal>glance_kernel_uuid</literal> using  <literal>glance image-list | grep ir-deploy-kernel-HOS4.0 </literal></para>

               </listitem>
               <listitem>
                  <para><literal>ironic node-update $node_id add driver_info/deploy_kernel=$glance_kernel_uuid driver_info/deploy_ramdisk=$glance_ramdisk_uuid</literal></para>

               </listitem>
            </itemizedlist>
         </listitem>
        <listitem>
            <para><literal>ironic node-set-maintenance $node_id false</literal></para>

         </listitem>
        <listitem>
            <para>ironic node-set-provision-state $node_id provide</para>

         </listitem>

      </itemizedlist>
   
    
    
      <bridgehead renderas="sect4">Re-upload User Images for Agent-Based Drivers</bridgehead>
      <para>After upgrade from <phrase/><phrase/>, if you have a node enrolled with agent based drivers and
      and try to spawn an instance with user images uploaded in <phrase/>, instance creation will fail with the message 
        "Error downloading image". </para>

      <para>You will need to re-upload any user images that were uploaded in <phrase/>, so that the images are uploaded to a new glance container.
        This will allow instance creation from nodes with agent-based drivers to succeed.</para>

      <para>In the followng example, the <literal>rhel_bios</literal> image is downloaded from Glance, and then re-uploaded to Glance.
    
      </para>
<itemizedlist>
            <listitem>
               <para>
          List all the images:
</para>
               <screen>
glance image-list

+--------------------------------------+--------------------------+
| ID                                   | Name                     |
+--------------------------------------+--------------------------+
| 5e38b504-68be-485b-a9f9-b1e0f3099566 | ir-deploy-iso-HOS3.0     |
| 74503106-0ac2-4135-9a46-09af503331f2 | ir-deploy-iso-HOS4.0     |
| c24235c8-7c31-46b0-b61e-acf665d35d42 | ir-deploy-kernel-HOS3.0  |
| 82a9b2ce-1913-4d83-9c0f-3291190b8fca | ir-deploy-kernel-HOS4.0  |
| aa642a5b-7cfd-4436-aa7a-651a420c9712 | ir-deploy-ramdisk-HOS3.0 |
| 646e2b3c-7f57-4fb3-9491-fdbefe9d3649 | ir-deploy-ramdisk-HOS4.0 |
| a0107aaf-ac8d-4958-9b87-c1f7a5e367d3 | <emphasis role="bold">rhel_bios</emphasis>                |
| e35cdf43-a520-46fd-b3e8-9f94fde87075 | update_ramdisk_3.0       |
+--------------------------------------+--------------------------+
</screen>
            </listitem>
            <listitem>
               <para>Download the <literal>rhel_bios</literal> image from Glance

</para>
               <screen>
glance image-download --file /tmp/rhel_bios_4.0 a0107aaf-ac8d-4958-9b87-c1f7a5e367d3
</screen>
            </listitem>
        
            <listitem>
               <para>
          Re-upload the image to Glance with a different name:
</para>
               <screen>
glance image-create --name rhel_bios_4.0 --file /tmp/rhel_bios_4.0 --disk-format qcow2 --container-format bare --progress --visibility public
[=============================&gt;] 100%
+------------------+--------------------------------------+
| Property         | Value                                |
+------------------+--------------------------------------+
| checksum         | 52ca72e12f7f82c6cd36f5e0e109a930     |
| container_format | bare                                 |
| created_at       | 2016-10-21T06:37:27Z                 |
| disk_format      | qcow2                                |
| id               | ade5e26b-6246-4b6e-b315-28bced03c7e1 |
| min_disk         | 0                                    |
| min_ram          | 0                                    |
| name             | rhel_bios_4.0                        |
| owner            | 650d45fca5d24b729cd97890ea74df82     |
| protected        | False                                |
| size             | 413024256                            |
| status           | active                               |
| tags             | []                                   |
| updated_at       | 2016-10-21T06:37:37Z                 |
| virtual_size     | None                                 |
| visibility       | public                               |
+------------------+--------------------------------------+
</screen>
            </listitem>
            <listitem>
               <para>List all the images again to see the re-uploaded version:
</para>
               <screen>
 glance image-list

+--------------------------------------+--------------------------+
| ID                                   | Name                     |
+--------------------------------------+--------------------------+
| 5e38b504-68be-485b-a9f9-b1e0f3099566 | ir-deploy-iso-HOS3.0     |
| 74503106-0ac2-4135-9a46-09af503331f2 | ir-deploy-iso-HOS4.0     |
| c24235c8-7c31-46b0-b61e-acf665d35d42 | ir-deploy-kernel-HOS3.0  |
| 82a9b2ce-1913-4d83-9c0f-3291190b8fca | ir-deploy-kernel-HOS4.0  |
| aa642a5b-7cfd-4436-aa7a-651a420c9712 | ir-deploy-ramdisk-HOS3.0 |
| 646e2b3c-7f57-4fb3-9491-fdbefe9d3649 | ir-deploy-ramdisk-HOS4.0 |
| a0107aaf-ac8d-4958-9b87-c1f7a5e367d3 | rhel_bios                |
| ade5e26b-6246-4b6e-b315-28bced03c7e1 | <emphasis role="bold">rhel_bios_4.0</emphasis>            |
| e35cdf43-a520-46fd-b3e8-9f94fde87075 | update_ramdisk_3.0       |
+--------------------------------------+--------------------------+
</screen>
            </listitem>
        
         </itemizedlist>

   
    
  </section>
