<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><!--Edit status: not edited-->
<section id="upgrade_recover_rabbit">
   <title>
      <phrase/>Recovering RabbitMQ after Failure during Upgrade</title>
        <para/>

   
      <bridgehead renderas="sect4">Recovering RabbitMQ after Failure during Upgrade</bridgehead>
      <para>During upgrade, RabbitMQ can lockup at cluster synchronization. If you encounter an error similar to the following during upgrade, you should run the RabbitMQ disaster 
        recovery playbook and start the upgrade again.</para>
      <screen>
2016-08-12 00:05:21,579 p=41620 u=stack |  TASK: [rabbitmq | _wait-for-cluster-sync | Check if RabbitMQ is in a cluster] ***
2016-08-12 00:05:23,311 p=41620 u=stack |  ok: [hlm002-cp1-c1-m1-mgmt -&gt; hlm002-cp1-c1-m2-mgmt]
2016-08-12 00:05:23,439 p=41620 u=stack |  TASK: [rabbitmq | _wait-for-cluster-sync | Wait for HA queue sync to complete] *** <emphasis role="bold">&lt;&lt;---- locks up</emphasis>
      </screen>
      <para>
         <emphasis role="bold">Recovering RabbitMQ:</emphasis>
      </para>
      <orderedlist>
        <listitem>
            <para>From the lifecycle manager, run the <literal>rabbitmq-disaster-recovery.yml</literal>
                    playbook:
                        </para>
            <screen>cd ~/scratch/ansible/next/hos/ansible/
ansible-playbook -i hosts/verb_hosts rabbitmq-disaster-recovery.yml</screen>
            <para>This
                        will tear down and reset any running RabbitMQ nodes. This has an extreme
                        effect on services. This should take roughly two minutes to complete, at
                        which point the RabbitMQ cluster will have been recreated from scratch with
                        service credentials reprovisioned into it.</para>
         </listitem>
        
        <listitem>
            <para> Then re-run the <literal>hlm-upgrade.yml</literal> playbook:
                    </para>
            <screen>cd ~/scratch/ansible/next/hos/ansible/
ansible-playbook -i hosts/verb_hosts hlm-upgrade.yml</screen>
         </listitem>
        
      </orderedlist>
   
        
    </section>
