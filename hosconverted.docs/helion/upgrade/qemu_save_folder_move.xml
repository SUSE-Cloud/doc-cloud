<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: not edited-->
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="qemu_save_folder_move">
    <title><ph conkeyref="HOS-conrefs/product-title"/>Handle <codeph>qemu/save</codeph> Folder Migration </title>
    <body><!--not tested-->
        <p conkeyref="HOS-conrefs/applies-to"/>
        
        <section>
            <title>Introduction</title>
            
            <p>In <keyword keyref="kw-hos-phrase-21"/>, the folder used for saving suspended instances,
                <codeph>/var/lib/libvirt/qemu/save</codeph>, is on the root filesystem which typically has
                limited capacity. To overcome this issue, <keyword keyref="kw-hos-phrase"/> uses a symbolic link  to a 
                new folder created in <codeph>/var/lib/nova/save</codeph>.
            </p>
            
            <p>When you are performing an upgrade, you will first need to wait for all on-going suspend and resume
                operations to complete and advise users that they should not perform any new suspend or resume 
                operations until the upgrade is finished.
            
                This is because, during the upgrade,  all the images of saved (suspended) instances are moved to the new folder 
                and then the original folder is deleted.  If there are any ongoing operations,  the folder could be deleted 
                before  suspend operations complete and then it will not be possible to resume the suspended instance(s).
                
                Also, during the upgrade, the nova compute manager processes will be restarted so any suspend/resume 
                operation in progress will be terminated when the compute manager on their host is restarted.
                
                During the compute manager restart, the task state should be reset.
            </p>
            
        </section>
 
        <section>
            <title>Identifying and Restarting Suspended Instances</title>
            
            <p>To identify suspended instances, execute the following nova command as an admin user:</p>
            
<codeblock>
nova list --all-tenants --status suspended --fields=name,status,task_state,host,flavor
</codeblock>      
            
            <p>To identify instances currently suspending or resuming, execute the following nova command as an admin user:</p>
            
<codeblock>
nova list --all-tenants --fields=name,status,task_state,host,flavor | grep 'suspending|resuming'
</codeblock>              
            
            <p>To restart the state of suspended instances for which the save file has been lost, enter the following nova command as an admin user:</p>
            
<codeblock>
nova reboot --hard &lt;uuid>
</codeblock>         
            <note type="note">The server will reboot rather than resume.</note>
            
            <p>To reset the state of instances in the progress of suspending/resuming at the time of the upgrade, enter the following nova command as an admin user:</p>
            
<codeblock>
nova reset-state --active &lt;uuid>
nova reboot --hard &lt;uuid>
</codeblock>        
            
            <note type="important">
                If a compute node has a lot of suspended instances, the upgrade process from <keyword keyref="kw-hos-phrase-21"/> to 
                <keyword keyref="kw-hos-phrase"/> could take a long time as all the images for the suspended instances need to be 
                copied to the new location.                
            </note>
            
        </section>
        
 
    </body>
</topic>
