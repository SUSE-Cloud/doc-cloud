<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: not edited-->
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="upgrade_recover_rabbit">
    <title><ph conkeyref="HOS-conrefs/product-title"/>Recovering RabbitMQ after Failure during Upgrade</title>
    <body><!--not tested-->
        <p conkeyref="HOS-conrefs/applies-to"/>

<section id="recover_rabbit">
    <title>Recovering RabbitMQ after Failure during Upgrade</title>
    
    <p>During upgrade, RabbitMQ can lockup at cluster synchronization. If you encounter an error similar to the following during upgrade, you should run the RabbitMQ disaster 
        recovery playbook and start the upgrade again.</p>

<codeblock>
2016-08-12 00:05:21,579 p=41620 u=stack |  TASK: [rabbitmq | _wait-for-cluster-sync | Check if RabbitMQ is in a cluster] ***
2016-08-12 00:05:23,311 p=41620 u=stack |  ok: [hlm002-cp1-c1-m1-mgmt -> hlm002-cp1-c1-m2-mgmt]
2016-08-12 00:05:23,439 p=41620 u=stack |  TASK: [rabbitmq | _wait-for-cluster-sync | Wait for HA queue sync to complete] *** <b>&lt;&lt;---- locks up</b>
</codeblock>

<!--    <codeblock>TASK: [rabbitmq | _reset-host | Stop the RabbitMQ application to enable reset] *** 
failed: [hpeit1-cp1-c1-m3-mgmt] =>
{"changed": true, "cmd": ["timeout", "5m", "rabbitmqctl", "stop_app"], "delta": "0:05:00.029892", 
"end": "2016-04-26 20:13:52.622088", "rc": 124, "start": "2016-04-26 20:08:52.592196", "warnings": []}</codeblock>-->
    
    <p><b>Recovering RabbitMQ:</b></p>
    
    <ol>
        <li>From the lifecycle manager, run the <codeph>rabbitmq-disaster-recovery.yml</codeph>
                    playbook:
                        <codeblock>cd ~/scratch/ansible/next/hos/ansible/
ansible-playbook -i hosts/verb_hosts rabbitmq-disaster-recovery.yml</codeblock><p>This
                        will tear down and reset any running RabbitMQ nodes. This has an extreme
                        effect on services. This should take roughly two minutes to complete, at
                        which point the RabbitMQ cluster will have been recreated from scratch with
                        service credentials reprovisioned into it.</p></li>
        
        <li> Then re-run the <codeph>hlm-upgrade.yml</codeph> playbook:
                    <codeblock>cd ~/scratch/ansible/next/hos/ansible/
ansible-playbook -i hosts/verb_hosts hlm-upgrade.yml</codeblock>
                </li>
        
    </ol>
    
</section>
        
    </body>
</topic>
