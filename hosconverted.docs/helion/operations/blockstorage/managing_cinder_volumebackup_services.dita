<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: not edited-->
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="topic_l1p_vpy_jt">
  <title><ph conkeyref="HOS-conrefs/product-title"/>Managing Cinder Volume and Backup
    Services</title>
  <abstract><shortdesc outputclass="hdphidden"/></abstract>
  <body>
    <!--not tested-->
    <section id="warning">
      <title>When to use these steps</title>
      <p>This operation should be used rarely and for good reason.</p>
      <p>If the host running the <codeph>cinder-volume</codeph> service fails for any reason it
        should be restarted as quickly as possible. Often the host running Cinder services also runs
        high availability (HA) services such as MySQL and RabbitMQ. These HA services are at risk
        while one of the nodes in the cluster is down. If it will take a significant amount of time
        to recover the failed node, then you may migrate the <codeph>cinder-volume</codeph> service
        to one of the other controller nodes. When the node has been recovered you should migrate
        the <codeph>cinder-volume</codeph> service back to the original (default) node.</p>
    </section>
    <section id="steps">
      <title>Migrating the cinder-volume service</title>
      <p>Use the following steps to migrate the cinder-volume service.</p>
      <ol id="ol_ck1_wdq_kx">
        <li>Log in to the lifecycle manager node.</li>
        <li>Determine the host index numbers for each of your control plane nodes. This host index
          number will be used in a later step. They can be obtained by running this
            playbook:<codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts cinder-show-volume-hosts.yml</codeblock><p>Here is an example snippet showing the output of a single three node control plane, with the host
            index numbers in
            bold:<codeblock>TASK: [_CND-CMN | show_volume_hosts | Show Cinder Volume hosts index and hostname] ***
ok: [helion-cp1-c1-m1] => (item=(0, 'helion-cp1-c1-m1')) => {
    "item": [
        <b>0</b>,
        "helion-cp1-c1-m1"
    ],
    "msg": "Index 0 Hostname helion-cp1-c1-m1"
}
ok: [helion-cp1-c1-m1] => (item=(1, 'helion-cp1-c1-m2')) => {
    "item": [
        <b>1</b>,
        "helion-cp1-c1-m2"
    ],
    "msg": "Index 1 Hostname helion-cp1-c1-m2"
}
ok: [helion-cp1-c1-m1] => (item=(2, 'helion-cp1-c1-m3')) => {
    "item": [
        <b>2</b>,
        "helion-cp1-c1-m3"
    ],
    "msg": "Index 2 Hostname helion-cp1-c1-m3"
}</codeblock></p></li>
        <li>Locate the control plane fact file for the control plane you need to migrate the service
          from. It will be located in the following
            directory:<codeblock>/etc/ansible/facts.d/</codeblock><p>These fact files use the
            following naming
          convention:</p><codeblock>cinder_volume_run_location_<i>&lt;control_plane_name></i>.fact</codeblock></li>
        <li>Edit the fact file to include the host index number of the control plane node you wish
          to migrate the <codeph>cinder-volume</codeph> services to. For example, if they currently
          reside on your first controller node, host index 0, and you wish to migrate them to your
          second controller, you would change the value in the fact file to <codeph>1</codeph>.</li>
        <li>If you are using data encryption on your lifecycle manager, ensure you have included the
          encryption key in your environment
          variables:<codeblock>export HOS_USER_PASSWORD_ENCRYPT_KEY=&lt;encryption key></codeblock></li>
        <li>Once you have edited the control plane fact file, run the Cinder volume migration
          playbook for the control plane nodes involved in the migration. This at minimum includes
          the one to start cinder-volume manager on and the one on which to stop it:
              <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts cinder-migrate-volume.yml --limit=&lt;limit_pattern1,limit_pattern2></codeblock><note><i>&lt;limit_pattern></i>
            is the pattern used to limit the hosts that are selected to those within a specific
            control plane.</note></li>
        <li>Ensure that once your maintenance or other tasks are completed that you migrate the
            <codeph>cinder-volume</codeph> services back to their original node using these same
          steps.</li>
      </ol>
    </section>
  </body>
</topic>
