<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><!--Edit status: not edited-->
<section id="liveInstMigration">
   <title>
      <phrase/>Live Migration of Instances</title>
    <para/>
    <para>
      <phrase/> Nova offers a set of commands that allow you to move compute
        instances between compute hosts. Which command you use will depend on the state of the host,
        what operating system is on the host, what type of storage the instances are using, and
        whether you want to migrate a single instance or all of the instances off of the host. We
        will describe these options on this page as well as give you step-by-step instructions for
        performing them.</para>

    
      <bridgehead renderas="sect4">Migration Options</bridgehead>
      <para>
         <emphasis role="bold">If your compute node has failed</emphasis>
      </para>
      <para>A compute host failure could be caused by hardware failure, such as the data disk needing
        to be replaced, power has been lost, or any other type of failure which requires that you
        replace the baremetal host. In this scenario, the instances on the compute node are
        unrecoverable and any data on the local ephemeral storage is lost. If you are utilizing
        block storage volumes, either as a boot device or as additional storage, they should be
        unaffected.</para>
      <para>In these cases you will want to use one of the Nova evacuate commands, which will cause
        Nova to rebuild the instances on other hosts.</para>
      <para>This table describes each of the evacuate options for failed compute nodes:</para>
      <informaltable id="table_fnj_tq1_sw" colsep="1" rowsep="1">
         <tgroup cols="2">
            <colspec colname="c1" colnum="1"/>
            <colspec colname="c2" colnum="2"/>
            <thead>
               <row>
                  <entry>Command</entry>
                  <entry>Description</entry>
               </row>
            </thead>
            <tbody>
               <row>
                  <entry>
                     <para>
                        <literal>nova evacuate &lt;instance&gt; &lt;hostname&gt;</literal>
                     </para>
                  </entry>
                  <entry>This command is used to evacuate a single instance from a failed host. You
                specify the compute instance UUID and the target host you want to evacuate it to. If
                no host is specified then the Nova scheduler will choose one for you.<para>See
                    <literal>nova help evacuate</literal> for more information and syntax. Further
                  details can also be seen in the OpenStack documentation here: <ulink url="http://docs.openstack.org/admin-guide/cli_nova_evacuate.html">Evacuate Instances</ulink>.</para>
                  </entry>
               </row>
               <row>
                  <entry>
                     <para>
                        <literal>nova host-evacuate &lt;hostname&gt; --target_host
                    &lt;target_hostname&gt;</literal>
                     </para>
                  </entry>
                  <entry>This command is used to evacuate all instances from a failed host. You specify
                the hostname of the compute host you want to evacuate. Optionally you can specify a
                target host. If no target host is specified then the Nova scheduler will choose a
                target host for each instance.<para>See <literal>nova help host-evacuate</literal> for
                  more information and syntax.</para>
                  </entry>
               </row>
            </tbody>
        </tgroup>
      </informaltable>
      <para>
         <emphasis role="bold">If your compute node is active, powered on, and the data disks are in working
        order</emphasis>
      </para>
      <para>If your compute host is powered on and the data disks are in working order you can utilize
        the migration commands to migrate your compute instances. There are two migration features,
        "cold" migration (also referred to simply as "migration") and live migration. Migration and
        live migration are two different functions.</para>
      <para>
         <emphasis role="bold">Cold migration</emphasis> is used to copy an instances data in a <literal>SHUTOFF</literal>
        status from one compute host to another. It does this using passwordless SSH access which
        has security concerns associated with it. For this reason, the <literal>nova migrate</literal>
        function has been disabled by default but you have the ability to enable this feature if you
        would like. Details on how to do this can be found in <xref linkend="enabling_the_nova_resize"/>.</para>
      <para>
         <emphasis role="bold">Live migration</emphasis> can be performed on instances in either an <literal>ACTIVE</literal> or
          <literal>PAUSED</literal> state and uses the QEMU hypervisor to manage the copy of the
        running processes and associated resources to the destination compute host using the
        hypervisors own protocol and thus is a more secure method and allows for less downtime.
        There may be a short network outage, usually a few milliseconds but could be up to a few
        seconds if your compute instances are busy, during a live migration. Also there may be some
        performance degredation during the process.</para>
      <para>The compute host must remain powered on during the migration process.</para>
      <para>Both the cold migration and live migration options will honor Nova group policies, which
        includes affinity settings. There is a limitation to keep in mind if you use group policies
        and that is discussed in the <xref linkend="liveInstMigration"/> section.</para>
      <para>This table describes each of the migration options for active compute nodes:</para>
      <informaltable id="table_vjs_wgf_5w" colsep="1" rowsep="1">
         <tgroup cols="4">
            <colspec colname="c1" colnum="1" colwidth="4*"/>
            <colspec colname="c2" colnum="2" colwidth="4*"/>
            <colspec colname="c3" colnum="3" colwidth="1*"/>
            <colspec colname="c4" colnum="4" colwidth="1*"/>
            <thead>
               <row>
                  <entry>Command</entry>
                  <entry>Description</entry>
                  <entry align="center">Linux for HPE Helion</entry>
                  <entry align="center">RHEL</entry>
               </row>
            </thead>
            <tbody>
               <row>
                  <entry>
                     <para>
                        <literal>nova migrate &lt;instance_uuid&gt;</literal>
                     </para>
                  </entry>
                  <entry>
                     <para>Used to cold migrate a single instance from a compute host. The
                    <literal>nova-scheduler</literal> will choose the new host.</para>
                     <para>This command will work against instances in an <literal>ACTIVE</literal> or
                    <literal>SHUTOFF</literal> state. The instances, if active, will be shutdown and
                  restarted. Instances in a <literal>PAUSED</literal> state cannot be cold
                  migrated.</para>
                     <para>See the difference between cold migration and live migration at the start of this
                  section.</para>
                  </entry>
                  <entry align="center"/>
                  <entry align="center"/>
               </row>
               <row>
                  <entry>
                     <para>
                        <literal>nova host-servers-migrate &lt;hostname&gt;</literal>
                     </para>
                  </entry>
                  <entry>
                     <para>Used to cold migrate all instances off a specified host to other available hosts,
                  chosen by the <literal>nova-scheduler</literal>.</para>
                     <para>This command will work against instances in an <literal>ACTIVE</literal> or
                    <literal>SHUTOFF</literal> state. The instances, if active, will be shutdown and
                  restarted. Instances in a <literal>PAUSED</literal> state cannot be cold
                  migrated.</para>
                     <para>See the difference between cold migration and live migration at
                  the start of this section.</para>
                  </entry>
                  <entry align="center"/>
                  <entry align="center"/>
               </row>
               <row>
                  <entry>
                     <para>
                        <literal>nova live-migration &lt;instance_uuid&gt; [&lt;target
                  host&gt;]</literal>
                     </para>
                  </entry>
                  <entry>Used to migrate a single instance between two compute hosts. You can optionally
                specify a target host or you can allow the nova scheduler to choose a host for you.
                If you choose to specify a target host, ensure that the target host has enough
                resources to host the instance prior to live migration.<para>Works for instances that
                  are booted from a block storage volume or that have any number of block storage
                  volumes attached.</para>
                     <para>This command works against instances in
                    <literal>ACTIVE</literal> or <literal>PAUSED</literal> states only.</para>
                     <para>Will work
                  on both Linux for HPE Helion and RHEL compute hosts.</para>
                  </entry>
                  <entry align="center">X</entry>
                  <entry align="center">X</entry>
               </row>
               <row>
                  <entry>
                     <para>
                        <literal>nova live-migration --block-migrate &lt;instance_uuid&gt; [&lt;target
                    host&gt;]</literal>
                     </para>
                  </entry>
                  <entry>Used to migrate a single instance between two compute hosts. You can optionally
                specify a target host or you can allow the nova scheduler to choose a host for you.
                If you choose to specify a target host, ensure that the target host has enough
                resources to host the instance prior to live migration.<para>Works for instances that
                  are booted from local (ephemeral) disk(s) only or if your instance has a mix of
                  ephemeral disk(s) and block storage volume(s) but are not booted from a block
                  storage volume.</para>
                     <para>This command works against instances in
                    <literal>ACTIVE</literal> or <literal>PAUSED</literal> states only.</para>
                     <para>Will work
                  on Linux for HPE Helion compute hosts only.</para>
                  </entry>
                  <entry align="center">X</entry>
                  <entry/>
               </row>
               <row>
                  <entry>
                     <para>
                        <literal>nova host-evacuate-live &lt;hostname&gt; [--target-host
                    &lt;target_hostname&gt;]</literal>
                     </para>
                  </entry>
                  <entry>Used to live migrate all instances off of a compute host. You can optionally
                specify a target host or you can allow the nova scheduler to choose a host for you.
                If you choose to specify a target host, ensure that the target host has enough
                resources to host the instance prior to live migration.<para>Works for instances that
                  are booted from a block storage volume or that have any number of block storage
                  volumes attached.</para>
                     <para>This command works against instances in
                    <literal>ACTIVE</literal> or <literal>PAUSED</literal> states only.</para>
                     <para>Will work
                  on both Linux for HPE Helion and RHEL compute hosts.</para>
                  </entry>
                  <entry align="center">X</entry>
                  <entry align="center">X</entry>
               </row>
               <row>
                  <entry>
                     <para>
                        <literal>nova host-evacuate-live --block-migrate &lt;hostname&gt; [--target-host
                    &lt;target_hostname&gt;]</literal>
                     </para>
                  </entry>
                  <entry>Used to live migrate all instances off of a compute host. You can optionally
                specify a target host or you can allow the nova scheduler to choose a host for you.
                If you choose to specify a target host, ensure that the target host has enough
                resources to host the instance prior to live migration.<para>Works for instances that
                  are booted from local (ephemeral) disk(s) only or if your instance has a mix of
                  ephemeral disk(s) and block storage volume(s) but are not booted from a block
                  storage volume.</para>
                     <para>This command works against instances in
                    <literal>ACTIVE</literal> or <literal>PAUSED</literal> states only.</para>
                     <para>Will work
                  on Linux for HPE Helion compute hosts only. </para>
                  </entry>
                  <entry align="center">X</entry>
                  <entry/>
               </row>
            </tbody>
        </tgroup>
      </informaltable>
   

    
      <bridgehead renderas="sect4">Limitations of these Features</bridgehead>
      <para>There are limitations that may impact your use of this feature:</para>
      <itemizedlist>
        <listitem>
            <para>To use live migration, your compute instances must be in either an
            <literal>ACTIVE</literal> or <literal>PAUSED</literal> state on the compute host. If you
          have instances in a <literal>SHUTOFF</literal> state then cold migration should be
          used.</para>
         </listitem>
        <listitem>
            <para>Instances in a <literal>Paused</literal> state cannot be live migrated using the Horizon
          dashboard. You will need to utilize the NovaClient CLI to perform these.</para>
         </listitem>
        <listitem>
            <para>Both cold migration and live migration honor an instance's group policies. If you are
          utilizing an affinity policy and are migrating multiple instances you may run into an
          error stating no hosts are available to migrate to. To work around this issue you should
          specify a target host when migrating these instances, which will bypass the
            <literal>nova-scheduler</literal>. You should ensure that the target host you choose has
          the resources available to host the instances.</para>
         </listitem>
        <listitem>
            <para>The <literal>nova host-evacuate-live</literal> command will produce an error if you have a
          compute host that has a mix of instances that use local ephemeral storage and instances
          that are booted from a block storage volume or have any number of block storage volumes
          attached. If you have a mix of these instance types, you may need to run the command
          twice, utilizing the <literal>--block-migrate</literal> option. This is described in further
          detail in the <xref linkend="liveInstMigration"/> section.</para>
         </listitem>
        <listitem>
            <para>If you are using both Linux for HPE Helion (KVM) and RHEL compute hosts, you cannot live
          migrate instances between them. Instances on KVM hosts can only be live migrated to other
          KVM hosts and the same for RHEL hosts. This is due to Red Hat's use of non-standard
          machine models.</para>
         </listitem>
        <listitem>
            <para>The migration options described in this document are not available on ESX compute
          hosts.</para>
         </listitem>
        <listitem>
            <para>Only instances booted from a block storage volume can be live migrated between RHEL
          compute hosts. If you are using local ephemeral storage then this feature is not
          supported. This is a limitation in RHEL 7.2.</para>
         </listitem>
        <listitem>
            <para>Ensure that you read and take into account any other limitations that exist in the
          release notes. See <citetitle>FIXME: broken external xref</citetitle> for more details.</para>
         </listitem>
      </itemizedlist>
   


    
      <bridgehead renderas="sect4">Performing a Live Migration</bridgehead>
      <para>Cloud administrators can perform a migration on an instance using either the Horizon
        dashboard, API, or CLI. Instances in a <literal>Paused</literal> state cannot be live migrated
        using the Horizon GUI. You will need to utilize the CLI to perform these.</para>
      <para>We have documented different scenarios:</para>
   

    <formalpara id="failed_host">
      <title>Migrating instances off of a failed compute host</title>
      <para/>
   </formalpara>

    <formalpara id="active_host">
      <title>Migrating instances off of an active compute host</title>
      <para/>
   </formalpara>


    <formalpara id="idg-operations-maintenance-live_migration-dita-10">
      <title>Troubleshooting migration or host evacuate issues</title>
      <para/>
   </formalpara>


  </section>
