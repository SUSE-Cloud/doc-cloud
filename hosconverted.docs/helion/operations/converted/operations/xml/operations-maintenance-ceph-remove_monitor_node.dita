<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><!--Edit status: not edited-->
<section id="remove_monitor_node">
   <title>
      <phrase/>Removing a Ceph Monitor Node</title>
    
    
    
    
      <bridgehead renderas="sect4">Notes</bridgehead>
      <para>It is recommended to maintain an odd number of Ceph monitors because the Paxos protocol is
        being used by Ceph monitors to form a consensus. Although clusters can be deployed with a
        single monitor, we strongly recommend to deploy three monitors on independent nodes for
        production usage to avoid a single point of failure of the monitor service.</para>

      <para>For this reason, it is recommended to maintain at least three and an odd number of Ceph
        monitors.</para>

   
    
    
      <bridgehead renderas="sect4">To Remove Monitor Nodes from the Controller Node</bridgehead>
      <para>Permanent removal of a monitor is not supported when the monitor service is installed on
        the controller node. However, to temporarily bring down the service on the controller node
        (for maintenance purposes), perform the following steps:</para>

      <orderedlist>
        <listitem>
            <para>Log in to the lifecycle manager.</para>

         </listitem>
        <listitem>
            <para>Stop the monitor service running on the specific host by running the following commands: </para>

            <screen>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts ceph-stop.yml --limit &lt;mon-node-to-remove&gt;</screen>
            <para>The hostname of the node can be found in the list generated from the output of the
            following command:</para>

            <screen>grep hostname ~/helion/my_cloud/info/server_info.yml</screen>
         </listitem>
        <listitem>
            <para>Remove the monitor service from the cluster:</para>

            <screen>ceph mon remove &lt;ceph-mon-host&gt;</screen>
            <note>
               <para>You can determine the value for <literal>&lt;ceph-mon-host&gt;</literal> by using the
            <literal>ceph -s</literal> command.</para>

            </note>
         </listitem>
      </orderedlist>
   
    
      <bridgehead renderas="sect4">Remove Monitor Nodes from a Separate/Dedicated Node</bridgehead>
      <para>Perform the following steps to remove a monitor node from a separate/dedicated node.</para>

      <orderedlist>
        <listitem>
            <para>Login to the monitor node to be removed.</para>

         </listitem>
        <listitem>
            <para>Stop the monitor service running on the specific host by running the following commands
          :</para>

            <screen>service ceph-mon@&lt;ceph-mon-host&gt; stop</screen>
         </listitem>
        <listitem>
            <para>Remove the monitor
          service:</para>

            <screen>ceph mon remove &lt;ceph-mon-host&gt;</screen>
         </listitem>
        <listitem>
            <para>Login to the lifecycle manager.</para>

         </listitem>
        <listitem>
            <para>Edit the <literal>servers.yml</literal> file and remove the host section from the
          file.</para>

            <screen>vim  ~/helion/my_cloud/definition/data/servers.yml</screen>
         </listitem>
        <listitem>
            <para>Commit your configuration to the <citetitle>FIXME: broken external xref</citetitle>, as follows:
          </para>

            <screen>cd ~/helion/hos/ansible
git add -A
git commit -m "My config or other commit message"</screen>
         </listitem>
        <listitem>
            <para>Run the configuration processor:
          </para>

            <screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</screen>
         </listitem>
        <listitem>
            <para>Update your deployment directory:
          </para>

            <screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</screen>
         </listitem>
        <listitem>
            <para>Remove the Monitor node from
            Cobbler:</para>

            <screen>sudo cobbler system remove --name &lt;node-name&gt;</screen>
            <para>For
            example: If you want to remove the <emphasis role="bold">mon1</emphasis> (monitor node), execute the following
            command:</para>
<screen>sudo cobbler system remove --name mon1</screen>

         </listitem>
      </orderedlist>
   
    
      <bridgehead renderas="sect4">Removing the Node from Monitoring</bridgehead>
      <para>Once you have removed the Ceph Monitor node, the alarms against them will trigger so there
        are additional steps to take to resolve this issue.</para>

      <para>You will want to SSH to each of the Monasca API servers and edit the
        <literal>/etc/monasca/agent/conf.d/host_alive.yaml</literal> file to remove references to
        the Ceph Monitor node you removed. This will require <literal>sudo</literal> access.</para>

      <para>Once you have removed the references on each of your Monasca API servers you then need to
        restart the monasca-agent on each of those servers with this command:</para>

      <screen>sudo service monasca-agent restart</screen>
      <para>With the Ceph Monitor node references removed and the monasca-agent restarted, you can then
        delete the corresponding alarm to finish this process. To do so we recommend using the
        Monasca CLI which should be installed on each of your Monasca API servers by default:</para>

      <screen>monasca alarm-list --metric-name host_alive_status --metric-dimensions hostname=&lt;ceph monitor node deleted&gt;</screen>
      <para>You can then delete the alarm with this command:</para>

      <screen>monasca alarm-delete &lt;alarm ID&gt;</screen>
   
  </section>
