<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><section id="dpdk_config">
   <title>
      <phrase/>DPDK Configurations</title>
    <itemizedlist>
        <listitem>
         <para>
            <ulink url="#dpdk_config/base_config">Base configuration</ulink>
         </para>
      </listitem>
        <!--<li><xref href="#dpdk_config/mellanox" format="dita">Mellanox changes to base configuration
          </xref></li>-->
        <listitem>
         <para>
            <ulink url="#dpdk_config/common_perf">Performance considerations common to
            all NIC types</ulink>
          </para>
         <itemizedlist>
            <listitem>
               <para>
                  <ulink url="#dpdk_config/core_frequency">Compute host core
                frequency</ulink>
               </para>
            </listitem>
            <listitem>
               <para>
                  <ulink url="#dpdk_config/non-posted">IO non-posted
              prefetch</ulink>
               </para>
            </listitem>
          </itemizedlist>
      </listitem>
        <!--<li><xref href="#dpdk_config/mellanox_perf" format="dita">Performance considerations for
            Mellanox ConnectX - 3 Pro </xref><ul>
            <li><xref href="#dpdk_config/steering" format="dita">Optimized steering mode</xref></li>
          </ul></li>-->
        <listitem>
         <para>
            <ulink url="#dpdk_config/multiqueue_config">Multiqueue
            configuration</ulink>
         </para>
      </listitem>
      </itemizedlist>
    
      <bridgehead renderas="sect4">Base configuration</bridgehead>
      <para>The following is specific to DL360 Gen9 and BIOS configuration as detailed in <xref linkend="dpdk_setup"/>.</para>
      <itemizedlist>
        <listitem>
            <para>EAL cores - 1, isolate: False in cpu-models </para>
         </listitem>
        <listitem>
            <para>PMD cores - 1 per NIC port </para>
         </listitem>
        <listitem>
            <para>Hugepages - 1G per PMD thread </para>
         </listitem>
        <listitem>
            <para>Memory channels - 4 </para>
         </listitem>
        <listitem>
            <para>Global rx queues - based on needs </para>
         </listitem>
      </itemizedlist>
   
    
    
      <bridgehead renderas="sect4">Performance considerations common to all NIC types</bridgehead>
      <para>
         <emphasis role="bold">Compute host core frequency</emphasis>
      </para>
      <para id="core_frequency">Host CPUs should be running at maximum performance. The following is a
        script to set that. Note that in this case there are 24 cores. This needs to be modified to
        fit your environment. For a DL360 Gen9, the BIOS should be configured to use "OS Control
        Mode" which can be found on the iLO Power Settings page. </para>
      <screen>for i in `seq 0 23`; do echo "performance" &gt; /sys/devices/system/cpu/cpu$i/cpufreq/scaling_governor; done</screen>
      <para>
         <emphasis role="bold">IO non-posted prefetch</emphasis>
      </para>
      <para id="non-posted">The DL360 Gen9 should have the IO non-posted prefetch disabled.
        Experimental evidence shows this yields an additional 6-8% performance boost.</para>
   
    
    
    
      <bridgehead renderas="sect4">Multiqueue configuration</bridgehead>
      <para>In order to use multiqueue, a property must be applied to the Glance image and a setting
        inside the resulting VM must be applied. In this example we create a 4 vCPU flavor for DPDK
        using 1G hugepages.</para>
      <screen>MI_NAME=dpdk

nova aggregate-create $MI_NAME nova
nova aggregate-add-host $MI_NAME helion-cp-comp0001-mgmt
nova aggregate-add-host $MI_NAME helion-cp-comp0002-mgmt
nova aggregate-set-metadata $MI_NAME pinned=true

nova flavor-create $MI_NAME 6 1024 20 4
nova flavor-key $MI_NAME set hw:cpu_policy=dedicated
nova flavor-key $MI_NAME set aggregate_instance_extra_specs:pinned=true
nova flavor-key $MI_NAME set hw:mem_page_size=1048576</screen>
      <para>And set the hw_vif_multiqueue_enabled property on the Glance image</para>
      <screen>openstack image set --property hw_vif_multiqueue_enabled=true &lt;image uuid&gt;</screen>
      <para>Once the VM is booted using the flavor above, inside the VM, choose the number of combined
        rx and tx queues to be equal to the number of vCPUs</para>
      <screen>sudo ethtool -L eth0 combined 4</screen>
      <para>On the hypervisor you can verify that multiqueue has been properly set by looking at the
        qemu process</para>
      <screen>-netdev type=vhost-user,id=hostnet0,chardev=charnet0,queues=4 -device virtio-net-pci,mq=on,vectors=10,</screen>
      <para>Here you can see that 'mq=on' and vectors=10. The formula for vectors is 2*num_queues+2</para>
   
  </section>
