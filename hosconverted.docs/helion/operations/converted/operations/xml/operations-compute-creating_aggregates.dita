<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><!--Edit status: not edited-->
<section id="aggregates">
   <title>
      <phrase/>Managing Compute Hosts using Aggregates and
    Scheduler Filters</title>
    
    <para>OpenStack Nova has the concepts of availability zones and host aggregates that enable you to
      segregate your Compute hosts. Availability zones are used to specify logical separation within
      your cloud based on the physical isolation or redundancy you have setup. Host aggregates are
      used to group compute hosts together based upon common features, such as operation system. For
      more information, see <ulink url="http://docs.openstack.org/openstack-ops/content/scaling.html">Scaling and Segregating your Cloud</ulink>.</para>
    <para>The Nova scheduler also has a filter scheduler, which supports both filtering and weighting
      to make decisions on where new compute instances should be created. For more information, see
        <ulink url="http://docs.openstack.org/developer/nova/filter_scheduler.html">Filter Scheduler</ulink> and <ulink url="http://docs.openstack.org/mitaka/config-reference/compute/scheduler.html">Scheduling</ulink>.</para>
    <para>This document is going to show you how to set up both a Nova host aggregate and configure the
      filter scheduler to further segregate your compute hosts.</para>


    
      <bridgehead renderas="sect4">Creating a Nova Aggregate</bridgehead>
      <para>These steps will show you how to create a Nova aggregate and how to add a compute host to
        it. You can run these steps on any machine that contains the NovaClient that also has
        network access to your cloud environment. These requirements are met by the lifecycle
        manager.</para>
      <orderedlist>
        <listitem>
            <para>Log in to the lifecycle manager.</para>
         </listitem>
        <listitem>
            <para>Source the administrative creds: </para>
            <screen>source ~/service.osrc</screen>
         </listitem>
        <listitem>
            <para>List your current Nova aggregates: </para>
            <screen>nova aggregate-list</screen>
         </listitem>
        <listitem>
            <para>Create a new Nova aggregate with this
            syntax:</para>
            <screen>nova aggregate-create &lt;aggregate-name&gt;</screen>
            <para>If you wish to
            have the aggregate appear as an availability zone, then specify an availability zone
            with this
            syntax:</para>
            <screen>nova aggregate-create &lt;aggregate-name&gt; &lt;availability-zone-name&gt;</screen>
            <para>So,
            for example, if you wish to create a new aggregate for your RHEL compute hosts and you
            wanted that to show up as the <literal>RHEL</literal> availability zone, you could use
            this command:</para>
            <screen>nova aggregate-create RHEL RHEL</screen>
            <para>This would
            produce an output similar to
          this:</para>
            <screen>+----+------+-------------------+-------+--------------------------+
| Id | Name | Availability Zone | Hosts | Metadata                 |
+----+------+-------------------+-------+--------------------------+
| 12 | RHEL | RHEL              |       | 'availability_zone=RHEL' |
+----+------+-------------------+-------+--------------------------+</screen>
         </listitem>
        <listitem>
            <para>Next, you need to add compute hosts to this aggregate so you can start by listing your
          current hosts. You will want to limit the output of this command to only the hosts running
          the <literal>compute</literal> service, like
          this:</para>
            <screen>nova host-list | grep compute</screen>
         </listitem>
        <listitem>
            <para>You can then add host(s) to your aggregate with this
          syntax:</para>
            <screen>nova aggregate-add-host &lt;aggregate-name&gt; &lt;host&gt;</screen>
         </listitem>
        <listitem>
            <para>Then you can confirm that this has been completed by listing the details of your
          aggregate: </para>
            <screen>nova aggregate-details &lt;aggregate-name&gt;</screen>
            <para>You can
            also list out your availability zones using this
          command:</para>
            <screen>nova availability-zone-list</screen>
         </listitem>
      </orderedlist>
   

    
      <bridgehead renderas="sect4">Using Nova Scheduler Filters</bridgehead>
      <para>The Nova scheduler has two filters that can help with differentiating between different
        compute hosts that we'll describe here.</para>
      <informaltable id="table_fq2_jht_lv" colsep="1" rowsep="1">
         <tgroup cols="2">
            <colspec colname="c1" colnum="1"/>
            <colspec colname="c2" colnum="2"/>
            <thead>
               <row>
                  <entry>Filter</entry>
                  <entry>Description</entry>
               </row>
            </thead>
            <tbody>
               <row>
                  <entry>AggregateImagePropertiesIsolation</entry>
                  <entry>Isolates compute hosts based on image properties and aggregate metadata. You
                can use commas to specify multiple values for the same property. The filter will
                then ensure at least one value matches.</entry>
               </row>
               <row>
                  <entry>AggregateInstanceExtraSpecsFilter</entry>
                  <entry>Checks that the aggregate metadata satisfies any extra specifications
                associated with the instance type. This uses
                  <literal>aggregate_instance_extra_specs</literal>
                  </entry>
               </row>
            </tbody>
        </tgroup>
      </informaltable>
      <note>
         <para>For details about other available filters, see <ulink url="http://docs.openstack.org/developer/nova/filter_scheduler.html">Filter Scheduler</ulink>.</para>
      </note>
   
  </section>
