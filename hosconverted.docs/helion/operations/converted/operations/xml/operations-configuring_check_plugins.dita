<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><section id="configuring_check_plugins">
   <title>Configuring Check Plugins</title>
        <para><emphasis role="bold">Manually configure a plugin when unit-testing using the monasca-setup script installed
                with the monasca-agent</emphasis></para>

        <para>Find a good explanation of configuring plugins here: <ulink url="https://github.com/openstack/monasca-agent/blob/master/docs/Agent.md#configuring">https://github.com/openstack/monasca-agent/blob/master/docs/Agent.md#configuring</ulink></para>

        
        <para>SSH to a node that has both the monasca-agent installed as well as the component you wish
            to monitor.</para>

        <para>The following is an example command that configures a plugin that has no parameters (uses
            the detection plugin class
            name).</para>
<screen>sudo /opt/stack/service/monasca-agent/venv/bin/monasca-setup -d HLMCeilometer</screen>

        
        <para>The following is an example command that configures the apache plugin and includes
            related
            parameters.</para>
<screen>sudo /opt/stack/service/monasca-agent/venv/bin/monasca-setup -d apache -a 'url=http://192.168.245.3:9095/server-status?auto'</screen>

        
        <para>If there is a change in the configuration it will restart the monasca-agent on the host
            so the configuration is loaded.</para>

        <para>After the plugin is configured, you can verify that the configuration file has your
            changes (see the <emphasis role="bold">Verify that your check plugin is configured</emphasis> section).</para>

        <para>Use the monasca CLI to see if your metric exists (see the <emphasis role="bold">Verify that metrics
                exist</emphasis> section).</para>

        
        
        <para><emphasis role="bold">Using Ansible modules to configure plugins in <phrase/>
      </emphasis></para>

        <para>The <literal>monasca_agent_plugin</literal> module is installed as part of the
            monasca-agent role.</para>

        
        <para>The following Ansible example configures the process.py plugin for the Ceilometer
            detection plugin. The following example only passes in the name of the detection
            class.</para>

        <screen>- name: _CEI-CMN | monasca_configure |
    Run Monasca agent HLM specific ceilometer detection plugin
  become: yes
  monasca_agent_plugin:
    name: "HLMCeilometer"</screen>

        
        <para>If a password or other sensitive data are passed to the detection plugin, the
                <literal>no_log</literal> option should be set to <emphasis role="bold">True</emphasis>. If the
                <literal>no_log</literal> option is not set to <emphasis role="bold">True</emphasis>, the data passed to the
            plugin will be logged to syslog.</para>

        
        <para>The following Ansible example configures the Vertica plugin and passes in related
            arguments.</para>
<screen>- name: Run Monasca Agent detection plugin for Vertica
  monasca_agent_plugin:
    name: "Vertica"
    args:
      user: {{ FND_VDB.vars.monitor_user_name }}
      password: {{ FND_VDB.vars.monitor_user_password }}
      timeout: 10
  no_log: True</screen>

        
        <para>The following Ansible example configures the Keystone endpoint using the http_check.py
            detection plugin. The class name <literal>httpcheck</literal> of the http_check.py
            detection plugin is the name.</para>

        <screen>#
- name:  keystone-monitor | local_monitor |
    Setup active check on keystone internal endpoint locally
  become: yes
  monasca_agent_plugin:
    name: "httpcheck"
    args: "use_keystone=False \
           url=http://{{ keystone_internal_listen_ip }}:{{
               keystone_internal_port }}/v3 \
           dimensions=service:identity-service,\
                       component:keystone-api,\
                       api_endpoint:internal,\
                       monitored_host_type:instance"
  tags:
    - keystone
    - keystone_monitor</screen>

        
        
        <para><emphasis role="bold">Verify that your check plugin is configured</emphasis></para>

        <para>All check configuration files are located in the following directory. You can see the
            plugins that are running by looking at the plugin configuration
            directory.</para>
<screen>/etc/monasca/agent/conf.d/</screen>

        
        <para>When the monasca-agent starts up, all of the check plugins that have a matching
            configuration file in the <literal>/etc/monasca/agent/conf.d/</literal> directory will be
            loaded.</para>

        <para>If there are errors running the check plugin they will be written to the following error
            log file.</para>
<screen>/var/log/monasca/agent/collector.log</screen>

        
        <para>You can change the monasca-agent log level by modifying the <literal>log_level</literal>
            option in the <literal>/etc/monasca/agent/agent.yaml</literal> configuration file, and
            then restarting the monasca-agent, using the following
            command.</para>
<screen>sudo service monasca-agent restart</screen>

        
        <para>You can debug a check plugin by running <literal>monasca-collector</literal> with the check
            option. The following is an example of the <literal>monasca-collector</literal>
            command.</para>
<screen>/opt/stack/service/monasca-agent/venv/bin$ sudo ./monasca-collector check &lt;check name&gt;</screen>

        
        <para><emphasis role="bold">Verify that metrics exist</emphasis></para>

        <para>Begin by logging in to your deployer or controller node.</para>

        <para>Run the following set of commands, including the <literal>monasca metric-list</literal>
            command. If the metric exists, it will be displayed in the
            output.</para>
<screen>source /home/hlmuser/service.osrc
monasca metric-list --name  &lt;metric name&gt;</screen>

    </section>
