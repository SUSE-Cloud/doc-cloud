<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.xml"> %entities; ]><!--Edit status: not edited-->
<section id="topic_nfp_xtf_rt">
   <title>
      <phrase/>ESX Host Commissioning</title>
                
                
                <para>ESX host commissioning is a functionality provided to a user to add additional
                        ESX hosts to an already-activated cluster. </para>

<note>
         <para>While activating a cluster
                                with a single host, local datastore is used for OVSvApp and nova
                                proxy installation. If a new host is commissioned in this cluster
                                and we try to vmotion by making the first host down, the nova proxy
                                fails to migrate in the local datastore. In this case, you must
                                manually migrate nova proxy datastore to the shared datastore and
                                vmotion succeeds. </para>

      </note>
<note>
         <para>Performing host commissioning after
                                reboot of deployer node may fail if
                                        <literal>/tmp/helion_tls*</literal> certificates are wiped off
                                during reboot. To overcome this issue the following playbook has to
                                be executed:
                                        </para>

         <screen>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts tls-reconfigure.yml</screen>
         <para>After
                                        running the preceding playbook execute this eon command
                                                <literal>eon resource-update &lt;RESOURCE_ID&gt;
                                                --action add_host --server-group &lt;SERVER_GROUP&gt;
                                        </literal> to perform host commissioning. </para>

      </note>

                <para>The following steps detail how to commission a new a host to an already activated
                                cluster.</para>

<orderedlist id="ol_xls_25f_rt">
                                <listitem>
            <para>List the current state of the cluster using EON python
                                                client:</para>

            <screen># eon resource-list</screen>
            <para>For
                                                example:</para>

            <screen># eon resource-list
+--------------------------------------+-----------+-------------+--------------------------------------+------------+-------+------------+------------+
| ID                                   | Name      | Moid        | Resource Manager ID                  | IP Address | Port  | Type       | State      |
+--------------------------------------+-----------+-------------+--------------------------------------+------------+-------+------------+------------+
| 1228fce5-df5d-445c-834e-ae633ac7e426 | Cluster2  | domain-c184 | BC9DED4E-1639-481D-B190-2B54A2BF5674 | UNSET      | UNSET | esxcluster | imported   |
| 469710f6-e9f2-48a4-aace-1f00cbd60487 | virtClust | domain-c943 | BC9DED4E-1639-481D-B190-2B54A2BF5674 | UNSET      | UNSET | esxcluster | activated  |
| a3003a32-6e3a-4d89-a072-ec64a4247fb0 | Cluster1  | domain-c21  | BC9DED4E-1639-481D-B190-2B54A2BF5674 | UNSET      | UNSET | esxcluster | imported   |
+--------------------------------------+-----------+-------------+--------------------------------------+------------+-------+------------+------------+</screen>
         </listitem>
                                <listitem>
            <para>Add the host in the maintenance mode to the already activated
                                                  cluster:</para>

            <mediaobject id="image_it1_3bp_lt">
                  <imageobject role="fo"><imagedata fileref="..-media-esx-eon_service_host1.png" width="75%" format="PNG"/></imageobject><imageobject role="html"><imagedata fileref="..-media-esx-eon_service_host1.png"/></imageobject>
               </mediaobject>

            <para> Any host that is in
                                        maintenance mode and without OVSvAPP will be considered as a
                                        new host to be activated. </para>

            <note>
               <para>You can also activate
                                                multiple hosts.</para>

            </note>
         </listitem>
                                <listitem>
            <para>Run the following command to update the
                                        cluster:</para>

            <screen>
               <literal># eon resource-update &lt;RESOURCE_ID&gt; --action add_host --server-group &lt;SERVER_GROUP&gt;</literal>
            </screen>
            <para>This
                                        process moves the host to a folder in the Datacenter, spawns
                                        the OVSvApp VM, configures the networking, and triggers the
                                        Ansible playbooks on the new node.  After successful
                                        execution, the host is moved back to the cluster. </para>

            <para>For
                                                example:</para>

            <screen># eon resource-update 9ab2196d-37d2-4006-a2c7-08946b5194ea --action add_host --server-group RACK01
+-----------------+--------------------------------------+
| Property        | Value                                |
+-----------------+--------------------------------------+
| id              | 9ab2196d-37d2-4006-a2c7-08946b5194ea |
| ip_address      | UNSET                                |
| name            | compute                              |
| password        | UNSET                                |
| port            | UNSET                                |
| resource_mgr_id | 9FDCFA66-6677-42A1-83FF-16DC32448021 |
| state           | host-commission-initiated            |
| type            | esxcluster                           |
| username        | UNSET                                |
+-----------------+--------------------------------------+</screen>
            <para>The
                                                following image shows the host in folder during
                                                execution of playbooks:</para>

            <mediaobject id="image_ush_nbp_lt">
                  <imageobject role="fo"><imagedata fileref="..-media-esx-eon_service_host2.png" width="75%" format="PNG"/></imageobject><imageobject role="html"><imagedata fileref="..-media-esx-eon_service_host2.png"/></imageobject>
               </mediaobject>

            <para>The following image
                                        shows the host after successful completion of Host
                                                  commissioning:</para>

            <mediaobject id="image_fck_qr5_vv">
                  <imageobject role="fo"><imagedata fileref="..-media-esx-eon_service_host3.png" width="75%" format="PNG"/></imageobject><imageobject role="html"><imagedata fileref="..-media-esx-eon_service_host3.png"/></imageobject>
               </mediaobject>

         </listitem>
                        </orderedlist>

        </section>
