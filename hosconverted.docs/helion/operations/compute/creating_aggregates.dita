<?xml version="1.0" encoding="UTF-8"?>
<!--Edit status: not edited-->
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="aggregates">
  <title><ph conkeyref="HOS-conrefs/product-title"/>Managing Compute Hosts using Aggregates and
    Scheduler Filters</title>
  <abstract><shortdesc outputclass="hdphidden">OpenStack Nova has the concepts of availability zones
      and host aggregates that enable you to segregate your compute hosts. Availability zones are
      used to specify logical separation within your cloud based on the physical isolation or
      redundancy you have setup. Host aggregates are used to group compute hosts together based upon
      common features, such as operation system. For more information, read this
    topic.</shortdesc></abstract>
  <body>
    <!--not tested-->
    <p>OpenStack Nova has the concepts of availability zones and host aggregates that enable you to
      segregate your Compute hosts. Availability zones are used to specify logical separation within
      your cloud based on the physical isolation or redundancy you have setup. Host aggregates are
      used to group compute hosts together based upon common features, such as operation system. For
      more information, see <xref
        href="http://docs.openstack.org/openstack-ops/content/scaling.html" scope="external"
        format="html">Scaling and Segregating your Cloud</xref>.</p>
    <p>The Nova scheduler also has a filter scheduler, which supports both filtering and weighting
      to make decisions on where new compute instances should be created. For more information, see
        <xref href="http://docs.openstack.org/developer/nova/filter_scheduler.html" scope="external"
        format="html">Filter Scheduler</xref> and <xref
        href="http://docs.openstack.org/mitaka/config-reference/compute/scheduler.html"
        scope="external" format="html">Scheduling</xref>.</p>
    <p>This document is going to show you how to set up both a Nova host aggregate and configure the
      filter scheduler to further segregate your compute hosts.</p>


    <section id="create_agg">
      <title>Creating a Nova Aggregate</title>
      <p>These steps will show you how to create a Nova aggregate and how to add a compute host to
        it. You can run these steps on any machine that contains the NovaClient that also has
        network access to your cloud environment. These requirements are met by the lifecycle
        manager.</p>
      <ol>
        <li>Log in to the lifecycle manager.</li>
        <li>Source the administrative creds: <codeblock>source ~/service.osrc</codeblock></li>
        <li>List your current Nova aggregates: <codeblock>nova aggregate-list</codeblock></li>
        <li>Create a new Nova aggregate with this
            syntax:<codeblock>nova aggregate-create &lt;aggregate-name></codeblock><p>If you wish to
            have the aggregate appear as an availability zone, then specify an availability zone
            with this
            syntax:</p><codeblock>nova aggregate-create &lt;aggregate-name> &lt;availability-zone-name></codeblock><p>So,
            for example, if you wish to create a new aggregate for your RHEL compute hosts and you
            wanted that to show up as the <codeph>RHEL</codeph> availability zone, you could use
            this command:</p><codeblock>nova aggregate-create RHEL RHEL</codeblock><p>This would
            produce an output similar to
          this:</p><codeblock>+----+------+-------------------+-------+--------------------------+
| Id | Name | Availability Zone | Hosts | Metadata                 |
+----+------+-------------------+-------+--------------------------+
| 12 | RHEL | RHEL              |       | 'availability_zone=RHEL' |
+----+------+-------------------+-------+--------------------------+</codeblock></li>
        <li>Next, you need to add compute hosts to this aggregate so you can start by listing your
          current hosts. You will want to limit the output of this command to only the hosts running
          the <codeph>compute</codeph> service, like
          this:<codeblock>nova host-list | grep compute</codeblock></li>
        <li>You can then add host(s) to your aggregate with this
          syntax:<codeblock>nova aggregate-add-host &lt;aggregate-name> &lt;host></codeblock></li>
        <li>Then you can confirm that this has been completed by listing the details of your
          aggregate: <codeblock>nova aggregate-details &lt;aggregate-name></codeblock><p>You can
            also list out your availability zones using this
          command:</p><codeblock>nova availability-zone-list</codeblock></li>
      </ol>
    </section>

    <section id="filters"><title>Using Nova Scheduler Filters</title>
      <p>The Nova scheduler has two filters that can help with differentiating between different
        compute hosts that we'll describe here.</p>
      <table frame="all" rowsep="1" colsep="1" id="table_fq2_jht_lv">
        <tgroup cols="2">
          <colspec colname="c1" colnum="1"/>
          <colspec colname="c2" colnum="2"/>
          <thead>
            <row>
              <entry>Filter</entry>
              <entry>Description</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>AggregateImagePropertiesIsolation</entry>
              <entry>Isolates compute hosts based on image properties and aggregate metadata. You
                can use commas to specify multiple values for the same property. The filter will
                then ensure at least one value matches.</entry>
            </row>
            <row>
              <entry>AggregateInstanceExtraSpecsFilter</entry>
              <entry>Checks that the aggregate metadata satisfies any extra specifications
                associated with the instance type. This uses
                  <codeph>aggregate_instance_extra_specs</codeph></entry>
            </row>
          </tbody>
        </tgroup>
      </table>
      <note>For details about other available filters, see <xref
          href="http://docs.openstack.org/developer/nova/filter_scheduler.html" scope="external"
          format="html">Filter Scheduler</xref>.</note>
      <sectiondiv>
        <p><b>Using the AggregateImagePropertiesIsolation Filter</b></p>
        <ol>
          <li>Log in to the lifecycle manager.</li>
          <li>Edit the <codeph>~/helion/my_cloud/config/nova/nova.conf.j2</codeph> file and add
              <codeph>AggregateImagePropertiesIsolation</codeph> to the scheduler_filters section.
            Example below, in bold:
              <codeblock># Scheduler
...
scheduler_available_filters = nova.scheduler.filters.all_filters
scheduler_default_filters = AvailabilityZoneFilter,RetryFilter,ComputeFilter,DiskFilter,RamFilter,ImagePropertiesFilter,ServerGroupAffinityFilter,ServerGroupAntiAffinityFilter,ComputeCapabilitiesFilter,NUMATopologyFilter,<b>AggregateImagePropertiesIsolation</b>
...</codeblock><p>Optionally,
              you can also add these
            lines:</p><codeblock>aggregate_image_properties_isolation_namespace = &lt;a prefix string></codeblock><codeblock>aggregate_image_properties_isolation_separator = &lt;a separator character></codeblock>
            (defaults to '.') <p>If these are added, the filter will only match image properties
              starting with the name space and separator - e.g. setting to
                <codeph>my_name_space</codeph> and <codeph>:</codeph> would mean the image property
                <codeph>my_name_space:image_type=RHEL</codeph> matches metadata
                <codeph>image_type=RHEL</codeph>, but an_<codeph>other=RHEL</codeph> would not be
              inspected for a match at all.</p><p>If these are not added all image properties will
              be matched against any similarly named aggregate metadata.</p></li>
          <li>Add image properties to images that should be scheduled using the above filter</li>
          <li>Commit the changes to git:
            <codeblock>git add -A
git commit -a -m "editing nova schedule filters"</codeblock></li>
          <li>Run the configuration processor:
            <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</codeblock></li>
          <li>Run the ready deployment playbook:
            <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</codeblock></li>
          <li>Run the Nova reconfigure playbook:
            <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts nova-reconfigure.yml</codeblock></li>
        </ol>
      </sectiondiv>
      <sectiondiv>
        <p><b>Using the AggregateInstanceExtraSpecsFilter Filter</b></p>
        <ol>
          <li>Log in to the lifecycle manager.</li>
          <li>Edit the <codeph>~/helion/my_cloud/config/nova/nova.conf.j2</codeph> file and add
              <codeph>AggregateInstanceExtraSpecsFilter</codeph> to the scheduler_filters section.
            Example below, in bold:
            <codeblock># Scheduler
...
scheduler_available_filters = nova.scheduler.filters.all_filters
scheduler_default_filters = AvailabilityZoneFilter,RetryFilter,ComputeFilter,DiskFilter,RamFilter,ImagePropertiesFilter,ServerGroupAffinityFilter,ServerGroupAntiAffinityFilter,ComputeCapabilitiesFilter,NUMATopologyFilter,<b>AggregateInstanceExtraSpecsFilter</b>
...</codeblock></li>
          <li>There is no additional configuration needed because the following is true: <ol>
              <li>The filter assumes <codeph>:</codeph> is a separator</li>
              <li>The filter will match all simple keys in extra_specs plus all keys with a
                separator if the prefix is <codeph>aggregate_instance_extra_specs</codeph> - e.g.
                  <codeph>image_type=RHEL</codeph> and
                  <codeph>aggregate_instance_extra_specs:image_type=RHEL</codeph> will both be
                matched against aggregate metadata <codeph>image_type=RHEL</codeph></li>
            </ol></li>
          <li>Add <codeph>extra_specs</codeph> to flavors that should be scheduled according to the
            above.</li>
          <li>Commit the changes to git:
            <codeblock>git add -A
git commit -a -m "Editing nova scheduler filters"</codeblock></li>
          <li>Run the configuration processor:
            <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</codeblock></li>
          <li>Run the ready deployment playbook:
            <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</codeblock></li>
          <li>Run the Nova reconfigure playbook:
            <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts nova-reconfigure.yml</codeblock></li>
        </ol>
      </sectiondiv>
    </section>
  </body>
</topic>
