<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.ent"> %entities; ]>
<!-- Copyright FUJITSU LIMITED 2017 -->
<section id="idg-cmmoperator-operate-c-deleteinfluxdbdata-xml-1">
 <title>Removing Metrics Data</title>
 <para>
  Metrics data is stored in the Metrics and Alarms InfluxDB Database. InfluxDB
  features an SQL-like query language for querying data and performing
  aggregations on that data.
 </para>
 <para>
  The <phrase>CMM</phrase> Metrics Agent configuration defines the metrics and
  types of measurement for which data is stored. For each measurement, a
  so-called series is written to the InfluxDB database. A series consists of a
  timestamp, the metric, and the value measured.
 </para>
 <para>
  Example:
 </para>
 <informalfigure>
  <mediaobject>
   <imageobject>
    <imagedata fileref="images-cmm-influxdb.png" depth="79" width="252"/>
   </imageobject>
   <textobject><phrase>CSI_Influxdb.png</phrase>
   </textobject>
  </mediaobject>
 </informalfigure>
 <para>
  Every series can be assigned key tags. In the case of <phrase>CMM</phrase>,
  this is the <literal>_tenant_id</literal> tag. This tag identifies the
  OpenStack project for which the metrics data has been collected.
 </para>
 <para>
  From time to time, you may want to delete outdated or unnecessary metrics
  data from the Metrics and Alarms Database, for example, to save space or
  remove data for metrics you are no longer interested in. To delete data, you
  use the InfluxDB command line interface, the interactive shell that is
  provided for the InfluxDB database.
 </para>
 <para>
  Proceed as follows to delete metrics data from the database:
 </para>
 <para>
  <orderedlist>
   <listitem>
    <para>
     Create a backup of the database. For details, refer to
     <xref linkend="idg-shared-operationmaintenance-c-backup-xml-1"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Determine the ID of the OpenStack project for the data to be deleted:
    </para>
    <para>
     Log in to the OpenStack dashboard and go to <emphasis role="bold">Identity
     &gt; Projects</emphasis>.
    </para>
    <para>
     The following OpenStack projects are initially relevant for metrics and
     alarms management:
    </para>
    <para>
     <itemizedlist>
      <listitem>
       <para>
        <literal>admin</literal>: All metrics data related to OpenStack.
       </para>
      </listitem>
      <listitem>
       <para>
        <literal>monasca</literal>: All metrics data related to
        <phrase>CMM</phrase>.
       </para>
      </listitem>
     </itemizedlist>
    </para>
    <para>
     In the course of the productive operation of <phrase>CMM</phrase>,
     additional projects may be created, for example, for tenant users.
    </para>
    <para>
     The <emphasis role="bold">Project ID</emphasis> field shows the relevant
     tenant ID.
    </para>
   </listitem>
   <listitem>
    <para>
     Log in to the host where <phrase>CMM</phrase> is installed.
    </para>
   </listitem>
   <listitem>
    <para>
     Go to the directory where InfluxDB is installed:
    </para>
    <para>
<screen>cd /usr/bin</screen>
    </para>
   </listitem>
   <listitem>
    <para>
     Connect to InfluxDB using the InfluxDB command line interface as follows:
    </para>
    <para>
<screen>./influx -host &lt;host_ip&gt;</screen>
    </para>
    <para>
     Replace <literal>host_ip</literal> with the IP address of the machine on
     which <phrase>CMM</phrase> is installed.
    </para>
    <para>
     The output of this command is, for example, as follows:
    </para>
    <para>
<screen>Connected to http://localhost:8086 version 0.9.1
InfluxDB shell 0.9.1</screen>
    </para>
   </listitem>
   <listitem>
    <para>
     Connect to the InfluxDB database of <phrase>CMM</phrase>
     (<literal>mon</literal>):
    </para>
    <para>
<screen>&gt; show databases
name: databases
----------------
name
mon

&gt; use mon
Using database mon</screen>
    </para>
   </listitem>
   <listitem>
    <para>
     Delete the desired data.
    </para>
    <itemizedlist>
     <listitem>
      <para>
       When a project is no longer relevant or a specific tenant is no longer
       used, delete all series for the project as follows:
      </para>
      <para>
<screen>DROP SERIES WHERE _tenant_id = '&lt;project ID&gt;'</screen>
      </para>
      <para>
       Example:
      </para>
      <para>
<screen>DROP SERIES WHERE _tenant_id = '27620d7ee6e948e29172f1d0950bd6f4'</screen>
      </para>
     </listitem>
     <listitem>
      <para>
       When a metric is no longer relevant for a project, delete all series for
       the specific project and metric as follows:
      </para>
      <para>
<screen>DROP SERIES FROM "&lt;metric&gt;" WHERE _tenant_id = '&lt;project ID&gt;'</screen>
      </para>
      <para>
       Example:
      </para>
      <para>
<screen>DROP SERIES FROM "cpu.user_perc" WHERE _tenant_id = '27620d7e'</screen>
      </para>
     </listitem>
     <listitem>
      <para>
       In order to avoid that the entire database becomes too large, you can,
       for example, create a backup, then drop the database and create a new,
       empty one:
      </para>
      <para>
<screen>DROP DATABASE mon</screen>
      </para>
      <para>
<screen>CREATE DATABASE mon</screen>
      </para>
     </listitem>
    </itemizedlist>
   </listitem>
   <listitem>
    <para>
     Restart the <literal>influxdb</literal> service, for example, as follows:
    </para>
    <para>
<screen>sudo systemctl restart influxdb</screen>
    </para>
   </listitem>
  </orderedlist>
 </para>
 <para>
  You can view all measurements for a specific project as follows:
 </para>
 <para>
<screen>SHOW MEASUREMENTS WHERE _tenant_id = '&lt;project ID&gt;'</screen>
 </para>
 <para>
  You can view the series for a specific metric and project, for example, as
  follows:
 </para>
 <para>
<screen>SHOW SERIES FROM "cpu.user_perc" WHERE _tenant_id = '&lt;project ID&gt;'</screen>
 </para>
</section>
