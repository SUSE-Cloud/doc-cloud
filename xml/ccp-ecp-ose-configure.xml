<?xml version="1.0"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE section [
 <!ENTITY % entities SYSTEM "entity-decl.ent"> %entities;
]>
<section xmlns="http://docbook.org/ns/docbook"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="sec.ecp-configure-deployment">
 <title>Configure the Deployment</title>
  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ccp-ose-configure.png" width="75%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ccp-ose-configure.png"/>
    </imageobject>
   </mediaobject>
  </informalfigure>
 <para>
  All the files for the deployment are in a
  <xref linkend="term-def-workspace"/>, whose default location is on localhost.
  The default name can be changed via the environment variable
  <literal>SOCOK8S_ENVNAME</literal>.
</para>
<para>
  This workspace is structured like an ansible-runner directory. It
  contains:
</para>
<itemizedlist>
  <listitem>
    <para>
      an inventory folder
    </para>
  </listitem>
  <listitem>
    <para>
      an env folder
    </para>
  </listitem>
</itemizedlist>
<para>
  This folder must also contain extra files necessary for the deployment, such
  as the <filename>ses_config.yml</filename> and the
  <literal>kubeconfig</literal> files.
</para>
<section xml:id="ecp-configure-the-inventory">
  <title>Configure the inventory</title>
  <para>
    If you are bringing your own cluster, create an inventory based on
    our example located in the <filename>examples</filename> folder.
  </para>
  <screen>---
caasp-admin:
  vars:
    ansible_user: root

caasp-masters:
  vars:
    ansible_user: root

caasp-workers:
  vars:
    ansible_user: root

soc-deployer:
  vars:
    ansible_user: root

ses_nodes:
  vars:
    ansible_user: root

airship-openstack-compute-workers:
  vars:
    ansible_user: root

airship-openstack-control-workers:
  vars:
    ansible_user: root

airship-openstack-l3-agent-workers:
  vars:
    ansible_user: root

airship-ucp-workers:
  vars:
    ansible_user: root

airship-kube-system-workers:
  vars:
    ansible_user: root</screen>
  <para>
    This inventory only contains the group names.
  </para>
  <para>
    For each group, a <literal>hosts: key</literal> must be added, with, as
    value, each of the hosts you will need. For example:
  </para>
  <screen>caasp-admin:
  hosts:
    my_user-57997-admin-x6sugiws4g34:
      ansible_host: 10.86.1.144</screen>
  <para>
    See also
    <link xlink:href="https://docs.ansible.com/ansible/2.7/user_guide/intro_inventory.html#hosts-and-groups">Ansible
    Inventory Hosts and Groups</link>.
  </para>
  <note>
   <para>
    Do not add <literal>localhost</literal> as a host in your inventory. It is
    a host reserved by Ansible. If you want to create an inventory node for
    your local machine, add your machine's hostname inside your inventory, and
    specify this host variable: <emphasis role="bold">ansible_connection:
    local</emphasis>
   </para>
  </note>
</section>
<section xml:id="ecp-make-the-ses-pools-known-by-ansible">
  <title>Make the SES pools Known by Ansible</title>
  <para>
    Ansible relies on two things to know the <xref
    linkend="term-def-ses"/> pools created for the
    Airship/OpenStack deployment:
  </para>
  <itemizedlist>
    <listitem>
      <para>
        a <filename>ses_config.yml</filename> file present in the workspace
      </para>
    </listitem>
    <listitem>
      <para>
        the ceph admin keyring, in base64, present in the file
        env/extravars of your workspace.
      </para>
    </listitem>
  </itemizedlist>
  <para>
    You can find an example <filename>ses_config.yml</filename> in examples/workdir.
  </para>
</section>
<section xml:id="ecp-configure-the-vip-that-will-be-used-for-openstack-service-public-endpoints">
  <title>Configure the VIP for OpenStack service public endpoints</title>
  <para>
    Add <literal>socok8s_ext_vip</literal>: with its appropriate value for your
    environment in your <filename>env/extravars</filename>. This should be an
    available IP on the external network (in a development environment, it can
    be the same as a CaaSP cluster network).
  </para>
  <para>
    For example:
  </para>
  <screen>socok8s_ext_vip: &quot;10.10.10.10&quot;</screen>
</section>
<section xml:id="ecp-configure-the-vip-that-will-be-used-for-airship-ucp-service-endpoints">
  <title>Configure the VIP for Airship UCP service endpoints</title>
  <para>
    Add <literal>socok8s_dcm_vip</literal>: with its appropriate value for your
    environment in your <filename>env/extravars</filename>. This should be an
    available IP on the data center management (DCM) network (in a development
    environment, it can be the same as a CaaSP cluster network).
  </para>
  <para>
    For example:
  </para>
  <screen>socok8s_dcm_vip: &quot;192.168.51.35&quot;</screen>
</section>
<section xml:id="ecp-provide-a-kubeconfig-file">
  <title>Provide a <literal>kubeconfig</literal> File</title>
  <para>
    socok8s relies on <literal>kubectl</literal> and Helm commands to configure
    your OpenStack deployment. You must provide a
    <filename>kubeconfig</filename> file on your localhost in your
    workspace. You can fetch this file from the Velum UI on your CaaSP cluster.
  </para>
</section>
<section xml:id="ecp-advanced-configuration">
  <title>Advanced configuration</title>
  <para>
    socok8s deployment variables respect Ansible general precedence. All
    the variables can be adapted.
  </para>
  <para>
    You can override most user facing variables with host vars and group
    vars.
  </para>
  <note>
   <para>
    You can also use <literal>extravars</literal>, as they always
    win. <literal>extravars</literal> can be used to override any deployment
    code.  Use it at your own risk.
   </para>
  </note>
  <para>
    socok8s is flexible and allows you to override the value of any
    upstream Helm chart value with appropriate overrides.
  </para>
    <note>
   <para>
    Please read <xref linkend="ccp-advanced-users"/> for inspiration on
    overrides.
   </para>
  </note>
</section>
</section>
