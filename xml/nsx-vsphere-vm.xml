<?xml version="1.0"?>
<!DOCTYPE section [
 <!ENTITY % entities SYSTEM "entity-decl.ent"> %entities;
]>
<section xml:id="nsx-vsphere-vm"
 xmlns="http://docbook.org/ns/docbook" version="5.1"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink">
 <title>Integrating with NSX for vSphere</title>
 <para>
  This section describes the installation steps and requirements for
  integrating with NSX for vSphere on virtual machines and baremetal hardware.
 </para>
  <xi:include href="nsx-pre_integration.xml"/>
<section>
 <title>Installing &ostack;</title>
 <para>
   &ostack; can be deployed in two ways: on baremetal (physical hardware) or in
   an ESXi virtual environment on virtual machines. The following instructions
   describe how to install &ostack;.
 </para>
 <note>
  <para>
   <emphasis role="bold">Changes for installation on baremetal hardware are noted in each
   section.</emphasis>  <!--For instructions on baremetal installation,
   see <xref linkend="nsx-vsphere-baremetal"/>. -->
  </para>
 </note>
 <para>
   This deployment example will consist of two ESXi clusters at minimum: a
   <literal>control-plane</literal> cluster and a <literal>compute</literal>
   cluster. The control-plane cluster must have 3 ESXi hosts minimum (due to
   VMware's recommendation that each NSX controller virtual machine is on a
   separate host). The compute cluster must have 2 ESXi hosts minimum.  There
   can be multiple compute clusters. The following table outlines the virtual
   machine specifications to be built in the control-plane cluster:
  </para>
  <table xml:id="nsx-hw-reqs-vm">
   <title>NSX Hardware Requirements for Virtual Machine Integration</title>
   <tgroup cols="6">
    <colspec colnum="1" colname="1" colwidth="35*"/>
    <colspec colnum="2" colname="2" colwidth="13*"/>
    <colspec colnum="3" colname="3" colwidth="13*"/>
    <colspec colnum="4" colname="4" colwidth="13*"/>
    <colspec colnum="5" colname="5" colwidth="13*"/>
    <colspec colnum="6" colname="6" colwidth="13"/>
    <thead>
     <row>
      <entry><para>Virtual Machine Role</para></entry>
      <entry><para>Required Number</para></entry>
      <entry><para>Disk</para></entry>
      <entry><para>Memory</para></entry>
      <entry><para>Network</para></entry>
      <entry><para>CPU</para></entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        Dedicated lifecycle manager
       </para>
       <para>
        <emphasis role="bold">Baremetal - not needed</emphasis>
       </para>
      </entry>
      <entry><para>1</para></entry>
      <entry><para>100GB</para></entry>
      <entry><para>8GB</para></entry>
      <entry><para>3 VMXNET Virtual Network Adapters</para></entry>
      <entry><para>4 vCPU</para></entry>
     </row>
     <row>
      <entry>
       <para>
        Controller virtual machines
       </para>
       <para>
        <emphasis role="bold">Baremetal - not needed</emphasis>
       </para>
      </entry>
      <entry><para>3</para></entry>
      <entry><para>3 x 300GB</para></entry>
      <entry><para>32GB</para></entry>
      <entry><para>3 VMXNET Virtual Network Adapters</para></entry>
      <entry><para>8 vCPU</para></entry>
     </row>
     <row>
      <entry><para>Compute virtual machines</para></entry>
      <entry><para>1 per compute cluster</para></entry>
      <entry><para>80GB</para></entry>
      <entry><para>4GB</para></entry>
      <entry><para>3 VMXNET Virtual Network Adapters</para></entry>
      <entry><para>2 vCPU</para></entry>
     </row>
     <row>
      <entry><para>NSX Edge Gateway/DLR/Metadata-proxy appliances</para></entry>
      <entry><para></para></entry>
      <entry><para>Autogenerated by NSXv</para></entry>
      <entry><para>Autogenerated by NSXv</para></entry>
      <entry><para>Autogenerated by NSXv</para></entry>
      <entry><para>Autogenerated by NSXv</para></entry>
     </row>
    </tbody>
   </tgroup>
  </table>
  <para>
   <emphasis role="bold">Baremetal: In addition to the ESXi hosts, it is
   recommended to have one physical host for the &lcm; node and three physical
   hosts for the controller nodes.</emphasis>
  </para>
  <xi:include href="nsx-ntwk-requirements.xml"/>
  <xi:include href="nsx-ntwk-model.xml"/>
 <section>
  <title>vSphere port security settings</title>
  <para>
   <emphasis role="bold">Baremetal: Even though the &ostack;
   deployment is on baremetal, it is still necessary to define each VLAN within
   a vSphere Distributed Switch for the &o_comp; compute proxy virtual
   machine.</emphasis>
  </para>
  <para>
   The vSphere port security settings for both VMs and baremetal are shown in the
   table below.
   </para>
  <informaltable>
   <tgroup cols="4">
    <colspec colnum="1" colname="1" colwidth="30*"/>
    <colspec colnum="2" colname="2" colwidth="10*"/>
    <colspec colnum="3" colname="3" colwidth="10*"/>
    <colspec colnum="4" colname="4" colwidth="50*"/>
    <thead>
     <row>
      <entry><para>Network Group</para></entry>
      <entry><para>VLAN Type</para></entry>
      <entry><para>Interface</para></entry>
      <entry><para>vSphere Port Group Security Settings</para></entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry><para>ESXi Hosts and vCenter</para></entry>
      <entry><para>Tagged</para></entry>
      <entry><para>N/A</para></entry>
      <entry><para>Defaults</para></entry>
     </row>
     <row>
      <entry><para>NSX Manager</para>
      <para>Must be able to reach ESXi Hosts and vCenter</para>
      </entry>
      <entry><para>Tagged</para></entry>
      <entry><para>N/A</para></entry>
      <entry><para>Defaults</para></entry>
     </row>
     <row>
      <entry><para>NSX VTEP Pool</para></entry>
      <entry><para>Tagged</para></entry>
      <entry><para>N/A</para></entry>
      <entry><para>Defaults</para></entry>
     </row>
     <row>
      <entry><para>Management</para></entry>
      <entry><para>Tagged or Untagged</para></entry>
      <entry><para>eth0</para></entry>
      <entry>
       <para>
        <emphasis role="bold">Promiscuous Mode</emphasis>: Accept
       </para>
       <para>
        <emphasis role="bold">MAC Address Changes</emphasis>: Reject
       </para>
       <para>
        <emphasis role="bold">Forged Transmits</emphasis>:Reject
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        Internal API (Optional, may be combined with the Management Network. If
        network segregation is required for security reasons, you can keep this
        as a separate network.)
       </para>
      </entry>
      <entry><para>Tagged</para></entry>
      <entry><para>eth2</para></entry>
      <entry>
       <para>
        <emphasis role="bold">Promiscuous Mode</emphasis>: Accept
       </para>
       <para>
        <emphasis role="bold">MAC Address Changes</emphasis>: Reject
       </para>
       <para>
        <emphasis role="bold">Forged Transmits</emphasis>: Accept
       </para>
      </entry>
     </row>
     <row>
      <entry><para>External API (Public)</para></entry>
      <entry><para>Tagged</para></entry>
      <entry><para>eth1</para></entry>
      <entry>
       <para>
        <emphasis role="bold">Promiscuous Mode</emphasis>: Accept
       </para>
       <para>
        <emphasis role="bold">MAC Address Changes</emphasis>: Reject
       </para>
       <para>
        <emphasis role="bold">Forged Transmits</emphasis>: Accept
       </para>
      </entry>
     </row>
     <row>
      <entry><para>External VM</para></entry>
      <entry><para>Tagged</para></entry>
      <entry><para>N/A</para></entry>
      <entry>
       <para>
        <emphasis role="bold">Promiscuous Mode</emphasis>: Accept
       </para>
       <para>
        <emphasis role="bold">MAC Address Changes</emphasis>: Reject
       </para>
       <para>
        <emphasis role="bold">Forged Transmits</emphasis>: Accept
       </para>
      </entry>
     </row>
     <row>
      <entry><para><emphasis role="bold">Baremetal Only: IPMI</emphasis></para></entry>
      <entry><para>Untagged</para></entry>
      <entry><para>N/A</para></entry>
      <entry><para>N/A</para></entry>
     </row>
    </tbody>
   </tgroup>
  </informaltable>
 </section>
  <xi:include href="nsx-configure-vsphere_env.xml"/>
  <section>
   <title>Deploying &productname;</title>
   <para>
    Within the vSphere environment, create the &ostack; virtual machines. At
    minimum, there must be the following:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      One &lcm; deployer
     </para>
    </listitem>
    <listitem>
     <para>
      Three &ostack; controllers
     </para>
    </listitem>
    <listitem>
     <para>
      One &ostack; &o_netw; compute proxy
     </para>
    </listitem>
   </itemizedlist>
   <para>
    For the minimum NSX hardware requirements, refer to <xref
    linkend="nsx-hw-reqs-vm"/>.
   </para>
   <para>
    If ESX VMs are to be used as &o_comp; compute proxy nodes, set up three LAN
    interfaces in each virtual machine as shown in the networking model table below.  There must
    be at least one &o_comp; compute proxy node per cluster.
   </para>
   <informaltable>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="50*"/>
     <colspec colnum="2" colname="2" colwidth="50*"/>
     <thead>
      <row>
       <entry><para>Network Group</para></entry>
       <entry><para>Interface</para></entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry><para>Management</para></entry>
       <entry><para><literal>eth0</literal></para></entry>
      </row>
      <row>
       <entry><para>External API</para></entry>
       <entry><para><literal>eth1</literal></para></entry>
      </row>
      <row>
       <entry><para>Internal API</para></entry>
       <entry><para><literal>eth2</literal></para></entry>
      </row>
     </tbody>
    </tgroup>
   </informaltable>

 <xi:include href="nsx-advanced-config.xml"/>

 <!-- Setting Up the &lcm; -->
 <section xml:id="sec.nsx.setup_deployer">
  <xi:include xpointer="element(/1/4/1)" href="installation-kvm_xpointer.xml"/>
  <xi:include xpointer="element(/1/4/2)" href="installation-kvm_xpointer.xml"/>
 </section>

 <!-- Setting Up NSX -->
 <xi:include href="nsx-configure-neutron-env-nsx.xml"/>

 </section>
</section>
</section>
