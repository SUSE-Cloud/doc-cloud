<?xml version="1.0"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [ <!ENTITY % entities SYSTEM "entities.ent"> %entities; ]>
<!-- Copyright FUJITSU LIMITED 2017 -->
<section id="idg-cmmoperator-cmmoperator-operate-c-backupdb-xml-1">
 <title>Databases</title>
 <para>
  You need to create regular backups of the following databases on the host
  where the <phrase>CMM</phrase> Service is installed:
 </para>
 <itemizedlist id="Elasticsearch_database_concept_conbody_section_1_ul">
  <listitem>
   <para>
    Elasticsearch database
   </para>
  </listitem>
  <listitem>
   <para>
    InfluxDB database
   </para>
  </listitem>
  <listitem>
   <para>
    MariaDB database
   </para>
  </listitem>
 </itemizedlist>
 <para id="It_is_recommended_that_backup_concept_conbody_section_1_p">
  It is recommended that backup and restore operations for databases are
  carried out by experienced operators only.
 </para>
 <bridgehead renderas="sect4">Elasticsearch Database</bridgehead>
 <para id="For_backing_up_and_restoring_concept_conbody_section_2_p">
  For backing up and restoring your Elasticsearch database, you can use the
  Snapshot and Restore module of Elasticsearch.
 </para>
 <para id="To_make_a_backup_of_the_datab_concept_conbody_section_2_p">
  To make a backup of the database, proceed as follows:
 </para>
 <orderedlist>
  <listitem id="Make_sure_that_concept_conbody_section_2_o">
   <para>
    Make sure that <literal>curl</literal> is installed. If this is not the
    case, download and install it, for example, from the following Web site:
    <ulink url="http://curl.haxx.se/download.html">
    http://curl.haxx.se/download.html </ulink>.
   </para>
  </listitem>
  <listitem>
   <para>
    Log in to the host where the <phrase>CMM</phrase> Service is installed.
   </para>
  </listitem>
  <listitem>
   <para>
    Create a snapshot repository.
   </para>
   <para>
    Example:
   </para>
<screen>curl -XPUT http://localhost:9200/_snapshot/my_backup -d '{
  "type": "fs",
  "settings": {
       "location": "/mount/backup/elasticsearch1/my_backup",
       "compress": true
  }
}'</screen>
   <para id="The_example_registers_a_share_concept_conbody_section_2_o">
    The example registers a shared file system repository (<literal>"type":
    "fs"</literal>) that uses the
    <literal>/mount/backup/elasticsearch1</literal> directory for storing
    snapshots.
   </para>
   <note>
    <para>
     The directory for storing snapshots must be specified as configured during
     the installation of the <phrase>CMM</phrase> Service in the
     <literal>group_vars/monasca_group</literal> file. The directory must be
     manually mounted before creating the snapshot. The
     <literal>elastic</literal> user must be specified as the owner of the
     directory.
    </para>
   </note>
   <para id="compress_concept_conbody_section_2_o">
    <literal>compress</literal> is turned on to compress the metadata files.
   </para>
  </listitem>
  <listitem id="Check_whether_the_repository_concept_conbody_section_2_o">
   <para>
    Check whether the repository was created successfully.
   </para>
   <para>
    Example:
   </para>
<screen>curl -XGET http://localhost:9200/_snapshot/my_backup</screen>
   <para>
    Example response for a successfully created repository:
   </para>
<screen>{
  "my_backup": {
    "type": "fs",
    "settings": {
      "compress": "true",
      "location": "/mount/backup/elasticsearch1/my_backup"
    }
  }
}</screen>
  </listitem>
  <listitem id="Create_a_snapshot_of_your_dat_concept_conbody_section_2_o">
   <para>
    Create a snapshot of your database that contains all indices. A repository
    can contain multiple snapshots of the same database. The name of a snapshot
    must be unique within the snapshots created for your database.
   </para>
   <para>
    Example:
   </para>
<screen>curl -XPUT http://localhost:9200/_snapshot/my_backup/snapshot_1?wait_for_completion=true</screen>
   <para>
    The example creates a snapshot named <literal>snapshot_1</literal> for all
    indices in the <literal>my_backup</literal> repository.
   </para>
  </listitem>
 </orderedlist>
 <para>
  To restore the database instance, proceed as follows:
 </para>
 <orderedlist id="Close_all_indices_of_your_dat_concept_conbody_section_2_o">
  <listitem>
   <para>
    Close all indices of your database.
   </para>
   <para>
    Example:
   </para>
<screen>curl -XPOST http://localhost:9200/_all/_close</screen>
  </listitem>
  <listitem>
   <para>
    Restore all indices from the snapshot you have created.
   </para>
   <para>
    Example:
   </para>
<screen>curl -XPOST http://localhost:9200/_snapshot/my_backup/snapshot_1/_restore</screen>
   <para>
    The example restores all indices from <literal>snapshot_1</literal> that is
    stored in the <literal>my_backup</literal> repository.
   </para>
  </listitem>
 </orderedlist>
 <para id="For_additional_information_ba_concept_conbody_section_2_p">
  For additional information backing up and restoring an Elasticsearch
  database, refer to the
  <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/modules-snapshots.html">
  Elasticsearch documentation </ulink>.
 </para>
 <bridgehead renderas="sect4">InfluxDB Database</bridgehead>
 <para>
  For backing up and restoring your InfluxDB database, you can use the InfluxDB
  shell. The shell is part of your InfluxDB distribution. If you installed
  InfluxDB via a package manager, the shell is, by default, installed in the
  <literal>/usr/bin</literal> directory.
 </para>
 <para>
  To make a backup of the database, proceed as follows:
 </para>
 <orderedlist>
  <listitem>
   <para>
    Log in to the InfluxDB database as a user who is allowed to run the
    <literal>influxdb</literal> service.
   </para>
   <para>
    Example:
   </para>
<screen>$ su influxdb </screen>
  </listitem>
  <listitem>
   <para>
    Back up the database.
   </para>
   <para>
    Example:
   </para>
<screen>$ ./influxd backup -host "&lt;host&gt;:&lt;port&gt;" /mount/backup/mysnapshot</screen>
   <para>
    Replace <literal>&lt;host&gt;</literal> and <literal>&lt;port&gt;</literal>
    with the IP address and port number that are defined in the
    <literal>meta</literal> section in your InfluxDB configuration file. By
    default, the <literal>influxdb.conf</literal> file is located in the
    <literal>/etc/influxdb/</literal> directory. The example creates the backup
    for the database in <literal>/mount/backup/mysnapshot</literal>.
   </para>
  </listitem>
 </orderedlist>
 <para>
  Before restoring the database, make sure that all database processes are shut
  down. To restore the database, you can then proceed as follows:
 </para>
 <orderedlist>
  <listitem>
   <para>
    Stop the InfluxDB database service. Use the following command:
   </para>
<screen>$ systemctl stop influxdb</screen>
  </listitem>
  <listitem>
   <para>
    Log in to the InfluxDB database as a user who is allowed to run the
    <literal>influxdb</literal> service.
   </para>
   <para>
    Example:
   </para>
<screen>$ su influxdb </screen>
  </listitem>
  <listitem>
   <para>
    Restore the database.
   </para>
   <para>
    Example:
   </para>
<screen>$ ./influxd restore -config /etc/influxdb/influxdb.conf /mount/backup/mysnapshot</screen>
   <para>
    The example restores the backup from
    <literal>/mount/backup/mysnapshot</literal> to
    <literal>/etc/influxdb/influxdb.conf</literal>.
   </para>
  </listitem>
  <listitem>
   <para>
    Start the InfluxDB database service. Use the following command:
   </para>
<screen>$ systemctl start influxdb</screen>
  </listitem>
 </orderedlist>
 <para>
  For additional information on backing up and restoring an InfluxDB database,
  refer to the
  <ulink url="https://docs.influxdata.com/influxdb/v0.10/administration/backup_and_restore/">
  InfluxDB documentation </ulink>.
 </para>
 <bridgehead renderas="sect4">MariaDB Database</bridgehead>
 <para id="For_backing_up_and_restoring_concept_conbody_section_4_p">
  For backing up and restoring your MariaDB database, you can use the
  <literal>mysqldump</literal> utility program. <literal>mysqldump</literal>
  performs a logical backup that produces a set of SQL statements. These
  statements can later be executed to restore the database.
 </para>
 <para>
  To back up your MariaDB database, you must be the owner of the database or a
  user with superuser privileges. You can use the following command.
 </para>
 <para>
  Example:
 </para>
<screen>mysqldump -u root -p mon &gt; dumpfile.sql</screen>
 <para>
  In addition to the name of the database, you have to specify the name and the
  location where <literal>mysqldump</literal> stores its output.
 </para>
 <para>
  To restore your MariaDB database, proceed as follows:
 </para>
 <orderedlist>
  <listitem>
   <para>
    Log in to the host where the <phrase>CMM</phrase> Service is installed as a
    user with root privileges.
   </para>
  </listitem>
  <listitem>
   <para>
    Go to the directory where the <phrase>CMM</phrase> installation package is
    located.
   </para>
   <para>
    Example:
   </para>
   <para>
<screen>cd /opt/FJSVsvcmm</screen>
   </para>
  </listitem>
  <listitem>
   <para>
    Stop all <phrase>CMM</phrase> agents and services:
   </para>
   <para>
<screen>./services.sh stop</screen>
   </para>
  </listitem>
  <listitem>
   <para>
    Start the <literal>mariadb</literal> service:
   </para>
<screen>systemctl start mariadb</screen>
  </listitem>
  <listitem id="Log_in_to_the_database_you_ha_concept_conbody_section_4_o">
   <para>
    Log in to the database you have backed up as a user with root privileges.
   </para>
   <para>
    Example:
   </para>
<screen>mysql -u root -p mon</screen>
  </listitem>
  <listitem id="Remove_and_create_the_databas_concept_conbody_section_4_o">
   <para>
    Remove and create the database:
   </para>
<screen>&gt; DROP DATABASE mon;
&gt; CREATE DATABASE mon;</screen>
  </listitem>
  <listitem id="Exit_concept_conbody_section_4_o">
   <para>
    Exit <literal>mariadb</literal>:
   </para>
<screen>&gt; \q</screen>
  </listitem>
  <listitem id="Restore_the_database._concept_conbody_section_4_o">
   <para>
    Restore the database.
   </para>
   <para>
    Example:
   </para>
<screen>mysql -u root -p mon &lt; dumpfile.sql</screen>
  </listitem>
  <listitem>
   <para>
    Start all <phrase>CMM</phrase> agents and services:
   </para>
<screen>./services.sh start</screen>
  </listitem>
 </orderedlist>
 <para id="For_additional_information_on_concept_conbody_section_4_p">
  For additional information on backing up and restoring a MariaDB database
  with <literal>mysqldump</literal>, refer to the
  <ulink url="https://mariadb.com/kb/en/mariadb/mysqldump/"> MariaDB
  documentation </ulink>.
 </para>
</section>
