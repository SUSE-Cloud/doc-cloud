<?xml version="1.0"?>
<!DOCTYPE section [
<!ENTITY % entities SYSTEM "entities.ent"> %entities;
]>
<!---->
<section xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="ts_compute">
 <title>计算服务故障排除</title>
 <para>
  Nova 服务的故障排除场景和解决办法。
 </para>
 <para>
  Nova 提供可扩展，按需，自助的计算资源访问。您可以使用本指南来帮助解决 Nova 服务的已知问题和故障排除。
 </para>
 <!---->
 <section xml:id="idg-all-operations-troubleshooting-ts_compute-xml-6">
  <title>如何重置计算实例的状态？</title>
  <para>
   如果您的实例卡在非活动状态（例如 <literal>Deleting</literal> 或 <literal>Rebooting</literal>），并且您希望重置状态以便可以再次与实例进行交互，则可以使用此方法。
  </para>
  <para>
   Nova 命令行工具（也称为 Nova CLI 或 python-novaclient）含有命令 <literal>nova reset-state</literal>，使您可以重置服务器的状态。
  </para>
  <para>
   以下是命令的帮助信息包括其语法：
  </para>
  <screen>$ nova help reset-state
   usage: nova reset-state [--active] &lt;server&gt; [&lt;server&gt; ...]
   
   Reset the state of a server.
   
   Positional arguments:
   &lt;server&gt;  Name or ID of server(s).
   
   Optional arguments:
   --active  Request the server be reset to "active" state instead of "error"
   state (the default).</screen>
  <para>
   如果您的实例卡在 <literal>Rebooting</literal> 状态，则可以使用此命令将其重置为 <literal>Active</literal>：
  </para>
  <screen>nova reset-state --active &lt;instance_id&gt;</screen>
 </section>
 <section xml:id="nova-consoleauth.troubleshoot">
  <title>nova-consoleauth 故障排除</title>
  <para>
   nova-consoleauth 服务默认在第一个控制器节点上运行，即 <literal>consoleauth_host_index=0</literal> 的主机。如果 nova-consoleauth 在第一个控制器节点上失败，则可以通过运行 ansible 脚本 nova-start.yml 并传入下一个控制器节点的索引来将其切换到另一个控制器节点。
  </para>
  <para>
   将 nova-consoleauth 切换到另一个控制器节点（例如控制器2）的命令是：
  </para>
  <screen>ansible-playbook -i hosts/verb_hosts nova-start.yml --extra-vars "consoleauth_host_index=1"</screen>
  <para>
   运行此命令后，您现在可以看到 <literal>nova-consoleauth</literal> 服务的两个实例，当您运行 <literal>nova
    service-list</literal> 命令时，该服务将显示为处于 <literal>disabled</literal> 状态。然后，您可以使用这些步骤删除该服务。
  </para>
  <procedure>
   <step>
    <para>
     获取重复的 nova-consoleauth 服务的服务 ID：
    </para>
    <screen>nova service-list</screen>
    <para>
     例子：
    </para>
    <screen>$ nova service-list
     +----+------------------+---------------------------+----------+----------+-------+----------------------------+-----------------+
     | Id | Binary           | Host                      | Zone     | Status   | State | Updated_at                 | Disabled Reason |
     +----+------------------+---------------------------+----------+----------+-------+----------------------------+-----------------+
| 1  | nova-conductor   | ...a-cp1-c1-m1-mgmt    | internal | enabled  | up    | 2016-08-25T12:11:48.000000 | -               |
| 10 | nova-conductor   | ...a-cp1-c1-m3-mgmt    | internal | enabled  | up    | 2016-08-25T12:11:47.000000 | -               |
| 13 | nova-conductor   | ...a-cp1-c1-m2-mgmt    | internal | enabled  | up    | 2016-08-25T12:11:48.000000 | -               |
| 16 | nova-scheduler   | ...a-cp1-c1-m1-mgmt    | internal | enabled  | up    | 2016-08-25T12:11:39.000000 | -               |
| 19 | nova-scheduler   | ...a-cp1-c1-m2-mgmt    | internal | enabled  | up    | 2016-08-25T12:11:41.000000 | -               |
| 22 | nova-scheduler   | ...a-cp1-c1-m3-mgmt    | internal | enabled  | up    | 2016-08-25T12:11:44.000000 | -               |
| 25 | nova-consoleauth | ...a-cp1-c1-m1-mgmt    | internal | enabled  | up    | 2016-08-25T12:11:45.000000 | -               |
| 49 | nova-compute     | ...a-cp1-comp0001-mgmt | nova     | enabled  | up    | 2016-08-25T12:11:48.000000 | -               |
| 52 | nova-compute     | ...a-cp1-comp0002-mgmt | nova     | enabled  | up    | 2016-08-25T12:11:41.000000 | -               |
| 55 | nova-compute     | ...a-cp1-comp0003-mgmt | nova     | enabled  | up    | 2016-08-25T12:11:43.000000 | -               |
<emphasis role="bold">| 70 | nova-consoleauth | ...a-cp1-c1-m3-mgmt    | internal | disabled | down  | 2016-08-25T12:10:40.000000 | -               |</emphasis>
     +----+------------------+---------------------------+----------+----------+-------+----------------------------+-----------------+</screen>
   </step>
   <step>
    <para>
     使用以下命令删除已禁用的重复服务：
    </para>
    <screen>nova service-delete &lt;service_ID&gt;</screen>
    <para>
     基于上一步中的示例，该命令应为：
    </para>
    <screen>nova service-delete 70</screen>
   </step>
  </procedure>
 </section>
 <section xml:id="ts_resize">
  <title>使用加密时，在 Nova 安装后启用迁移或调整大小功能</title>
  <para>
   如果在云部署期间运行配置处理器时使用了数据加密，并且想在初始安装后启用 Nova 调整大小和迁移功能，如果您进行了其他配置更改，则需要在启用这些功能之前运行配置处理器。
  </para>
  <para>
   只有已启用数据加密才会遇到这个问题。如果您尚未启用加密，则无需按照以下步骤操作。如果您正在使用加密并且在初始安装或升级后进行了配置更改并运行了配置处理器，而且您已运行<filename>ready-deployment.yml</filename> 脚本，如果您希望启用迁移或 Nova 调整大小功能，以下步骤将允许您继续。请注意，下面提到的 ansible 保险库密钥是您提供给配置处理器的加密密钥。
  </para>
  <procedure>
   <step>
    <para>
     登录 &lcm;.
    </para>
   </step>
   <step>
    <para>
     查看本地 git 的 ansible 分支：
    </para>
<screen>cd ~/openstack
git checkout ansible</screen>
   </step>
   <step>
    <para>
     运行 git log，然后选择之前的提交：
    </para>
    <screen>git log</screen>
    <para>
     在下面的这个例子中使用的提交是，
     <literal>ac54d619b4fd84b497c7797ec61d989b64b9edb3</literal>:
    </para>
    <screen>$ git log
     
     commit 69f95002f9bad0b17f48687e4d97b2a791476c6a
     Merge: 439a85e ac54d61
     Author: git user &lt;user@company.com&gt;
     Date:   Fri May 6 09:08:55 2016 +0000
     
     Merging promotion of saved output
     
     commit 439a85e209aeeca3ab54d1a9184efb01604dbbbb
     Author: git user &lt;user@company.com&gt;
     Date:   Fri May 6 09:08:24 2016 +0000
     
     Saved output from CP run on 1d3976dac4fd7e2e78afad8d23f7b64f9d138778
     
     commit <emphasis role="bold">ac54d619b4fd84b497c7797ec61d989b64b9edb3</emphasis>
     Merge: a794083 66ffe07
     Author: git user &lt;user@company.com&gt;
     Date:   Fri May 6 08:32:04 2016 +0000
     
     Merging promotion of saved output</screen>
   </step>
   <step>
    <para>
     查看该提交：
    </para>
    <screen>git checkout &lt;commit_ID&gt;</screen>
    <para>
     使用上面的相同示例，这是该运行的命令：
    </para>
    <screen>$ git checkout ac54d619b4fd84b497c7797ec61d989b64b9edb3
     Note: checking out 'ac54d619b4fd84b497c7797ec61d989b64b9edb3'.
     
     You are in 'detached HEAD' state. You can look around, make experimental
     changes and commit them, and you can discard any commits you make in this
     state without impacting any branches by performing another checkout.
     
     If you want to create a new branch to retain commits you create, you may
     do so (now or later) by using -b with the checkout command again. Example:
     
     git checkout -b new_branch_name
     
     HEAD is now at ac54d61... Merging promotion of saved output</screen>
   </step>
   <step>
    <para>
     切换到 ansible 输出目录：
    </para>
    <screen>cd ~/openstack/my_cloud/stage/ansible/group_vars/</screen>
   </step>
   <step>
    <para>
     从 ansible 保险库中查看 <literal>group_vars</literal> 文件 - 它将是下面的格式，您的计算集群名称为标签：
    </para>
    <screen>&lt;cloud name&gt;-&lt;control plane name&gt;-&lt;compute cluster name&gt;</screen>
    <para>
     使用此命令从 ansible 保险库查看此 group_vars 文件，该命令将提示您输入保险库密码：
    </para>
    <screen>ansible-vault view &lt;group_vars_file&gt;</screen>
   </step>
   <step>
    <para>
     在此文件的内容中搜索 <literal>nova_ssh_key</literal> 部分，该部分将包含私有和公共 SSH 密钥，您应将这些密钥保存到临时文件中，以便在以后的步骤中使用它。
    </para>
    <para>
     这是一个示例，粗体部分是您需要保存的内容：
    </para>
    <screen>NOV_KVM:
     vars:
     <emphasis role="bold">              nova_ssh_key:
      private: '-----BEGIN RSA PRIVATE KEY-----
      MIIEpAIBAAKCAQEAv/hhekzykD2K8HnVNBKZcJWYrVlUyb6gR8cvE6hbh2ISzooA
      jQc3xgglIwpt5TuwpTY3LL0C4PEHObxy9WwqXTHBZp8jg/02RzD02bEcZ1WT49x7
      Rj8f5+S1zutHlDv7PwEIMZPAHA8lihfGFG5o+QHUmsUHgjShkWPdHXw1+6mCO9V/
      eJVZb3nDbiunMOBvyyk364w+fSzes4UDkmCq8joDa5KkpTgQK6xfw5auEosyrh8D
      zocN/JSdr6xStlT6yY8naWziXr7p/QhG44RPD9SSD7dhkyJh+bdCfoFVGdjmF8yA
      h5DlcLu9QhbJ/scb7yMP84W4L5GwvuWCCFJTHQIDAQABAoIBAQCCH5O7ecMFoKG4
      JW0uMdlOJijqf93oLk2oucwgUANSvlivJX4AGj9k/YpmuSAKvS4cnqZBrhDwdpCG
      Q0XNM7d3mk1VCVPimNWc5gNiOBpftPNdBcuNryYqYq4WBwdq5EmGyGVMbbFPk7jH
      ZRwAJ2MCPoplKl7PlGtcCMwNu29AGNaxCQEZFmztXcEFdMrfpTh3kuBI536pBlEi
      Srh23mRILn0nvLXMAHwo94S6bI3JOQSK1DBCwtA52r5YgX0nkZbi2MvHISY1TXBw
      SiWgzqW8dakzVu9UNif9nTDyaJDpU0kr0/LWtBQNdcpXnDSkHGjjnIm2pJVBC+QJ
      SM9o8h1lAoGBANjGHtG762+dNPEUUkSNWVwd7tvzW9CZY35iMR0Rlux4PO+OXwNq
      agldHeUpgG1MPl1ya+rkf0GD62Uf4LHTDgaEkUfiXkYtcJwHbjOnj3EjZLXaYMX2
      LYBE0bMKUkQCBdYtCvZmo6+dfC2DBEWPEhvWi7zf7o0CJ9260aS4UHJzAoGBAOK1
      P//K7HBWXvKpY1yV2KSCEBEoiM9NA9+RYcLkNtIy/4rIk9ShLdCJQVWWgDfDTfso
      sJKc5S0OtOsRcomvv3OIQD1PvZVfZJLKpgKkt20/w7RwfJkYC/jSjQpzgDpZdKRU
      vRY8P5iryptleyImeqV+Vhf+1kcH8t5VQMUU2XAvAoGATpfeOqqIXMpBlJqKjUI2
      QNi1bleYVVQXp43QQrrK3mdlqHEU77cYRNbW7OwUHQyEm/rNN7eqj8VVhi99lttv
      fVt5FPf0uDrnVhq3kNDSh/GOJQTNC1kK/DN3WBOI6hFVrmZcUCO8ewJ9MD8NQG7z
      4NXzigIiiktayuBd+/u7ZxMCgYEAm6X7KaBlkn8KMypuyIsssU2GwHEG9OSYay9C
      Ym8S4GAZKGyrakm6zbjefWeV4jMZ3/1AtXg4tCWrutRAwh1CoYyDJlUQAXT79Phi
      39+8+6nSsJimQunKlmvgX7OK7wSp24U+SPzWYPhZYzVaQ8kNXYAOlezlquDfMxxv
      GqBE5QsCgYA8K2p/z2kGXCNjdMrEM02reeE2J1Ft8DS/iiXjg35PX7WVIZ31KCBk
      wgYTWq0Fwo2W/EoJVl2o74qQTHK0Bs+FTnR2nkVF3htEOAW2YXQTTN2rEsHmlQqE
      A9iGTNwm9hvzbvrWeXtx8Zk/6aYfsXCoxq193KglS40shOCaXzWX0w==
      -----END RSA PRIVATE KEY-----'
      public: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/+GF6TPKQPYrwedU0Epl
      wlZitWVTJvqBHxy8TqFuHYhLOigCNBzfGCCUjCm3lO7ClNjcsvQLg8Qc5vHL1bCpdMc
      FmnyOD/TZHMPTZsRxnVZPj3HtGPx/n5LXO60eUO/s/AQgxk8AcDyWKF8YUbmj5Ad
      SaxQeCNKGRY90dfDX7qYI71X94lVlvecNuK6cw4G/LKTfrjD59LN6zhQOSYKryOgNrkq
      SlOBArrF/Dlq4SizKuHwPOhw38lJ2vrFK2VPrJjydpbOJevun9CEbjhE8P1JIPt2GTImH5t0
      J+gVUZ2OYXzICHkOVwu71CFsn+xxvvIw/zhbgvkbC+5YIIUlMd
      Generated Key for Nova User</emphasis>
     NTP_CLI:</screen>
   </step>
   <step>
    <para>
     切换回 <literal>site</literal> 分支：
    </para>
<screen>cd ~/openstack
git checkout site</screen>
   </step>
   <step>
    <para>
     导航到此分支中的 group_vars 目录：
    </para>
<screen>cd ~/scratch/ansible/next/ardana/ansible/group_vars</screen>
   </step>
   <step>
    <para>
     编辑您的计算 group_vars 文件，该命令将提示您输入保险库密码：
    </para>
    <screen>ansible-vault edit &lt;group_vars_file&gt;
     Vault password:
     Decryption successful</screen>
   </step>
   <step>
    <para>
     在此文件的内容中搜索 <literal>nova_ssh_key</literal> 部分，并将私钥和公钥替换为您之前在步骤＃7中保存在临时文件中的内容。
    </para>
   </step>
   <step>
    <para>
     删除先前创建的临时文件，现在您可以运行部署了。有关启用 Nova 调整大小和迁移的信息，请参阅<xref linkend="enabling_the_nova_resize"/>。
    </para>
   </step>
  </procedure>
 </section>
 <section xml:id="idg-all-operations-troubleshooting-ts_compute-xml-9">
  <title>计算 (ESX)</title>
  <para>
   <!---->
   <emphasis role="bold">实例处于活动状态时无法创建实例快照</emphasis>
  </para>
  <para>
   VMWare vCenter 存在一个已知问题，如果您有计算实例在 <literal>Active</literal> 状态下，则在尝试快照时会收到以下错误：
  </para>
  <screen>An error occurred while saving the snapshot: Failed to quiesce the virtual machine</screen>
  <para>
   此问题的解决方法是停止实例。以下是使用命令行工具实现此目的的步骤：
  </para>
  <procedure>
   <step>
    <para>
     使用 NovaClient 停止实例：
    </para>
    <screen>nova stop &lt;instance UUID&gt;</screen>
   </step>
   <step>
    <para>
     快照实例。
    </para>
   </step>
   <step>
    <para>
     重新启动实例：
    </para>
    <screen>nova start &lt;instance UUID&gt;</screen>
   </step>
  </procedure>
 </section>
</section>
