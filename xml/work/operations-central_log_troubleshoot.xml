<?xml version="1.0"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
type="text/xml"
title="Profiling step"?>
<!DOCTYPE section [
<!ENTITY % entities SYSTEM "entities.ent"> %entities;
]>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xml:id="sec.central_log.troubleshoot">
 <title>集中日志记录故障排除</title>
 <para>
  本节包含以下场景：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <xref linkend="sec.central_log.review_logs"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec.central_log.monitor"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec.central_log.log_collection"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec.central_log.error_kibana"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec.central_log.store_log"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec.central_log.slow_log"/>
   </para>
  </listitem>
 </itemizedlist>
 <section xml:id="sec.central_log.review_logs">
  <title>查看日志文件</title>
  <para>
   您可以通过查看日志来解决特定于服务的问题。登录 Kibana 后，请按照以下步骤加载日志以供查看：
  </para>
  <orderedlist>
   <listitem>
    <para>
     导航到 <emphasis role="bold">Settings</emphasis> 菜单以设置要搜索的索引格式。
    </para>
   </listitem>
   <listitem>
    <para>
     在 <emphasis role="bold">Index name or pattern</emphasis> 字段中，您可以输入 <literal>logstash-*</literal> 来查询所有 elasticsearch 索引。
    </para>
   </listitem>
   <listitem>
    <para>
     单击绿色的 <emphasis role="bold">Create</emphasis> 按钮以创建和加载索引。
    </para>
   </listitem>
   <listitem>
    <para>
     转到 <emphasis role="bold">Discover</emphasis> 菜单中加载索引使其可供搜索。
    </para>
   </listitem>
  </orderedlist>
  <para>
   加载日志后，您可以从 Kibana 窗口右上角的下拉列表中更改时间范围。您有以下选项可供选择：
  </para>
  <itemizedlist>
   <listitem>
    <para>
     <emphasis role="bold">Quick</emphasis> - 提供各种时间范围选择
    </para>
   </listitem>
   <listitem>
    <para>
     <emphasis role="bold">Relative</emphasis> - 允许您相对于当前时间选择范围的开始时间
    </para>
   </listitem>
   <listitem>
    <para>
     <emphasis role="bold">Absolute</emphasis> - 允许您选择要查询的日期范围
    </para>
   </listitem>
  </itemizedlist>
  <para>
   搜索时，选择您想要使用的常见字段，例如：
  </para>
  <itemizedlist>
   <listitem>
    <para>
     <emphasis role="bold">type</emphasis> - 包括服务名称，例如 <literal>keystone</literal> 或 <literal>ceilometer</literal>
    </para>
   </listitem>
   <listitem>
    <para>
     <emphasis role="bold">host </emphasis>- 您可以指定要在日志中搜索的特定主机
    </para>
   </listitem>
   <listitem>
    <para>
     <emphasis role="bold">file</emphasis> - 您可以指定要搜索的特定日志文件
    </para>
   </listitem>
  </itemizedlist>
  <para>
   有关使用 Kibana 和 Elasticsearch 查询日志的更多详细信息，请参阅 <link xlink:href="https://www.elastic.co/guide/en/kibana/3.0/working-with-queries-and-filters.html"/>
  </para>
 </section>
 <section xml:id="sec.central_log.monitor">
  <title>监控集中日志记录</title>
  <para>
   为了防范潜在日志记录问题，并在问题影响日志记录之前解决问题，您可能需要监视集中日志记录警报。
  </para>
  <para>
   <emphasis role="bold">要监控日志记录警报：</emphasis>
  </para>
  <orderedlist>
   <listitem>
    <para>
     登录到 Operations Console。
    </para>
   </listitem>
   <listitem>
    <para>
     从左上角的菜单按钮，导航到 <emphasis role="bold">Alarm Definitions</emphasis> 页面。
    </para>
   </listitem>
   <listitem>
    <para>
     查找应用于各种主机的警报定义。有关集中记录报警定义，请参见 <xref linkend="alarmdefinitions"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     导航到 <emphasis role="bold">Alarms</emphasis> 页面
    </para>
   </listitem>
   <listitem>
    <para>
     查找应用于各种主机的警报定义。这些应与 <xref linkend="alarmdefinitions"/>中的警报定义相匹配。
    </para>
   </listitem>
   <listitem>
    <para>
     查看警报是绿色（良好）还是处于不良状态。如果有任何不良状态，请查看 <xref linkend="alarmdefinitions"/>中可能要执行的操作。
    </para>
   </listitem>
  </orderedlist>
  <para>
   您可以在"Alarms"页面中使用过滤来查找以下内容：
  </para>
  <orderedlist>
   <listitem>
    <para>
     要查找可能已下线的进程，请过滤 <emphasis role="bold">"Process"</emphasis>，然后确保进程在线：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Elasticsearch
      </para>
     </listitem>
     <listitem>
      <para>
       Logstash
      </para>
     </listitem>
     <listitem>
      <para>
       Beaver
      </para>
     </listitem>
     <listitem>
      <para>
       Apache (Kafka)
      </para>
     </listitem>
     <listitem>
      <para>
       Kibana
      </para>
     </listitem>
     <listitem>
      <para>
       Monasca
      </para>
     </listitem>
    </itemizedlist>
   </listitem>
   <listitem>
    <para>
     要查找足够的硬盘空间，请筛选 <emphasis role="bold">"Disk"</emphasis>
    </para>
   </listitem>
   <listitem>
    <para>
     要查找足够的 RAM 内存，请过滤 <emphasis role="bold">"Memory"</emphasis>
    </para>
   </listitem>
  </orderedlist>
 </section>
 <section xml:id="sec.central_log.log_collection">
  <title>可能无法收集日志的情况</title>
  <para>
   在以下情况下，集中日志记录可能无法收集日志数据：
  </para>
  <itemizedlist>
   <listitem>
    <para>
     如果 Beaver 服务未在一个或多个节点（控制或计算）上运行，则不会收集来自这些节点的日志。
    </para>
   </listitem>
  </itemizedlist>
 </section>
 <section xml:id="sec.central_log.error_kibana">
  <title>创建 Kibana 可视化时出错</title>
  <para>
   在 Kibana 中创建可视化时，您可能会收到与此类似的错误：
  </para>
  <screen>"logstash-*" index pattern does not contain any of the following field types: number</screen>
  <para>
   要解决此问题：
  </para>
  <orderedlist>
   <listitem>
    <para>
     登入 Kibana。
    </para>
   </listitem>
   <listitem>
    <para>
     导航到 <literal>Settings</literal> 页面。
    </para>
   </listitem>
   <listitem>
    <para>
     在左边的面板选择 <literal>logstash-*</literal> 索引。
    </para>
   </listitem>
   <listitem>
    <para>
     点击 <emphasis role="bold">Refresh</emphasis> 按钮。刷新索引后您可能会看到一个映射冲突警告。
    </para>
   </listitem>
   <listitem>
    <para>
     重新创建可视化。
    </para>
   </listitem>
  </orderedlist>
 </section>
 <section xml:id="sec.central_log.store_log">
  <title>部署 Logging-API 后，日志没有被集中存储</title>
  <para>
   如果您使用的 Logging-API 并未集中存储日志，请使用以下核对表对 Logging-API 进行故障排除。
  </para>
  <informaltable colsep="1" rowsep="1">
   <tgroup cols="2">
    <colspec colname="c1" colnum="1" colwidth="1*"/>
    <colspec colname="c2" colnum="2" colwidth="19*"/>
    <thead>
     <row>
      <entry>☐</entry>
      <entry>Item</entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry/>
      <entry>
       <para>
        确认 Monasca 正在运行。
       </para>
      </entry>
     </row>
     <row>
      <entry/>
      <entry>
       <para>
        检查 Monasca 触发的任何警报。
       </para>
      </entry>
     </row>
     <row>
      <entry/>
      <entry>
       <para>
        检查是否已触发 Logging-API（monasca-log-api）进程警报。
       </para>
      </entry>
     </row>
     <row>
      <entry/>
      <entry>
       <para>
        运行 Ansible 脚本以获取 &lcm; 的状态：
       </para>
       <screen>ansible-playbook -i hosts/verb_hosts hlm-status.yml</screen>
      </entry>
     </row>
     <row>
      <entry/>
      <entry>
       <para>
        对 Lifecycle Manager 上发生故障的所有特定任务进行故障排除。
       </para>
      </entry>
     </row>
     <row>
      <entry/>
      <entry>确认 Logging-API 守护程序在线。</entry>
     </row>
     <row>
      <entry/>
      <entry>
       <para>
        运行 Ansible 脚本来试图启动 Logging-API 守护程序：
       </para>
       <screen>ansible-playbook –I hosts/verb_hosts logging-start.yml</screen>
      </entry>
     </row>
     <row>
      <entry/>
      <entry>
       <para>
        如果您在尝试启动守护程序时遇到错误，请解决它们。
       </para>
      </entry>
     </row>
     <row>
      <entry/>
      <entry>
       <para>
        验证配置文件中的 Logging-API 配置设置是否正确：
       </para>
       <screen>roles/kronos-api/templates/kronos-apache2.conf.j2</screen>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </informaltable>
  <para>
   以下是 Logging-API 配置文件示例：
  </para>
  <screen>{#
   # (c) Copyright 2015-2016 Hewlett Packard Enterprise Development LP
   # Licensed under the Apache License, Version 2.0 (the "License"); you may
   # not use this file except in compliance with the License. You may obtain
   # a copy of the License at
   #
   # http://www.apache.org/licenses/LICENSE-2.0
   #
   # Unless required by applicable law or agreed to in writing, software
   # distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
   # WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
   # License for the specific language governing permissions and limitations
   # under the License.
   #
   #}
   Listen {{ kronos_api_host }}:{{ kronos_api_port }}
   &lt;VirtualHost *:{{ kronos_api_port }}&gt;
   WSGIDaemonProcess log-api processes=4 threads=4 socket-timeout=300  user={{ kronos_user }} group={{ kronos_group }} python-path=/opt/stack/service/kronos/venv:/opt/stack/service/kronos/venv/bin/../lib/python2.7/site-packages/ display-name=monasca-log-api
   WSGIProcessGroup log-api
   WSGIApplicationGroup log-api
   WSGIScriptAlias / {{ kronos_wsgi_dir }}/app.wsgi
   ErrorLog /var/log/kronos/wsgi.log
   LogLevel info
   CustomLog /var/log/kronos/wsgi-access.log combined
   
   &lt;Directory /opt/stack/service/kronos/venv/bin/../lib/python2.7/site-packages/monasca_log_api&gt;
   Options Indexes FollowSymLinks MultiViews
   Require all granted
   AllowOverride None
   Order allow,deny
   allow from all
   LimitRequestBody 102400
   &lt;/Directory&gt;
   
   SetEnv no-gzip 1
   &lt;/VirtualHost&gt;
  </screen>
 </section>
 <section xml:id="sec.central_log.slow_log">
  <title>重新启用慢速日志记录</title>
  <para>
   早期版本默认启用 MariaDB 慢速日志记录。慢速日志记录日志将缓慢的 MariaDB 查询记录到 FND-MDB 主机上的 /var/log/mysql/mysql-slow.log。
  </para>
  <para>
   由于临时令牌可能会记录到慢速日志中，出于安全原因，我们已禁用此版本中的慢速日志。
  </para>
  <para>
   要重新启用慢速日志记录，请执行以下步骤：
  </para>
  <orderedlist>
   <listitem>
    <para>
     登入 &lcm; 并设置 mariadb 服务可配置项以启用慢速日志记录。
    </para>
    <screen>cd ~/openstack/my_cloud</screen>
    <orderedlist>
     <listitem>
      <para>
       检查 slow_query_log 当前是否已禁用，值为0：
      </para>
      <screen>grep slow ./config/percona/my.cfg.j2
       slow_query_log          = 0
       slow_query_log_file     = /var/log/mysql/mysql-slow.log</screen>
     </listitem>
     <listitem>
      <para>
       在服务器可配置模板文件中启用慢速日志记录并确认新值：
      </para>
      <screen>sed -e 's/slow_query_log = 0/slow_query_log = 1/' -i ./config/percona/my.cfg.j2
       grep slow ./config/percona/my.cfg.j2
       slow_query_log          = 1
       slow_query_log_file     = /var/log/mysql/mysql-slow.log</screen>
     </listitem>
     <listitem>
      <para>
       提交更改：
      </para>
      <screen>git add -A
       git commit -m "Enable Slow Logging"</screen>
     </listitem>
    </orderedlist>
   </listitem>
   <listitem>
    <para>
     运行配置处理器。
    </para>
    <screen>cd ~/openstack/ardana/ansible/
     ansible-playbook -i hosts/localhost config-processor-run.yml</screen>
   </listitem>
   <listitem>
    <para>
     系统将提示您输入加密密钥，并询问您是否要将加密密钥更改为新值，并且密钥必须是与之前不同的密钥。您可以通过键入以下内容来关闭加密：
    </para>
    <screen>ansible-playbook -i hosts/localhost config-processor-run.yml -e encrypt="" -e rekey=""</screen>
   </listitem>
   <listitem>
    <para>
     创建部署目录。
    </para>
    <screen>ansible-playbook -i hosts/localhost ready-deployment.yml</screen>
   </listitem>
   <listitem>
    <para>
     重新配置 Percona（注意这将重新启动集群主机上的 mysqld 服务器）。
    </para>
    <screen>ansible-playbook -i hosts/verb_hosts percona-reconfigure.yml</screen>
   </listitem>
  </orderedlist>
 </section>
</section>
