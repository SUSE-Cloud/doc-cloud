<?xml version="1.0"?>
<!DOCTYPE section [
<!ENTITY % entities SYSTEM "entities.ent"> %entities;
]>
<!---->
<section xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="recover_vertica">
 <title>文件系统问题后恢复 Vertica</title>
 <para>
  在 &kw-hos-phrase; 中，监视服务使用 Vertica 作为数据库。如果配置不正确，或者遇到高于预期的负载，并且文件系统已填满，Vertica 可能会故障转移并需要重新创建。此页面展示场景以及如何解决它们。
 </para>
 <para>
  在 &kw-hos-phrase; 中，监视服务使用 Vertica 作为数据库。如果配置不正确，或者遇到高于预期的负载，并且文件系统已填满，Vertica 可能会故障转移并需要重新创建。在这些情况下，您将需要依照以下的描述重新创建 Vertica 数据库。
 </para>
 <para>
  在达到这一点之前，您可能会看到 <literal>Disk Usage</literal> 警报触发，这表示文件系统正在填满。如果您可以使用以下步骤快速解决此问题，则可以防止 Vertica 数据库故障。
 </para>
 <para>
  此页面展示场景以及如何解决它们。
 </para>
 <section xml:id="changing_retention">
  <title>更改 Vertica 保留期</title>
  <para>
   如果触发了 <literal>mount_point: /var/vertica</literal> 上的 <literal>Disk Usage</literal> 警报，并且 Vertica 数据库和 API 仍处于运行状态，则可以使用以下步骤更改保留期限来解决这个问题：
  </para>
  <procedure>
   <step>
    <para>
     登入 &lcm;.
    </para>
   </step>
   <step>
    <para>
     编辑下面提到的配置文件以修改保留期。
    </para>
    <para>
     要编辑的配置文件是：
    </para>
    <screen>~/openstack/my_cloud/config/monasca/configuration.yml</screen>
    <para>
     将 <literal>vertica_retention_period</literal> 的值更改为您希望在 Vertica 中保存 Monasca 数据的天数。如果您的 Vertica 文件系统刚刚填满或快要填满，请确保将其降低到小于填满所需天数的值。
    </para>
    <para>
     该部分看起来像这样，加粗用于强调：
    </para>
    <screen># Retention variables
     kafka_low_disk_retention: 1800000 # 30 minutes in milliseconds
     kafka_log_retention_hours: "{{ monasca_tunings.kafka_log_retention_hours }}"
     <emphasis role="bold">vertica_retention_period: 45 # 45 day default retention</emphasis></screen>
   </step>
   <step>
    <para>
     用以下的指令提交您的配置文件到 <xref linkend="using_git"/>，如下：
    </para>
    <screen>git commit -a -m "changing Vertica retention period"</screen>
   </step>
   <step>
    <para>
     运行配置处理器：
    </para>
    <screen>cd ~/openstack/ardana/ansible
     ansible-playbook -i hosts/localhost config-processor-run.yml</screen>
   </step>
   <step>
    <para>
     更新部署目录：
    </para>
    <screen>cd ~/openstack/ardana/ansible
     ansible-playbook -i hosts/localhost ready-deployment.yml</screen>
   </step>
   <step>
    <para>
     运行此剧本将重新配置控制器节点上的cronjob：
    </para>
    <screen>cd ~/scratch/ansible/next/hos/ansible
     ansible-playbook -i hosts/verb_hosts monasca-deploy.yml --tags monasca-schema-vertica</screen>
   </step>
   <step>
    <para>
     从您的第一个控制器节点（可能是您的 &lcm;），手动运行新创建的 Vertica 的清理cronjob：
    </para>
    <screen>sudo /etc/cron.daily/vertica-cleanup</screen>
    <para>
     在此之后，它将每24小时自动运行一次。
    </para>
   </step>
  </procedure>
 </section>
 <section xml:id="recreate_vertica">
  <title>重新创建 Vertica 数据库</title>
  <warning>
   <para>
    这些步骤将删除所有现有数据。它应该作为最后的手段。
   </para>
  </warning>
  <para>
   如果您的Vertica数据库因文件系统问题而故障，需要重新创建它，这些步骤将向您展示如何操作。
  </para>
  <procedure>
   <step>
    <para>
     在每个运行 <literal>vertica</literal> 服务的控制器节点上，运行此命令，删除 Vertica 的 logrotate 目录：
    </para>
    <screen>sudo rm -rf /opt/vertica/config/logrotate</screen>
   </step>
   <step>
    <para>
     登入 &lcm;。
    </para>
   </step>
   <step>
    <para>
     删除 Vertica 数据库：
    </para>
    <screen>cd ~/scratch/ansible/next/hos/ansible
     ansible-playbook -i hosts/verb_hosts monasca-vertica-dbclean.yml -e "force='yes'"</screen>
   </step>
   <step>
    <para>
     重新安装Vertica数据库：
    </para>
    <screen>cd ~/scratch/ansible/next/hos/ansible
     ansible-playbook -i hosts/verb_hosts monasca-deploy.yml --tags vertica,monasca-schema-vertica</screen>
   </step>
   <step>
    <para>
     运行这两个剧本重新启动 API 和 Persister：
    </para>
    <screen>cd ~/scratch/ansible/next/hos/ansible
     ansible-playbook -i hosts/verb_hosts monasca-stop.yml --tags monasca-api,persister
     ansible-playbook -i hosts/verb_hosts monasca-start.yml --tags monasca-api,persister</screen>
   </step> 
   <step>
    <para>
     检查 Vertica 的状态：
    </para>
    <screen>cd ~/scratch/ansible/next/hos/ansible
     ansible-playbook -i hosts/verb_hosts monasca-status.yml --tags vertica</screen>
   </step>
   <step>
    <para>
     此时，应重新创建Vertica数据库。如果保留期是问题的根源，您可能需要考虑降低保留期。详见：<xref linkend="changing_retention"/>。
    </para>
   </step>
  </procedure>
 </section>
</section>
