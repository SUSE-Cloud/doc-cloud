<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<chapter xml:id="glance-user-guide" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Glance User Guide</title>
      <section xml:id="image-identifiers">
        <title>Image Identifiers</title>
        <para>Images are uniquely identified by way of a URI that
            matches the following signature:</para>
        <screen>&lt;Glance Server Location&gt;/v1/images/&lt;ID&gt;</screen>
        <para>where <literal>&lt;Glance Server Location&gt;</literal> is the resource location of the Glance service
            that knows about an image, and <literal>&lt;ID&gt;</literal> is the image’s identifier. Image
            identifiers in Glance are <emphasis>uuids</emphasis>, making them <emphasis>globally unique</emphasis>.</para>
      </section>
      <section xml:id="image-statuses">
        <title>Image Statuses</title>
        <para>Images in Glance can be in one the following statuses:</para>
        <itemizedlist>
          <listitem>
            <para>
              <literal>queued</literal>
            </para>
            <para>The image identifier has been reserved for an image in the Glance
                    registry. No image data has been uploaded to Glance and the image
                    size was not explicitly set to zero on creation.</para>
          </listitem>
          <listitem>
            <para>
              <literal>saving</literal>
            </para>
            <para>Denotes that an image’s raw data is currently being uploaded to Glance.
                    When an image is registered with a call to <literal>POST /images</literal> and there
                    is an <literal>x-image-meta-location</literal> header present, that image will never be in
                    the <literal>saving</literal> status (as the image data is already available in some other
                    location).</para>
          </listitem>
          <listitem>
            <para>
              <literal>active</literal>
            </para>
            <para>Denotes an image that is fully available in Glance. This occurs when
                    the image data is uploaded, or the image size is explicitly set to
                    zero on creation.</para>
          </listitem>
          <listitem>
            <para>
              <literal>deactivated</literal>
            </para>
            <para>Denotes that access to image data is not allowed to any non-admin user.
                    Prohibiting downloads of an image also prohibits operations like image
                    export and image cloning that may require image data.</para>
          </listitem>
          <listitem>
            <para>
              <literal>killed</literal>
            </para>
            <para>Denotes that an error occurred during the uploading of an image’s data,
                    and that the image is not readable.</para>
          </listitem>
          <listitem>
            <para>
              <literal>deleted</literal>
            </para>
            <para>Glance has retained the information about the image, but it is no longer
                    available to use. An image in this state will be removed automatically
                    at a later date.</para>
          </listitem>
          <listitem>
            <para>
              <literal>pending_delete</literal>
            </para>
            <para>This is similar to <literal>deleted</literal>, however, Glance has not yet removed the
                    image data. An image in this state is not recoverable.</para>
          </listitem>
        </itemizedlist>
        <figure>
          <title>This is a representation of how the image move from one status to the next.</title>
          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="image_status_transition.png"/>
            </imageobject>
            <imageobject role="html">
              <imagedata fileref="image_status_transition.png"/>
            </imageobject>
          </mediaobject>
        </figure>
      </section>
      <section xml:id="task-statuses">
        <title>Task Statuses</title>
        <para>Tasks in Glance can be in one the following statuses:</para>
        <itemizedlist>
          <listitem>
            <para>
              <literal>pending</literal>
            </para>
            <para>The task identifier has been reserved for a task in the Glance.
                    No processing has begun on it yet.</para>
          </listitem>
          <listitem>
            <para>
              <literal>processing</literal>
            </para>
            <para>The task has been picked up by the underlying executor and is being run
                    using the backend Glance execution logic for that task type.</para>
          </listitem>
          <listitem>
            <para>
              <literal>success</literal>
            </para>
            <para>Denotes that the task has had a successful run within Glance. The <literal>result</literal>
                    field of the task shows more details about the outcome.</para>
          </listitem>
          <listitem>
            <para>
              <literal>failure</literal>
            </para>
            <para>Denotes that an error occurred during the execution of the task and it
                    cannot continue processing. The <literal>message</literal> field of the task shows what the
                    error was.</para>
          </listitem>
        </itemizedlist>
      </section>
      <section>
        <title>Image Statuses</title>
        <para>Images in Glance can be in one the following statuses:</para>
        <itemizedlist>
          <listitem>
            <para>
              <literal>queued</literal>
            </para>
            <para>The image identifier has been reserved for an image in the Glance
                    registry. No image data has been uploaded to Glance and the image
                    size was not explicitly set to zero on creation.</para>
          </listitem>
          <listitem>
            <para>
              <literal>saving</literal>
            </para>
            <para>Denotes that an image’s raw data is currently being uploaded to Glance.
                    When an image is registered with a call to <literal>POST /images</literal> and there
                    is an <literal>x-image-meta-location</literal> header present, that image will never be in
                    the <literal>saving</literal> status (as the image data is already available in some other
                    location).</para>
          </listitem>
          <listitem>
            <para>
              <literal>active</literal>
            </para>
            <para>Denotes an image that is fully available in Glance. This occurs when
                    the image data is uploaded, or the image size is explicitly set to
                    zero on creation.</para>
          </listitem>
          <listitem>
            <para>
              <literal>deactivated</literal>
            </para>
            <para>Denotes that access to image data is not allowed to any non-admin user.
                    Prohibiting downloads of an image also prohibits operations like image
                    export and image cloning that may require image data.</para>
          </listitem>
          <listitem>
            <para>
              <literal>killed</literal>
            </para>
            <para>Denotes that an error occurred during the uploading of an image’s data,
                    and that the image is not readable.</para>
          </listitem>
          <listitem>
            <para>
              <literal>deleted</literal>
            </para>
            <para>Glance has retained the information about the image, but it is no longer
                    available to use. An image in this state will be removed automatically
                    at a later date.</para>
          </listitem>
          <listitem>
            <para>
              <literal>pending_delete</literal>
            </para>
            <para>This is similar to <literal>deleted</literal>, however, Glance has not yet removed the
                    image data. An image in this state is not recoverable.</para>
          </listitem>
        </itemizedlist>
        <figure>
          <title>This is a representation of how the image move from one status to the next.</title>
          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="image_status_transition.png"/>
            </imageobject>
            <imageobject role="html">
              <imagedata fileref="image_status_transition.png"/>
            </imageobject>
          </mediaobject>
        </figure>
      </section>
      <section>
        <title>Task Statuses</title>
        <para>Tasks in Glance can be in one the following statuses:</para>
        <itemizedlist>
          <listitem>
            <para>
              <literal>pending</literal>
            </para>
            <para>The task identifier has been reserved for a task in the Glance.
                    No processing has begun on it yet.</para>
          </listitem>
          <listitem>
            <para>
              <literal>processing</literal>
            </para>
            <para>The task has been picked up by the underlying executor and is being run
                    using the backend Glance execution logic for that task type.</para>
          </listitem>
          <listitem>
            <para>
              <literal>success</literal>
            </para>
            <para>Denotes that the task has had a successful run within Glance. The <literal>result</literal>
                    field of the task shows more details about the outcome.</para>
          </listitem>
          <listitem>
            <para>
              <literal>failure</literal>
            </para>
            <para>Denotes that an error occurred during the execution of the task and it
                    cannot continue processing. The <literal>message</literal> field of the task shows what the
                    error was.</para>
          </listitem>
        </itemizedlist>
      </section>
      <section xml:id="formats">
        <title>Disk and Container Formats</title>
        <para>When adding an image to Glance, you must specify what the virtual
            machine image’s <emphasis>disk format</emphasis> and <emphasis>container format</emphasis> are. Disk and container
            formats are configurable on a per-deployment basis. This document intends to
            establish a global convention for what specific values of <emphasis>disk_format</emphasis> and
            <emphasis>container_format</emphasis> mean.</para>
        <section xml:id="disk-format">
          <title>Disk Format</title>
          <para>The disk format of a virtual machine image is the format of the underlying
                disk image. Virtual appliance vendors have different formats for laying out
                the information contained in a virtual machine disk image.</para>
          <para>You can set your image’s disk format to one of the following:</para>
          <itemizedlist>
            <listitem>
              <para>
                <emphasis role="bold">raw</emphasis>
              </para>
              <para>This is an unstructured disk image format</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">vhd</emphasis>
              </para>
              <para>This is the VHD disk format, a common disk format used by virtual machine
                        monitors from VMware, Xen, Microsoft, VirtualBox, and others.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">vhdx</emphasis>
              </para>
              <para>This is the VHDX disk format, an enhanced version of the VHD format which
                        supports larger disk sizes among other features.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">vmdk</emphasis>
              </para>
              <para>Another common disk format supported by many common virtual machine monitors.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">vdi</emphasis>
              </para>
              <para>A disk format supported by VirtualBox virtual machine monitor and the QEMU
                        emulator.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">iso</emphasis>
              </para>
              <para>An archive format for the data contents of an optical disc (For example, CDROM).</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">ploop</emphasis>
              </para>
              <para>A disk format supported and used by Virtuozzo to run OS Containers.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">qcow2</emphasis>
              </para>
              <para>A disk format supported by the QEMU emulator that can expand dynamically and
                        supports Copy on Write.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">aki</emphasis>
              </para>
              <para>This indicates what is stored in Glance is an Amazon kernel image.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">ari</emphasis>
              </para>
              <para>This indicates what is stored in Glance is an Amazon ramdisk image.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">ami</emphasis>
              </para>
              <para>This indicates what is stored in Glance is an Amazon machine image.</para>
            </listitem>
          </itemizedlist>
        </section>
        <section xml:id="container-format">
          <title>Container Format</title>
          <para>The container format refers to whether the virtual machine image is in a
                file format that also contains metadata about the actual virtual machine.</para>
          <note>
            <para>The container format string is not currently used by Glance or
                other OpenStack components, so it is safe to simply specify <emphasis role="bold">bare</emphasis> as
                the container format if you are unsure.</para>
          </note>
          <para>You can set your image’s container format to one of the following:</para>
          <itemizedlist>
            <listitem>
              <para>
                <emphasis role="bold">bare</emphasis>
              </para>
              <para>This indicates there is no container or metadata envelope for the image.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">ovf</emphasis>
              </para>
              <para>This is the OVF container format.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">aki</emphasis>
              </para>
              <para>This indicates what is stored in Glance is an Amazon kernel image.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">ari</emphasis>
              </para>
              <para>This indicates what is stored in Glance is an Amazon ramdisk image.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">ami</emphasis>
              </para>
              <para>This indicates what is stored in Glance is an Amazon machine image</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">ova</emphasis>
              </para>
              <para>This indicates what is stored in Glance is an OVA tar archive file.</para>
            </listitem>
            <listitem>
              <para>
                <emphasis role="bold">docker</emphasis>
              </para>
              <para>This indicates what is stored in Glance is a Docker tar archive of
                        the container filesystem.</para>
            </listitem>
          </itemizedlist>
        </section>
      </section>
      <section xml:id="common-image-properties">
        <title>Common Image Properties</title>
        <para>When adding an image to Glance, you may specify some common image properties
            that may prove useful to consumers of your image.</para>
        <para>This document explains the names of these properties and the expected values.</para>
        <para>The common image properties are also described in a JSON schema, found in
              <literal>/etc/glance/schema-image.json</literal> in the Glance source code.</para>
        <section xml:id="architecture">
          <title>
            <emphasis role="bold">architecture</emphasis>
          </title>
          <para>Operating system architecture as specified in
                <link xlink:href="https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html"/>.</para>
        </section>
        <section xml:id="instance-uuid">
          <title>
            <emphasis role="bold">instance_uuid</emphasis>
          </title>
          <para>Metadata which can be used to record which instance this image is associated
                with. (Informational only, does not create an instance snapshot.)</para>
        </section>
        <section xml:id="kernel-id">
          <title>
            <emphasis role="bold">kernel_id</emphasis>
          </title>
          <para>The ID of image stored in Glance that should be used as the kernel when booting
                an AMI-style image.</para>
        </section>
        <section xml:id="ramdisk-id">
          <title>
            <emphasis role="bold">ramdisk_id</emphasis>
          </title>
          <para>The ID of image stored in Glance that should be used as the ramdisk when
                booting an AMI-style image.</para>
        </section>
        <section xml:id="os-distro">
          <title>
            <emphasis role="bold">os_distro</emphasis>
          </title>
          <para>The common name of the operating system distribution as specified in
                <link xlink:href="https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html"/>.</para>
        </section>
        <section xml:id="os-version">
          <title>
            <emphasis role="bold">os_version</emphasis>
          </title>
          <para>The operating system version as specified by the distributor.</para>
        </section>
      </section>
      <section xml:id="metadata-definition-concepts">
        <title>Metadata Definition Concepts</title>
        <para>The metadata definition service was added to Glance in the Juno release of
            OpenStack.</para>
        <para>It provides a common API for vendors, admins, services, and users to
            meaningfully <emphasis role="bold">define</emphasis> available key and value pair metadata that
            can be used on different types of resources (images, artifacts, volumes,
            flavors, aggregates, and other resources). A definition includes a property’s
            key, its description, its constraints, and the resource types to which it
            can be associated.</para>
        <para>This catalog does not store the values for specific instance properties.</para>
        <para>For example, a definition of a virtual CPU topology property for the number of
            cores will include the base key to use (for example, <literal>cpu_cores</literal>), a description,
            and value constraints like requiring it to be an integer. So, a user,
            potentially through Horizon, would be able to search this catalog to list the
            available properties they can add to a flavor or image. They will see the
            virtual CPU topology property in the list and know that it must be an integer.</para>
        <para>When the user adds the property its key and value will be stored in the
            service that owns that resource (for example, Nova for flavors and in Glance
            for images). The catalog also includes any additional prefix required when
            the property is applied to different types of resources, such as <literal>hw_</literal> for
            images and <literal>hw:</literal> for flavors. So, on an image, the user would know to set the
            property as <literal>hw_cpu_cores=1</literal>.</para>
        <section xml:id="terminology">
          <title>Terminology</title>
          <section xml:id="background">
            <title>Background</title>
            <para>The term <emphasis>metadata</emphasis> can become very overloaded and confusing. This
                    catalog is about the additional metadata that is passed as arbitrary
                    key and value pairs or tags across various artifacts and OpenStack services.</para>
            <para>Below are a few examples of the various terms used for metadata across
                    OpenStack services today:</para>
            <informaltable>
              <tgroup cols="3">
                <colspec colname="c1" colwidth="25"/>
                <colspec colname="c2" colwidth="27"/>
                <colspec colname="c3" colwidth="22"/>
                <thead>
                  <row>
                    <entry>
                      <para>Nova</para>
                    </entry>
                    <entry>
                      <para>Cinder</para>
                    </entry>
                    <entry>
                      <para>Glance</para>
                    </entry>
                  </row>
                </thead>
                <tbody>
                  <row>
                    <entry>
                      <variablelist>
                        <varlistentry>
                          <term>Flavor</term>
                          <listitem>
                            <itemizedlist>
                              <listitem>
                                <para>
                                  <emphasis>extra specs</emphasis>
                                </para>
                              </listitem>
                            </itemizedlist>
                          </listitem>
                        </varlistentry>
                        <varlistentry>
                          <term>Host Aggregate</term>
                          <listitem>
                            <itemizedlist>
                              <listitem>
                                <para>
                                  <emphasis>metadata</emphasis>
                                </para>
                              </listitem>
                            </itemizedlist>
                          </listitem>
                        </varlistentry>
                        <varlistentry>
                          <term>Servers</term>
                          <listitem>
                            <itemizedlist>
                              <listitem>
                                <para>
                                  <emphasis>metadata</emphasis>
                                </para>
                              </listitem>
                              <listitem>
                                <para>
                                  <emphasis>scheduler_hints</emphasis>
                                </para>
                              </listitem>
                              <listitem>
                                <para>
                                  <emphasis>tags</emphasis>
                                </para>
                              </listitem>
                            </itemizedlist>
                          </listitem>
                        </varlistentry>
                      </variablelist>
                    </entry>
                    <entry>
                      <variablelist>
                        <varlistentry>
                          <term>Volume &amp; Snapshot</term>
                          <listitem>
                            <itemizedlist>
                              <listitem>
                                <para>
                                  <emphasis>image metadata</emphasis>
                                </para>
                              </listitem>
                              <listitem>
                                <para>
                                  <emphasis>metadata</emphasis>
                                </para>
                              </listitem>
                            </itemizedlist>
                          </listitem>
                        </varlistentry>
                        <varlistentry>
                          <term>VolumeType</term>
                          <listitem>
                            <itemizedlist>
                              <listitem>
                                <para>
                                  <emphasis>extra specs</emphasis>
                                </para>
                              </listitem>
                              <listitem>
                                <para>
                                  <emphasis>qos specs</emphasis>
                                </para>
                              </listitem>
                            </itemizedlist>
                          </listitem>
                        </varlistentry>
                      </variablelist>
                    </entry>
                    <entry>
                      <variablelist>
                        <varlistentry>
                          <term>Image &amp; Snapshot</term>
                          <listitem>
                            <itemizedlist>
                              <listitem>
                                <para>
                                  <emphasis>properties</emphasis>
                                </para>
                              </listitem>
                              <listitem>
                                <para>
                                  <emphasis>tags</emphasis>
                                </para>
                              </listitem>
                            </itemizedlist>
                          </listitem>
                        </varlistentry>
                      </variablelist>
                    </entry>
                  </row>
                </tbody>
              </tgroup>
            </informaltable>
          </section>
          <section xml:id="catalog-concepts">
            <title>Catalog Concepts</title>
            <para>The below figure illustrates the concept terminology used in the metadata
                    definitions catalog:</para>
            <screen>A namespace is associated with 0 to many resource types, making it visible to
the API and UI for applying to that type of resource. RBAC Permissions are
managed at a namespace level.

+----------------------------------------------+
|         Namespace                            |
|                                              |
| +-----------------------------------------+  |
| |        Object Definition                |  |
| |                                         |  |        +--------------------+
| | +-------------------------------------+ |  |  +--&gt;  | Resource Type:     |
| | | Property Definition A (key=integer) | |  |  |     | e.g. Nova Flavor   |
| | +-------------------------------------+ |  |  |     +--------------------+
| |                                         |  |  |
| | +-------------------------------------+ |  |  |
| | | Property Definition B (key=string)  | |  |  |     +--------------------+
| | +-------------------------------------+ |  +--+--&gt;  | Resource Type:     |
| |                                         |  |  |     | e.g. Glance Image  |
| +-----------------------------------------+  |  |     +--------------------+
|                                              |  |
|  +-------------------------------------+     |  |
|  | Property Definition C (key=boolean) |     |  |     +--------------------+
|  +-------------------------------------+     |  +--&gt;  | Resource Type:     |
|                                              |        | e.g. Cinder Volume |
+----------------------------------------------+        +--------------------+

 Properties may be defined standalone or within the context of an object.</screen>
          </section>
          <section xml:id="catalog-terminology">
            <title>Catalog Terminology</title>
            <para>The following terminology is used within the metadata definition catalog.</para>
            <para>
              <emphasis role="bold">Namespaces</emphasis>
            </para>
            <para>Metadata definitions are contained in namespaces.</para>
            <itemizedlist>
              <listitem>
                <para>Specify the access controls (CRUD) for everything defined in it. Allows for
                            admin only, different projects, or the entire cloud to define and use the
                            definitions in the namespace.</para>
              </listitem>
              <listitem>
                <para>Associates the contained definitions to different types of resources.</para>
              </listitem>
            </itemizedlist>
            <para>
              <emphasis role="bold">Properties</emphasis>
            </para>
            <para>A property describes a single property and its primitive constraints. Each
                    property can only be a primitive type:</para>
            <itemizedlist>
              <listitem>
                <para>string, integer, number, boolean, array</para>
              </listitem>
            </itemizedlist>
            <para>Each primitive type is described using simple JSON schema notation. This
                    means no nested objects and no definition referencing.</para>
            <para>
              <emphasis role="bold">Objects</emphasis>
            </para>
            <para>An object describes a group of one to many properties and their primitive
                    constraints. Each property in the group can ONLY be a primitive type:</para>
            <itemizedlist>
              <listitem>
                <para>string, integer, number, boolean, array</para>
              </listitem>
            </itemizedlist>
            <para>Each primitive type is described using simple JSON schema notation. This
                    means no nested objects.</para>
            <para>The object may optionally define required properties under the semantic
                    understanding that a user who uses the object should provide all required
                    properties.</para>
            <para>
              <emphasis role="bold">Resource Type Association</emphasis>
            </para>
            <para>Resource type association specifies the relationship between resource
                    types and the namespaces that are applicable to them. This information can be
                    used to drive UI and CLI views. For example, the same namespace of
                    objects, properties, and tags may be used for images, snapshots, volumes, and
                    flavors. Or a namespace may only apply to images.</para>
            <para>Resource types should be aligned with Heat resource types whenever possible.
                    <link xlink:href="http://docs.openstack.org/developer/heat/template_guide/openstack.html"/></para>
            <para>It is important to note that the same base property key can require different
                    prefixes depending on the target resource type. The API provides a way to
                    retrieve the correct property based on the target resource type.</para>
            <para>Below are a few examples:</para>
            <para>The desired virtual CPU topology can be set on both images and flavors
                    via metadata. The keys have different prefixes on images than on flavors.
                    On flavors keys are prefixed with <literal>hw:</literal>, but on images the keys are prefixed
                    with <literal>hw_</literal>.</para>
            <para>For more: <link xlink:href="https://github.com/openstack/nova-specs/blob/master/specs/juno/implemented/virt-driver-vcpu-topology.rst"/>.</para>
            <para>Another example is the <literal>AggregateInstanceExtraSpecsFilter</literal> and scoped properties
                    (For example, properties with <literal>something:something=value</literal>). For scoped or namespaced
                    properties, the <literal>AggregateInstanceExtraSpecsFilter</literal> requires a prefix of
                    <literal>aggregate_instance_extra_specs:</literal> to be used on flavors but not on the
                    aggregate itself. Otherwise, the filter will not evaluate the property during
                    scheduling.</para>
            <para>So, on a host aggregate, you may see:</para>
            <para><literal>companyx:fastio=true</literal></para>
            <para>But then when used on the flavor, the <literal>AggregateInstanceExtraSpecsFilter</literal> needs:</para>
            <para><literal>aggregate_instance_extra_specs:companyx:fastio=true</literal></para>
            <para>In some cases, there may be multiple different filters that may use
                    the same property with different prefixes. In this case, the correct prefix
                    needs to be set based on which filter is enabled.</para>
          </section>
        </section>
      </section>
      <section xml:id="using-glance-s-image-public-apis">
        <title>Using Glance’s Image Public APIs</title>
        <para>Glance is the reference implementation of the OpenStack Images API. As such,
            Glance fully implements versions 1 and 2 of the Images API.</para>
        <note>
          <para>The Images API v1 has been DEPRECATED in the Newton release. The
                migration path is to use the <link xlink:href="http://developer.openstack.org/api-ref/image/v2/">Images API v2</link> instead of version 1
                of the API. The Images API v1 will ultimately be removed, following the
                <link xlink:href="https://governance.openstack.org/reference/tags/assert_follows-standard-deprecation.html">OpenStack standard deprecation policy</link>.</para>
        </note>
        <para>There used to be a sentence here saying, “The Images API specification is
            developed alongside Glance, but is not considered part of the Glance project.”
            That’s only partially true (or completely false, depending upon how strict you
            are about these things). Conceptually, the OpenStack Images API is an
            independent definition of a REST API. In practice, however, the only way
            to participate in the evolution of the Images API is to work with the Glance
            community to define the new functionality and provide its reference
            implementation. Further, Glance falls under the designated sections provision
            of the OpenStack DefCore Guidelines, which basically means that in order to
            qualify as OpenStack, a cloud exposing an OpenStack Images API must include
            the Glance Images API implementation code. Thus, although conceptually
            independent, the OpenStack Images APIs are intimately associated with Glance.</para>
        <para>
          <emphasis role="bold">References</emphasis>
        </para>
        <itemizedlist>
          <listitem>
            <para>
              <link xlink:href="http://git.openstack.org/cgit/openstack/defcore/tree/doc/source/process/Lexicon.rst#n54">Designated sections (definition)</link>
            </para>
          </listitem>
          <listitem>
            <para>
              <link xlink:href="https://governance.openstack.org/resolutions/20140402-defcore-designated-sections-guidelines.html">2014-04-02 DefCore Designated Sections Guidelines</link>
            </para>
          </listitem>
          <listitem>
            <para>
              <link xlink:href="https://github.com/openstack/defcore/blob/master/doc/source/process/CoreDefinition.rst">OpenStack Core Definition</link>
            </para>
          </listitem>
          <listitem>
            <para>
              <link xlink:href="https://github.com/openstack/defcore">DefCore Guidelines Repository</link>
            </para>
          </listitem>
        </itemizedlist>
        <section xml:id="glance-and-the-images-apis-past-present-and-future">
          <title>Glance and the Images APIs: Past, Present, and Future</title>
          <para>Here’s a quick summary of the Images APIs that have been implemented by Glance.
                If you’re interested in more details, you can consult the Release Notes for all
                the OpenStack releases (beginning with “Bexar”) to follow the evolution of
                features in Glance and the Images APIs.</para>
          <section xml:id="images-v1-api">
            <title>Images v1 API</title>
            <para>The v1 API was originally designed as a service API for use by Nova and other
                    OpenStack services. In the Kilo release, the v1.1 API was downgraded from
                    CURRENT to SUPPORTED. In the Newton release, the version 1 API is officially
                    declared DEPRECATED.</para>
            <para>During the deprecation period, the Images v1 API is closed to further
                    development. The Glance code implementing the v1 API accepts only serious
                    bug fixes.</para>
            <para>Since Folsom, it has been possible to deploy OpenStack without exposing the
                    Images v1 API to end users. The Compute v2 API contains image-related API
                    calls allowing users to list images, list images details, show image details
                    for a specific image, delete images, and manipulate image metadata. Nova acts
                    as a proxy to Glance for these image-related calls. It’s important to note
                    that the image-related calls in the Compute v2 API are a proper subset of the
                    calls available in the Images APIs.</para>
            <para>In the Newton release, Nova (and other OpenStack services that consume images)
                    have been modified to use the Images v2 API by default.</para>
            <para>
              <emphasis role="bold">Reference</emphasis>
            </para>
            <itemizedlist>
              <listitem>
                <para>
                  <link xlink:href="https://governance.openstack.org/reference/tags/assert_follows-standard-deprecation.html#requirements">OpenStack Standard Deprecation Requirements</link>
                </para>
              </listitem>
            </itemizedlist>
          </section>
          <section xml:id="images-v2-api">
            <title>Images v2 API</title>
            <para>The v2 API is the CURRENT OpenStack Images API. It provides a more friendly
                    interface to consumers than did the v1 API, as it was specifically designed to
                    expose images-related functionality as a public-facing endpoint. It’s the
                    version that’s currently open to development.</para>
            <para>A common strategy is to deploy multiple Glance nodes: internal-facing nodes
                    providing the Images APIs for internal consumers like Nova, and external-facing
                    nodes providing the Images v2 API for public use.</para>
          </section>
          <section xml:id="the-future">
            <title>The Future</title>
            <para>During the long and tumultuous design phase of what has since become an
                    independent service named “Glare” (the Glance Artifacts Repository), the Glance
                    community loosely spoke about the Artifacts API being “Glance v3”. This,
                    however, was only a shorthand way of speaking of the Artifacts effort. The
                    Artifacts API can’t be the Images v3 API since Artifacts are not the same as
                    Images. Conceptually, a virtual machine image could be an Artifact, and the
                    Glare code has been designed to be compatible with the Images v2 API. But at
                    this time, there are no plans to implement an Images v3 API.</para>
            <para>During the Newton development cycle, Glare became an independent OpenStack
                    project. While it’s evident that there’s a need for an Artifact Repository in
                    OpenStack, whether it will be as ubiquitous as the need for an Images
                    Repository isn’t clear. On the other hand, industry trends could go in the
                    opposite direction where everyone needs Artifacts and deployers view images as
                    simply another type of digital artifact.</para>
          </section>
        </section>
        <section>
          <title>Authentication</title>
          <para>Glance depends on Keystone and the OpenStack Identity API to handle
                authentication of clients. You must obtain an authentication token from
                Keystone using and send it along with all API requests to Glance through
                the <literal>X-Auth-Token</literal> header. Glance will communicate back to Keystone to
                verify the token validity and obtain your identity credentials.</para>
          <para>See <link xlink:href="https://docs.openstack.org/glance/pike/admin/authentication.html#authentication">Authentication With Keystone</link>
                for more information on integrating with Keystone.</para>
        </section>
        <section xml:id="using-v1-x">
          <title>Using v1.X</title>
          <note>
            <para>The Images API v1 has been DEPRECATED in the Newton release. The
                    migration path is to use the <link xlink:href="http://developer.openstack.org/api-ref/image/v2/">Images API v2</link>
                    instead of version 1 of the API. The Images API v1 will ultimately be removed, following the
                    <link xlink:href="https://governance.openstack.org/reference/tags/assert_follows-standard-deprecation.html">OpenStack standard deprecation policy</link>.</para>
          </note>
          <para>For the purpose of examples, assume there is a Glance API server running
                at the URL <literal>http://glance.openstack.example.org</literal> on the default port 80.</para>
          <section xml:id="list-available-images">
            <title>List Available Images</title>
            <para>We want to see a list of available images that the authenticated user has
                    access to. This includes images owned by the user, images shared with the user
                    and public images.</para>
            <para>We issue a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v1/images</literal> to
                    retrieve this list of available images. The data is returned as a JSON-encoded
                    mapping in the following format:</para>
            <screen>{'images': [
  {'uri': 'http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9',
   'name': 'SLES 15',
   'disk_format': 'vhd',
   'container_format': 'ovf',
   'size': '5368709120'}
  ...]}</screen>
          </section>
          <section xml:id="list-available-images-in-more-detail">
            <title>List Available Images in More Detail</title>
            <para>We want to see a more detailed list of available images that the authenticated
                    user has access to. This includes images owned by the user, images shared with
                    the user and public images.</para>
            <para>We issue a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v1/images/detail</literal> to
                    retrieve this list of available images. The data is returned as a
                    JSON-encoded mapping in the following format:</para>
            <screen>{'images': [
  {'uri': 'http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9',
   'name': 'SLES 15',
   'disk_format': 'vhd',
   'container_format': 'ovf',
   'size': '5368709120',
   'checksum': 'c2e5db72bd7fd153f53ede5da5a06de3',
   'created_at': '2010-02-03 09:34:01',
   'updated_at': '2010-02-03 09:34:01',
   'deleted_at': '',
   'status': 'active',
   'is_public': true,
   'min_ram': 256,
   'min_disk': 5,
   'owner': null,
   'properties': {'distro': 'SLES 15'}},
  ...]}</screen>
            <note>
              <para>All timestamps returned are in UTC.</para>
              <para>The <literal>updated_at</literal> timestamp is the timestamp when an image’s metadata
                        was last updated, not its image data, as all image data is immutable
                        once stored in Glance.</para>
              <para>The <literal>properties</literal> field is a mapping of free-form key and value pairs that
                        have been saved with the image metadata.</para>
              <para>The <literal>checksum</literal> field is an MD5 checksum of the image file data.</para>
              <para>The <literal>is_public</literal> field is a boolean indicating whether the image is
                        publicly available.</para>
              <para>The <literal>min_ram</literal> field is an integer specifying the minimum amount of
                        RAM needed to run this image on an instance in megabytes.</para>
              <para>The <literal>min_disk</literal> field is an integer specifying the minimum amount of
                        disk space needed to run this image on an instance in gigabytes.</para>
              <para>The <literal>owner</literal> field is a string which may either be null or which will
                        indicate the owner of the image.</para>
            </note>
          </section>
          <section xml:id="filtering-images-lists">
            <title>Filtering Images Lists</title>
            <para>Both the <literal>GET /v1/images</literal> and <literal>GET /v1/images/detail</literal> requests take query
                    parameters that serve to filter the returned list of images. The following
                    list details these query parameters.</para>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>name=NAME</literal>
                </para>
                <para>Filters images having a <literal>name</literal> attribute matching <literal>NAME</literal>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>container_format=FORMAT</literal>
                </para>
                <para>Filters images having a <literal>container_format</literal> attribute matching <literal>FORMAT</literal>.</para>
                <para>For more information, see <xref linkend="formats"/>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>disk_format=FORMAT</literal>
                </para>
                <para>Filters images having a <literal>disk_format</literal> attribute matching <literal>FORMAT</literal>.</para>
                <para>For more information, see <xref linkend="formats"/>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>status=STATUS</literal>
                </para>
                <para>Filters images having a <literal>status</literal> attribute matching <literal>STATUS</literal>.</para>
                <para>For more information, see <xref linkend="image-statuses"/>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>size_min=BYTES</literal>
                </para>
                <para>Filters images having a <literal>size</literal> attribute greater than or equal to <literal>BYTES</literal>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>size_max=BYTES</literal>
                </para>
                <para>Filters images having a <literal>size</literal> attribute less than or equal to <literal>BYTES</literal>.</para>
              </listitem>
            </itemizedlist>
            <para>These two resources also accept additional query parameters:</para>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>sort_key=KEY</literal>
                </para>
                <para>Results will be ordered by the specified image attribute <literal>KEY</literal>. Accepted
                            values include <literal>id</literal>, <literal>name</literal>, <literal>status</literal>, <literal>disk_format</literal>,
                            <literal>container_format</literal>, <literal>size</literal>, <literal>created_at</literal> (default) and <literal>updated_at</literal>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>sort_dir=DIR</literal>
                </para>
                <para>Results will be sorted in the direction <literal>DIR</literal>. Accepted values are <literal>asc</literal>
                            for ascending or <literal>desc</literal> (default) for descending.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>marker=ID</literal>
                </para>
                <para>An image identifier marker may be specified. When present, only images which
                            occur after the identifier <literal>ID</literal> will be listed. (These are the images that
                            have a <literal>sort_key</literal> later than that of the marker <literal>ID</literal> in the <literal>sort_dir</literal>
                            direction.)</para>
              </listitem>
              <listitem>
                <para>
                  <literal>limit=LIMIT</literal>
                </para>
                <para>When present, the maximum number of results returned will not exceed <literal>LIMIT</literal>.</para>
              </listitem>
            </itemizedlist>
            <note>
              <para>If the specified <literal>LIMIT</literal> exceeds the operator defined limit (<literal>api_limit_max</literal>)
                        then the number of results returned may be less than <literal>LIMIT</literal>.</para>
            </note>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>is_public=PUBLIC</literal>
                </para>
                <para>An admin user may use the <literal>is_public</literal> parameter to control which results are
                            returned.</para>
                <para>When the <literal>is_public</literal> parameter is absent or set to <literal>True</literal> the following images
                            will be listed: Images whose <literal>is_public</literal> field is <literal>True</literal>, owned images and
                            shared images.</para>
                <para>When the <literal>is_public</literal> parameter is set to <literal>False</literal> the following images will be
                            listed: Images (owned, shared, or non-owned) whose <literal>is_public</literal> field is <literal>False</literal>.</para>
                <para>When the <literal>is_public</literal> parameter is set to <literal>None</literal> all images will be listed
                            irrespective of owner, shared status or the <literal>is_public</literal> field.</para>
              </listitem>
            </itemizedlist>
            <note>
              <para>Use of the <literal>is_public</literal> parameter is restricted to admin users. For all other
                        users it will be ignored.</para>
            </note>
          </section>
          <section xml:id="retrieve-image-metadata">
            <title>Retrieve Image Metadata</title>
            <para>We want to see detailed information for a specific virtual machine image
                    that the Glance server knows about.</para>
            <para>We have queried the Glance server for a list of images and the
                    data returned includes the <literal>uri</literal> field for each available image. This
                    <literal>uri</literal> field value contains the exact location needed to get the metadata
                    for a specific image.</para>
            <para>Continuing the example from above, in order to get metadata about the
                    first image returned, we can issue a <literal>HEAD</literal> request to the Glance
                    server for the image’s URI.</para>
            <para>We issue a <literal>HEAD</literal> request to
                    <literal>http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9</literal> to
                    retrieve complete metadata for that image. The metadata is returned as a
                    set of HTTP headers that begin with the prefix <literal>x-image-meta-</literal>. The
                    following shows an example of the HTTP headers returned from the above
                    <literal>HEAD</literal> request:</para>
            <screen>x-image-meta-uri              http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9
x-image-meta-name             SLES 15
x-image-meta-disk_format      vhd
x-image-meta-container_format ovf
x-image-meta-size             5368709120
x-image-meta-checksum         c2e5db72bd7fd153f53ede5da5a06de3
x-image-meta-created_at       2010-02-03 09:34:01
x-image-meta-updated_at       2010-02-03 09:34:01
x-image-meta-deleted_at
x-image-meta-status           available
x-image-meta-is_public        true
x-image-meta-min_ram          256
x-image-meta-min_disk         0
x-image-meta-owner            null
x-image-meta-property-distro  SLES 15</screen>
            <note>
              <para>All timestamps returned are in UTC.</para>
              <para>The <literal>x-image-meta-updated_at</literal> timestamp is the timestamp when an
                        image’s metadata was last updated, not its image data, as all
                        image data is immutable once stored in Glance.</para>
              <para>There may be multiple headers that begin with the prefix
                        <literal>x-image-meta-property-</literal>. These headers are free-form key and value pairs
                        that have been saved with the image metadata. The key is the string
                        after <literal>x-image-meta-property-</literal> and the value is the value of the header.</para>
              <para>The response’s <literal>ETag</literal> header will always be equal to the
                        <literal>x-image-meta-checksum</literal> value.</para>
              <para>The response’s <literal>x-image-meta-is_public</literal> value is a boolean indicating
                        whether the image is publicly available.</para>
              <para>The response’s <literal>x-image-meta-owner</literal> value is a string which may either
                        be null or which will indicate the owner of the image.</para>
            </note>
          </section>
          <section xml:id="retrieve-raw-image-data">
            <title>Retrieve Raw Image Data</title>
            <para>We want to retrieve that actual raw data for a specific virtual machine image
                    that the Glance server knows about.</para>
            <para>We have queried the Glance server for a list of images and the
                    data returned includes the <literal>uri</literal> field for each available image. This
                    <literal>uri</literal> field value contains the exact location needed to get the metadata
                    for a specific image.</para>
            <para>Continuing the example from above, in order to get metadata about the
                    first image returned, we can issue a <literal>HEAD</literal> request to the Glance
                    server for the image’s URI.</para>
            <para>We issue a <literal>GET</literal> request to
                    <literal>http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9</literal> to
                    retrieve metadata for that image as well as the image itself encoded
                    into the response body.</para>
            <para>The metadata is returned as a set of HTTP headers that begin with the
                    prefix <literal>x-image-meta-</literal>. The following shows an example of the HTTP headers
                    returned from the above <literal>GET</literal> request:</para>
            <screen>x-image-meta-uri              http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9
x-image-meta-name             SLES 15
x-image-meta-disk_format      vhd
x-image-meta-container_format ovf
x-image-meta-size             5368709120
x-image-meta-checksum         c2e5db72bd7fd153f53ede5da5a06de3
x-image-meta-created_at       2010-02-03 09:34:01
x-image-meta-updated_at       2010-02-03 09:34:01
x-image-meta-deleted_at
x-image-meta-status           available
x-image-meta-is_public        true
x-image-meta-min_ram          256
x-image-meta-min_disk         5
x-image-meta-owner            null
x-image-meta-property-distro  SLES 15</screen>
            <note>
              <para>All timestamps returned are in UTC.</para>
              <para>The <literal>x-image-meta-updated_at</literal> timestamp is the timestamp when an
                        image’s metadata was last updated, not its image data, as all
                        image data is immutable once stored in Glance.</para>
              <para>There may be multiple headers that begin with the prefix
                        <literal>x-image-meta-property-</literal>. These headers are free-form key and value pairs
                        that have been saved with the image metadata. The key is the string
                        after <literal>x-image-meta-property-</literal> and the value is the value of the header.</para>
              <para>The response’s <literal>Content-Length</literal> header shall be equal to the value of
                        the <literal>x-image-meta-size</literal> header.</para>
              <para>The response’s <literal>ETag</literal> header will always be equal to the
                        <literal>x-image-meta-checksum</literal> value.</para>
              <para>The response’s <literal>x-image-meta-is_public</literal> value is a boolean indicating
                        whether the image is publicly available.</para>
              <para>The response’s <literal>x-image-meta-owner</literal> value is a string which may either
                        be null or which will indicate the owner of the image.</para>
              <para>The image data itself will be the body of the HTTP response returned
                        from the request, which will have content-type of
                        <literal>application/octet-stream</literal>.</para>
            </note>
          </section>
          <section xml:id="add-a-new-image">
            <title>Add a New Image</title>
            <para>We have created a new virtual machine image in some way (created a
                    snapshot or backed up an existing image) and we
                    wish to do two things:</para>
            <itemizedlist>
              <listitem>
                <para>Store the disk image data in Glance.</para>
              </listitem>
              <listitem>
                <para>Store metadata about this image in Glance.</para>
              </listitem>
            </itemizedlist>
            <para>We can do the above two activities in a single call to the Glance API.
                    Assuming, like in the examples above, that a Glance API server is running
                    at <literal>http://glance.openstack.example.org</literal>, we issue a <literal>POST</literal> request to add an image to
                    Glance:</para>
            <screen>POST http://glance.openstack.example.org/v1/images</screen>
            <para>The metadata about the image is sent to Glance in HTTP headers. The body
                    of the HTTP request to the Glance API will be the MIME-encoded disk
                    image data.</para>
          </section>
          <section xml:id="reserve-a-new-image">
            <title>Reserve a New Image</title>
            <para>We can also perform the activities described in <xref linkend="add-a-new-image"/> using two
                    separate calls to the Image API; the first to register the image metadata, and
                    the second to add the image disk data. This is known as reserving an image.</para>
            <para>The first call should be a <literal>POST</literal> to <literal>http://glance.openstack.example.org/v1/images</literal>,
                    which will result in a new image id being registered with a status of
                    <literal>queued</literal>:</para>
            <screen>{'image':
 {'status': 'queued',
  'id': '71c675ab-d94f-49cd-a114-e12490b328d9',
  ...}
 ...}</screen>
            <para>The image data can then be added using a <literal>PUT</literal> to
                    <literal>http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9</literal>.
                    The image status will then be set to <literal>active</literal> by Glance.</para>
            <para>
              <emphasis role="bold">Image Metadata in HTTP Headers</emphasis>
            </para>
            <para>Glance will view as image metadata any HTTP header that it receives in a
                    <literal>POST</literal> request where the header key is prefixed with the strings
                    <literal>x-image-meta-</literal> and <literal>x-image-meta-property-</literal>.</para>
            <para>The list of metadata headers that Glance accepts are listed below.</para>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>x-image-meta-name</literal>
                </para>
                <para>This header is required, unless reserving an image. Its value should be the
                            name of the image.</para>
                <note>
                  <para>The name of an image <emphasis>is not unique to a Glance node</emphasis>. It
                            would be an unrealistic expectation of users to know all the unique
                            names of all other user’s images.</para>
                </note>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-id</literal>
                </para>
                <para>This header is optional.</para>
                <para>When present, Glance will use the supplied identifier for the image.
                            If the identifier already exists in that Glance node, then a
                            <emphasis role="bold">409 Conflict</emphasis> will be returned by Glance. The value of the header
                            must be a uuid in hexadecimal string notation
                            (that is 71c675ab-d94f-49cd-a114-e12490b328d9).</para>
                <para>When this header is <emphasis>not</emphasis> present, Glance will generate an identifier
                            for the image and return this identifier in the response (see below).</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-store</literal>
                </para>
                <para>This header is optional. Valid values are one of <literal>file</literal>, <literal>rbd</literal>,
                            <literal>swift</literal>, <literal>cinder</literal>, <literal>sheepdog</literal> or <literal>vsphere</literal>.</para>
                <para>When present, Glance will attempt to store the disk image data in the
                            backing store indicated by the value of the header. If the Glance node
                            does not support the backing store, Glance will return a <emphasis role="bold">400 Bad Request</emphasis>.</para>
                <para>When not present, Glance will store the disk image data in the backing
                            store that is marked as default. See the configuration option <literal>default_store</literal>
                            for more information.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-disk_format</literal>
                </para>
                <para>This header is required, unless reserving an image. Valid values are one of
                            <literal>aki</literal>, <literal>ari</literal>, <literal>ami</literal>, <literal>raw</literal>, <literal>iso</literal>, <literal>vhd</literal>, <literal>vhdx</literal>, <literal>vdi</literal>,
                            <literal>qcow2</literal>, <literal>vmdk</literal> or <literal>ploop</literal>.</para>
                <para>For more information, see <xref linkend="formats"/>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-container_format</literal>
                </para>
                <para>This header is required, unless reserving an image. Valid values are one of
                            <literal>aki</literal>, <literal>ari</literal>, <literal>ami</literal>, <literal>bare</literal>, <literal>ova</literal>, <literal>ovf</literal>, or <literal>docker</literal>.</para>
                <para>For more information, see <xref linkend="formats"/>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-size</literal>
                </para>
                <para>This header is optional.</para>
                <para>When present, Glance assumes that the expected size of the request body
                            will be the value of this header. If the length in bytes of the request
                            body <emphasis>does not match</emphasis> the value of this header, Glance will return a
                            <emphasis role="bold">400 Bad Request</emphasis>.</para>
                <para>When not present, Glance will calculate the image’s size based on the size
                            of the request body.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-checksum</literal>
                </para>
                <para>This header is optional. When present, it specifies the <emphasis role="bold">MD5</emphasis> checksum
                            of the image file data.</para>
                <para>When present, Glance will verify the checksum generated from the back-end
                            store while storing your image against this value and return a
                            <emphasis role="bold">400 Bad Request</emphasis> if the values do not match.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-is_public</literal>
                </para>
                <para>This header is optional.</para>
                <para>When Glance finds the string <literal>true</literal> (case-insensitive), the image is marked as
                            a public one, meaning that any user may view its metadata and may read
                            the disk image from Glance.</para>
                <para>When not present, the image is assumed to be <emphasis>not public</emphasis> and owned by
                            a user.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-min_ram</literal>
                </para>
                <para>This header is optional. When present, it specifies the minimum amount of
                            RAM in megabytes required to run this image on a server.</para>
                <para>When not present, the image is assumed to have a minimum RAM requirement of 0.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-min_disk</literal>
                </para>
                <para>This header is optional. When present, it specifies the expected minimum disk
                            space in gigabytes required to run this image on a server.</para>
                <para>When not present, the image is assumed to have a minimum disk space
                            requirement of 0.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-owner</literal>
                </para>
                <para>This header is optional and only meaningful for admins.</para>
                <para>Glance normally sets the owner of an image to be the tenant or user
                            (depending on the <literal>owner_is_tenant</literal> configuration option) of the
                            authenticated user issuing the request. However, if the authenticated user
                            has the Admin role, this default may be overridden by setting this header to
                            null or to a string identifying the owner of the image.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>x-image-meta-property-*</literal>
                </para>
                <para>When Glance receives any HTTP header whose key begins with the string prefix
                            <literal>x-image-meta-property-</literal>, Glance adds the key and value to a set of custom,
                            free-form image properties stored with the image. The key is a
                            lower-cased string following the prefix <literal>x-image-meta-property-</literal> with dashes
                            and punctuation replaced with underscores.</para>
                <para>There is no limit on the number of free-form key and value attributes that can
                            be attached to the image. However, keep in mind that the 8K limit on the
                            size of all the HTTP headers sent in a request will effectively limit the
                            number of image properties.</para>
              </listitem>
            </itemizedlist>
          </section>
          <section xml:id="update-an-image">
            <title>Update an Image</title>
            <para>Glance will consider any HTTP header that it receives in a <literal>PUT</literal> request
                    as an instance of image metadata. In this case, the header key should be
                    prefixed with the strings <literal>x-image-meta-</literal> and <literal>x-image-meta-property-</literal>.</para>
            <para>If an image was previously reserved, and thus is in the <literal>queued</literal> state, then
                    image data can be added by including it as the request body. If the image
                    already has data associated with it (for example, it is not in the <literal>queued</literal>
                    state), then including a request body will result in a <emphasis role="bold">409 Conflict</emphasis>
                    exception.</para>
            <para>On success, the <literal>PUT</literal> request will return the image metadata encoded as HTTP
                    headers.</para>
            <para>See more about image statuses here <xref linkend="image-statuses"/>.</para>
          </section>
          <section xml:id="list-image-memberships">
            <title>List Image Memberships</title>
            <para>We want to see a list of the other system tenants (or users, if
                    <literal>owner_is_tenant</literal> is <literal>False</literal>) that may access a given virtual machine image that
                    the Glance server knows about. We take the <literal>uri</literal> field of the image data,
                    append <literal>/members</literal> to it, and issue a <literal>GET</literal> request on the resulting URL.</para>
            <para>Continuing from the example above, in order to get the memberships for the
                    first image returned, we can issue a <literal>GET</literal> request to the Glance
                    server for
                    <literal>http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9/members</literal>.
                    And we will get back JSON data such as the following:</para>
            <screen>{'members': [
 {'member_id': 'tenant1',
  'can_share': false}
 ...]}</screen>
            <para>The <literal>member_id</literal> field identifies a tenant with which the image is shared. If
                    that tenant is authorized to further share the image, the <literal>can_share</literal> field is
                    <literal>true</literal>.</para>
          </section>
          <section xml:id="list-shared-images">
            <title>List Shared Images</title>
            <para>We want to see a list of images which are shared with a given tenant. We issue
                    a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v1/shared-images/tenant1</literal>. We
                    will get back JSON data such as the following:</para>
            <screen>{'shared_images': [
 {'image_id': '71c675ab-d94f-49cd-a114-e12490b328d9',
  'can_share': false}
 ...]}</screen>
            <para>The <literal>image_id</literal> field identifies an image shared with the tenant named by
                    <emphasis>member_id</emphasis>. If the tenant is authorized to further share the image, the
                    <literal>can_share</literal> field is <literal>true</literal>.</para>
          </section>
          <section xml:id="add-a-member-to-an-image">
            <title>Add a Member to an Image</title>
            <para>We want to authorize a tenant to access a private image. We issue a <literal>PUT</literal>
                    request to
                    <literal>http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9/members/tenant1</literal>.
                    With no body, this will add the membership to the image, leaving existing
                    memberships unmodified and defaulting new memberships to have <literal>can_share</literal>
                    set to <literal>false</literal>. We may also optionally attach a body of the following form:</para>
            <screen>{'member':
 {'can_share': true}
}</screen>
            <para>If such a body is provided, both existing and new memberships will have
                    <literal>can_share</literal> set to the provided value (either <literal>true</literal> or <literal>false</literal>). This query
                    will return a 204 (<literal>No Content</literal>) status code.</para>
          </section>
          <section xml:id="remove-a-member-from-an-image">
            <title>Remove a Member from an Image</title>
            <para>We want to revoke a tenant’s right to access a private image. We issue a
                    <literal>DELETE</literal> request to <literal>http://glance.openstack.example.org/v1/images/1/members/tenant1</literal>.
                    This query will return a 204 (<literal>No Content</literal>) status code.</para>
          </section>
          <section xml:id="replace-a-membership-list-for-an-image">
            <title>Replace a Membership List for an Image</title>
            <para>The full membership list for a given image may be replaced. We issue a <literal>PUT</literal>
                    request to
                    <literal>http://glance.openstack.example.org/v1/images/71c675ab-d94f-49cd-a114-e12490b328d9/members</literal>
                    with a body of the following form:</para>
            <screen>{'memberships': [
 {'member_id': 'tenant1',
  'can_share': false}
 ...]}</screen>
            <para>All existing memberships which are not named in the replacement body are
                    removed, and those which are named have their <literal>can_share</literal> settings changed as
                    specified. (The <literal>can_share</literal> setting may be omitted, which will cause that
                    setting to remain unchanged in the existing memberships.) All new memberships
                    will be created, with <literal>can_share</literal> defaulting to <literal>false</literal> unless it is specified
                    otherwise.</para>
          </section>
        </section>
        <section xml:id="image-membership-changes-in-version-2-0">
          <title>Image Membership Changes in Version 2.0</title>
          <para>Version 2.0 of the Images API eliminates the <literal>can_share</literal> attribute of image
                membership. In the version 2.0 model, image sharing is not transitive.</para>
          <para>In version 2.0, image members have a <literal>status</literal> attribute that reflects
                how the image should be treated with respect to that image member’s image-list.</para>
          <itemizedlist>
            <listitem>
              <para>The <literal>status</literal> attribute may have one of three values: <literal>pending</literal>,
                        <literal>accepted</literal>, or <literal>rejected</literal>.</para>
            </listitem>
            <listitem>
              <para>By default, only those shared images with status <literal>accepted</literal> are included in
                        an image member’s image-list.</para>
            </listitem>
            <listitem>
              <para>Only an image member may change their membership status.</para>
            </listitem>
            <listitem>
              <para>Only an image owner may create members on an image. The status of a newly
                        created image member is <literal>pending</literal>. The image owner cannot change the
                        status of a member.</para>
            </listitem>
          </itemizedlist>
          <section xml:id="distinctions-from-version-1-x-api-calls">
            <title>Distinctions from Version 1.x API Calls</title>
            <itemizedlist>
              <listitem>
                <para>The response to a request to list the members of an image has changed.</para>
                <para>call: <literal>GET</literal> on <literal>/v2/images/{imageId}/members</literal></para>
                <para>response: see the JSON schema at <literal>/v2/schemas/members</literal></para>
              </listitem>
              <listitem>
                <para>The request body in the call to create an image member has changed.</para>
                <para>call: <literal>POST</literal> to <literal>/v2/images/{imageId}/members</literal></para>
                <para>request body:</para>
                <screen>{ "member": "&lt;MEMBER_ID&gt;" }</screen>
                <para>Where the <literal>{memberId}</literal> is the tenant ID of the image member.</para>
                <para>The member status of a newly created image member is <literal>pending</literal>.</para>
              </listitem>
            </itemizedlist>
          </section>
          <section xml:id="new-api-calls">
            <title>New API Calls</title>
            <itemizedlist>
              <listitem>
                <para>Change the status of an image member</para>
                <para>call: <literal>PUT</literal> on <literal>/v2/images/{imageId}/members/{memberId}</literal>.</para>
                <para>Request body:</para>
                <screen>{ "status": "&lt;STATUS_VALUE&gt;" }</screen>
                <para>Where &lt;STATUS_VALUE&gt; is <literal>pending</literal>, <literal>accepted</literal>, or <literal>rejected</literal>.
                            The <literal>{memberId}</literal> is the tenant ID of the image member.</para>
              </listitem>
            </itemizedlist>
          </section>
        </section>
        <section xml:id="images-v2-tasks-api">
          <title>Images v2 Tasks API</title>
          <para>Version 2 of the OpenStack Images API introduces a Task resource that is used
                to create and monitor long-running asynchronous image-related processes. See
                the <link xlink:href="https://docs.openstack.org/glance/pike/admin/tasks.html#tasks">Tasks</link>
                section of the Glance documentation for more information.</para>
          <para>The following Task calls are available:</para>
          <section xml:id="create-a-task">
            <title>Create a Task</title>
            <para>A user wants to initiate a Task. The user issues a <literal>POST</literal> request to
                    <literal>/v2/tasks</literal>. The request body is of Content-type <literal>application/json</literal> and
                    must contain the following fields:</para>
            <itemizedlist>
              <listitem>
                <para><literal>type</literal>: A string specified by the enumeration defined in the Task schema.</para>
              </listitem>
              <listitem>
                <para><literal>input</literal>: A JSON object. The content is defined by the cloud provider who
                            has exposed the endpoint being contacted.</para>
              </listitem>
            </itemizedlist>
            <para>The response is a Task entity as defined by the Task schema. It includes an
                    <literal>id</literal> field that can be used in a subsequent call to poll the Task for status
                    changes.</para>
            <para>A Task is created in <literal>pending</literal> status.</para>
          </section>
          <section xml:id="show-a-task">
            <title>Show a Task</title>
            <para>A user wants to see detailed information about a Task the user owns. The user
                    issues a <literal>GET</literal> request to <literal>/v2/tasks/{taskId}</literal>.</para>
            <para>The response is in <literal>application/json</literal> format. The exact structure is given
                    by the Task schema located at <literal>/v2/schemas/task</literal>.</para>
          </section>
          <section xml:id="list-tasks">
            <title>List Tasks</title>
            <para>A user wants to see what Tasks have been created in their project. The
                    user issues a <literal>GET</literal> request to <literal>/v2/tasks</literal>.</para>
            <para>The response is in <literal>application/json</literal> format. The exact structure is given
                    by the task schema located at <literal>/v2/schemas/tasks</literal>.</para>
            <note>
              <para>As indicated by the schema, the list of Tasks is provided in a
                    sparse format. To see more information about a particular Task in the list,
                    the user would use the show Task call described above.</para>
            </note>
          </section>
          <section xml:id="filtering-and-sorting-the-tasks-list">
            <title>Filtering and Sorting the Tasks List</title>
            <para>The <literal>GET /v2/tasks</literal> request takes query parameters that server to filter the
                    returned list of Tasks. The following list details these query parameters.</para>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>status={status}</literal>
                </para>
                <para>Filters the list to display only those tasks in the specified status. See
                      the Task schema or the <xref linkend="task-statuses"/> section of this
                      documentation for the legal values to use for <literal>{status}</literal>.</para>
                <para>For example, a request to <literal>GET /v2/tasks?status=pending</literal> would return only
                            those Tasks whose current status is <literal>pending</literal>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>type={type}</literal>
                </para>
                <para>Filters the list to display only those Tasks of the specified type. See the
                            enumeration defined in the Task schema for the legal values to use for
                            <literal>{type}</literal>.</para>
                <para>For example, a request to <literal>GET /v2/tasks?type=import</literal> would return only
                            import Tasks.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>sort_dir={direction}</literal>
                </para>
                <para>Sorts the list of tasks according to <literal>updated_at</literal> datetime. Legal values
                            are <literal>asc</literal> (ascending) and <literal>desc</literal> (descending). By default, the Task list
                            is sorted by <literal>created_at</literal> time in descending chronological order.</para>
              </listitem>
            </itemizedlist>
          </section>
        </section>
        <section>
          <title>API Message Localization</title>
          <para>Glance supports HTTP message localization. For example, an HTTP client can
                receive API messages in Chinese even if the locale language of the server is
                English.</para>
          <section>
            <title>How to use it</title>
            <para>To receive localized API messages, the HTTP client needs to specify the
                    <emphasis role="bold">Accept-Language</emphasis> header to indicate the language that will translate the
                    message. For more information about Accept-Language, refer to <link xlink:href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html"/></para>
            <para>A typical curl API request will be like below:</para>
            <screen>curl -i -X GET -H 'Accept-Language: zh' -H 'Content-Type: application/json'
http://glance.openstack.example.org/v2/images/aaa</screen>
            <para>Then the response will be like the following:</para>
            <screen>HTTP/1.1 404 Not Found
Content-Length: 234
Content-Type: text/html; charset=UTF-8
X-Openstack-Request-Id: req-54d403a0-064e-4544-8faf-4aeef086f45a
Date: Sat, 22 Feb 2014 06:26:26 GMT

&lt;html&gt;
&lt;head&gt;
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;404 Not Found&lt;/h1&gt;
&amp;#25214;&amp;#19981;&amp;#21040;&amp;#20219;&amp;#20309;&amp;#20855;&amp;#26377;&amp;#26631;&amp;#35782; aaa &amp;#30340;&amp;#26144;&amp;#20687;&lt;br /&gt;&lt;br /&gt;
&lt;/body&gt;
&lt;/html&gt;</screen>
            <note>
              <para>Make sure to have a language package under <literal>/usr/share/locale-langpack/</literal> on
                        the target Glance server.</para>
            </note>
          </section>
        </section>
      </section>
      <section xml:id="using-glance-s-client-tools">
        <title>Using Glance’s Client Tools</title>
        <para>The command-line tool and python library for Glance are both installed
            through the python-glanceclient project. Explore the following resources
            for more information:</para>
        <itemizedlist>
          <listitem>
            <para>
              <link xlink:href="http://docs.openstack.org/developer/python-glanceclient/">Official Docs</link>
            </para>
          </listitem>
          <listitem>
            <para>
              <link xlink:href="http://pypi.python.org/pypi/python-glanceclient">Pypi Page</link>
            </para>
          </listitem>
          <listitem>
            <para>
              <link xlink:href="http://github.com/openstack/python-glanceclient">GitHub Project</link>
            </para>
          </listitem>
        </itemizedlist>
      </section>
      <section xml:id="using-glance-s-metadata-definitions-catalog-public-apis">
        <title>Using Glance’s Metadata Definitions Catalog Public APIs</title>
        <para>A common API hosted by the Glance service for vendors, admins, services, and
            users to meaningfully define available key and value pair and tag metadata.
            The intent is to enable better metadata collaboration across artifacts,
            services, and projects for OpenStack users.</para>
        <para>This is about the definition of the available metadata that can be used on
            different types of resources (images, artifacts, volumes, flavors, aggregates,
            etc). A definition includes the properties type, its key, its description,
            and its constraints. This catalog will not store the values for specific
            instance properties.</para>
        <para>For example, a definition of a virtual CPU topology property for number of
            cores will include the key to use, a description, and value constraints like
            requiring it to be an integer. So, a user, potentially through Horizon, would
            be able to search this catalog to list the available properties they can add to
            a flavor or image. They will see the virtual CPU topology property in the list
            and know that it must be an integer. In the Horizon example, when the user adds
            the property, its key and value will be stored in the service that owns that
            resource (Nova for flavors and in Glance for images).</para>
        <para>Diagram: <link xlink:href="https://wiki.openstack.org/w/images/b/bb/Glance-Metadata-API.png"/></para>
        <para>Glance Metadata Definitions Catalog implementation started with API version v2.</para>
        <section>
          <title>Authentication</title>
          <para>Glance depends on Keystone and the OpenStack Identity API to handle
                authentication of clients. You must obtain an authentication token from
                Keystone send it along with all API requests to Glance through the
                <literal>X-Auth-Token</literal> header. Glance will communicate back to Keystone to verify
                the token validity and obtain your identity credentials.</para>
          <para>See <link xlink:href="https://docs.openstack.org/glance/pike/admin/authentication.html#authentication">Authentication With Keystone</link>
                for more information on integrating with Keystone.</para>
        </section>
        <section xml:id="using-v2-x">
          <title>Using v2.X</title>
          <para>For the purpose of examples, assume there is a Glance API server running
                at the URL <literal>http://glance.openstack.example.org</literal> on the default port 80.</para>
          <section xml:id="list-available-namespaces">
            <title>List Available Namespaces</title>
            <para>We want to see a list of available namespaces that the authenticated user
                    has access to. This includes namespaces owned by the user,
                    namespaces shared with the user and public namespaces.</para>
            <para>We issue a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v2/metadefs/namespaces</literal>
                    to retrieve this list of available namespaces.
                    The data is returned as a JSON-encoded mapping in the following format:</para>
            <screen>{
  "namespaces": [
      {
          "namespace": "MyNamespace",
          "display_name": "My User Friendly Namespace",
          "description": "My description",
          "visibility": "public",
          "protected": true,
          "owner": "The Test Owner",
          "self": "/v2/metadefs/namespaces/MyNamespace",
          "schema": "/v2/schemas/metadefs/namespace",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z",
          "resource_type_associations": [
              {
                  "name": "OS::Nova::Aggregate",
                  "created_at": "2014-08-28T17:13:06Z",
                  "updated_at": "2014-08-28T17:13:06Z"
              },
              {
                  "name": "OS::Nova::Flavor",
                  "prefix": "aggregate_instance_extra_specs:",
                  "created_at": "2014-08-28T17:13:06Z",
                  "updated_at": "2014-08-28T17:13:06Z"
              }
          ]
      }
  ],
  "first": "/v2/metadefs/namespaces?sort_key=created_at&amp;sort_dir=asc",
  "schema": "/v2/schemas/metadefs/namespaces"
}</screen>
            <note>
              <para>Listing namespaces will only show the summary of each namespace including
                        counts and resource type associations. Detailed responses including all its
                        objects definitions, property definitions will only be available on
                        each individual GET namespace request.</para>
            </note>
          </section>
          <section xml:id="filtering-namespaces-lists">
            <title>Filtering Namespaces Lists</title>
            <para><literal>GET /v2/metadefs/namespaces</literal> requests take query parameters that serve to
                    filter the returned list of namespaces. The following
                    list details these query parameters.</para>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>resource_types=RESOURCE_TYPES</literal>
                </para>
                <para>Filters namespaces having a <literal>resource_types</literal> within the list of
                            comma separated <literal>RESOURCE_TYPES</literal>.</para>
              </listitem>
            </itemizedlist>
            <para>GET resource also accepts additional query parameters:</para>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>sort_key=KEY</literal>
                </para>
                <para>Results will be ordered by the specified sort attribute <literal>KEY</literal>. Accepted
                            values include <literal>namespace</literal>, <literal>created_at</literal> (default) and <literal>updated_at</literal>.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>sort_dir=DIR</literal>
                </para>
                <para>Results will be sorted in the direction <literal>DIR</literal>. Accepted values are <literal>asc</literal>
                            for ascending or <literal>desc</literal> (default) for descending.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>marker=NAMESPACE</literal>
                </para>
                <para>A namespace identifier marker may be specified. When present only
                            namespaces which occur after the identifier <literal>NAMESPACE</literal> will be listed,
                            for example the namespaces which have a <literal>sort_key</literal> later than that of the marker
                            <literal>NAMESPACE</literal> in the <literal>sort_dir</literal> direction.</para>
              </listitem>
              <listitem>
                <para>
                  <literal>limit=LIMIT</literal>
                </para>
                <para>When present the maximum number of results returned will not exceed <literal>LIMIT</literal>.</para>
              </listitem>
            </itemizedlist>
            <note>
              <para>If the specified <literal>LIMIT</literal> exceeds the operator defined limit (<literal>api_limit_max</literal>)
                        then the number of results returned may be less than <literal>LIMIT</literal>.</para>
            </note>
            <itemizedlist>
              <listitem>
                <para>
                  <literal>visibility=PUBLIC</literal>
                </para>
                <para>An admin user may use the <literal>visibility</literal> parameter to control which results are
                            returned (<literal>PRIVATE</literal> or <literal>PUBLIC</literal>).</para>
              </listitem>
            </itemizedlist>
          </section>
          <section xml:id="retrieve-namespace">
            <title>Retrieve Namespace</title>
            <para>We want to see a more detailed information about a namespace that the
                    authenticated user has access to. The detail includes the properties, objects,
                    and resource type associations.</para>
            <para>We issue a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}</literal>
                    to retrieve the namespace details.
                    The data is returned as a JSON-encoded mapping in the following format:</para>
            <screen>{
  "namespace": "MyNamespace",
  "display_name": "My User Friendly Namespace",
  "description": "My description",
  "visibility": "public",
  "protected": true,
  "owner": "The Test Owner",
  "schema": "/v2/schemas/metadefs/namespace",
  "resource_type_associations": [
      {
          "name": "OS::Glance::Image",
          "prefix": "hw_",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z"
      },
      {
          "name": "OS::Cinder::Volume",
          "prefix": "hw_",
          "properties_target": "image",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z"
      },
      {
          "name": "OS::Nova::Flavor",
          "prefix": "filter1:",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z"
      }
  ],
  "properties": {
      "nsprop1": {
          "title": "My namespace property1",
          "description": "More info here",
          "type": "boolean",
          "default": true
      },
      "nsprop2": {
          "title": "My namespace property2",
          "description": "More info here",
          "type": "string",
          "default": "value1"
      }
  },
  "objects": [
      {
          "name": "object1",
          "description": "my-description",
          "self": "/v2/metadefs/namespaces/MyNamespace/objects/object1",
          "schema": "/v2/schemas/metadefs/object",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z",
          "required": [],
          "properties": {
              "prop1": {
                  "title": "My object1 property1",
                  "description": "More info here",
                  "type": "array",
                  "items": {
                      "type": "string"
                  }
              }
          }
      },
      {
          "name": "object2",
          "description": "my-description",
          "self": "/v2/metadefs/namespaces/MyNamespace/objects/object2",
          "schema": "/v2/schemas/metadefs/object",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z",
          "properties": {
              "prop1": {
                  "title": "My object2 property1",
                  "description": "More info here",
                  "type": "integer",
                  "default": 20
              }
          }
      }
  ]
}</screen>
          </section>
          <section xml:id="retrieve-available-resource-types">
            <title>Retrieve available Resource Types</title>
            <para>We want to see the list of all resource types that are available in Glance.</para>
            <para>We issue a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v2/metadefs/resource_types</literal>
                    to retrieve all resource types.</para>
            <para>The data is returned as a JSON-encoded mapping in the following format:</para>
            <screen>{
  "resource_types": [
      {
          "created_at": "2014-08-28T17:13:04Z",
          "name": "OS::Glance::Image",
          "updated_at": "2014-08-28T17:13:04Z"
      },
      {
          "created_at": "2014-08-28T17:13:04Z",
          "name": "OS::Cinder::Volume",
          "updated_at": "2014-08-28T17:13:04Z"
      },
      {
          "created_at": "2014-08-28T17:13:04Z",
          "name": "OS::Nova::Flavor",
          "updated_at": "2014-08-28T17:13:04Z"
      },
      {
          "created_at": "2014-08-28T17:13:04Z",
          "name": "OS::Nova::Aggregate",
          "updated_at": "2014-08-28T17:13:04Z"
      },
      {
          "created_at": "2014-08-28T17:13:04Z",
          "name": "OS::Nova::Server",
          "updated_at": "2014-08-28T17:13:04Z"
      }
  ]
}</screen>
          </section>
          <section xml:id="retrieve-resource-types-associated-with-a-namespace">
            <title>Retrieve Resource Types associated with a Namespace</title>
            <para>We want to see the list of resource types that are associated for a specific
                    namespace.</para>
            <para>We issue a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/resource_types</literal>
                    to retrieve resource types.</para>
            <para>The data is returned as a JSON-encoded mapping in the following format:</para>
            <screen>{
  "resource_type_associations" : [
      {
         "name" : "OS::Glance::Image",
         "prefix" : "hw_",
         "created_at": "2014-08-28T17:13:04Z",
         "updated_at": "2014-08-28T17:13:04Z"
      },
      {
         "name" :"OS::Cinder::Volume",
         "prefix" : "hw_",
         "properties_target" : "image",
         "created_at": "2014-08-28T17:13:04Z",
         "updated_at": "2014-08-28T17:13:04Z"
      },
      {
         "name" : "OS::Nova::Flavor",
         "prefix" : "hw:",
         "created_at": "2014-08-28T17:13:04Z",
         "updated_at": "2014-08-28T17:13:04Z"
      }
  ]
}</screen>
          </section>
          <section xml:id="add-namespace">
            <title>Add Namespace</title>
            <para>We want to create a new namespace that can contain the properties, objects,
                    etc.</para>
            <para>We issue a <literal>POST</literal> request to add an namespace to Glance:</para>
            <screen>POST http://glance.openstack.example.org/v2/metadefs/namespaces/</screen>
            <para>The input data is an JSON-encoded mapping in the following format:</para>
            <screen>{
  "namespace": "MyNamespace",
  "display_name": "My User Friendly Namespace",
  "description": "My description",
  "visibility": "public",
  "protected": true
}</screen>
            <note>
              <para>Optionally properties, objects and resource type associations could be
                        added in the same input. See GET Namespace output above (input will be
                        similar).</para>
            </note>
          </section>
          <section xml:id="update-namespace">
            <title>Update Namespace</title>
            <para>We want to update an existing namespace.</para>
            <para>We issue a <literal>PUT</literal> request to update an namespace to Glance:</para>
            <screen>PUT http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}</screen>
            <para>The input data is similar to Add Namespace.</para>
          </section>
          <section xml:id="delete-namespace">
            <title>Delete Namespace</title>
            <para>We want to delete an existing namespace including all its objects,
                    properties etc.</para>
            <para>We issue a <literal>DELETE</literal> request to delete an namespace to Glance:</para>
            <screen>DELETE http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}</screen>
          </section>
          <section xml:id="associate-resource-type-with-namespace">
            <title>Associate Resource Type with Namespace</title>
            <para>We want to associate a resource type with an existing namespace.</para>
            <para>We issue a <literal>POST</literal> request to associate resource type to Glance:</para>
            <screen>POST http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/resource_types</screen>
            <para>The input data is an JSON-encoded mapping in the following format:</para>
            <screen>{
        "name" :"OS::Cinder::Volume",
        "prefix" : "hw_",
        "properties_target" : "image",
        "created_at": "2014-08-28T17:13:04Z",
        "updated_at": "2014-08-28T17:13:04Z"
}</screen>
          </section>
          <section xml:id="remove-resource-type-associated-with-a-namespace">
            <title>Remove Resource Type associated with a Namespace</title>
            <para>We want to de-associate namespace from a resource type.</para>
            <para>We issue a <literal>DELETE</literal> request to de-associate namespace resource type to
                    Glance:</para>
            <screen>DELETE http://glance.openstack.example.org/v2//metadefs/namespaces/{namespace}/resource_types/{resource_type}</screen>
          </section>
          <section xml:id="list-objects-in-namespace">
            <title>List Objects in Namespace</title>
            <para>We want to see the list of meta definition objects in a specific namespace.</para>
            <para>We issue a <literal>GET</literal> request to <literal>http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/objects</literal>
                    to retrieve objects.</para>
            <para>The data is returned as a JSON-encoded mapping in the following format:</para>
            <screen>{
      "objects": [
      {
          "name": "object1",
          "description": "my-description",
          "self": "/v2/metadefs/namespaces/MyNamespace/objects/object1",
          "schema": "/v2/schemas/metadefs/object",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z",
          "required": [],
          "properties": {
              "prop1": {
                  "title": "My object1 property1",
                  "description": "More info here",
                  "type": "array",
                  "items": {
                      "type": "string"
                  }
              }
          }
      },
      {
          "name": "object2",
          "description": "my-description",
          "self": "/v2/metadefs/namespaces/MyNamespace/objects/object2",
          "schema": "/v2/schemas/metadefs/object",
          "created_at": "2014-08-28T17:13:06Z",
          "updated_at": "2014-08-28T17:13:06Z",
          "properties": {
              "prop1": {
                  "title": "My object2 property1",
                  "description": "More info here",
                  "type": "integer",
                  "default": 20
              }
          }
      }
  ],
  "schema": "/v2/schemas/metadefs/objects"
}</screen>
          </section>
          <section xml:id="add-object-in-a-specific-namespace">
            <title>Add object in a specific namespace</title>
            <para>We want to create a new object which can group the properties.</para>
            <para>We issue a <literal>POST</literal> request to add object to a namespace in Glance:</para>
            <screen>POST http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/objects</screen>
            <para>The input data is an JSON-encoded mapping in the following format:</para>
            <screen>{
  "name": "StorageQOS",
  "description": "Our available storage QOS.",
  "required": [
      "minIOPS"
  ],
  "properties": {
      "minIOPS": {
          "type": "integer",
          "description": "The minimum IOPs required",
          "default": 100,
          "minimum": 100,
          "maximum": 30000369
      },
      "burstIOPS": {
          "type": "integer",
          "description": "The expected burst IOPs",
          "default": 1000,
          "minimum": 100,
          "maximum": 30000377
      }
  }
}</screen>
          </section>
          <section xml:id="update-object-in-a-specific-namespace">
            <title>Update Object in a specific namespace</title>
            <para>We want to update an existing object.</para>
            <para>We issue a <literal>PUT</literal> request to update an object to Glance:</para>
            <screen>PUT http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/objects/{object_name}</screen>
            <para>The input data is similar to Add Object.</para>
          </section>
          <section xml:id="delete-object-in-a-specific-namespace">
            <title>Delete Object in a specific namespace</title>
            <para>We want to delete an existing object.</para>
            <para>We issue a <literal>DELETE</literal> request to delete object in a namespace to Glance:</para>
            <screen>DELETE http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/objects/{object_name}</screen>
          </section>
          <section xml:id="add-property-definition-in-a-specific-namespace">
            <title>Add property definition in a specific namespace</title>
            <para>We want to create a new property definition in a namespace.</para>
            <para>We issue a <literal>POST</literal> request to add property definition to a namespace in
                    Glance:</para>
            <screen>POST http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/properties</screen>
            <para>The input data is an JSON-encoded mapping in the following format:</para>
            <screen>{
  "name": "hypervisor_type",
  "title" : "Hypervisor",
  "type": "array",
  "description": "The type of hypervisor required",
  "items": {
      "type": "string",
      "enum": [
          "hyperv",
          "qemu",
          "kvm"
      ]
  }
}</screen>
          </section>
          <section xml:id="update-property-definition-in-a-specific-namespace">
            <title>Update property definition in a specific namespace</title>
            <para>We want to update an existing object.</para>
            <para>We issue a <literal>PUT</literal> request to update an property definition in a namespace to
                    Glance:</para>
            <screen>PUT http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/properties/{property_name}</screen>
            <para>The input data is similar to Add property definition.</para>
          </section>
          <section xml:id="delete-property-definition-in-a-specific-namespace">
            <title>Delete property definition in a specific namespace</title>
            <para>We want to delete an existing object.</para>
            <para>We issue a <literal>DELETE</literal> request to delete property definition in a namespace to
                    Glance:</para>
            <screen>DELETE http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}/properties/{property_name}</screen>
          </section>
        </section>
        <section>
          <title>API Message Localization</title>
          <para>Glance supports HTTP message localization. For example, an HTTP client can
                receive API messages in Chinese even if the locale language of the server is
                English.</para>
          <section>
            <title>How to use it</title>
            <para>To receive localized API messages, the HTTP client needs to specify the
                    <emphasis role="bold">Accept-Language</emphasis> header to indicate the language to use to translate the
                    message. For more info about Accept-Language, refer <link xlink:href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html"/></para>
            <para>A typical curl API request will be like below:</para>
            <screen>curl -i -X GET -H 'Accept-Language: zh' -H 'Content-Type: application/json'
http://glance.openstack.example.org/v2/metadefs/namespaces/{namespace}</screen>
            <para>Then the response will be like the following:</para>
            <screen>HTTP/1.1 404 Not Found
Content-Length: 234
Content-Type: text/html; charset=UTF-8
X-Openstack-Request-Id: req-54d403a0-064e-4544-8faf-4aeef086f45a
Date: Sat, 22 Feb 2014 06:26:26 GMT

&lt;html&gt;
&lt;head&gt;
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;404 Not Found&lt;/h1&gt;
&amp;#25214;&amp;#19981;&amp;#21040;&amp;#20219;&amp;#20309;&amp;#20855;&amp;#26377;&amp;#26631;&amp;#35782; aaa &amp;#30340;&amp;#26144;&amp;#20687;&lt;br /&gt;&lt;br /&gt;
&lt;/body&gt;
&lt;/html&gt;</screen>
            <note>
              <para>Ensure there is the language package under <literal>/usr/share/locale-langpack/</literal> on
                        the target Glance server.</para>
            </note>
          </section>
        </section>
      </section>
      <section xml:id="image-signature-verification">
        <title>Image Signature Verification</title>
        <para>Glance has the ability to perform image validation using a digital
            signature and asymmetric cryptography. To trigger this, you must define
            specific image properties (described below), and have stored a
            certificate signed with your private key in a local Barbican installation.</para>
        <para>When the image properties exist on an image, Glance will validate
            the uploaded image data against these properties before storing it.
            If validation is unsuccessful, the upload will fail and the image will
            be deleted.</para>
        <para>Additionally, the image properties may be used by other services (for
            example, Nova) to perform data verification when the image is downloaded
            from Glance.</para>
        <section>
          <title>Requirements</title>
          <para>Barbican key manager - See <link xlink:href="http://docs.openstack.org/developer/barbican/setup/devstack.html"/>.</para>
        </section>
        <section>
          <title>Configuration</title>
          <para>The <literal>etc/glance-api.conf</literal> can be modified to change keystone endpoint of
                barbican. By default barbican will try to connect to keystone at
                <link xlink:href="http://localhost:5000/v3"/> but if keystone is on another host then this
                should be changed.</para>
          <para>In <literal>glance-api.conf</literal> find the following lines:</para>
          <screen>[barbican]
auth_endpoint = http://localhost:5000/v3</screen>
          <para>Then replace <link xlink:href="http://localhost:5000/v3"/> with the URL of keystone, also adding <literal>/v3</literal>
                to the end of it. For example, ‘<link xlink:href="https://192.168.245.9:5000/v3"/>’.</para>
          <para>Another option in <literal>etc/glance-api.conf</literal> which can be configured is which key manager
                to use. By default Glance will use the default key manager defined by the Castellan
                key manager interface, which is currently the Barbican key manager.</para>
          <para>In <literal>glance-api.conf</literal> find the following lines:</para>
          <screen>[key_manager]
api_class = castellan.key_manager.barbican_key_manager.BarbicanKeyManager</screen>
          <para>Then replace the value with the desired key manager class.</para>
          <note>
            <para>If those lines do not exist then simply add them to the end of the file.</para>
          </note>
        </section>
        <section xml:id="using-the-signature-verification">
          <title>Using the Signature Verification</title>
          <para>An image will need a few properties for signature verification to be enabled,
                these are:</para>
          <screen>img_signature
img_signature_hash_method
img_signature_key_type
img_signature_certificate_uuid</screen>
          <section xml:id="property-img-signature">
            <title>Property img_signature</title>
            <para>This is the signature of your image.</para>
            <note>
              <para>The max character limit is 255.</para>
            </note>
          </section>
          <section xml:id="property-img-signature-hash-method">
            <title>Property img_signature_hash_method</title>
            <para>Hash methods is the method you hash with.</para>
            <para>Current ones you can use are:</para>
            <itemizedlist>
              <listitem>
                <para>SHA-224</para>
              </listitem>
              <listitem>
                <para>SHA-256</para>
              </listitem>
              <listitem>
                <para>SHA-384</para>
              </listitem>
              <listitem>
                <para>SHA-512</para>
              </listitem>
            </itemizedlist>
          </section>
          <section xml:id="property-img-signature-key-type">
            <title>Property img_signature_key_type</title>
            <para>This is the key_types you can use for your image.</para>
            <para>Current ones you can use are:</para>
            <itemizedlist>
              <listitem>
                <para>RSA-PSS</para>
              </listitem>
              <listitem>
                <para>DSA</para>
              </listitem>
              <listitem>
                <para>ECC-CURVES</para>
              </listitem>
            </itemizedlist>
            <itemizedlist>
              <listitem>
                <para>SECT571K1</para>
              </listitem>
              <listitem>
                <para>SECT409K1</para>
              </listitem>
              <listitem>
                <para>SECT571R1</para>
              </listitem>
              <listitem>
                <para>SECT409R1</para>
              </listitem>
              <listitem>
                <para>SECP521R1</para>
              </listitem>
              <listitem>
                <para>SECP384R1</para>
              </listitem>
            </itemizedlist>
            <note>
              <para>ECC curves - Only keysizes above 384 are included.
                        Not all ECC curves may be supported by the back end.</para>
            </note>
          </section>
          <section xml:id="property-img-signature-certificate-uuid">
            <title>Property img_signature_certificate_uuid</title>
            <para>This is the UUID of the certificate that you upload to Barbican.</para>
            <para>Therefore the type passed to glance is:</para>
            <itemizedlist>
              <listitem>
                <para>UUID</para>
              </listitem>
            </itemizedlist>
            <note>
              <para>The supported certificate types are:</para>
              <itemizedlist>
                <listitem>
                  <para>X_509</para>
                </listitem>
              </itemizedlist>
            </note>
          </section>
        </section>
        <section xml:id="example-usage">
          <title>Example Usage</title>
          <para>Follow these instructions to create your keys:</para>
          <screen>$ openssl genrsa -out private_key.pem 1024
Generating RSA private key, 1024 bit long modulus
...............................................++++++
..++++++
e is 65537 (0x10001)

$ openssl rsa -pubout -in private_key.pem -out public_key.pem
writing RSA key

$ openssl req -new -key private_key.pem -out cert_request.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.

$ openssl x509 -req -days 14 -in cert_request.csr -signkey private_key.pem -out new_cert.crt
Signature ok
subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd
Getting Private key</screen>
          <para>Upload your certificate. This only has to be done once as you can use
                the same <literal>Secret href</literal> for many images until it expires:</para>
          <screen>$ openstack secret store --name test --algorithm RSA --expiration 2016-06-29 --secret-type certificate --payload-content-type "application/octet-stream" --payload-content-encoding base64 --payload "$(base64 new_cert.crt)"
+---------------+-----------------------------------------------------------------------+
| Field         | Value                                                                 |
+---------------+-----------------------------------------------------------------------+
| Secret href   | http://127.0.0.1:9311/v1/secrets/cd7cc675-e573-419c-8fff-33a72734a243 |

$ cert_uuid=cd7cc675-e573-419c-8fff-33a72734a243</screen>
          <para>Get an image and create the signature:</para>
          <screen>$ echo This is a dodgy image &gt; myimage

$ openssl dgst -sha256 -sign private_key.pem -sigopt rsa_padding_mode:pss -out myimage.signature myimage

$ base64 -w 0 myimage.signature &gt; myimage.signature.b64

$ image_signature=$(cat myimage.signature.b64)</screen>
          <note>
            <para>Using Glance v1 requires <literal>-w 0</literal> due to not supporting multiline image properties.
                    Glance v2 does support multiline image properties and does not require <literal>-w 0</literal> but may still be used.</para>
          </note>
          <para>Create the image:</para>
          <screen>$ glance image-create --name mySignedImage --container-format bare --disk-format qcow2 --property img_signature="$image_signature" --property img_signature_certificate_uuid="$cert_uuid" --property img_signature_hash_method='SHA-256' --property img_signature_key_type='RSA-PSS' &lt; myimage</screen>
          <note>
            <para>Creating the image can fail if validation does not succeed.
                    This will cause the image to be deleted.</para>
          </note>
        </section>
        <section xml:id="other-links">
          <title>Other Links</title>
          <itemizedlist>
            <listitem>
              <para>
                <link xlink:href="https://etherpad.openstack.org/p/mitaka-glance-image-signing-instructions"/>
              </para>
            </listitem>
            <listitem>
              <para>
                <link xlink:href="http://docs.openstack.org/ops-guide/ops_user_facing_operations.html"/>
              </para>
            </listitem>
          </itemizedlist>
        </section>
      </section>
    </chapter>
