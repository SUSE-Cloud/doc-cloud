<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Zone Placement Policy V1.0</title>
  <para>This policy is designed to make sure the nodes in a cluster are distributed
            across multiple availability zones according to a specified scheme.</para>
  <section>
    <title>Applicable Profiles</title>
    <para>The policy is designed to handle Nova server clusters only, i.e. clusters with
                a profile of type <literal>os.nova.server-1.0</literal> for example.</para>
  </section>
  <section>
    <title>Actions Handled</title>
    <para>The policy is capable of handling the following actions:</para>
    <itemizedlist>
      <listitem>
        <para><literal>CLUSTER_SCALE_IN</literal>: an action that carries an optional integer value named
                        <literal>count</literal> in its <literal>inputs</literal>.</para>
      </listitem>
      <listitem>
        <para><literal>CLUSTER_SCALE_OUT</literal>: an action that carries an optional integer value
                        named <literal>count</literal> in its <literal>inputs</literal>.</para>
      </listitem>
      <listitem>
        <para><literal>CLUSTER_RESIZE</literal>: an action that accepts a map as its input parameters in
                        its <literal>inputs</literal> property, such as “<literal>adjustment_type</literal>”, “<literal>number</literal>” etc.</para>
      </listitem>
      <listitem>
        <para><literal>NODE_CREATE</literal>: an action originated directly from a RPC request. Such an
                        action will have a node object associated with it, which becomes the one to
                        be handled by this policy.</para>
      </listitem>
    </itemizedlist>
    <para>The policy will be checked <emphasis role="bold">BEFORE</emphasis> any of the above mentioned actions is
                executed. Because the same policy implementation is used for covering both the
                cases of scaling out a cluster and the cases of scaling in, the zone placement
                policy need to parse the inputs in different scenarios.</para>
    <para>The placement policy can be used independently, with and without other polices
                attached to the same cluster. So the policy needs to understand whether there
                are policy decisions from other policies (such as a
                ).</para>
    <para>When the policy is checked, it will first attempt to get the proper <literal>count</literal>
                input value, which may be an outcome from other policies or the inputs for
                the action. For more details, check the scenarios described in following
                sections.</para>
  </section>
  <section>
    <title>Scenarios</title>
    <section>
      <title>S1: <literal>CLUSTER_SCALE_IN</literal></title>
      <para>The placement policy first checks if there are policy decisions from other
                    policies by looking into the <literal>deletion</literal> field of the action’s <literal>data</literal>
                    property. If there is such a field, the policy attempts to extract the
                    <literal>count</literal> value from the <literal>deletion</literal> field. If the <literal>count</literal> value is not
                    found, 1 is assumed to be the default.</para>
      <para>If, however, the policy fails to find the <literal>deletion</literal> field, it tries to find
                    if there is a <literal>count</literal> field in the action’s <literal>inputs</literal> property. If the
                    answer is true, the policy will use it, or else it will fall back to assume 1
                    as the default count.</para>
      <para>After the policy has find out the <literal>count</literal> value (i.e. number of nodes to be
                    deleted), it validates the list of availability zone names provided to the
                    policy. If for some reason, none of the provided names passed the validation,
                    the policy check fails with the following data recorded in the action’s
                    <literal>data</literal> property:</para>
      <screen>{
  "status": "ERROR",
  "reason": "No availability zone found available.",
}</screen>
      <para>With the list of availability zones known to be good and the map of node
                    distribution specified in the policy spec, senlin engine continues to
                    calculate a distribution plan that best matches the desired distribution.
                    If there are nodes that cannot be fit into the distribution plan, the policy
                    check fails with an error recorded in the action’s <literal>data</literal>, as shown below:</para>
      <screen>{
  "status": "ERROR",
  "reason": "There is no feasible plan to handle all nodes."
}</screen>
      <para>If there is a feasible plan to remove nodes from each availability zone, the
                    policy saves the plan into the <literal>data</literal> property of the action as exemplified
                    below:</para>
      <screen>{
  "status": "OK",
  "deletion": {
    "count": 3,
    "zones": {
      "nova-1": 2,
      "nova-2": 1
    }
  }
}</screen>
      <para>This means in total, 3 nodes should be removed from the cluster. Among them,
                    2 nodes should be selected from availability zone “<literal>nova-1</literal>” and the rest
                    one should be selected from availability zone “<literal>nova-2</literal>”.</para>
      <para><emphasis role="bold">NOTE</emphasis>: When there is a  attached to the
                    same cluster. That deletion policy will be evaluated after the zone placement
                    policy and it is expected to rebase its candidate selection on the zone
                    distribution enforced here. For example, if the deletion policy is tasked to
                    select the oldest nodes for deletion, it will adapt its behavior to select
                    the oldest nodes from each availability zone. The number of nodes to be chosen
                    from each availability zone would be based on the output from this placement
                    policy.</para>
    </section>
    <section>
      <title>S2: <literal>CLUSTER_SCALE_OUT</literal></title>
      <para>The placement policy first checks if there are policy decisions from other
                    policies by looking into the <literal>creation</literal> field of the action’s <literal>data</literal>
                    property. If there is such a field, the policy attempts to extract the
                    <literal>count</literal> value from the <literal>creation</literal> field. If the <literal>count</literal> value is not
                    found, 1 is assumed to be the default.</para>
      <para>If, however, the policy fails to find the <literal>creation</literal> field, it tries to find
                    if there is a <literal>count</literal> field in the action’s <literal>inputs</literal> property. If the
                    answer is true, the policy will use it, or else it will fall back to assume 1
                    as the default node count.</para>
      <para>After the policy has find out the <literal>count</literal> value (i.e. number of nodes to be
                    created), it validates the list of availability zone names provided to the
                    policy and extracts the current distribution of nodes among those availability
                    zones.</para>
      <para>If for some reason, none of the provided names passed the validation,
                    the policy check fails with the following data recorded in the action’s
                    <literal>data</literal> property:</para>
      <screen>{
  "status": "ERROR",
  "reason": "No availability zone found available.",
}</screen>
      <para>The logic of generating a distribution plan is almost identical to what have
                    been described in scenario <emphasis>S1</emphasis>, except for the output format. When there is
                    a feasible plan to accommodate all nodes, the plan is saved into the <literal>data</literal>
                    property of the action as shown in the following example:</para>
      <screen>{
  "status": "OK",
  "creation": {
    "count": 3,
    "zones": {
      "nova-1": 1,
      "nova-2": 2
    }
  }
}</screen>
      <para>This means in total, 3 nodes should be created into the cluster. Among them,
                    2 nodes should be created at availability zone “<literal>nova-1</literal>” and the left one
                    should be created at availability zone “<literal>nova-2</literal>”.</para>
    </section>
    <section>
      <title>S3: <literal>CLUSTER_RESIZE</literal></title>
      <para>The placement policy first checks if there are policy decisions from other
                    policies by looking into the <literal>creation</literal> field of the action’s <literal>data</literal>
                    property. If there is such a field, the policy extracts the <literal>count</literal> value
                    from the <literal>creation</literal> field. If the <literal>creation</literal> field is not found, the policy
                    tries to find if there is a <literal>deletion</literal> field in the action’s <literal>data</literal>
                    property. If there is such a field, the policy extracts the <literal>count</literal> value
                    from the <literal>creation</literal> field. If neither <literal>creation</literal> nor <literal>deletion</literal> is found
                    in the action’s <literal>data</literal> property, the policy proceeds to parse the raw inputs
                    of the action.</para>
      <para>The output from the parser may indicate an invalid combination of input
                    values. If that is the case, the policy check fails with the action’s
                    <literal>data</literal> set to something like the following example:</para>
      <screen>{
  "status": "ERROR",
  "reason": &lt;error message from the parser.&gt;
}</screen>
      <para>If the parser successfully parsed the action’s raw inputs, the policy tries
                    again to find if there is either <literal>creation</literal> or <literal>deletion</literal> field in the
                    action’s <literal>data</literal> property. It will use the <literal>count</literal> value from the field
                    found as the number of nodes to be handled.</para>
      <para>When the placement policy finds out the number of nodes to create (or delete),
                    it proceeds to calculate a distribution plan. If the action is about growing
                    the size of the cluster, the logic and the output format are the same as that
                    have been outlined in scenario <emphasis>S2</emphasis>. Otherwise, the logic and the output
                    format are identical to that have been described in scenario <emphasis>S1</emphasis>.</para>
    </section>
    <section>
      <title>S4: <literal>NODE_CREATE</literal></title>
      <para>When handling a <literal>NODE_CREATE</literal> action, the zone placement policy needs to
                    process the single node associated with the action, i.e. the node to be
                    created. If, however, the node is referencing a profile whose spec contains
                    a <literal>availability_zone</literal> property, it means the requesting user has a preferred
                    availability zone for the new node. In this case, the placement policy will
                    return directly without choosing availability zone for the node.</para>
      <para>If the profile spec doesn’t have <literal>availability_zone</literal> specified, the
                    placement policy will proceed to do an evaluation of the current zone
                    distribution followed by a calculation of distribution plan so that the new
                    node will be deployed in a proper availability zone. These logics and the
                    output format are identical to that in scenario <emphasis>S2</emphasis>.</para>
    </section>
  </section>
</section>
