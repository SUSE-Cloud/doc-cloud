<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Enable Object Storage meters for Ubuntu</title>
  <para>Telemetry uses a combination of polling and notifications to collect
            Object Storage meters.</para>
  <note>
    <para>Your environment must include the Object Storage service.</para>
  </note>
  <section>
    <title>Prerequisites</title>
    <para>The Telemetry service requires access to the Object Storage service
                using the <literal>ResellerAdmin</literal> role. Perform these steps on the controller
                node.</para>
    <procedure>
      <step>
        <para>Source the <literal>admin</literal> credentials to gain access to admin-only
                        CLI commands.</para>
        <screen language="console">$ . admin-openrc</screen>
      </step>
      <step>
        <para>Create the <literal>ResellerAdmin</literal> role:</para>
        <screen language="console">$ openstack role create ResellerAdmin
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | None                             |
| id        | 462fa46c13fd4798a95a3bfbe27b5e54 |
| name      | ResellerAdmin                    |
+-----------+----------------------------------+</screen>
      </step>
      <step>
        <para>Add the <literal>ResellerAdmin</literal> role to the <literal>ceilometer</literal> user:</para>
        <screen language="console">$ openstack role add --project service --user ceilometer ResellerAdmin</screen>
        <note>
          <para>This command provides no output.</para>
        </note>
      </step>
    </procedure>
  </section>
  <section>
    <title>Install components</title>
    <itemizedlist>
      <listitem>
        <para>Install the packages:</para>
        <screen language="console"># apt-get install python-ceilometermiddleware</screen>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Configure Object Storage to use Telemetry</title>
    <para>Perform these steps on the controller and any other nodes that
                run the Object Storage proxy service.</para>
    <itemizedlist>
      <listitem>
        <para>Edit the <literal>/etc/swift/proxy-server.conf</literal> file
                        and complete the following actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[filter:keystoneauth]</literal> section, add the
                                <literal>ResellerAdmin</literal> role:</para>
            <screen language="ini">[filter:keystoneauth]
...
operator_roles = admin, user, ResellerAdmin</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[pipeline:main]</literal> section, add <literal>ceilometer</literal>:</para>
            <screen language="ini"><?dbsuse-fo font-size="8pt"?>[pipeline:main]
pipeline = catch_errors gatekeeper healthcheck proxy-logging cache container_sync bulk ratelimit authtoken keystoneauth container-quotas account-quotas slo dlo versioned_writes proxy-logging ceilometer proxy-server</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[filter:ceilometer]</literal> section, configure notifications:</para>
            <screen language="ini">[filter:ceilometer]
paste.filter_factory = ceilometermiddleware.swift:filter_factory
...
control_exchange = swift
url = rabbit://openstack:RABBIT_PASS@controller:5672/
driver = messagingv2
topic = notifications
log_level = WARN</screen>
            <para>Replace <literal>RABBIT_PASS</literal> with the password you chose for the
                                <literal>openstack</literal> account in <literal>RabbitMQ</literal>.</para>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Finalize installation</title>
    <itemizedlist>
      <listitem>
        <para>Restart the Object Storage proxy service:</para>
        <screen language="console"># service swift-proxy restart</screen>
      </listitem>
    </itemizedlist>
  </section>
</section>
