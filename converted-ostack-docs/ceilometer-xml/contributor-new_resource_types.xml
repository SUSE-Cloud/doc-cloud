<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Ceilometer + Gnocchi Integration</title>
  <warning>
    <para>Remember that custom modification may result in conflicts with upstream upgrades.
                If not intended to be merged with upstream, it’s advisable to directly create
                resource-types via Gnocchi API.</para>
  </warning>
  <section>
    <title>Managing Resource Types</title>
    <para>Resource types in Gnocchi are managed by Ceilometer. The following describes how to add/remove
                or update Gnocchi resource types to support new Ceilometer data.</para>
    <para>The modification or creation of Gnocchi resource type definitions are managed
                 of <literal>ceilometer/gnocchi_client.py</literal>.</para>
    <para>The following operations are supported:</para>
    <procedure>
      <step>
        <para>Adding a new attribute to a resource type. The following adds <literal>flavor_name</literal> attribute
                        to an existing <literal>instance</literal> resource:</para>
      </step>
    </procedure>
    <screen>{"desc": "add flavor_name to instance",
 "type": "update_attribute_type",
 "resource_type": "instance",
 "data": [{
     "op": "add",
     "path": "/attributes/flavor_name",
     "value": {"type": "string", "min_length": 0, "max_length": 255,
               "required": True, "options": {'fill': ''}}
 }]}</screen>
    <procedure>
      <step>
        <para>Remove an existing attribute from a resource type. The following removes <literal>server_group</literal>
                        attribute from <literal>instance</literal> resource:</para>
      </step>
    </procedure>
    <screen>{"desc": "remove server_group to instance",
 "type": "update_attribute_type",
 "resource_type": "instance",
 "data": [{
     "op": "remove",
     "path": "/attributes/server_group"
 }]}</screen>
    <procedure>
      <step>
        <para>Creating a new resource type. The following creates a new resource type named
                        <literal>nova_compute</literal> with a required attribute <literal>host_name</literal>:</para>
      </step>
    </procedure>
    <screen>{"desc": "add nova_compute resource type",
 "type": "create_resource_type",
 "resource_type": "nova_compute",
 "data": [{
     "attributes": {"host_name": {"type": "string", "min_length": 0,
                    "max_length": 255, "required": True}}
 }]}</screen>
    <note>
      <para>Do not modify the existing change steps when making changes. Each modification
                    requires a new step to be added and for <literal>ceilometer-upgrade –skip-metering-database</literal>
                    to be run to apply the change to Gnocchi.</para>
    </note>
    <para>With accomplishing sections above, don’t forget to add a new resource type or attributes of
                a resource type into :the file:<literal>ceilometer/dispatcher/data/gnocchi_resources.yaml</literal>.</para>
  </section>
</section>
