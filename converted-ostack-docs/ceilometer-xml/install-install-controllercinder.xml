<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Enable Block Storage meters for Ubuntu</title>
  <para>Telemetry uses notifications to collect Block Storage service meters.
            Perform these steps on the controller and Block Storage nodes.</para>
  <note>
    <para>Your environment must include the Block Storage service.</para>
  </note>
  <section>
    <title>Configure Cinder to use Telemetry</title>
    <para>Edit the <literal>/etc/cinder/cinder.conf</literal> file and complete the
                following actions:</para>
    <itemizedlist>
      <listitem>
        <para>In the <literal>[oslo_messaging_notifications]</literal> section, configure notifications:</para>
        <screen language="ini">[oslo_messaging_notifications]
...
driver = messagingv2</screen>
      </listitem>
    </itemizedlist>
    <itemizedlist>
      <listitem>
        <para>Enable periodic usage statistics relating to block storage. To use it, you
                        must run this command in the following format:</para>
        <screen language="console">$ cinder-volume-usage-audit  --start_time='YYYY-MM-DD HH:MM:SS' \
  --end_time='YYYY-MM-DD HH:MM:SS' --send_actions</screen>
        <para>This script outputs what volumes or snapshots were created, deleted, or
                        exists in a given period of time and some information about these
                        volumes or snapshots.</para>
        <para>Using this script via cron you can get notifications periodically, for
                        example, every 5 minutes:</para>
        <screen>*/5 * * * * /path/to/cinder-volume-usage-audit --send_actions</screen>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Finalize installation</title>
    <procedure>
      <step>
        <para>Restart the Block Storage services on the controller node:</para>
        <screen language="console"># service cinder-api restart
# service cinder-scheduler restart</screen>
      </step>
      <step>
        <para>Restart the Block Storage services on the storage nodes:</para>
        <screen language="console"># service cinder-volume restart</screen>
      </step>
    </procedure>
  </section>
</section>
