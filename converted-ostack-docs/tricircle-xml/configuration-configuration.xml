<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Configuration Guide</title>
  <para>A brief introduction to configure Tricircle service. Only the
            configuration items for Tricircle will be described here. Logging,
            messaging, database, keystonemiddleware etc configuration which are
            generated from OpenStack Oslo library, will not be described here. Since
            these configuration items are common to Nova, Cinder, Neutron. Please
            refer to corresponding description from Nova, Cinder or Neutron.</para>
  <section>
    <title>Common Options</title>
    <para>In the common configuration options, the group of “client” need to be
                configured in Admin API, XJob, Local Plugin and Central Plugin. The
                “tricircle_db_connection” should be configured in Admin API, XJob and
                Central Plugin.</para>
    <table>
      <title>Description of common configuration options</title>
      <tgroup cols="2">
        <colspec colname="c1" colwidth="50.0*"/>
        <colspec colname="c2" colwidth="50.0*"/>
        <thead>
          <row>
            <entry>
              <para>Configuration option = Default value</para>
            </entry>
            <entry>
              <para>Description</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[DEFAULT]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>tricircle_db_connection</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) database connection string for Tricircle, for example, mysql+pymysql://root:password@127.0.0.1/tricircle?charset=utf8</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[client]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>admin_password</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) password of admin account, needed when auto_refresh_endpoint set to True, for example, password.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>admin_tenant</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) tenant name of admin account, needed when auto_refresh_endpoint set to True, for example, demo.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>admin_tenant_domain_name</literal> = <literal>Default</literal></para>
            </entry>
            <entry>
              <para>(String) tenant domain name of admin account, needed when auto_refresh_endpoint set to True.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>admin_user_domain_name</literal> = <literal>Default</literal></para>
            </entry>
            <entry>
              <para>(String) user domain name of admin account, needed when auto_refresh_endpoint set to True.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>admin_username</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) username of admin account, needed when auto_refresh_endpoint set to True.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>auth_url</literal> = <literal>http://127.0.0.1/identity</literal></para>
            </entry>
            <entry>
              <para>(String) keystone authorization url, for example, <link xlink:href="http://$service_host/identity"/></para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>identity_url</literal> = <literal>http://127.0.0.1/identity/v3</literal></para>
            </entry>
            <entry>
              <para>(String) keystone service url, for example, <link xlink:href="http://$service_host/identity/v3"/></para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>auto_refresh_endpoint</literal> = <literal>True</literal></para>
            </entry>
            <entry>
              <para>(Boolean) if set to True, endpoint will be automatically refreshed if timeout accessing endpoint.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>bridge_cidr</literal> = <literal>100.0.0.0/9</literal></para>
            </entry>
            <entry>
              <para>(String) cidr pool of the bridge network, for example, 100.0.0.0/9</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>neutron_timeout</literal> = <literal>60</literal></para>
            </entry>
            <entry>
              <para>(Integer) timeout for neutron client in seconds.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>top_region_name</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) region name of Central Neutron in which client needs to access, for example, CentralRegion.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>cross_pod_vxlan_mode</literal> = <literal>p2p</literal></para>
            </entry>
            <entry>
              <para>(String) Cross-pod VxLAN networking support mode, possible choices are p2p l2gw and noop</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>
  <section>
    <title>Tricircle Admin API Settings</title>
    <para>Tricircle Admin API servers for managing the mapping between OpenStack instances
                and availability zone, retrieving object uuid routing and exposing API for
                maintenance. The following items should be configured in Tricircle’s api.conf.</para>
    <table>
      <title>Description of Tricircle Admin API configuration options</title>
      <tgroup cols="2">
        <colspec colname="c1" colwidth="50.0*"/>
        <colspec colname="c2" colwidth="50.0*"/>
        <thead>
          <row>
            <entry>
              <para>Configuration option = Default value</para>
            </entry>
            <entry>
              <para>Description</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[DEFAULT]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>api_workers</literal> = <literal>1</literal></para>
            </entry>
            <entry>
              <para>(Integer) The port to bind to</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>auth_strategy</literal> = <literal>keystone</literal></para>
            </entry>
            <entry>
              <para>(String) The type of authentication to use</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>bind_host</literal> = <literal>0.0.0.0</literal></para>
            </entry>
            <entry>
              <para>(String) The host IP to bind to</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>bind_port</literal> = <literal>19999</literal></para>
            </entry>
            <entry>
              <para>(Integer) The port to bind to</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>
  <section>
    <title>Tricircle XJob Settings</title>
    <para>Tricircle XJob serves for receiving and processing cross Neutron
                functionality and other async jobs from Admin API or Tricircle Central
                Neutron Plugin. The following items should be configured in Tricircle’s
                xjob.conf.</para>
    <table>
      <title>Description of Tricircle XJob configuration options</title>
      <tgroup cols="2">
        <colspec colname="c1" colwidth="50.0*"/>
        <colspec colname="c2" colwidth="50.0*"/>
        <thead>
          <row>
            <entry>
              <para>Configuration option = Default value</para>
            </entry>
            <entry>
              <para>Description</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[DEFAULT]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>periodic_enable</literal> = <literal>True</literal></para>
            </entry>
            <entry>
              <para>(Boolean) Enable periodic tasks</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>periodic_fuzzy_delay</literal> = <literal>60</literal></para>
            </entry>
            <entry>
              <para>(Integer) Range of seconds to randomly delay when starting the periodic task scheduler to reduce stampeding. (Disable by setting to 0)</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>report_interval</literal> = <literal>10</literal></para>
            </entry>
            <entry>
              <para>(Integer) Seconds between nodes reporting state to datastore</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>host</literal> = <literal>tricircle.xhost</literal></para>
            </entry>
            <entry>
              <para>(String) The host name for RPC server, each node should have different host name.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>job_run_expire</literal> = <literal>180</literal></para>
            </entry>
            <entry>
              <para>(Integer) Running job is considered expires after this time, in seconds</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>workers</literal> = <literal>1</literal></para>
            </entry>
            <entry>
              <para>(Integer) Number of workers</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>worker_handle_timeout</literal> = <literal>1800</literal></para>
            </entry>
            <entry>
              <para>(Integer) Timeout for worker’s one turn of processing, in seconds</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>worker_sleep_time</literal> = <literal>60</literal></para>
            </entry>
            <entry>
              <para>(Float) Seconds a worker sleeps after one run in a loop</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>redo_time_span</literal> = <literal>172800</literal></para>
            </entry>
            <entry>
              <para>(Integer) Time span in seconds, we calculate the latest job timestamp by
                                    subtracting this time span from the current timestamp, jobs created
                                    between these two timestamps will be redone</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>
  <section>
    <title>Networking Setting for Tricircle</title>
    <para>To make the networking automation work, two plugins need to be configured:
                Tricircle Central Neutron Plugin and Tricircle Local Neutron Plugin.</para>
    <para>
      <emphasis role="bold">Tricircle Central Neutron Plugin</emphasis>
    </para>
    <para>The Tricircle Central Neutron Plugin serves for tenant level L2/L3 networking
                automation across multiple Neutron servers. The following items should be
                configured in central Neutron’s neutron.conf.</para>
    <table>
      <title>Description of Central Neutron configuration options</title>
      <tgroup cols="2">
        <colspec colname="c1" colwidth="50.0*"/>
        <colspec colname="c2" colwidth="50.0*"/>
        <thead>
          <row>
            <entry>
              <para>Configuration option = Default value</para>
            </entry>
            <entry>
              <para>Description</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[DEFAULT]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>core_plugin</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) core plugin central Neutron server uses, should be set to tricircle.network.central_plugin.TricirclePlugin</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[tricircle]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>bridge_network_type</literal> = <literal>vxlan</literal></para>
            </entry>
            <entry>
              <para>(String) Type of l3 bridge network, this type should be enabled in tenant_network_types and is not local type, for example, vlan or vxlan.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>default_region_for_external_network</literal> = <literal>RegionOne</literal></para>
            </entry>
            <entry>
              <para>(String) Default region where the external network belongs to, it must exist, for example, RegionOne.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>network_vlan_ranges</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) List of &lt;physical_network&gt;:&lt;vlan_min&gt;:&lt;vlan_max&gt; or &lt;physical_network&gt; specifying physical_network names usable for VLAN provider and tenant networks, as well as ranges of VLAN tags on each available for allocation to tenant networks, for example, bridge:2001:3000.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>tenant_network_types</literal> = <literal>vxlan,local</literal></para>
            </entry>
            <entry>
              <para>(String) Ordered list of network_types to allocate as tenant networks. The default value “local” is useful for single pod connectivity, for example, local vlan and vxlan.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>type_drivers</literal> = <literal>vxlan,local</literal></para>
            </entry>
            <entry>
              <para>(String) List of network type driver entry points to be loaded from the tricircle.network.type_drivers namespace, for example, local vlan and vxlan.</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>vni_ranges</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) Comma-separated list of &lt;vni_min&gt;:&lt;vni_max&gt; tuples enumerating ranges of VXLAN VNI IDs that are available for tenant network allocation, for example, 1001:2000</para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>flat_networks</literal> = <literal>*</literal></para>
            </entry>
            <entry>
              <para>(String) List of physical_network names with which flat networks can be created. Use default ‘*’ to allow flat networks with arbitrary physical_network names. Use an empty list to disable flat networks.</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <para>
      <emphasis role="bold">Tricircle Local Neutron Plugin</emphasis>
    </para>
    <para>The Tricircle Local Neutron Plugin serves for cross Neutron networking
                automation triggering. It is a shim layer between real core plugin and
                Neutron API server. The following items should be configured in local
                Neutron’s neutron.conf</para>
    <table>
      <title>Description of Local Neutron configuration options</title>
      <tgroup cols="2">
        <colspec colname="c1" colwidth="50.0*"/>
        <colspec colname="c2" colwidth="50.0*"/>
        <thead>
          <row>
            <entry>
              <para>Configuration option = Default value</para>
            </entry>
            <entry>
              <para>Description and Example</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[DEFAULT]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>core_plugin</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) core plugin local Neutron server uses, should be set to tricircle.network.local_plugin.TricirclePlugin</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[tricircle]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>central_neutron_url</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) Central Neutron server url, for example, <link xlink:href="http://$service_host:9696"/></para>
            </entry>
          </row>
          <row>
            <entry>
              <para><literal>real_core_plugin</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) The core plugin the Tricircle local plugin will invoke, for example, neutron.plugins.ml2.plugin.Ml2Plugin</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <para>
      <emphasis role="bold">Tricircle Local Neutron L3 Plugin</emphasis>
    </para>
    <para>In multiple OpenStack clouds, if the external network is located in the
                first OpenStack cloud, but the port which will be associated with one
                floating ip is located in the second OpenStack cloud, then the network for
                this port may not be able to be added to the router in the first OpenStack.
                In Tricircle, to address this scenario, a bridge network will be used
                to connect the routers in these two OpenStack clouds if the network is not
                a cross Neutron L2 network. To make it happen, the Tricircle Local Neutron L3
                Plugin or other L3 service plugin should be able to associate a floating ip to
                a port whose network is not directly attached to the router. TricircleL3Plugin
                is inherited from Neutron original L3RouterPlugin, and overrides the original
                “get_router_for_floatingip” implementation to allow associating a floating ip
                to a port whose network is not directly attached to the router. If you want
                to configure local Neutron to use original L3RouterPlugin, then you need to
                patch the function “get_router_for_floatingip” as what has been done in
                TricircleL3Plugin.</para>
    <para>If only cross Neutron L2 networking is needed in the deployment, it’s not
                necessary to configure the service plugins.</para>
    <para>The following item should be configured in local Neutron’s neutron.conf</para>
    <table>
      <title>Description of Local Neutron configuration options</title>
      <tgroup cols="2">
        <colspec colname="c1" colwidth="50.0*"/>
        <colspec colname="c2" colwidth="50.0*"/>
        <thead>
          <row>
            <entry>
              <para>Configuration option = Default value</para>
            </entry>
            <entry>
              <para>Description and Example</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                <emphasis role="bold">[DEFAULT]</emphasis>
              </para>
            </entry>
            <entry/>
          </row>
          <row>
            <entry>
              <para><literal>service_plugins</literal> = <literal>None</literal></para>
            </entry>
            <entry>
              <para>(String) service plugins local Neutron server uses, can be set to tricircle.network.local_l3_plugin.TricircleL3Plugin</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>
</section>
