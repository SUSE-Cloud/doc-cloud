<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Install and configure for Ubuntu</title>
  <para>This section describes how to install and configure the DNS
            service for Ubuntu 14.04 (LTS).</para>
  <section>
    <title>Prerequisites</title>
    <para>Before you install and configure the DNS service,
                you must create service credentials and API endpoints.</para>
    <procedure>
      <step>
        <para>Source the <literal>admin</literal> credentials to gain access to
                        admin-only CLI commands:</para>
        <screen language="console">$ source admin-openrc</screen>
      </step>
      <step>
        <para>To create the service credentials, complete these steps:</para>
        <itemizedlist>
          <listitem>
            <para>Create the <literal>designate</literal> user:</para>
            <screen language="console">$ openstack user create --domain default --password-prompt designate</screen>
          </listitem>
          <listitem>
            <para>Add the <literal>admin</literal> role to the <literal>designate</literal> user:</para>
            <screen language="console">$ openstack role add --project service --user designate admin</screen>
          </listitem>
          <listitem>
            <para>Create the designate service entities:</para>
            <screen language="console">$ openstack service create --name designate --description "DNS" dns</screen>
          </listitem>
        </itemizedlist>
      </step>
      <step>
        <para>Create the DNS service API endpoint:</para>
        <screen language="console">$ openstack endpoint create --region RegionOne \
  dns public http://controller:9001/</screen>
      </step>
    </procedure>
  </section>
  <section>
    <title>Install and configure components</title>
    <note>
      <para>Default configuration files vary by distribution. You might need
                    to add these sections and options rather than modifying existing
                    sections and options. Also, an ellipsis (<literal>...</literal>) in the configuration
                    snippets indicates potential default configuration options that you
                    should retain.</para>
    </note>
    <procedure>
      <step>
        <para>Install the packages:</para>
        <screen language="console"># apt-get install designate</screen>
      </step>
      <step>
        <para>Create a <literal>designate</literal> database that is accessible by the <literal>designate</literal>
                        user. Replace <literal>DESIGNATE_DBPASS</literal> with a suitable password:</para>
        <screen language="console"># mysql -u root -p
mysql&gt; CREATE DATABASE designate CHARACTER SET utf8 COLLATE utf8_general_ci;
mysql&gt; GRANT ALL PRIVILEGES ON designate.* TO 'designate'@'localhost' \
IDENTIFIED BY 'DESIGNATE_DBPASS';
mysql&gt; GRANT ALL PRIVILEGES ON designate.* TO 'designate'@'%' \
IDENTIFIED BY 'DESIGNATE_DBPASS';</screen>
      </step>
      <step>
        <para>Install the BIND9 packages:</para>
        <screen language="console"># apt-get install bind9 bind9utils bind9-doc</screen>
      </step>
      <step>
        <para>Create an RNDC Key:</para>
        <screen language="console"># rndc-confgen -a -k designate -c /etc/designate/rndc.key</screen>
      </step>
      <step>
        <para>Add the following options in the <literal>/etc/bind/named.conf.options</literal> file:</para>
        <screen language="none">...
include "/etc/designate/rndc.key";

options {
    ...
    allow-new-zones yes;
    request-ixfr no;
    listen-on port 53 { 127.0.0.1; };
    recursion no;
    allow-query { 127.0.0.1; };
};

controls {
  inet 127.0.0.1 port 953
    allow { 127.0.0.1; } keys { "designate"; };
};</screen>
      </step>
      <step>
        <para>Restart the DNS service:</para>
        <screen language="console"># service bind9 restart</screen>
      </step>
      <step>
        <para>Edit the <literal>/etc/designate/designate.conf</literal> file and
                        complete the following actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[service:api]</literal> section, configure <literal>auth_strategy</literal>:</para>
            <screen language="ini">[service:api]
listen = 0.0.0.0:9001
auth_strategy = keystone
enable_api_v1 = True
api_base_uri = http://controller:9001/
enabled_extensions_v1 = quotas, reports
enable_api_v2 = True
enabled_extensions_v2 = quotas, reports</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[keystone_authtoken]</literal> section, configure the following options:</para>
            <screen language="ini">[keystone_authtoken]
auth_host = controller
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = designate
admin_password = DESIGNATE_PASS</screen>
            <para>Replace <literal>DESIGNATE_PASS</literal> with the password you chose for the
                                <literal>designate</literal> user in the Identity service.</para>
          </listitem>
          <listitem>
            <para>In the <literal>[service:worker]</literal> section, enable the worker model:</para>
            <screen language="ini">enabled = True
notify = True</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[storage:sqlalchemy]</literal> section, configure database access:</para>
            <screen language="ini">[storage:sqlalchemy]
connection = mysql+pymysql://designate:DESIGNATE_DBPASS@controller/designate</screen>
            <para>Replace <literal>DESIGNATE_DBPASS</literal> with the password you chose for the
                                <literal>designate</literal> database.</para>
          </listitem>
          <listitem>
            <para>Populate the designate database</para>
            <screen language="console"># su -s /bin/sh -c "designate-manage database sync" designate</screen>
          </listitem>
        </itemizedlist>
      </step>
      <step>
        <para>Restart the designate central and API services:</para>
        <screen language="console"># service designate-central restart
# service designate-api restart</screen>
      </step>
      <step>
        <para>Create a pools.yaml file in <literal>/etc/designate/pools.yaml</literal> with the following
                        contents:</para>
        <screen language="yaml">- name: default
  # The name is immutable. There will be no option to change the name after
  # creation and the only way will to change it will be to delete it
  # (and all zones associated with it) and recreate it.
  description: Default Pool

  attributes: {}

  # List out the NS records for zones hosted within this pool
  # This should be a record that is created outside of designate, that
  # points to the public IP of the controller node.
  ns_records:
    - hostname: ns1-1.example.org.
      priority: 1

  # List out the nameservers for this pool. These are the actual BIND servers.
  # We use these to verify changes have propagated to all nameservers.
  nameservers:
    - host: 127.0.0.1
      port: 53

  # List out the targets for this pool. For BIND there will be one
  # entry for each BIND server, as we have to run rndc command on each server
  targets:
    - type: bind9
      description: BIND9 Server 1

      # List out the designate-mdns servers from which BIND servers should
      # request zone transfers (AXFRs) from.
      # This should be the IP of the controller node.
      # If you have multiple controllers you can add multiple masters
      # by running designate-mdns on them, and adding them here.
      masters:
        - host: 127.0.0.1
          port: 5354

      # BIND Configuration options
      options:
        host: 127.0.0.1
        port: 53
        rndc_host: 127.0.0.1
        rndc_port: 953
        rndc_key_file: /etc/designate/rndc.key</screen>
      </step>
      <step>
        <para>Update the pools:</para>
        <screen language="console"># su -s /bin/sh -c "designate-manage pool update" designate</screen>
      </step>
      <step>
        <para>Install Designate Worker, producer and mini-dns</para>
        <screen language="console"># apt install designate-worker
# apt install designate-producer
# apt install designate-mdns</screen>
      </step>
      <step>
        <para>Restart the designate and mDNS services:</para>
        <screen language="console"># service designate-worker restart
# service designate-producer restart
# service designate-mdns restart</screen>
      </step>
    </procedure>
  </section>
</section>
