<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Troubleshooting</title>
  <section>
    <title>I have a broken zone</title>
    <para>A zone is considered broken when it is not receiving updates anymore. Its status can be “ERROR” if Designate detected the error condition or it can be stuck in “PENDING” for a long time.</para>
    <para>Review the logs from the API, Central, Producer, Worker and MiniDNS.
                Identify the transaction ID of the last successful change and the first failing change. Using the ID, you can filter logs from the Designate components that are related to the same transaction.
                Look for log messages with ERROR level before and after the first failing update.</para>
    <para>Failures in updating a zone are usually related to problems in Producer, Worker, MiniDNS or the database.</para>
    <para>Ensure the services are running and network connectivity is not impaired.</para>
    <para>Transient network issues can be the cause of a broken zone. Producer and Worker are stateful services and perform attempts at restoring failing zones over time. Restarting the services will trigger new attempts.</para>
  </section>
  <section>
    <title>I have a broken pool</title>
  </section>
  <section>
    <title>I deleted a zone but it’s still in the database</title>
    <para>Deleted zones are flagged with “status” set to “DELETED” and “task” set to “NONE” once the deletion process terminates successfully.</para>
  </section>
  <section>
    <title>What ports should be open?</title>
    <para>Port numbers are configurable: review your designate.conf</para>
    <para>The default values are:</para>
    <informaltable>
      <tgroup cols="3">
        <colspec colname="c1" colwidth="52.2*"/>
        <colspec colname="c2" colwidth="26.1*"/>
        <colspec colname="c3" colwidth="21.7*"/>
        <thead>
          <row>
            <entry>
              <para>Component
                                    (header rows optional)</para>
            </entry>
            <entry>
              <para>Protocol</para>
            </entry>
            <entry>
              <para>Port
                                    numbers</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry morerows="1">
              <para>Agent</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>5358</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>UDP</para>
            </entry>
            <entry>
              <para>5358</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>API</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>9001</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>Keystone (external)</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>35357</para>
            </entry>
          </row>
          <row>
            <entry morerows="1">
              <para>MiniDNS</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>5354</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>UDP</para>
            </entry>
            <entry>
              <para>5354</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>MySQL</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>3306</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>RabbitMQ</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>5672</para>
            </entry>
          </row>
          <row>
            <entry morerows="1">
              <para>Resolvers</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>53</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>UDP</para>
            </entry>
            <entry>
              <para>53</para>
            </entry>
          </row>
          <row>
            <entry morerows="1">
              <para>ZooKeeper</para>
            </entry>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>2181</para>
            </entry>
          </row>
          <row>
            <entry>
              <para>TCP</para>
            </entry>
            <entry>
              <para>2888,3888</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>
  </section>
  <section>
    <title>What network protocol are used?</title>
    <para>HTTP[S] by the API, RabbitMQ and the MySQL protocol by most components, DNS (resolution and XFR), ZooKeeper, Memcached.</para>
  </section>
  <section>
    <title>What needs access to the Database?</title>
    <para>Central, MiniDNS</para>
  </section>
  <section>
    <title>What needs access to RabbitMQ?</title>
    <para>The API, Central, Producer, Worker, MiniDNS</para>
  </section>
  <section>
    <title>What needs access to ZooKeeper?</title>
    <para>Pool and Producer</para>
  </section>
  <section>
    <title>What needs access to Memcached?</title>
    <para>API and Worker</para>
  </section>
  <section>
    <title>How do I monitor Designate?</title>
    <para>Designate can be monitored by various <link xlink:href="https://wiki.openstack.org/wiki/Operations/Monitoring">monitoring systems listed here</link></para>
    <para>OpenStack recommends <link xlink:href="https://wiki.openstack.org/wiki/Monasca">Monasca</link></para>
  </section>
  <section>
    <title>What are useful metrics to monitor?</title>
    <itemizedlist>
      <listitem>
        <para>General host monitoring, i.e. CPU load, memory usage, disk and network I/O</para>
      </listitem>
      <listitem>
        <para>MySQL performance, errors and free disk space</para>
      </listitem>
      <listitem>
        <para>Number of zones in ACTIVE, PENDING and ERROR status</para>
      </listitem>
      <listitem>
        <para>API queries per second, broken down by “read” and “write” operation on zones, records, etc</para>
      </listitem>
      <listitem>
        <para>Zone change propagation time i.e. how long does it takes for a record update to reach the resolvers</para>
      </listitem>
      <listitem>
        <para>Log messages containing having “ERROR” level</para>
      </listitem>
      <listitem>
        <para>Quotas utilization i.e. number of existing records/zones against the maximum allowed</para>
      </listitem>
      <listitem>
        <para>Memcached, RabbitMQ, ZooKeeper performance and errors</para>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>What are useful metrics to review first during an incident?</title>
    <itemizedlist>
      <listitem>
        <para>Host, network and MySQL performance metrics</para>
      </listitem>
      <listitem>
        <para>Number of zones in ACTIVE, PENDING and ERROR status</para>
      </listitem>
      <listitem>
        <para>Log messages containing having “ERROR” level</para>
      </listitem>
    </itemizedlist>
  </section>
</section>
