<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Secondary Zones</title>
  <para>The Designate v2 API introduced functionality that allows Designate to act as a
            DNS slave, rather than a master for a zone. This is accomplished by completing
            a zone transfer (AXFR) from a DNS server managed outside of Designate.</para>
  <section>
    <title>RecordSets / Records</title>
    <para>Changes to secondary zones are managed outside of Designate. Users must make
                the changes they wish, and prompt a fresh zone transfer (AXFR) into Designate
                to make those changes live on any DNS servers Designate manages.</para>
  </section>
  <section>
    <title>Setup</title>
    <para>To add a secondary zone to Designate, there must be a DNS master for the zone,
                to which Designate can act as a slave. For this guide, we assume that you have
                already set this up.</para>
    <para>The remaining Designate set up will be similar to a non-secondary zone setup.
                You’ll need a primary DNS server for Designate to manage and transfer secondary
                zones to.</para>
    <para>In our examples we’ll use the following values:</para>
    <para><emphasis>Name</emphasis> - example.com.</para>
    <para><emphasis>Masters</emphasis> - 192.168.27.100</para>
    <section>
      <title>Setup - example NSD4</title>
      <para>Skip this section if you have a master already to use.</para>
      <note>
        <para>For this it is assumed that you are running on Ubuntu.</para>
      </note>
    </section>
    <section>
      <title>Install</title>
      <para>For some reason there’s a bug with the nsd package so it doesn’t create the user that it needs for the installation. So we’ll create that before installing the package.</para>
      <screen language="bash">$ sudo apt-get install nsd</screen>
    </section>
    <section>
      <title>Configure</title>
      <screen language="bash">$ sudo zcat /usr/share/doc/nsd/examples/nsd.conf.sample.gz &gt;/tmp/nsd.conf
$ sudo mv /tmp/nsd.conf /etc/nsd/nsd.conf</screen>
      <para>Add the following to /etc/nsd/nsd.conf</para>
      <note>
        <para>If you’re wondering why we set notify to <literal>192.168.27.100</literal>:<literal>5354</literal> it’s because MDNS runs on 5354 by default.</para>
      </note>
      <screen language="bash">$ sudo vi /etc/nsd/nsd.conf</screen>
      <para>Add the contents:</para>
      <screen language="yaml">pattern:
    name: "mdns"
    zonefile: "%s.zone"
    notify: 192.168.27.100@5354 NOKEY
    provide-xfr: 192.168.27.100 NOKEY
    allow-axfr-fallback: yes</screen>
    </section>
    <section>
      <title>Add a zone file</title>
      <para>Create a new <emphasis>Zone</emphasis> in NSD called <emphasis>example.com.</emphasis></para>
      <para>
        <emphasis role="bold">/etc/nsd/example.com.zone</emphasis>
      </para>
      <screen language="bash">$ sudo vi /etc/nsd/example.com.zone</screen>
      <para>And add the contents:</para>
      <screen>$TTL 1800 ;minimum ttl
example.com.         IN      SOA     ns1.example.com. admin.example.net. (
                        2014111301      ;serial
                        3600            ;refresh
                        600             ;retry
                        180000          ;expire
                        600             ;negative ttl
                        )

                TXT             "v=spf1 +a +mx ~all"
                SPF             "v=spf1 +a +mx ~all"

                NS              ns1.example.com.
                NS              ns2.example.com.
                NS              ns3.example.com.

                MX      0       mail1.example.com.
                MX      5       mail2.example.com.
                MX      10      mail3.example.com.

                A               10.0.0.1
                A               10.0.0.2
                A               10.0.0.3


ns1             A               172.16.28.100
ns2             A               172.16.28.101
ns3             A               172.16.28.103

mail1             A               10.0.10.1
mail2             A               10.0.10.2
mail3             A               10.0.10.3

google          CNAME           google.com.</screen>
    </section>
    <section>
      <title>Restart NSD</title>
      <screen language="bash">$ sudo service nsd restart</screen>
      <para>Check that it’s working</para>
      <screen language="bash">$ sudo nsd-control status</screen>
      <para>Activate the zone in NSD</para>
      <screen language="bash">$ sudo nsd-control addzone example.com mdns</screen>
    </section>
  </section>
  <section>
    <title>Creating the Zone</title>
    <para>When you create a domain in Designate there are two possible initial actions:</para>
    <itemizedlist>
      <listitem>
        <para>Domain is created but transfer fails if it’s not available yet in master,
                        then typically the initial transfer will be done once the master sends first
                        NOTIFY.</para>
      </listitem>
      <listitem>
        <para>Domain is created and transfers straight away.</para>
      </listitem>
    </itemizedlist>
    <para>In both cases the interaction between your master and Designate is handled by
                the MDNS instance at the Designate side.</para>
    <para>Definition of values:</para>
    <itemizedlist>
      <listitem>
        <para><emphasis>email</emphasis> set to the value of the <emphasis>managed_resource_email</emphasis> option in the
                        <emphasis>central</emphasis> section of the Designate configuration.</para>
      </listitem>
      <listitem>
        <para><emphasis>transferred_at</emphasis> is <emphasis role="bold">null</emphasis> and <emphasis>version</emphasis> is <emphasis role="bold">1</emphasis> since the zone has not
                        transferred yet.</para>
      </listitem>
    </itemizedlist>
    <screen language="console">$ openstack zone create --type secondary --masters 192.168.27.100 example.com.</screen>
  </section>
</section>
