<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Upgrading to Mitaka from Liberty</title>
  <section>
    <title>Pools Configuration</title>
    <para>We have updated how the config data for pools is now stored.</para>
    <para>Previously there was a mix of content in the <literal>designate.conf</literal> file and in the
                designate database.</para>
    <para>We have moved all of the data to the database in Mitaka, to avoid confusion, and
                avoid the massive complexity that exists in the config file.</para>
    <warning>
      <para>This part of the upgrade <emphasis role="bold">requires</emphasis> downtime.</para>
    </warning>
    <para>We have 2 new commands in the <literal>designate-manage</literal> utility that are able to assist
                the migration.</para>
    <para>To make the config syntax simpler we have a new YAML based config file that is
                used to load information into the database.</para>
    <screen language="yaml"><?dbsuse-fo font-size="8pt"?>---

- name: default
  # The name is immutable. There will be no option to change the name after
  # creation and the only way will to change it will be to delete it
  # (and all zones associated with it) and recreate it.
  description: Default PowerDNS Pool


  # Attributes are Key:Value pairs that describe the pool. for example the level
  # of service (i.e. service_tier:GOLD), capabilities (i.e. anycast: true) or
  # other metadata. Users can use this information to point their zones to the
  # correct pool
  attributes: {}

  # List out the NS records for zones hosted within this pool
  ns_records:
    - hostname: ns1-1.example.org.
      priority: 1
    - hostname: ns1-2.example.org.
      priority: 2

  # List out the nameservers for this pool. These are the actual PowerDNS
  # servers. We use these to verify changes have propagated to all nameservers.
  nameservers:
    - host: 192.0.2.2
      port: 53
    - host: 192.0.2.3
      port: 53

  # List out the targets for this pool. For PowerDNS, this is the database
  # (or databases, if you deploy a separate DB for each PowerDNS server)
  targets:
    - type: powerdns
      description: PowerDNS Database Cluster

      # List out the designate-mdns servers from which PowerDNS servers should
      # request zone transfers (AXFRs) from.
      masters:
        - host: 192.0.2.1
          port: 5354

      # PowerDNS Configuration options
      options:
        host: 192.0.2.1
        port: 53
        connection: 'mysql+pymysql://designate:password@127.0.0.1/designate_pdns?charset=utf8'

  # Optional list of additional IP/Port's for which designate-mdns will send
  # DNS NOTIFY packets to
  also_notifies:
   - host: 192.0.2.4
     port: 53

</screen>
    <para>We have a command that will allow you to take your current running config, and
                export it to the new YAML format.</para>
    <note>
      <para>You will need to have at least one instance of central running, and machine
                    <literal>designate-manage</literal> is running on will need access to the messaging queue</para>
    </note>
    <screen language="console">designate-manage pool generate_file --file output.yml</screen>
    <para>This will create a YAML file, with all the currently defined pools, and all of their config.</para>
    <para>We suggest this is then migrated into a config management system, or other document management system.</para>
    <para>From this point on all updates to pools should be done by updating this file, and
                running:</para>
    <screen language="console">designate-manage pool update --file /path/to/file.yml</screen>
    <section>
      <title>Pools - Step by Step</title>
      <procedure>
        <step>
          <para>Ensure there is not 2 pools with the same name.</para>
        </step>
        <step>
          <para>Stop all Designate Services.</para>
        </step>
        <step>
          <para>Deploy new Mitaka code</para>
        </step>
        <step>
          <para>Start <literal>designate-central</literal></para>
        </step>
        <step>
          <variablelist>
            <varlistentry>
              <term>Run</term>
              <listitem>
                <screen language="console">designate-manage pool export_from_config --file output.yml</screen>
              </listitem>
            </varlistentry>
          </variablelist>
        </step>
        <step>
          <para>Ensure the output file is correct (reference sample file for each value)</para>
        </step>
        <step>
          <para>Run</para>
          <screen language="console">designate-manage pool update --file output.yml --dry_run True --delete True</screen>
        </step>
        <step>
          <para>Ensure the output of this command is not removing any Pools</para>
        </step>
        <step>
          <para>Run</para>
          <screen language="console">designate-manage pool update --file output.yml --delete True</screen>
        </step>
        <step>
          <para>Start the remaining designate services.</para>
        </step>
      </procedure>
    </section>
  </section>
</section>
