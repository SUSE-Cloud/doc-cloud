<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Networking Option 2: Self-service networks</title>
  <para>Install and configure the Networking components on the <emphasis>controller</emphasis> node.</para>
  <section>
    <title>Install the components</title>
    <screen language="console"># zypper install --no-recommends openstack-neutron \
  openstack-neutron-server openstack-neutron-linuxbridge-agent \
  openstack-neutron-l3-agent openstack-neutron-dhcp-agent \
  openstack-neutron-metadata-agent bridge-utils</screen>
  </section>
  <section>
    <title>Configure the server component</title>
    <itemizedlist>
      <listitem>
        <para>Edit the <literal>/etc/neutron/neutron.conf</literal> file and complete the following
                        actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[database]</literal> section, configure database access:</para>
            <screen language="ini">[database]
# ...
connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron</screen>
            <para>Replace <literal>NEUTRON_DBPASS</literal> with the password you chose for the
                                database.</para>
            <note>
              <para>Comment out or remove any other <literal>connection</literal> options in the
                                    <literal>[database]</literal> section.</para>
            </note>
          </listitem>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> section, enable the Modular Layer 2 (ML2)
                                plug-in, router service, and overlapping IP addresses:</para>
            <screen language="ini">[DEFAULT]
# ...
core_plugin = ml2
service_plugins = router
allow_overlapping_ips = true</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> section, configure <literal>RabbitMQ</literal>
                                message queue access:</para>
            <screen language="ini">[DEFAULT]
# ...
transport_url = rabbit://openstack:RABBIT_PASS@controller</screen>
            <para>Replace <literal>RABBIT_PASS</literal> with the password you chose for the
                                <literal>openstack</literal> account in RabbitMQ.</para>
          </listitem>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> and <literal>[keystone_authtoken]</literal> sections, configure
                                Identity service access:</para>
            <screen language="ini">[DEFAULT]
# ...
auth_strategy = keystone

[keystone_authtoken]
# ...
auth_uri = http://controller:5000
auth_url = http://controller:35357
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = NEUTRON_PASS</screen>
            <para>Replace <literal>NEUTRON_PASS</literal> with the password you chose for the <literal>neutron</literal>
                                user in the Identity service.</para>
            <note>
              <para>Comment out or remove any other options in the
                                    <literal>[keystone_authtoken]</literal> section.</para>
            </note>
          </listitem>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> and <literal>[nova]</literal> sections, configure Networking to
                                notify Compute of network topology changes:</para>
            <screen language="ini">[DEFAULT]
# ...
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true

[nova]
# ...
auth_url = http://controller:35357
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = nova
password = NOVA_PASS</screen>
            <para>Replace <literal>NOVA_PASS</literal> with the password you chose for the <literal>nova</literal>
                                user in the Identity service.</para>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Configure the Modular Layer 2 (ML2) plug-in</title>
    <para>The ML2 plug-in uses the Linux bridge mechanism to build layer-2 (bridging
                and switching) virtual networking infrastructure for instances.</para>
    <itemizedlist>
      <listitem>
        <para>Edit the <literal>/etc/neutron/plugins/ml2/ml2_conf.ini</literal> file and complete the
                        following actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[ml2]</literal> section, enable flat, VLAN, and VXLAN networks:</para>
            <screen language="ini">[ml2]
# ...
type_drivers = flat,vlan,vxlan</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[ml2]</literal> section, enable VXLAN self-service networks:</para>
            <screen language="ini">[ml2]
# ...
tenant_network_types = vxlan</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[ml2]</literal> section, enable the Linux bridge and layer-2 population
                                mechanisms:</para>
            <screen language="ini">[ml2]
# ...
mechanism_drivers = linuxbridge,l2population</screen>
            <warning>
              <para>After you configure the ML2 plug-in, removing values in the
                                    <literal>type_drivers</literal> option can lead to database inconsistency.</para>
            </warning>
            <note>
              <para>The Linux bridge agent only supports VXLAN overlay networks.</para>
            </note>
          </listitem>
          <listitem>
            <para>In the <literal>[ml2]</literal> section, enable the port security extension driver:</para>
            <screen language="ini">[ml2]
# ...
extension_drivers = port_security</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[ml2_type_flat]</literal> section, configure the provider virtual
                                network as a flat network:</para>
            <screen language="ini">[ml2_type_flat]
# ...
flat_networks = provider</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[ml2_type_vxlan]</literal> section, configure the VXLAN network identifier
                                range for self-service networks:</para>
            <screen language="ini">[ml2_type_vxlan]
# ...
vni_ranges = 1:1000</screen>
          </listitem>
          <listitem>
            <para>In the <literal>[securitygroup]</literal> section, enable ipset to increase
                                efficiency of security group rules:</para>
            <screen language="ini">[securitygroup]
# ...
enable_ipset = true</screen>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Configure the Linux bridge agent</title>
    <para>The Linux bridge agent builds layer-2 (bridging and switching) virtual
                networking infrastructure for instances and handles security groups.</para>
    <itemizedlist>
      <listitem>
        <para>Edit the <literal>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</literal> file and
                        complete the following actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[linux_bridge]</literal> section, map the provider virtual network to the
                                provider physical network interface:</para>
            <screen language="ini">[linux_bridge]
physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME</screen>
            <para>Replace <literal>PROVIDER_INTERFACE_NAME</literal> with the name of the underlying
                                provider physical network interface. See 
                                for more information.</para>
          </listitem>
          <listitem>
            <para>In the <literal>[vxlan]</literal> section, enable VXLAN overlay networks, configure the
                                IP address of the physical network interface that handles overlay
                                networks, and enable layer-2 population:</para>
            <screen language="ini">[vxlan]
enable_vxlan = true
local_ip = OVERLAY_INTERFACE_IP_ADDRESS
l2_population = true</screen>
            <para>Replace <literal>OVERLAY_INTERFACE_IP_ADDRESS</literal> with the IP address of the
                                underlying physical network interface that handles overlay networks. The
                                example architecture uses the management interface to tunnel traffic to
                                the other nodes. Therefore, replace <literal>OVERLAY_INTERFACE_IP_ADDRESS</literal> with
                                the management IP address of the controller node. See
                                 for more information.</para>
          </listitem>
          <listitem>
            <para>In the <literal>[securitygroup]</literal> section, enable security groups and
                                configure the Linux bridge iptables firewall driver:</para>
            <screen language="ini">[securitygroup]
# ...
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</screen>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Configure the layer-3 agent</title>
    <para>The Layer-3 (L3) agent provides routing and NAT services for
                self-service virtual networks.</para>
    <itemizedlist>
      <listitem>
        <para>Edit the <literal>/etc/neutron/l3_agent.ini</literal> file and complete the following
                        actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> section, configure the Linux bridge interface driver
                                and external network bridge:</para>
            <screen language="ini">[DEFAULT]
# ...
interface_driver = linuxbridge</screen>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Configure the DHCP agent</title>
    <para>The DHCP agent provides DHCP services for virtual networks.</para>
    <itemizedlist>
      <listitem>
        <para>Edit the <literal>/etc/neutron/dhcp_agent.ini</literal> file and complete the following
                        actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> section, configure the Linux bridge interface driver,
                                Dnsmasq DHCP driver, and enable isolated metadata so instances on provider
                                networks can access metadata over the network:</para>
            <screen language="ini">[DEFAULT]
# ...
interface_driver = linuxbridge
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = true</screen>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
    <para>Return to <emphasis>Networking controller node configuration</emphasis>.</para>
  </section>
</section>
