<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>BGP dynamic routing</title>
  <para>BGP dynamic routing enables advertisement of self-service (private) network
            prefixes to physical network devices that support BGP such as routers, thus
            removing the conventional dependency on static routes. The feature relies
            on <xref linkend="config-address-scopes"/> and requires knowledge of
            their operation for proper deployment.</para>
  <para>BGP dynamic routing consists of a service plug-in and an agent. The service
            plug-in implements the Networking service extension and the agent manages BGP
            peering sessions. A cloud administrator creates and configures a BGP speaker
            using the CLI or API and manually schedules it to one or more hosts running
            the agent. Agents can reside on hosts with or without other Networking
            service agents. Prefix advertisement depends on the binding of external
            networks to a BGP speaker and the address scope of external and internal
            IP address ranges or subnets.</para>
  <informalfigure>
    <mediaobject>
      <imageobject role="fo">
        <imagedata fileref="bgp-dynamic-routing-overview.png"/>
      </imageobject>
      <imageobject role="html">
        <imagedata fileref="bgp-dynamic-routing-overview.png"/>
      </imageobject>
    </mediaobject>
  </informalfigure>
  <note>
    <para>Although self-service networks generally use private IP address ranges
                (RFC1918) for IPv4 subnets, BGP dynamic routing can advertise any IPv4
                address ranges.</para>
  </note>
  <section>
    <title>Example configuration</title>
    <para>The example configuration involves the following components:</para>
    <itemizedlist>
      <listitem>
        <para>One BGP agent.</para>
      </listitem>
      <listitem>
        <para>One address scope containing IP address range 203.0.113.0/24 for
                        provider networks, and IP address ranges 192.0.2.0/25 and 192.0.2.128/25
                        for self-service networks.</para>
      </listitem>
      <listitem>
        <para>One provider network using IP address range 203.0.113.0/24.</para>
      </listitem>
      <listitem>
        <para>Three self-service networks.</para>
        <itemizedlist>
          <listitem>
            <para>Self-service networks 1 and 2 use IP address ranges inside of
                                the address scope.</para>
          </listitem>
          <listitem>
            <para>Self-service network 3 uses a unique IP address range 198.51.100.0/24 to
                                demonstrate that the BGP speaker does not advertise prefixes outside
                                of address scopes.</para>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
        <para>Three routers. Each router connects one self-service network to the
                        provider network.</para>
        <itemizedlist>
          <listitem>
            <para>Router 1 contains IP addresses 203.0.113.11 and 192.0.2.1</para>
          </listitem>
          <listitem>
            <para>Router 2 contains IP addresses 203.0.113.12 and 192.0.2.129</para>
          </listitem>
          <listitem>
            <para>Router 3 contains IP addresses 203.0.113.13 and 198.51.100.1</para>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
    <note>
      <para>The example configuration assumes sufficient knowledge about the
                    Networking service, routing, and BGP. For basic deployment of the
                    Networking service, consult one of the
                    <xref linkend="deploy"/>. For more information on BGP, see
                    <link xlink:href="https://tools.ietf.org/html/rfc4271">RFC 4271</link>.</para>
    </note>
    <section>
      <title>Controller node</title>
      <itemizedlist>
        <listitem>
          <para>In the <literal>neutron.conf</literal> file, enable the conventional layer-3 and BGP
                            dynamic routing service plug-ins:</para>
          <screen language="ini"><?dbsuse-fo font-size="8pt"?>[DEFAULT]
service_plugins = neutron_dynamic_routing.services.bgp.bgp_plugin.BgpPlugin,neutron.services.l3_router.l3_router_plugin.L3RouterPlugin</screen>
        </listitem>
      </itemizedlist>
    </section>
    <section>
      <title>Agent nodes</title>
      <itemizedlist>
        <listitem>
          <para>In the <literal>bgp_dragent.ini</literal> file:</para>
          <itemizedlist>
            <listitem>
              <para>Configure the driver.</para>
              <screen language="ini"><?dbsuse-fo font-size="8pt"?>[BGP]
bgp_speaker_driver = neutron_dynamic_routing.services.bgp.agent.driver.ryu.driver.RyuBgpDriver</screen>
              <note>
                <para>The agent currently only supports the Ryu BGP driver.</para>
              </note>
            </listitem>
            <listitem>
              <para>Configure the router ID.</para>
              <screen language="ini">[BGP]
bgp_router_id = ROUTER_ID</screen>
              <para>Replace <literal>ROUTER_ID</literal> with a suitable unique 32-bit number, typically an
                                    IPv4 address on the host running the agent. For example, 192.0.2.2.</para>
            </listitem>
          </itemizedlist>
        </listitem>
      </itemizedlist>
    </section>
    <section>
      <title>Verify service operation</title>
      <procedure>
        <step>
          <para>Source the administrative project credentials.</para>
        </step>
        <step>
          <para>Verify presence and operation of each BGP dynamic routing agent.</para>
          <screen language="console"><?dbsuse-fo font-size="8pt"?>$ neutron agent-list --agent-type="BGP dynamic routing agent"
+--------------------------------------+---------------------------+------------+-------------------+-------+----------------+---------------------------+
| id                                   | agent_type                | host       | availability_zone | alive | admin_state_up | binary                    |
+--------------------------------------+---------------------------+------------+-------------------+-------+----------------+---------------------------+
| 37729181-2224-48d8-89ef-16eca8e2f77e | BGP dynamic routing agent | controller |                   | :-)   | True           | neutron-bgp-dragent       |
+--------------------------------------+---------------------------+------------+-------------------+-------+----------------+---------------------------+</screen>
        </step>
      </procedure>
    </section>
    <section>
      <title>Create the address scope and subnet pools</title>
      <procedure>
        <step>
          <para>Create an address scope. The provider (external) and self-service networks
                            must belong to the same address scope for the agent to advertise those
                            self-service network prefixes.</para>
          <screen language="console">$ openstack address scope create --share --ip-version 4 bgp

+------------+--------------------------------------+
| Field      | Value                                |
+------------+--------------------------------------+
| headers    |                                      |
| id         | f71c958f-dbe8-49a2-8fb9-19c5f52a37f1 |
| ip_version | 4                                    |
| name       | bgp                                  |
| project_id | 86acdbd1d72745fd8e8320edd7543400     |
| shared     | True                                 |
+------------+--------------------------------------+</screen>
        </step>
        <step>
          <para>Create subnet pools. The provider and self-service networks use different
                            pools.</para>
          <itemizedlist>
            <listitem>
              <para>Create the provider network pool.</para>
              <screen language="console">$ openstack subnet pool create --pool-prefix 203.0.113.0/24 \
  --address-scope bgp provider

+-------------------+--------------------------------------+
| Field             | Value                                |
+-------------------+--------------------------------------+
| address_scope_id  | f71c958f-dbe8-49a2-8fb9-19c5f52a37f1 |
| created_at        | 2017-01-12T14:58:57Z                 |
| default_prefixlen | 8                                    |
| default_quota     | None                                 |
| description       |                                      |
| headers           |                                      |
| id                | 63532225-b9a0-445a-9935-20a15f9f68d1 |
| ip_version        | 4                                    |
| is_default        | False                                |
| max_prefixlen     | 32                                   |
| min_prefixlen     | 8                                    |
| name              | provider                             |
| prefixes          | 203.0.113.0/24                       |
| project_id        | 86acdbd1d72745fd8e8320edd7543400     |
| revision_number   | 1                                    |
| shared            | False                                |
| updated_at        | 2017-01-12T14:58:57Z                 |
+-------------------+--------------------------------------+</screen>
            </listitem>
            <listitem>
              <para>Create the self-service network pool.</para>
              <screen language="console">$ openstack subnet pool create --pool-prefix 192.0.2.0/25 \
  --pool-prefix 192.0.2.128/25 --address-scope bgp \
  --share selfservice

+-------------------+--------------------------------------+
| Field             | Value                                |
+-------------------+--------------------------------------+
| address_scope_id  | f71c958f-dbe8-49a2-8fb9-19c5f52a37f1 |
| created_at        | 2017-01-12T15:02:31Z                 |
| default_prefixlen | 8                                    |
| default_quota     | None                                 |
| description       |                                      |
| headers           |                                      |
| id                | 8d8270b1-b194-4b7e-914c-9c741dcbd49b |
| ip_version        | 4                                    |
| is_default        | False                                |
| max_prefixlen     | 32                                   |
| min_prefixlen     | 8                                    |
| name              | selfservice                          |
| prefixes          | 192.0.2.0/25, 192.0.2.128/25         |
| project_id        | 86acdbd1d72745fd8e8320edd7543400     |
| revision_number   | 1                                    |
| shared            | True                                 |
| updated_at        | 2017-01-12T15:02:31Z                 |
+-------------------+--------------------------------------+</screen>
            </listitem>
          </itemizedlist>
        </step>
      </procedure>
    </section>
    <section>
      <title>Create the provider and self-service networks</title>
      <procedure>
        <step>
          <para>Create the provider network.</para>
          <screen language="console">$ openstack network create provider --external --provider-physical-network \
  provider --provider-network-type flat
Created a new network:
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | UP                                   |
| availability_zone_hints   |                                      |
| availability_zones        |                                      |
| created_at                | 2016-12-21T08:47:41Z                 |
| description               |                                      |
| headers                   |                                      |
| id                        | 190ca651-2ee3-4a4b-891f-dedda47974fe |
| ipv4_address_scope        | None                                 |
| ipv6_address_scope        | None                                 |
| is_default                | False                                |
| mtu                       | 1450                                 |
| name                      | provider                             |
| port_security_enabled     | True                                 |
| project_id                | c961a8f6d3654657885226378ade8220     |
| provider:network_type     | flat                                 |
| provider:physical_network | provider                             |
| provider:segmentation_id  | 66                                   |
| revision_number           | 3                                    |
| router:external           | External                             |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   |                                      |
| tags                      | []                                   |
| updated_at                | 2016-12-21T08:47:41Z                 |
+---------------------------+--------------------------------------+</screen>
        </step>
        <step>
          <para>Create a subnet on the provider network using an IP address range from
                            the provider subnet pool.</para>
          <screen language="console">$ neutron subnet-create --name provider --subnetpool provider \
  --prefixlen 24 --allocation-pool start=203.0.113.11,end=203.0.113.254 \
  --gateway 203.0.113.1 provider
Created a new subnet:
+-------------------+---------------------------------------------------+
| Field             | Value                                             |
+-------------------+---------------------------------------------------+
| allocation_pools  | {"start": "203.0.113.11", "end": "203.0.113.254"} |
| cidr              | 203.0.113.0/24                                    |
| created_at        | 2016-03-17T23:17:16                               |
| description       |                                                   |
| dns_nameservers   |                                                   |
| enable_dhcp       | True                                              |
| gateway_ip        | 203.0.113.1                                       |
| host_routes       |                                                   |
| id                | 8ed65d41-2b2a-4f3a-9f92-45adb266e01a              |
| ip_version        | 4                                                 |
| ipv6_address_mode |                                                   |
| ipv6_ra_mode      |                                                   |
| name              | provider                                          |
| network_id        | 68ec148c-181f-4656-8334-8f4eb148689d              |
| subnetpool_id     | 3771c0e7-7096-46d3-a3bd-699c58e70259              |
| tenant_id         | b3ac05ef10bf441fbf4aa17f16ae1e6d                  |
| updated_at        | 2016-03-17T23:17:16                               |
+-------------------+---------------------------------------------------+</screen>
          <note>
            <para>The IP address allocation pool starting at <literal>.11</literal> improves clarity of
                                the diagrams. You can safely omit it.</para>
          </note>
        </step>
        <step>
          <para>Create the self-service networks.</para>
          <screen language="console">$ openstack network create selfservice1
Created a new network:
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | UP                                   |
| availability_zone_hints   |                                      |
| availability_zones        |                                      |
| created_at                | 2016-12-21T08:49:38Z                 |
| description               |                                      |
| headers                   |                                      |
| id                        | 9d842606-ef3d-4160-9ed9-e03fa63aed96 |
| ipv4_address_scope        | None                                 |
| ipv6_address_scope        | None                                 |
| mtu                       | 1450                                 |
| name                      | selfservice1                         |
| port_security_enabled     | True                                 |
| project_id                | c961a8f6d3654657885226378ade8220     |
| provider:network_type     | vxlan                                |
| provider:physical_network | None                                 |
| provider:segmentation_id  | 106                                  |
| revision_number           | 3                                    |
| router:external           | Internal                             |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   |                                      |
| tags                      | []                                   |
| updated_at                | 2016-12-21T08:49:38Z                 |
+---------------------------+--------------------------------------+

$ openstack network create selfservice2
Created a new network:
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | UP                                   |
| availability_zone_hints   |                                      |
| availability_zones        |                                      |
| created_at                | 2016-12-21T08:50:05Z                 |
| description               |                                      |
| headers                   |                                      |
| id                        | f85639e1-d23f-438e-b2b1-f40570d86b1c |
| ipv4_address_scope        | None                                 |
| ipv6_address_scope        | None                                 |
| mtu                       | 1450                                 |
| name                      | selfservice2                         |
| port_security_enabled     | True                                 |
| project_id                | c961a8f6d3654657885226378ade8220     |
| provider:network_type     | vxlan                                |
| provider:physical_network | None                                 |
| provider:segmentation_id  | 21                                   |
| revision_number           | 3                                    |
| router:external           | Internal                             |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   |                                      |
| tags                      | []                                   |
| updated_at                | 2016-12-21T08:50:05Z                 |
+---------------------------+--------------------------------------+

$ openstack network create selfservice3
Created a new network:
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | UP                                   |
| availability_zone_hints   |                                      |
| availability_zones        |                                      |
| created_at                | 2016-12-21T08:50:35Z                 |
| description               |                                      |
| headers                   |                                      |
| id                        | eeccdb82-5cf4-4999-8ab3-e7dc99e7d43b |
| ipv4_address_scope        | None                                 |
| ipv6_address_scope        | None                                 |
| mtu                       | 1450                                 |
| name                      | selfservice3                         |
| port_security_enabled     | True                                 |
| project_id                | c961a8f6d3654657885226378ade8220     |
| provider:network_type     | vxlan                                |
| provider:physical_network | None                                 |
| provider:segmentation_id  | 86                                   |
| revision_number           | 3                                    |
| router:external           | Internal                             |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   |                                      |
| tags                      | []                                   |
| updated_at                | 2016-12-21T08:50:35Z                 |
+---------------------------+--------------------------------------+</screen>
        </step>
        <step>
          <para>Create a subnet on the first two self-service networks using an IP address
                            range from the self-service subnet pool.</para>
          <screen language="console">$ neutron subnet-create --name selfservice1 --subnetpool selfservice \
  --prefixlen 25 selfservice1
Created a new subnet:
+-------------------+----------------------------------------------------+
| Field             | Value                                              |
+-------------------+----------------------------------------------------+
| allocation_pools  | {"start": "192.0.2.2", "end": "192.0.2.127"}       |
| cidr              | 192.0.2.0/25                                       |
| created_at        | 2016-03-17T23:20:20                                |
| description       |                                                    |
| dns_nameservers   |                                                    |
| enable_dhcp       | True                                               |
| gateway_ip        | 198.51.100.1                                       |
| host_routes       |                                                    |
| id                | 8edd3dc2-df40-4d71-816e-a4586d61c809               |
| ip_version        | 4                                                  |
| ipv6_address_mode |                                                    |
| ipv6_ra_mode      |                                                    |
| name              | selfservice1                                       |
| network_id        | be79de1e-5f56-11e6-9dfb-233e41cec48c               |
| subnetpool_id     | c7e9737a-cfd3-45b5-a861-d1cee1135a92               |
| tenant_id         | b3ac05ef10bf441fbf4aa17f16ae1e6d                   |
| updated_at        | 2016-03-17T23:20:20                                |
+-------------------+----------------------------------------------------+

$ neutron subnet-create --name selfservice2 --subnetpool selfservice \
  --prefixlen 25 selfservice2
Created a new subnet:
+-------------------+------------------------------------------------+
| Field             | Value                                          |
+-------------------+------------------------------------------------+
| allocation_pools  | {"start": "192.0.2.130", "end": "192.0.2.254"} |
| cidr              | 192.0.2.128/25                                 |
| created_at        | 2016-03-17T23:20:20                            |
| description       |                                                |
| dns_nameservers   |                                                |
| enable_dhcp       | True                                           |
| gateway_ip        | 192.0.2.129                                    |
| host_routes       |                                                |
| id                | 8edd3dc2-df40-4d71-816e-a4586d61c809           |
| ip_version        | 4                                              |
| ipv6_address_mode |                                                |
| ipv6_ra_mode      |                                                |
| name              | selfservice2                                   |
| network_id        | c1fd9846-5f56-11e6-a8ac-0f998d9cc0a2           |
| subnetpool_id     | c7e9737a-cfd3-45b5-a861-d1cee1135a92           |
| tenant_id         | b3ac05ef10bf441fbf4aa17f16ae1e6d               |
| updated_at        | 2016-03-17T23:20:20                            |
+-------------------+------------------------------------------------+</screen>
        </step>
        <step>
          <para>Create a subnet on the last self-service network using an IP address
                            range outside of the address scope.</para>
          <screen language="console">$ neutron subnet-create --name subnet3 selfservice3 198.51.100.0/24
Created a new subnet:
+-------------------+----------------------------------------------------+
| Field             | Value                                              |
+-------------------+----------------------------------------------------+
| allocation_pools  | {"start": "198.51.100.2", "end": "198.51.100.254"} |
| cidr              | 198.51.100.0/24                                    |
| created_at        | 2016-03-17T23:20:20                                |
| description       |                                                    |
| dns_nameservers   |                                                    |
| enable_dhcp       | True                                               |
| gateway_ip        | 198.51.100.1                                       |
| host_routes       |                                                    |
| id                | cd9f9156-5f59-11e6-aeec-172ec7ee939a               |
| ip_version        | 4                                                  |
| ipv6_address_mode |                                                    |
| ipv6_ra_mode      |                                                    |
| name              | selfservice3                                       |
| network_id        | c283dc1c-5f56-11e6-bfb6-efc30e1eb73b               |
| subnetpool_id     |                                                    |
| tenant_id         | b3ac05ef10bf441fbf4aa17f16ae1e6d                   |
| updated_at        | 2016-03-17T23:20:20                                |
+-------------------+----------------------------------------------------+</screen>
        </step>
      </procedure>
    </section>
    <section>
      <title>Create and configure the routers</title>
      <procedure>
        <step>
          <para>Create the routers.</para>
          <screen language="console">$ openstack router create router1
+-------------------------+--------------------------------------+
| Field                   | Value                                |
+-------------------------+--------------------------------------+
| admin_state_up          | UP                                   |
| availability_zone_hints |                                      |
| availability_zones      |                                      |
| created_at              | 2017-01-10T13:15:19Z                 |
| description             |                                      |
| distributed             | False                                |
| external_gateway_info   | null                                 |
| flavor_id               | None                                 |
| ha                      | False                                |
| headers                 |                                      |
| id                      | 3f6f4ef8-63be-11e6-bbb3-2fbcef363ab8 |
| name                    | router1                              |
| project_id              | b3ac05ef10bf441fbf4aa17f16ae1e6d     |
| revision_number         | 1                                    |
| routes                  |                                      |
| status                  | ACTIVE                               |
| updated_at              | 2017-01-10T13:15:19Z                 |
+-------------------------+--------------------------------------+

$ openstack router create router2
+-------------------------+--------------------------------------+
| Field                   | Value                                |
+-------------------------+--------------------------------------+
| admin_state_up          | UP                                   |
| availability_zone_hints |                                      |
| availability_zones      |                                      |
| created_at              | 2017-01-10T13:15:19Z                 |
| description             |                                      |
| distributed             | False                                |
| external_gateway_info   | null                                 |
| flavor_id               | None                                 |
| ha                      | False                                |
| headers                 |                                      |
| id                      | 3fd21a60-63be-11e6-9c95-5714c208c499 |
| name                    | router2                              |
| project_id              | b3ac05ef10bf441fbf4aa17f16ae1e6d     |
| revision_number         | 1                                    |
| routes                  |                                      |
| status                  | ACTIVE                               |
| updated_at              | 2017-01-10T13:15:19Z                 |
+-------------------------+--------------------------------------+

$ openstack router create router3
+-------------------------+--------------------------------------+
| Field                   | Value                                |
+-------------------------+--------------------------------------+
| admin_state_up          | UP                                   |
| availability_zone_hints |                                      |
| availability_zones      |                                      |
| created_at              | 2017-01-10T13:15:19Z                 |
| description             |                                      |
| distributed             | False                                |
| external_gateway_info   | null                                 |
| flavor_id               | None                                 |
| ha                      | False                                |
| headers                 |                                      |
| id                      | 40069a4c-63be-11e6-9ecc-e37c1eaa7e84 |
| name                    | router3                              |
| project_id              | b3ac05ef10bf441fbf4aa17f16ae1e6d     |
| revision_number         | 1                                    |
| routes                  |                                      |
| status                  | ACTIVE                               |
| updated_at              | 2017-01-10T13:15:19Z                 |
+-------------------------+--------------------------------------+</screen>
        </step>
        <step>
          <para>For each router, add one self-service subnet as an interface on the router.</para>
          <screen language="console">$ neutron router-interface-add router1 selfservice1
Added interface 90e3880a-5f5c-11e6-914c-9f3e20c8c151 to router router1.

$ neutron router-interface-add router2 selfservice2
Added interface 91628362-5f5c-11e6-826a-7322fb03a821 to router router2.

$ neutron router-interface-add router3 selfservice3
Added interface 91d51044-5f5c-11e6-bf55-ffd180541cc2 to router router3.</screen>
        </step>
        <step>
          <para>Add the provider network as a gateway on each router.</para>
          <screen language="console">$ neutron router-gateway-set router1 provider
Set gateway for router router1

$ neutron router-gateway-set router2 provider
Set gateway for router router2

$ neutron router-gateway-set router3 provider
Set gateway for router router3</screen>
        </step>
      </procedure>
    </section>
    <section>
      <title>Create and configure the BGP speaker</title>
      <para>The BGP speaker advertises the next-hop IP address for eligible self-service
                    networks and floating IP addresses for instances using those networks.</para>
      <procedure>
        <step>
          <para>Create the BGP speaker.</para>
          <screen language="console">$ neutron bgp-speaker-create --ip-version 4 \
  --local-as LOCAL_AS bgpspeaker
Created a new bgp_speaker:
+-----------------------------------+--------------------------------------+
| Field                             | Value                                |
+-----------------------------------+--------------------------------------+
| advertise_floating_ip_host_routes | True                                 |
| advertise_tenant_networks         | True                                 |
| id                                | 5f227f14-4f46-4eca-9524-fc5a1eabc358 |
| ip_version                        | 4                                    |
| local_as                          | 1234                                 |
| name                              | bgpspeaker                           |
| networks                          |                                      |
| peers                             |                                      |
| tenant_id                         | b3ac05ef10bf441fbf4aa17f16ae1e6d     |
+-----------------------------------+--------------------------------------+</screen>
          <para>Replace <literal>LOCAL_AS</literal> with an appropriate local autonomous system number.
                            The example configuration uses AS 1234.</para>
        </step>
        <step>
          <para>A BGP speaker requires association with a provider network to determine
                            eligible prefixes. The association builds a list of all virtual routers
                            with gateways on provider and self-service networks in the same address
                            scope so the BGP speaker can advertise self-service network prefixes with
                            the corresponding router as the next-hop IP address. Associate the BGP
                            speaker with the provider network.</para>
          <screen language="console">$ neutron bgp-speaker-network-add bgpspeaker provider
Added network provider to BGP speaker bgpspeaker.</screen>
        </step>
        <step>
          <para>Verify association of the provider network with the BGP speaker.</para>
          <screen language="console">$ neutron bgp-speaker-show bgpspeaker
+-----------------------------------+--------------------------------------+
| Field                             | Value                                |
+-----------------------------------+--------------------------------------+
| advertise_floating_ip_host_routes | True                                 |
| advertise_tenant_networks         | True                                 |
| id                                | 5f227f14-4f46-4eca-9524-fc5a1eabc358 |
| ip_version                        | 4                                    |
| local_as                          | 1234                                 |
| name                              | bgpspeaker                           |
| networks                          | 68ec148c-181f-4656-8334-8f4eb148689d |
| peers                             |                                      |
| tenant_id                         | b3ac05ef10bf441fbf4aa17f16ae1e6d     |
+-----------------------------------+--------------------------------------+</screen>
        </step>
        <step>
          <para>Verify the prefixes and next-hop IP addresses that the BGP speaker
                            advertises.</para>
          <screen language="console">$ neutron bgp-speaker-advertiseroute-list bgpspeaker
+-----------------+--------------+
| destination     | next_hop     |
+-----------------+--------------+
| 192.0.2.0/25    | 203.0.113.11 |
| 192.0.2.128/25  | 203.0.113.12 |
+-----------------+--------------+</screen>
        </step>
        <step>
          <para>Create a BGP peer.</para>
          <screen language="console">$ neutron bgp-peer-create --peer-ip 192.0.2.1 \
  --remote-as REMOTE_AS bgppeer
Created a new bgp_peer:
+-----------+--------------------------------------+
| Field     | Value                                |
+-----------+--------------------------------------+
| auth_type | none                                 |
| id        | 35c89ca0-ac5a-4298-a815-0b073c2362e9 |
| name      | bgppeer                              |
| peer_ip   | 192.0.2.1                            |
| remote_as | 4321                                 |
| tenant_id | b3ac05ef10bf441fbf4aa17f16ae1e6d     |
+-----------+--------------------------------------+</screen>
          <para>Replace <literal>REMOTE_AS</literal> with an appropriate remote autonomous system number.
                            The example configuration uses AS 4321 which triggers EBGP peering.</para>
          <note>
            <para>The host containing the BGP agent must have layer-3 connectivity to
                                the provider router.</para>
          </note>
        </step>
        <step>
          <para>Add a BGP peer to the BGP speaker.</para>
          <screen language="console">$ neutron bgp-speaker-peer-add bgpspeaker bgppeer
Added BGP peer bgppeer to BGP speaker bgpspeaker.</screen>
        </step>
        <step>
          <para>Verify addition of the BGP peer to the BGP speaker.</para>
          <screen language="console">$ neutron bgp-speaker-show bgpspeaker
+-----------------------------------+--------------------------------------+
| Field                             | Value                                |
+-----------------------------------+--------------------------------------+
| advertise_floating_ip_host_routes | True                                 |
| advertise_tenant_networks         | True                                 |
| id                                | 5f227f14-4f46-4eca-9524-fc5a1eabc358 |
| ip_version                        | 4                                    |
| local_as                          | 1234                                 |
| name                              | bgpspeaker                           |
| networks                          | 68ec148c-181f-4656-8334-8f4eb148689d |
| peers                             | 35c89ca0-ac5a-4298-a815-0b073c2362e9 |
| tenant_id                         | b3ac05ef10bf441fbf4aa17f16ae1e6d     |
+-----------------------------------+--------------------------------------+</screen>
          <note>
            <para>After creating a peering session, you cannot change the local or remote
                                autonomous system numbers.</para>
          </note>
        </step>
      </procedure>
    </section>
    <section>
      <title>Schedule the BGP speaker to an agent</title>
      <procedure>
        <step>
          <para>Unlike most agents, BGP speakers require manual scheduling to an agent.
                            BGP speakers only form peering sessions and begin prefix advertisement
                            after scheduling to an agent. Schedule the BGP speaker to agent
                            <literal>37729181-2224-48d8-89ef-16eca8e2f77e</literal>.</para>
          <screen language="console">$ neutron bgp-dragent-speaker-add 37729181-2224-48d8-89ef-16eca8e2f77e bgpspeaker
Associated BGP speaker bgpspeaker to the Dynamic Routing agent.</screen>
        </step>
        <step>
          <para>Verify scheduling of the BGP speaker to the agent.</para>
          <screen language="console">$ neutron bgp-dragent-list-hosting-speaker bgpspeaker
+--------------------------------------+------------+----------------+-------+
| id                                   | host       | admin_state_up | alive |
+--------------------------------------+------------+----------------+-------+
| 37729181-2224-48d8-89ef-16eca8e2f77e | controller | True           | :-)   |
+--------------------------------------+------------+----------------+-------+

$ neutron bgp-speaker-list-on-dragent 37729181-2224-48d8-89ef-16eca8e2f77e
+--------------------------------------+------------+----------+------------+
| id                                   | name       | local_as | ip_version |
+--------------------------------------+------------+----------+------------+
| 5f227f14-4f46-4eca-9524-fc5a1eabc358 | bgpspeaker |     1234 |          4 |
+--------------------------------------+------------+----------+------------+</screen>
        </step>
      </procedure>
    </section>
  </section>
  <section>
    <title>Prefix advertisement</title>
    <para>BGP dynamic routing advertises prefixes for self-service networks and host
                routes for floating IP addresses.</para>
    <para>Advertisement of a self-service network requires satisfying the following
                conditions:</para>
    <itemizedlist>
      <listitem>
        <para>The external and self-service network reside in the same address scope.</para>
      </listitem>
      <listitem>
        <para>The router contains an interface on the self-service subnet and a gateway
                        on the external network.</para>
      </listitem>
      <listitem>
        <para>The BGP speaker associates with the external network that provides a
                        gateway on the router.</para>
      </listitem>
      <listitem>
        <para>The BGP speaker has the <literal>advertise_tenant_networks</literal> attribute set to
                        <literal>True</literal>.</para>
      </listitem>
    </itemizedlist>
    <informalfigure>
      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="bgp-dynamic-routing-example1.png"/>
        </imageobject>
        <imageobject role="html">
          <imagedata fileref="bgp-dynamic-routing-example1.png"/>
        </imageobject>
      </mediaobject>
    </informalfigure>
    <para>Advertisement of a floating IP address requires satisfying the following
                conditions:</para>
    <itemizedlist>
      <listitem>
        <para>The router with the floating IP address binding contains a gateway on
                        an external network with the BGP speaker association.</para>
      </listitem>
      <listitem>
        <para>The BGP speaker has the <literal>advertise_floating_ip_host_routes</literal> attribute
                        set to <literal>True</literal>.</para>
      </listitem>
    </itemizedlist>
    <informalfigure>
      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="bgp-dynamic-routing-example2.png"/>
        </imageobject>
        <imageobject role="html">
          <imagedata fileref="bgp-dynamic-routing-example2.png"/>
        </imageobject>
      </mediaobject>
    </informalfigure>
  </section>
  <section>
    <title>Operation with Distributed Virtual Routers (DVR)</title>
    <para>In deployments using DVR, the BGP speaker advertises floating IP
                addresses and self-service networks differently. For floating IP
                addresses, the BGP speaker advertises the floating IP agent gateway
                on the corresponding compute node as the next-hop IP address. For
                self-service networks using SNAT, the BGP speaker advertises the
                DVR SNAT node as the next-hop IP address.</para>
    <para>For example, consider the following components:</para>
    <procedure>
      <step>
        <para>A provider network using IP address range 203.0.113.0/24, and supporting
                        floating IP addresses 203.0.113.101, 203.0.113.102, and 203.0.113.103.</para>
      </step>
      <step>
        <para>A self-service network using IP address range 198.51.100.0/24.</para>
      </step>
      <step>
        <para>The SNAT gateway resides on 203.0.113.11.</para>
      </step>
      <step>
        <para>The floating IP agent gateways (one per compute node) reside on
                        203.0.113.12, 203.0.113.13, and 203.0.113.14.</para>
      </step>
      <step>
        <para>Three instances, one per compute node, each with a floating IP
                        address.</para>
      </step>
    </procedure>
    <screen language="console">$ neutron bgp-speaker-advertiseroute-list bgpspeaker
+------------------+--------------+
| destination      | next_hop     |
+------------------+--------------+
| 198.51.100.0/24  | 203.0.113.11 |
| 203.0.113.101/32 | 203.0.113.12 |
| 203.0.113.102/32 | 203.0.113.13 |
| 203.0.113.103/32 | 203.0.113.14 |
+------------------+--------------+</screen>
    <note>
      <para>DVR lacks support for routing directly to a fixed IP address via the
                    floating IP agent gateway port and thus prevents the BGP speaker from
                    advertising fixed IP addresses.</para>
    </note>
    <para>You can also identify floating IP agent gateways in your environment to
                assist with verifying operation of the BGP speaker.</para>
    <screen language="console"><?dbsuse-fo font-size="8pt"?>$ neutron port-list --device_owner="network:floatingip_agent_gateway"
+--------------------------------------+------+-------------------+--------------------------------------------------------------------------------------------------------+
| id                                   | name | mac_address       | fixed_ips                                                                                              |
+--------------------------------------+------+-------------------+--------------------------------------------------------------------------------------------------------+
| 87cf2970-4970-462e-939e-00e808295dfa |      | fa:16:3e:7c:68:e3 | {"subnet_id": "8ed65d41-2b2a-4f3a-9f92-45adb266e01a", "ip_address": "203.0.113.12"}                    |
| 8d218440-0d2e-49d0-8a7b-3266a6146dc1 |      | fa:16:3e:9d:78:cf | {"subnet_id": "8ed65d41-2b2a-4f3a-9f92-45adb266e01a", "ip_address": "203.0.113.13"}                    |
| 87cf2970-4970-462e-939e-00e802281dfa |      | fa:16:3e:6b:18:e0 | {"subnet_id": "8ed65d41-2b2a-4f3a-9f92-45adb266e01a", "ip_address": "203.0.113.14"}                    |
+--------------------------------------+------+-------------------+--------------------------------------------------------------------------------------------------------+</screen>
  </section>
  <section>
    <title>IPv6</title>
    <para>BGP dynamic routing supports peering via IPv6 and advertising IPv6 prefixes.</para>
    <itemizedlist>
      <listitem>
        <para>To enable peering via IPv6, create a BGP peer and use an IPv6 address for
                        <literal>peer_ip</literal>.</para>
      </listitem>
      <listitem>
        <para>To enable advertising IPv6 prefixes, create an address scope with
                        <literal>ip_version=6</literal> and a BGP speaker with <literal>ip_version=6</literal>.</para>
      </listitem>
    </itemizedlist>
    <note>
      <para>DVR with IPv6 functions similarly to DVR with IPv4.</para>
    </note>
  </section>
  <section>
    <title>High availability</title>
    <para>BGP dynamic routing supports scheduling a BGP speaker to multiple agents
                which effectively multiplies prefix advertisements to the same peer. If
                an agent fails, the peer continues to receive advertisements from one or
                more operational agents.</para>
    <procedure>
      <step>
        <para>Show available dynamic routing agents.</para>
        <screen language="console"><?dbsuse-fo font-size="8pt"?>$ neutron agent-list --agent-type="BGP dynamic routing agent"
+--------------------------------------+---------------------------+----------+-------------------+-------+----------------+---------------------------+
| id                                   | agent_type                | host     | availability_zone | alive | admin_state_up | binary                    |
+--------------------------------------+---------------------------+----------+-------------------+-------+----------------+---------------------------+
| 37729181-2224-48d8-89ef-16eca8e2f77e | BGP dynamic routing agent | bgp-ha1  |                   | :-)   | True           | neutron-bgp-dragent       |
| 1a2d33bb-9321-30a2-76ab-22eff3d2f56a | BGP dynamic routing agent | bgp-ha2  |                   | :-)   | True           | neutron-bgp-dragent       |
+--------------------------------------+---------------------------+----------+-------------------+-------+----------------+---------------------------+</screen>
      </step>
      <step>
        <para>Schedule BGP speaker to multiple agents.</para>
        <screen language="console">$ neutron bgp-dragent-speaker-add 37729181-2224-48d8-89ef-16eca8e2f77e bgpspeaker
Associated BGP speaker bgpspeaker to the Dynamic Routing agent.

$ neutron bgp-dragent-speaker-add 1a2d33bb-9321-30a2-76ab-22eff3d2f56a bgpspeaker
Associated BGP speaker bgpspeaker to the Dynamic Routing agent.

$ neutron bgp-dragent-list-hosting-speaker bgpspeaker
+--------------------------------------+---------+----------------+-------+
| id                                   | host    | admin_state_up | alive |
+--------------------------------------+---------+----------------+-------+
| 37729181-2224-48d8-89ef-16eca8e2f77e | bgp-ha1 | True           | :-)   |
| 1a2d33bb-9321-30a2-76ab-22eff3d2f56a | bgp-ha2 | True           | :-)   |
+--------------------------------------+---------+----------------+-------+

$ neutron bgp-speaker-list-on-dragent 37729181-2224-48d8-89ef-16eca8e2f77e
+--------------------------------------+------------+----------+------------+
| id                                   | name       | local_as | ip_version |
+--------------------------------------+------------+----------+------------+
| 5f227f14-4f46-4eca-9524-fc5a1eabc358 | bgpspeaker |     1234 |          4 |
+--------------------------------------+------------+----------+------------+

$ neutron bgp-speaker-list-on-dragent 1a2d33bb-9321-30a2-76ab-22eff3d2f56a
+--------------------------------------+------------+----------+------------+
| id                                   | name       | local_as | ip_version |
+--------------------------------------+------------+----------+------------+
| 5f227f14-4f46-4eca-9524-fc5a1eabc358 | bgpspeaker |     1234 |          4 |
+--------------------------------------+------------+----------+------------+</screen>
      </step>
    </procedure>
  </section>
</section>
