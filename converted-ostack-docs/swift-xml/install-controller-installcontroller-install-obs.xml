<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Install and configure the controller node for openSUSE and SUSE Linux Enterprise</title>
  <para>This section describes how to install and configure the proxy service that
            handles requests for the account, container, and object services operating
            on the storage nodes. For simplicity, this guide installs and configures
            the proxy service on the controller node. However, you can run the proxy
            service on any node with network connectivity to the storage nodes.
            Additionally, you can install and configure the proxy service on multiple
            nodes to increase performance and redundancy. For more information, see the
            <link xlink:href="http://docs.openstack.org/developer/swift/deployment_guide.html">Deployment Guide</link>.</para>
  <para>This section applies to openSUSE Leap 42.2 and SUSE Linux Enterprise Server
            12 SP2.</para>
  <section>
    <title>Prerequisites</title>
    <para>The proxy service relies on an authentication and authorization mechanism such
                as the Identity service. However, unlike other services, it also offers an
                internal mechanism that allows it to operate without any other OpenStack
                services. Before you configure the Object Storage service, you must
                create service credentials and an API endpoint.</para>
    <note>
      <para>The Object Storage service does not use an SQL database on the controller
                    node. Instead, it uses distributed SQLite databases on each storage node.</para>
    </note>
    <procedure>
      <step>
        <para>Source the <literal>admin</literal> credentials to gain access to admin-only CLI commands:</para>
        <screen language="console">$ . admin-openrc</screen>
      </step>
      <step>
        <para>To create the Identity service credentials, complete these steps:</para>
        <itemizedlist>
          <listitem>
            <para>Create the <literal>swift</literal> user:</para>
            <screen language="console">$ openstack user create --domain default --password-prompt swift
User Password:
Repeat User Password:
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | default                          |
| enabled   | True                             |
| id        | d535e5cbd2b74ac7bfb97db9cced3ed6 |
| name      | swift                            |
+-----------+----------------------------------+</screen>
          </listitem>
          <listitem>
            <para>Add the <literal>admin</literal> role to the <literal>swift</literal> user:</para>
            <screen language="console">$ openstack role add --project service --user swift admin</screen>
            <note>
              <para>This command provides no output.</para>
            </note>
          </listitem>
          <listitem>
            <para>Create the <literal>swift</literal> service entity:</para>
            <screen language="console">$ openstack service create --name swift \
  --description "OpenStack Object Storage" object-store
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Object Storage         |
| enabled     | True                             |
| id          | 75ef509da2c340499d454ae96a2c5c34 |
| name        | swift                            |
| type        | object-store                     |
+-------------+----------------------------------+</screen>
          </listitem>
        </itemizedlist>
      </step>
      <step>
        <para>Create the Object Storage service API endpoints:</para>
        <screen language="console">$ openstack endpoint create --region RegionOne \
  object-store public http://controller:8080/v1/AUTH_%\(project_id\)s
+--------------+----------------------------------------------+
| Field        | Value                                        |
+--------------+----------------------------------------------+
| enabled      | True                                         |
| id           | 12bfd36f26694c97813f665707114e0d             |
| interface    | public                                       |
| region       | RegionOne                                    |
| region_id    | RegionOne                                    |
| service_id   | 75ef509da2c340499d454ae96a2c5c34             |
| service_name | swift                                        |
| service_type | object-store                                 |
| url          | http://controller:8080/v1/AUTH_%(project_id)s |
+--------------+----------------------------------------------+

$ openstack endpoint create --region RegionOne \
  object-store internal http://controller:8080/v1/AUTH_%\(project_id\)s
+--------------+----------------------------------------------+
| Field        | Value                                        |
+--------------+----------------------------------------------+
| enabled      | True                                         |
| id           | 7a36bee6733a4b5590d74d3080ee6789             |
| interface    | internal                                     |
| region       | RegionOne                                    |
| region_id    | RegionOne                                    |
| service_id   | 75ef509da2c340499d454ae96a2c5c34             |
| service_name | swift                                        |
| service_type | object-store                                 |
| url          | http://controller:8080/v1/AUTH_%(project_id)s |
+--------------+----------------------------------------------+

$ openstack endpoint create --region RegionOne \
  object-store admin http://controller:8080/v1
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | ebb72cd6851d4defabc0b9d71cdca69b |
| interface    | admin                            |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 75ef509da2c340499d454ae96a2c5c34 |
| service_name | swift                            |
| service_type | object-store                     |
| url          | http://controller:8080/v1        |
+--------------+----------------------------------+</screen>
      </step>
    </procedure>
  </section>
  <section>
    <title>Install and configure components</title>
    <note>
      <para>Default configuration files vary by distribution. You might need
                    to add these sections and options rather than modifying existing
                    sections and options. Also, an ellipsis (<literal>...</literal>) in the configuration
                    snippets indicates potential default configuration options that you
                    should retain.</para>
    </note>
    <procedure>
      <step>
        <para>Install the packages:</para>
        <screen language="console"># zypper install openstack-swift-proxy python-swiftclient \
  python-keystoneclient python-keystonemiddleware \
  python-xml memcached</screen>
        <note>
          <para>Complete OpenStack environments already include some of these
                            packages.</para>
        </note>
        <procedure>
          <step>
            <para>Edit the <literal>/etc/swift/proxy-server.conf</literal> file and complete the
                                following actions:</para>
            <itemizedlist>
              <listitem>
                <para>In the <literal>[DEFAULT]</literal> section, configure the bind port, user, and
                                        configuration directory:</para>
                <screen language="none">[DEFAULT]
...
bind_port = 8080
user = swift
swift_dir = /etc/swift</screen>
              </listitem>
              <listitem>
                <para>In the <literal>[pipeline:main]</literal> section, remove the <literal>tempurl</literal> and
                                        <literal>tempauth</literal> modules and add the <literal>authtoken</literal> and <literal>keystoneauth</literal>
                                        modules:</para>
                <screen language="none"><?dbsuse-fo font-size="8pt"?>[pipeline:main]
pipeline = catch_errors gatekeeper healthcheck proxy-logging cache container_sync bulk ratelimit authtoken keystoneauth container-quotas account-quotas slo dlo versioned_writes proxy-logging proxy-server</screen>
                <note>
                  <para>Do not change the order of the modules.</para>
                </note>
                <note>
                  <para>For more information on other modules that enable additional features,
                                            see the <link xlink:href="http://docs.openstack.org/developer/swift/deployment_guide.html">Deployment Guide</link>.</para>
                </note>
              </listitem>
              <listitem>
                <para>In the <literal>[app:proxy-server]</literal> section, enable automatic account creation:</para>
                <screen language="console">[app:proxy-server]
use = egg:swift#proxy
...
account_autocreate = True</screen>
              </listitem>
              <listitem>
                <para>In the <literal>[filter:keystoneauth]</literal> section, configure the operator roles:</para>
                <screen language="console">[filter:keystoneauth]
use = egg:swift#keystoneauth
...
operator_roles = admin,user</screen>
              </listitem>
              <listitem>
                <para>In the <literal>[filter:authtoken]</literal> section, configure Identity service access:</para>
                <screen language="none">[filter:authtoken]
paste.filter_factory = keystonemiddleware.auth_token:filter_factory
...
auth_uri = http://controller:5000
auth_url = http://controller:35357
memcached_servers = controller:11211
auth_type = password
project_domain_id = default
user_domain_id = default
project_name = service
username = swift
password = SWIFT_PASS
delay_auth_decision = True</screen>
                <para>Replace <literal>SWIFT_PASS</literal> with the password you chose for the <literal>swift</literal> user
                                        in the Identity service.</para>
                <note>
                  <para>Comment out or remove any other options in the <literal>[filter:authtoken]</literal>
                                            section.</para>
                </note>
              </listitem>
              <listitem>
                <para>In the <literal>[filter:cache]</literal> section, configure the <literal>memcached</literal> location:</para>
                <screen language="none">[filter:cache]
use = egg:swift#memcache
...
memcache_servers = controller:11211</screen>
              </listitem>
            </itemizedlist>
          </step>
        </procedure>
      </step>
    </procedure>
  </section>
</section>
