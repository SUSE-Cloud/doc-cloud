<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Troubleshooting tips</title>
  <section>
    <title>Diagnose: Customer complains they receive a HTTP status 500 when trying to browse containers</title>
    <para>This entry is prompted by a real customer issue and exclusively focused on how
                that problem was identified.
                There are many reasons why a http status of 500 could be returned. If
                there are no obvious problems with the swift object store, then it may
                be necessary to take a closer look at the users transactions.
                After finding the users swift account, you can
                search the swift proxy logs on each swift proxy server for
                transactions from this user. The linux <literal>bzgrep</literal> command can be used to
                search all the proxy log files on a node including the <literal>.bz2</literal> compressed
                files. For example:</para>
    <screen><?dbsuse-fo font-size="8pt"?>$ PDSH_SSH_ARGS_APPEND="-o StrictHostKeyChecking=no" pdsh -l &lt;yourusername&gt; -R ssh \
  -w &lt;redacted&gt;.68.[4-11,132-139 4-11,132-139],&lt;redacted&gt;.132.[4-11,132-139] \
  'sudo bzgrep -w AUTH_redacted-4962-4692-98fb-52ddda82a5af /var/log/swift/proxy.log*' |  dshbak -c
 .
 .
 ----------------
 &lt;redacted&gt;.132.6
 ----------------
 Feb 29 08:51:57 sw-aw2az2-proxy011 proxy-server &lt;redacted&gt;.16.132
 &lt;redacted&gt;.66.8 29/Feb/2012/08/51/57 GET /v1.0/AUTH_redacted-4962-4692-98fb-52ddda82a5af
 /%3Fformat%3Djson HTTP/1.0 404 - - &lt;REDACTED&gt;_4f4d50c5e4b064d88bd7ab82 - - -
 tx429fc3be354f434ab7f9c6c4206c1dc3 - 0.0130</screen>
    <para>This shows a <literal>GET</literal> operation on the users account.</para>
    <note>
      <para>The HTTP status returned is 404, Not found, rather than 500 as reported by the user.</para>
    </note>
    <para>Using the transaction ID, <literal>tx429fc3be354f434ab7f9c6c4206c1dc3</literal> you can
                search the swift object servers log files for this transaction ID:</para>
    <screen><?dbsuse-fo font-size="8pt"?>$ PDSH_SSH_ARGS_APPEND="-o StrictHostKeyChecking=no" pdsh -l &lt;yourusername&gt; -R ssh \
  -w &lt;redacted&gt;.72.[4-67|4-67],&lt;redacted&gt;.[4-67|4-67],&lt;redacted&gt;.[4-67|4-67],&lt;redacted&gt;.204.[4-131] \
  'sudo bzgrep tx429fc3be354f434ab7f9c6c4206c1dc3 /var/log/swift/server.log*' | dshbak -c
.
.
----------------
&lt;redacted&gt;.72.16
----------------
Feb 29 08:51:57 sw-aw2az1-object013 account-server &lt;redacted&gt;.132.6 - -

[29/Feb/2012:08:51:57 +0000|] "GET /disk9/198875/AUTH_redacted-4962-4692-98fb-52ddda82a5af"
404 - "tx429fc3be354f434ab7f9c6c4206c1dc3" "-" "-"

0.0016 ""
----------------
&lt;redacted&gt;.31
----------------
Feb 29 08:51:57 node-az2-object060 account-server &lt;redacted&gt;.132.6 - -
[29/Feb/2012:08:51:57 +0000|] "GET /disk6/198875/AUTH_redacted-4962-
4692-98fb-52ddda82a5af" 404 - "tx429fc3be354f434ab7f9c6c4206c1dc3" "-" "-" 0.0011 ""
----------------
&lt;redacted&gt;.204.70
----------------

Feb 29 08:51:57 sw-aw2az3-object0067 account-server &lt;redacted&gt;.132.6 - -
[29/Feb/2012:08:51:57 +0000|] "GET /disk6/198875/AUTH_redacted-4962-
4692-98fb-52ddda82a5af" 404 - "tx429fc3be354f434ab7f9c6c4206c1dc3" "-" "-" 0.0014 ""</screen>
    <note>
      <para>The 3 GET operations to 3 different object servers that hold the 3
                    replicas of this users account. Each <literal>GET</literal> returns a HTTP status of 404,
                    Not found.</para>
    </note>
    <para>Next, use the <literal>swift-get-nodes</literal> command to determine exactly where the
                user’s account data is stored:</para>
    <screen><?dbsuse-fo font-size="8pt"?>$ sudo swift-get-nodes /etc/swift/account.ring.gz AUTH_redacted-4962-4692-98fb-52ddda82a5af
Account AUTH_redacted-4962-4692-98fb-52ddda82a5af
Container None
Object None

Partition 198875
Hash 1846d99185f8a0edaf65cfbf37439696

Server:Port Device &lt;redacted&gt;.31:6202 disk6
Server:Port Device &lt;redacted&gt;.204.70:6202 disk6
Server:Port Device &lt;redacted&gt;.72.16:6202 disk9
Server:Port Device &lt;redacted&gt;.204.64:6202 disk11 [Handoff]
Server:Port Device &lt;redacted&gt;.26:6202 disk11 [Handoff]
Server:Port Device &lt;redacted&gt;.72.27:6202 disk11 [Handoff]

curl -I -XHEAD "`http://&lt;redacted&gt;.31:6202/disk6/198875/AUTH_redacted-4962-4692-98fb-52ddda82a5af"
&lt;http://15.185.138.31:6202/disk6/198875/AUTH_db0050ad-4962-4692-98fb-52ddda82a5af&gt;`_
curl -I -XHEAD "`http://&lt;redacted&gt;.204.70:6202/disk6/198875/AUTH_redacted-4962-4692-98fb-52ddda82a5af"
&lt;http://15.185.204.70:6202/disk6/198875/AUTH_db0050ad-4962-4692-98fb-52ddda82a5af&gt;`_
curl -I -XHEAD "`http://&lt;redacted&gt;.72.16:6202/disk9/198875/AUTH_redacted-4962-4692-98fb-52ddda82a5af"
&lt;http://15.185.72.16:6202/disk9/198875/AUTH_db0050ad-4962-4692-98fb-52ddda82a5af&gt;`_
curl -I -XHEAD "`http://&lt;redacted&gt;.204.64:6202/disk11/198875/AUTH_redacted-4962-4692-98fb-52ddda82a5af"
&lt;http://15.185.204.64:6202/disk11/198875/AUTH_db0050ad-4962-4692-98fb-52ddda82a5af&gt;`_ # [Handoff]
curl -I -XHEAD "`http://&lt;redacted&gt;.26:6202/disk11/198875/AUTH_redacted-4962-4692-98fb-52ddda82a5af"
&lt;http://15.185.136.26:6202/disk11/198875/AUTH_db0050ad-4962-4692-98fb-52ddda82a5af&gt;`_ # [Handoff]
curl -I -XHEAD "`http://&lt;redacted&gt;.72.27:6202/disk11/198875/AUTH_redacted-4962-4692-98fb-52ddda82a5af"
&lt;http://15.185.72.27:6202/disk11/198875/AUTH_db0050ad-4962-4692-98fb-52ddda82a5af&gt;`_ # [Handoff]

ssh &lt;redacted&gt;.31 "ls -lah /srv/node/disk6/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/"
ssh &lt;redacted&gt;.204.70 "ls -lah /srv/node/disk6/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/"
ssh &lt;redacted&gt;.72.16 "ls -lah /srv/node/disk9/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/"
ssh &lt;redacted&gt;.204.64 "ls -lah /srv/node/disk11/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/" # [Handoff]
ssh &lt;redacted&gt;.26 "ls -lah /srv/node/disk11/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/" # [Handoff]
ssh &lt;redacted&gt;.72.27 "ls -lah /srv/node/disk11/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/" # [Handoff]</screen>
    <para>Check each of the primary servers, &lt;redacted&gt;.31, &lt;redacted&gt;.204.70  and &lt;redacted&gt;.72.16, for
                this users account. For example on &lt;redacted&gt;.72.16:</para>
    <screen><?dbsuse-fo font-size="8pt"?>$ ls -lah /srv/node/disk9/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/
total 1.0M
drwxrwxrwx 2 swift swift 98 2012-02-23 14:49 .
drwxrwxrwx 3 swift swift 45 2012-02-03 23:28 ..
-rw------- 1 swift swift 15K 2012-02-23 14:49 1846d99185f8a0edaf65cfbf37439696.db
-rw-rw-rw- 1 swift swift 0 2012-02-23 14:49 1846d99185f8a0edaf65cfbf37439696.db.pending</screen>
    <para>So this users account db, an sqlite db is present. Use sqlite to
                checkout the account:</para>
    <screen><?dbsuse-fo font-size="8pt"?>$ sudo cp /srv/node/disk9/accounts/198875/696/1846d99185f8a0edaf65cfbf37439696/1846d99185f8a0edaf65cfbf37439696.db /tmp
$ sudo sqlite3 /tmp/1846d99185f8a0edaf65cfbf37439696.db
sqlite&gt; .mode line
sqlite&gt; select * from account_stat;
account = AUTH_redacted-4962-4692-98fb-52ddda82a5af
created_at = 1328311738.42190
put_timestamp = 1330000873.61411
delete_timestamp = 1330001026.00514
container_count = 0
object_count = 0
bytes_used = 0
hash = eb7e5d0ea3544d9def940b19114e8b43
id = 2de8c8a8-cef9-4a94-a421-2f845802fe90
status = DELETED
status_changed_at = 1330001026.00514
metadata =</screen>
    <para>Next try and find the <literal>DELETE</literal> operation for this account in the proxy
                server logs:</para>
    <screen><?dbsuse-fo font-size="8pt"?>$ PDSH_SSH_ARGS_APPEND="-o StrictHostKeyChecking=no" pdsh -l &lt;yourusername&gt; -R ssh \
  -w &lt;redacted&gt;.68.[4-11,132-139 4-11,132-139],&lt;redacted&gt;.132.[4-11,132-139|4-11,132-139] \
  'sudo bzgrep AUTH_redacted-4962-4692-98fb-52ddda82a5af /var/log/swift/proxy.log* \
  | grep -w DELETE | awk "{print $3,$10,$12}"' |- dshbak -c
.
.
Feb 23 12:43:46 sw-aw2az2-proxy001 proxy-server &lt;redacted&gt; &lt;redacted&gt;.66.7 23/Feb/2012/12/43/46 DELETE /v1.0/AUTH_redacted-4962-4692-98fb-
52ddda82a5af/ HTTP/1.0 204 - Apache-HttpClient/4.1.2%20%28java%201.5%29 &lt;REDACTED&gt;_4f458ee4e4b02a869c3aad02 - - -
tx4471188b0b87406899973d297c55ab53 - 0.0086</screen>
    <para>From this you can see the operation that resulted in the account being deleted.</para>
  </section>
  <section>
    <title>Procedure: Deleting objects</title>
    <section>
      <title>Simple case - deleting small number of objects and containers</title>
      <note>
        <para><literal>swift-direct</literal> is specific to the Hewlett Packard Enterprise Helion Public Cloud.
                        Use <literal>swiftly</literal> as an alternative.</para>
      </note>
      <note>
        <para>Object and container names are in UTF8. Swift direct accepts UTF8
                        directly, not URL-encoded UTF8 (the REST API expects UTF8 and then
                        URL-encoded). In practice cut and paste of foreign language strings to
                        a terminal window will produce the right result.</para>
        <para>Hint: Use the <literal>head</literal> command before any destructive commands.</para>
      </note>
      <para>To delete a small number of objects, log into any proxy node and proceed
                    as follows:</para>
      <para>Examine the object in question:</para>
      <screen><?dbsuse-fo font-size="8pt"?>$ sudo -u swift /opt/hp/swift/bin/swift-direct head 132345678912345 container_name obj_name</screen>
      <para>See if <literal>X-Object-Manifest</literal> or <literal>X-Static-Large-Object</literal> is set,
                    then this is the manifest object and segment objects may be in another
                    container.</para>
      <para>If the <literal>X-Object-Manifest</literal> attribute is set, you need to find the
                    name of the objects this means it is a DLO. For example,
                    if <literal>X-Object-Manifest</literal> is <literal>container2/seg-blah</literal>, list the contents
                    of the container container2 as follows:</para>
      <screen>$ sudo -u swift /opt/hp/swift/bin/swift-direct show 132345678912345 container2</screen>
      <para>Pick out the objects whose names start with <literal>seg-blah</literal>.
                    Delete the segment objects as follows:</para>
      <screen><?dbsuse-fo font-size="8pt"?>$ sudo -u swift /opt/hp/swift/bin/swift-direct delete 132345678912345 container2 seg-blah01
$ sudo -u swift /opt/hp/swift/bin/swift-direct delete 132345678912345 container2 seg-blah02
etc</screen>
      <para>If <literal>X-Static-Large-Object</literal> is set, you need to read the contents. Do this by:</para>
      <itemizedlist>
        <listitem>
          <para>Using swift-get-nodes to get the details of the object’s location.</para>
        </listitem>
        <listitem>
          <para>Change the <literal>-X HEAD</literal> to <literal>-X GET</literal> and run <literal>curl</literal> against one copy.</para>
        </listitem>
        <listitem>
          <para>This lists a JSON body listing containers and object names</para>
        </listitem>
        <listitem>
          <para>Delete the objects as described above for DLO segments</para>
        </listitem>
      </itemizedlist>
      <para>Once the segments are deleted, you can delete the object using
                    <literal>swift-direct</literal> as described above.</para>
      <para>Finally, use <literal>swift-direct</literal> to delete the container.</para>
    </section>
  </section>
  <section>
    <title>Procedure: Decommissioning swift nodes</title>
    <para>Should Swift nodes need to be decommissioned (e.g.,, where they are being
                re-purposed), it is very important to follow the following steps.</para>
    <procedure>
      <step>
        <para>In the case of object servers, follow the procedure for removing
                        the node from the rings.</para>
      </step>
      <step>
        <para>In the case of swift proxy servers, have the network team remove
                        the node from the load balancers.</para>
      </step>
      <step>
        <para>Open a network ticket to have the node removed from network
                        firewalls.</para>
      </step>
      <step>
        <para>Make sure that you remove the <literal>/etc/swift</literal> directory and everything in it.</para>
      </step>
    </procedure>
  </section>
</section>
