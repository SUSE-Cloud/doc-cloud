<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Watcher User Guide</title>
  <para>See the
            <link xlink:href="https://docs.openstack.org/watcher/latest/architecture.html">architecture page</link>
            for an architectural overview of the different components of Watcher and how
            they fit together.</para>
  <para>In this guide we’re going to take you through the fundamentals of using
            Watcher.</para>
  <para>The following diagram shows the main interactions between the
            <xref linkend="administrator-definition"/> and the Watcher system:</para>
  <informalfigure>
    <mediaobject>
      <imageobject role="fo">
        <imagedata fileref="sequence_overview_watcher_usage.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
        <imagedata fileref="sequence_overview_watcher_usage.png" width="100%"/>
      </imageobject>
    </mediaobject>
  </informalfigure>
  <section>
    <title>Getting started with Watcher</title>
    <para>This guide assumes you have a working installation of Watcher. If you get
                “<emphasis>watcher: command not found</emphasis>” you may have to verify your installation.
                Please refer to the <link xlink:href="http://docs.openstack.org/developer/python-watcherclient">installation guide</link>.
                In order to use Watcher, you have to configure your credentials suitable for
                watcher command-line tools.</para>
    <para>You can interact with Watcher either by using our dedicated <link xlink:href="http://docs.openstack.org/developer/python-watcherclient/index.html">Watcher CLI</link>
                named <literal>watcher</literal>, or by using the <link xlink:href="http://docs.openstack.org/developer/python-openstackclient/man/openstack.html">OpenStack CLI</link><literal>openstack</literal>.</para>
    <para>If you want to deploy Watcher in Horizon, please refer to the <link xlink:href="http://docs.openstack.org/developer/watcher-dashboard/deploy/installation.html">Watcher Horizon
                    plugin installation guide</link>.</para>
  </section>
  <section>
    <title>Seeing what the Watcher CLI can do ?</title>
    <para>We can see all of the commands available with Watcher CLI by running the
                watcher binary without options.</para>
    <screen>$ watcher help</screen>
    <para>or:</para>
    <screen>$ openstack help optimize</screen>
  </section>
  <section>
    <title>How do I run an audit of my cluster ?</title>
    <para>First, you need to find the <xref linkend="goal-definition"/> you want to achieve:</para>
    <screen>$ watcher goal list</screen>
    <para>or:</para>
    <screen>$ openstack optimize goal list</screen>
    <note>
      <para>If you get “<emphasis>You must provide a username via either –os-username or via
                        env[OS_USERNAME]</emphasis>” you may have to verify your credentials.</para>
    </note>
    <para>Then, you can create an <xref linkend="audit-template-definition"/>.
                An <xref linkend="audit-template-definition"/> defines an optimization
                <xref linkend="goal-definition"/> to achieve (i.e. the settings of your audit).</para>
    <screen>$ watcher audittemplate create my_first_audit_template &lt;your_goal&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize audittemplate create my_first_audit_template &lt;your_goal&gt;</screen>
    <para>Although optional, you may want to actually set a specific strategy for your
                audit template. If so, you may can search of its UUID or name using the
                following command:</para>
    <screen>$ watcher strategy list --goal &lt;your_goal_uuid_or_name&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize strategy list --goal &lt;your_goal_uuid_or_name&gt;</screen>
    <para>You can use the following command to check strategy details including which
                parameters of which format it supports:</para>
    <screen>$ watcher strategy show &lt;your_strategy&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize strategy show &lt;your_strategy&gt;</screen>
    <para>The command to create your audit template would then be:</para>
    <screen>$ watcher audittemplate create my_first_audit_template &lt;your_goal&gt; \
  --strategy &lt;your_strategy&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize audittemplate create my_first_audit_template &lt;your_goal&gt; \
  --strategy &lt;your_strategy&gt;</screen>
    <para>Then, you can create an audit. An audit is a request for optimizing your
                cluster depending on the specified <xref linkend="goal-definition"/>.</para>
    <para>You can launch an audit on your cluster by referencing the
                <xref linkend="audit-template-definition"/> (i.e. the settings of your
                audit) that you want to use.</para>
    <itemizedlist>
      <listitem>
        <para>Get the <xref linkend="audit-template-definition"/> UUID or name:</para>
      </listitem>
    </itemizedlist>
    <screen>$ watcher audittemplate list</screen>
    <para>or:</para>
    <screen>$ openstack optimize audittemplate list</screen>
    <itemizedlist>
      <listitem>
        <para>Start an audit based on this <xref linkend="audit-template-definition"/> settings:</para>
      </listitem>
    </itemizedlist>
    <screen>$ watcher audit create -a &lt;your_audit_template&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize audit create -a &lt;your_audit_template&gt;</screen>
    <para>If your_audit_template was created by –strategy &lt;your_strategy&gt;, and it
                defines some parameters (command <literal>watcher strategy show</literal> to check parameters
                format), your can append <literal>-p</literal> to input required parameters:</para>
    <screen>$ watcher audit create -a &lt;your_audit_template&gt; \
  -p &lt;your_strategy_para1&gt;=5.5 -p &lt;your_strategy_para2&gt;=hi</screen>
    <para>or:</para>
    <screen>$ openstack optimize audit create -a &lt;your_audit_template&gt; \
  -p &lt;your_strategy_para1&gt;=5.5 -p &lt;your_strategy_para2&gt;=hi</screen>
    <para>Input parameter could cause audit creation failure, when:</para>
    <itemizedlist>
      <listitem>
        <para>no predefined strategy for audit template</para>
      </listitem>
      <listitem>
        <para>no parameters spec in predefined strategy</para>
      </listitem>
      <listitem>
        <para>input parameters don’t comply with spec</para>
      </listitem>
    </itemizedlist>
    <para>Watcher service will compute an <xref linkend="action-plan-definition"/>
                composed of a list of potential optimization <xref linkend="action-definition"/>
                (instance migration, disabling of a compute node, …) according to the
                <xref linkend="goal-definition"/> to achieve. You can see all of the goals
                available in section <literal>[watcher_strategies]</literal> of the Watcher service
                configuration file.</para>
    <itemizedlist>
      <listitem>
        <para>Wait until the Watcher audit has produced a new <xref linkend="action-plan-definition"/>, and get it:</para>
      </listitem>
    </itemizedlist>
    <screen>$ watcher actionplan list --audit &lt;the_audit_uuid&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize actionplan list --audit &lt;the_audit_uuid&gt;</screen>
    <itemizedlist>
      <listitem>
        <para>Have a look on the list of optimization <xref linkend="action-definition"/>
                        contained in this new <xref linkend="action-plan-definition"/>:</para>
      </listitem>
    </itemizedlist>
    <screen>$ watcher action list --action-plan &lt;the_action_plan_uuid&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize action list --action-plan &lt;the_action_plan_uuid&gt;</screen>
    <para>Once you have learned how to create an <xref linkend="action-plan-definition"/>, it’s time to go further by applying it to your
                cluster:</para>
    <itemizedlist>
      <listitem>
        <para>Execute the <xref linkend="action-plan-definition"/>:</para>
      </listitem>
    </itemizedlist>
    <screen>$ watcher actionplan start &lt;the_action_plan_uuid&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize actionplan start &lt;the_action_plan_uuid&gt;</screen>
    <para>You can follow the states of the <xref linkend="action-definition"/> by
                periodically calling:</para>
    <screen>$ watcher action list</screen>
    <para>or:</para>
    <screen>$ openstack optimize action list</screen>
    <para>You can also obtain more detailed information about a specific action:</para>
    <screen>$ watcher action show &lt;the_action_uuid&gt;</screen>
    <para>or:</para>
    <screen>$ openstack optimize action show &lt;the_action_uuid&gt;</screen>
  </section>
</section>
