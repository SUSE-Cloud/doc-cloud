<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>VM Workload Consolidation Strategy</title>
  <section>
    <title>Synopsis</title>
    <para><emphasis role="bold">display name</emphasis>: <literal>vm_workload_consolidation</literal></para>
    <para><emphasis role="bold">goal</emphasis>: <literal>vm_consolidation</literal></para>
    <para>
      <emphasis>VM Workload Consolidation Strategy</emphasis>
    </para>
    <para>A load consolidation strategy based on heuristic first-fit
                    algorithm which focuses on measured CPU utilization and tries to
                    minimize hosts which have too much or too little load respecting
                    resource capacity constraints.</para>
    <para>This strategy produces a solution resulting in more efficient
                    utilization of cluster resources using following four phases:</para>
    <itemizedlist>
      <listitem>
        <para>Offload phase - handling over-utilized resources</para>
      </listitem>
      <listitem>
        <para>Consolidation phase - handling under-utilized resources</para>
      </listitem>
      <listitem>
        <para>Solution optimization - reducing number of migrations</para>
      </listitem>
      <listitem>
        <para>Disability of unused compute nodes</para>
      </listitem>
    </itemizedlist>
    <para>A capacity coefficients (cc) might be used to adjust optimization
                    thresholds. Different resources may require different coefficient
                    values as well as setting up different coefficient values in both
                    phases may lead to to more efficient consolidation in the end.
                    If the cc equals 1 the full resource capacity may be used, cc
                    values lower than 1 will lead to resource under utilization and
                    values higher than 1 will lead to resource overbooking.
                    e.g. If targeted utilization is 80 percent of a compute node capacity,
                    the coefficient in the consolidation phase will be 0.8, but
                    may any lower value in the offloading phase. The lower it gets
                    the cluster will appear more released (distributed) for the
                    following consolidation phase.</para>
    <para>As this strategy leverages VM live migration to move the load
                    from one compute node to another, this feature needs to be set up
                    correctly on all compute nodes within the cluster.
                    This strategy assumes it is possible to live migrate any VM from
                    an active compute node to any other active compute node.</para>
  </section>
  <section>
    <title>Requirements</title>
    <section>
      <title>Metrics</title>
      <para>The <emphasis>vm_workload_consolidation</emphasis> strategy requires the following metrics:</para>
      <informaltable>
        <tgroup cols="4">
          <colspec colname="c1" colwidth="51.9*"/>
          <colspec colname="c2" colwidth="22.2*"/>
          <colspec colname="c3" colwidth="13.0*"/>
          <colspec colname="c4" colwidth="13.0*"/>
          <thead>
            <row>
              <entry>
                <para>metric</para>
              </entry>
              <entry>
                <para>service name</para>
              </entry>
              <entry>
                <para>plugins</para>
              </entry>
              <entry>
                <para>comment</para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para>
                  <literal>memory</literal>
                </para>
              </entry>
              <entry>
                <para>
                  <link xlink:href="http://docs.openstack.org/admin-guide/telemetry-measurements.html#openstack-compute">ceilometer</link>
                </para>
              </entry>
              <entry>
                <para>none</para>
              </entry>
              <entry/>
            </row>
            <row>
              <entry>
                <para>
                  <literal>disk.root.size</literal>
                </para>
              </entry>
              <entry>
                <para>
                  <link xlink:href="http://docs.openstack.org/admin-guide/telemetry-measurements.html#openstack-compute">ceilometer</link>
                </para>
              </entry>
              <entry>
                <para>none</para>
              </entry>
              <entry/>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
      <para>The following metrics are not required but increase the accuracy of
                    the strategy if available:</para>
      <informaltable>
        <tgroup cols="4">
          <colspec colname="c1" colwidth="51.9*"/>
          <colspec colname="c2" colwidth="22.2*"/>
          <colspec colname="c3" colwidth="13.0*"/>
          <colspec colname="c4" colwidth="13.0*"/>
          <thead>
            <row>
              <entry>
                <para>metric</para>
              </entry>
              <entry>
                <para>service name</para>
              </entry>
              <entry>
                <para>plugins</para>
              </entry>
              <entry>
                <para>comment</para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para>
                  <literal>memory.resident</literal>
                </para>
              </entry>
              <entry>
                <para>
                  <link xlink:href="http://docs.openstack.org/admin-guide/telemetry-measurements.html#openstack-compute">ceilometer</link>
                </para>
              </entry>
              <entry>
                <para>none</para>
              </entry>
              <entry/>
            </row>
            <row>
              <entry>
                <para>
                  <literal>cpu_util</literal>
                </para>
              </entry>
              <entry>
                <para>
                  <link xlink:href="http://docs.openstack.org/admin-guide/telemetry-measurements.html#openstack-compute">ceilometer</link>
                </para>
              </entry>
              <entry>
                <para>none</para>
              </entry>
              <entry/>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
    </section>
    <section>
      <title>Cluster data model</title>
      <para>Default Watcher’s Compute cluster data model:</para>
      <para>Nova cluster data model collector</para>
      <para>The Nova cluster data model collector creates an in-memory
                        representation of the resources exposed by the compute service.</para>
    </section>
    <section>
      <title>Actions</title>
      <para>Default Watcher’s actions:</para>
      <informaltable>
        <tgroup cols="2">
          <colspec colname="c1" colwidth="50.0*"/>
          <colspec colname="c2" colwidth="50.0*"/>
          <thead>
            <row>
              <entry>
                <para>action</para>
              </entry>
              <entry>
                <para>description</para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para>
                  <literal>migration</literal>
                </para>
              </entry>
              <entry>
                <para>Migrates a server to a destination nova-compute host</para>
                <para>This action will allow you to migrate a server to another compute
                                            destination host.
                                            Migration type ‘live’ can only be used for migrating active VMs.
                                            Migration type ‘cold’ can be used for migrating non-active VMs
                                            as well active VMs, which will be shut down while migrating.</para>
                <para>The action schema is:</para>
                <screen>schema = Schema({
 'resource_id': str,  # should be a UUID
 'migration_type': str,  # choices -&gt; "live", "cold"
 'destination_node': str,
 'source_node': str,
})</screen>
                <para>The <literal>resource_id</literal> is the UUID of the server to migrate.
                                            The <literal>source_node</literal> and <literal>destination_node</literal> parameters are respectively the
                                            source and the destination compute hostname (list of available compute
                                            hosts is returned by this command: <literal>nova service-list --binary
nova-compute</literal>).</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>change_nova_service_state</literal>
                </para>
              </entry>
              <entry>
                <para>Disables or enables the nova-compute service, deployed on a host</para>
                <para>By using this action, you will be able to update the state of a
                                            nova-compute service. A disabled nova-compute service can not be selected
                                            by the nova scheduler for future deployment of server.</para>
                <para>The action schema is:</para>
                <screen>schema = Schema({
 'resource_id': str,
 'state': str,
})</screen>
                <para>The <literal>resource_id</literal> references a nova-compute service name (list of available
                                            nova-compute services is returned by this command: <literal>nova service-list
--binary nova-compute</literal>).
                                            The <literal>state</literal> value should either be <literal>ONLINE</literal> or <literal>OFFLINE</literal>.</para>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
    </section>
    <section>
      <title>Planner</title>
      <para>Default Watcher’s planner:</para>
      <para>Weight planner implementation</para>
      <para>This implementation builds actions with parents in accordance with weights.
                        Set of actions having a higher weight will be scheduled before
                        the other ones. There are two config options to configure:
                        action_weights and parallelization.</para>
      <para>
        <emphasis>Limitations</emphasis>
      </para>
      <itemizedlist>
        <listitem>
          <para>This planner requires to have action_weights and parallelization configs
                                tuned well.</para>
        </listitem>
      </itemizedlist>
    </section>
  </section>
  <section>
    <title>Configuration</title>
    <para>Strategy parameter is:</para>
    <informaltable>
      <tgroup cols="4">
        <colspec colname="c1" colwidth="28.9*"/>
        <colspec colname="c2" colwidth="7.9*"/>
        <colspec colname="c3" colwidth="17.1*"/>
        <colspec colname="c4" colwidth="46.1*"/>
        <thead>
          <row>
            <entry>
              <para>parameter</para>
            </entry>
            <entry>
              <para>type</para>
            </entry>
            <entry>
              <para>default Value</para>
            </entry>
            <entry>
              <para>description</para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                <literal>period</literal>
              </para>
            </entry>
            <entry>
              <para>Number</para>
            </entry>
            <entry>
              <para>3600</para>
            </entry>
            <entry>
              <para>The time interval in seconds
                                    for getting statistic aggregation
                                    from metric data source</para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>
  </section>
  <section>
    <title>Efficacy Indicator</title>
    <screen>
      <para>{'name': 'released_nodes_ratio', 'description': 'Ratio of released compute nodes divided by the total number of enabled compute nodes.', 'unit': '%', 'value': 0}</para>
    </screen>
  </section>
  <section>
    <title>Algorithm</title>
    <para>For more information on the VM Workload consolidation strategy please refer to: <link xlink:href="https://specs.openstack.org/openstack/watcher-specs/specs/mitaka/implemented/zhaw-load-consolidation.html"/></para>
  </section>
  <section>
    <title>How to use it ?</title>
    <screen language="shell">$ openstack optimize audittemplate create \
  at1 server_consolidation --strategy vm_workload_consolidation

$ openstack optimize audit create -a at1</screen>
  </section>
  <section>
    <title>External Links</title>
    <para>
      <emphasis>Spec URL</emphasis>
      <link xlink:href="https://specs.openstack.org/openstack/watcher-specs/specs/mitaka/implemented/zhaw-load-consolidation.html"/>
    </para>
  </section>
</section>
