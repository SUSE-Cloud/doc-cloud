<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Using Keystone Middleware with Barbican</title>
  <section>
    <title>Prerequisites</title>
    <para>To enable Keystone integration with Barbican you’ll need a relatively current
                version of Keystone. It is sufficient if you are installing an OpenStack cloud
                where all services including Keystone and Barbican are from the same release.
                If you don’t have an instance of Keystone available, you can use one of the
                following ways to setup your own.</para>
    <procedure>
      <step>
        <para>
          <link xlink:href="https://registry.hub.docker.com/u/jmvrbanac/simple-keystone/">Simple Dockerized Keystone</link>
        </para>
      </step>
      <step>
        <para>
          <link xlink:href="http://docs.openstack.org/developer/keystone/installing.html">Installing Keystone</link>
        </para>
      </step>
      <step>
        <para>An OpenStack cloud with Keystone (Devstack in the simplest case)</para>
      </step>
    </procedure>
  </section>
  <section>
    <title>Hooking up Barbican to Keystone</title>
    <para>Assuming that you’ve already setup your Keystone instance, connecting
                Barbican to Keystone is quite simple. When completed, Barbican should
                require a valid X-Auth-Token to be provided with all API calls except
                the get version call.</para>
    <procedure>
      <step>
        <para>Turn off any active instances of Barbican</para>
      </step>
      <step>
        <para>Edit <literal>/etc/barbican/barbican-api-paste.ini</literal></para>
        <procedure>
          <step>
            <para>Change the pipeline <literal>/v1</literal> value from unauthenticated <literal>barbican_api</literal>
                                to the authenticated <literal>barbican-api-keystone</literal>. This step will not be
                                necessary on barbican from OpenStack Newton or higher, since barbican
                                will default to using Keystone authentication as of OpenStack Newton.</para>
          </step>
        </procedure>
        <screen language="ini">[composite:main]
use = egg:Paste#urlmap
/: barbican_version
/v1: barbican-api-keystone</screen>
        <procedure>
          <step>
            <para>Replace <literal>authtoken</literal> filter values to match your Keystone
                                setup</para>
          </step>
        </procedure>
        <screen language="ini">[filter:authtoken]
paste.filter_factory = keystonemiddleware.auth_token:filter_factory
auth_plugin = password
username = {YOUR_KEYSTONE_USERNAME}
password = {YOUR_KEYSTONE_PASSWORD}
user_domain_id = {YOUR_KEYSTONE_USER_DOMAIN}
project_name = {YOUR_KEYSTONE_PROJECT}
project_domain_id = {YOUR_KEYSTONE_PROJECT_DOMAIN}
auth_uri = http://{YOUR_KEYSTONE_ENDPOINT}:5000/v3
auth_url = http://{YOUR_KEYSTONE_ENDPOINT}:35357/v3</screen>
        <para>Alternatively, you can shorten this to</para>
        <screen language="ini">[filter:authtoken]
paste.filter_factory = keystonemiddleware.auth_token:filter_factory</screen>
        <para>and store Barbican’s Keystone credentials in the <literal>[keystone_authtoken]</literal>
                            section of <literal>/etc/barbican/barbican.conf</literal></para>
        <screen language="ini">[keystone_authtoken]
auth_plugin = password
username = {YOUR_KEYSTONE_USERNAME}
password = {YOUR_KEYSTONE_PASSWORD}
user_domain_id = {YOUR_KEYSTONE_USER_DOMAIN}
project_name = {YOUR_KEYSTONE_PROJECT}
project_domain_id = {YOUR_KEYSTONE_PROJECT_DOMAIN}
auth_uri = http://{YOUR_KEYSTONE_ENDPOINT}:5000/v3
auth_url = http://{YOUR_KEYSTONE_ENDPOINT}:35357/v3</screen>
      </step>
      <step>
        <para>Start Barbican <literal>{barbican_home}/bin/barbican.sh start</literal></para>
      </step>
    </procedure>
  </section>
</section>
