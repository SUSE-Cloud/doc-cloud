<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Install and configure for Ubuntu</title>
  <para>This section describes how to install and configure the
            Telemetry Alarming service, code-named aodh, on the controller node.</para>
  <para>This section assumes that you already have a working OpenStack
            environment with at least the following components installed:
            Compute, Image Service, Identity.</para>
  <section>
    <title>Prerequisites</title>
    <para>Before you install and configure the Telemetry service, you must create a
                database, service credentials, and API endpoints.</para>
    <procedure>
      <step>
        <para>To create the database, complete these steps:</para>
        <itemizedlist>
          <listitem>
            <para>Use the database access client to connect to
                                the database server as the <literal>root</literal> user:</para>
            <screen language="console">$ mysql -u root -p</screen>
          </listitem>
          <listitem>
            <para>Create the <literal>aodh</literal> database:</para>
            <screen language="console">CREATE DATABASE aodh;</screen>
          </listitem>
          <listitem>
            <para>Grant proper access to the <literal>aodh</literal> database:</para>
            <screen language="console">GRANT ALL PRIVILEGES ON aodh.* TO 'aodh'@'localhost' \
  IDENTIFIED BY 'AODH_DBPASS';
GRANT ALL PRIVILEGES ON aodh.* TO 'aodh'@'%' \
  IDENTIFIED BY 'AODH_DBPASS';</screen>
            <para>Replace <literal>AODH_DBPASS</literal> with a suitable password.</para>
          </listitem>
          <listitem>
            <para>Exit the database access client.</para>
          </listitem>
        </itemizedlist>
      </step>
      <step>
        <para>Source the <literal>admin</literal> credentials to gain access to admin-only
                        CLI commands:</para>
        <screen language="console">$ . admin-openrc</screen>
      </step>
      <step>
        <para>To create the service credentials, complete these steps:</para>
        <itemizedlist>
          <listitem>
            <para>Create the <literal>aodh</literal> user:</para>
            <screen language="console">$ openstack user create --domain default \
  --password-prompt aodh
User Password:
Repeat User Password:
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| domain_id           | default                          |
| enabled             | True                             |
| id                  | b7657c9ea07a4556aef5d34cf70713a3 |
| name                | aodh                             |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+</screen>
          </listitem>
          <listitem>
            <para>Add the <literal>admin</literal> role to the <literal>aodh</literal> user:</para>
            <screen language="console">$ openstack role add --project service --user aodh admin</screen>
            <note>
              <para>This command provides no output.</para>
            </note>
          </listitem>
          <listitem>
            <para>Create the <literal>aodh</literal> service entity:</para>
            <screen language="console">$ openstack service create --name aodh \
  --description "Telemetry" alarming
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | Telemetry                        |
| enabled     | True                             |
| id          | 3405453b14da441ebb258edfeba96d83 |
| name        | aodh                             |
| type        | alarming                         |
+-------------+----------------------------------+</screen>
          </listitem>
        </itemizedlist>
      </step>
      <step>
        <para>Create the Alarming service API endpoints:</para>
        <screen language="console">$ openstack endpoint create --region RegionOne \
  alarming public http://controller:8042
  +--------------+----------------------------------+
  | Field        | Value                            |
  +--------------+----------------------------------+
  | enabled      | True                             |
  | id           | 340be3625e9b4239a6415d034e98aace |
  | interface    | public                           |
  | region       | RegionOne                        |
  | region_id    | RegionOne                        |
  | service_id   | 8c2c7f1b9b5049ea9e63757b5533e6d2 |
  | service_name | aodh                             |
  | service_type | alarming                         |
  | url          | http://controller:8042           |
  +--------------+----------------------------------+

$ openstack endpoint create --region RegionOne \
  alarming internal http://controller:8042
  +--------------+----------------------------------+
  | Field        | Value                            |
  +--------------+----------------------------------+
  | enabled      | True                             |
  | id           | 340be3625e9b4239a6415d034e98aace |
  | interface    | internal                         |
  | region       | RegionOne                        |
  | region_id    | RegionOne                        |
  | service_id   | 8c2c7f1b9b5049ea9e63757b5533e6d2 |
  | service_name | aodh                             |
  | service_type | alarming                         |
  | url          | http://controller:8042           |
  +--------------+----------------------------------+

$ openstack endpoint create --region RegionOne \
  alarming admin http://controller:8042
  +--------------+----------------------------------+
  | Field        | Value                            |
  +--------------+----------------------------------+
  | enabled      | True                             |
  | id           | 340be3625e9b4239a6415d034e98aace |
  | interface    | admin                            |
  | region       | RegionOne                        |
  | region_id    | RegionOne                        |
  | service_id   | 8c2c7f1b9b5049ea9e63757b5533e6d2 |
  | service_name | aodh                             |
  | service_type | alarming                         |
  | url          | http://controller:8042           |
  +--------------+----------------------------------+</screen>
      </step>
    </procedure>
  </section>
  <section>
    <title>Install and configure components</title>
    <note>
      <para>Default configuration files vary by distribution. You might need to add
                    these sections and options rather than modifying existing sections and
                    options. Also, an ellipsis (â€¦) in the configuration snippets indicates
                    potential default configuration options that you should retain.</para>
    </note>
    <procedure>
      <step>
        <para>Install the packages:</para>
        <screen language="console"># apt-get install aodh-api aodh-evaluator aodh-notifier \
  aodh-listener aodh-expirer python-aodhclient</screen>
      </step>
    </procedure>
    <procedure>
      <step>
        <para>Edit the <literal>/etc/aodh/aodh.conf</literal> file and complete the following actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[database]</literal> section, configure database access:</para>
            <screen language="ini">[database]
...
connection = mysql+pymysql://aodh:AODH_DBPASS@controller/aodh</screen>
            <para>Replace <literal>AODH_DBPASS</literal> with the password you chose for the
                                Telemetry Alarming module database. You must escape special characters
                                such as <literal>:</literal>, <literal>/</literal>, <literal>+</literal>, and <literal>@</literal> in the connection string in accordance
                                with <link xlink:href="https://www.ietf.org/rfc/rfc2396.txt">RFC2396</link>.</para>
          </listitem>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> section,
                                configure <literal>RabbitMQ</literal> message queue access:</para>
            <screen language="ini">[DEFAULT]
...
transport_url = rabbit://openstack:RABBIT_PASS@controller</screen>
            <para>Replace <literal>RABBIT_PASS</literal> with the password you chose for the
                                <literal>openstack</literal> account in <literal>RabbitMQ</literal>.</para>
          </listitem>
          <listitem>
            <para>In the <literal>[DEFAULT]</literal> and <literal>[keystone_authtoken]</literal> sections,
                                configure Identity service access:</para>
            <screen language="ini">[DEFAULT]
...
auth_strategy = keystone

[keystone_authtoken]
...
auth_uri = http://controller:5000
auth_url = http://controller:35357
memcached_servers = controller:11211
auth_type = password
project_domain_id = default
user_domain_id = default
project_name = service
username = aodh
password = AODH_PASS</screen>
            <para>Replace <literal>AODH_PASS</literal> with the password you chose for
                                the <literal>aodh</literal> user in the Identity service.</para>
          </listitem>
          <listitem>
            <para>In the <literal>[service_credentials]</literal> section, configure service credentials:</para>
            <screen language="ini">[service_credentials]
...
auth_type = password
auth_url = http://controller:5000/v3
project_domain_id = default
user_domain_id = default
project_name = service
username = aodh
password = AODH_PASS
interface = internalURL
region_name = RegionOne</screen>
            <para>Replace <literal>AODH_PASS</literal> with the password you chose for
                                the <literal>aodh</literal> user in the Identity service.</para>
          </listitem>
        </itemizedlist>
      </step>
    </procedure>
    <procedure>
      <step>
        <para>In order to initialize the database please run the <literal>aodh-dbsync</literal> script.</para>
      </step>
    </procedure>
  </section>
  <section>
    <title>Finalize installation</title>
    <procedure>
      <step>
        <para>Restart the Alarming services:</para>
        <screen language="console"># service aodh-api restart
# service aodh-evaluator restart
# service aodh-notifier restart
# service aodh-listener restart</screen>
      </step>
    </procedure>
  </section>
</section>
