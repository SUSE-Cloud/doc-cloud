<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Keystone Event Notifications</title>
  <para>Keystone provides notifications about usage data so that 3rd party applications
            can use the data for billing, monitoring, or quota purposes. This document
            describes the current inclusions and exclusions for Keystone notifications.</para>
  <para>Keystone currently supports two notification formats: a Basic Notification,
            and a Cloud Auditing Data Federation (<link xlink:href="http://www.dmtf.org/standards/cadf">CADF</link>) Notification.
            The supported operations between the two types of notification formats are
            documented below.</para>
  <section>
    <title>Common Notification Structure</title>
    <para>Notifications generated by Keystone are generated in JSON format. An external
                application can format them into ATOM format and publish them as a feed.
                Currently, all notifications are immediate, meaning they are generated when a
                specific event happens. Notifications all adhere to a specific top level
                format:</para>
    <screen language="javascript">{
    "event_type": "identity.&lt;resource_type&gt;.&lt;operation&gt;",
    "message_id": "&lt;message_id&gt;",
    "payload": {},
    "priority": "INFO",
    "publisher_id": "identity.&lt;hostname&gt;",
    "timestamp": "&lt;timestamp&gt;"
}</screen>
    <para>Where <literal>&lt;resource_type&gt;</literal> is a Keystone resource, such as user or project, and
                <literal>&lt;operation&gt;</literal> is a Keystone operation, such as created, deleted.</para>
    <para>The key differences between the two notification formats (Basic and CADF), lie
                within the <literal>payload</literal> portion of the notification.</para>
    <para>The <literal>priority</literal> of the notification being sent is not configurable through
                the Keystone configuration file. This value is defaulted to INFO for all
                notifications sent in Keystone’s case.</para>
  </section>
  <section>
    <title>Auditing with CADF</title>
    <para>Keystone uses the <link xlink:href="https://docs.openstack.org/developer/pycadf">PyCADF</link> library to emit CADF notifications, these events
                adhere to the DMTF <link xlink:href="http://www.dmtf.org/standards/cadf">CADF</link> specification. This standard provides auditing
                capabilities for compliance with security, operational, and business processes
                and supports normalized and categorized event data for federation and
                aggregation.</para>
    <para>CADF notifications include additional context data around the <literal>resource</literal>,
                the <literal>action</literal> and the <literal>initiator</literal>.</para>
    <para>CADF notifications may be emitted by changing the <literal>notification_format</literal> to
                <literal>cadf</literal> in the configuration file.</para>
    <para>The <literal>payload</literal> portion of a CADF Notification is a CADF <literal>event</literal>, which
                is represented as a JSON dictionary. For example:</para>
    <screen language="javascript">{
    "typeURI": "http://schemas.dmtf.org/cloud/audit/1.0/event",
    "initiator": {
        "typeURI": "service/security/account/user",
        "host": {
            "agent": "curl/7.22.0(x86_64-pc-linux-gnu)",
            "address": "127.0.0.1"
        },
        "id": "&lt;initiator_id&gt;"
    },
    "target": {
        "typeURI": "&lt;target_uri&gt;",
        "id": "openstack:1c2fc591-facb-4479-a327-520dade1ea15"
    },
    "observer": {
        "typeURI": "service/security",
        "id": "openstack:3d4a50a9-2b59-438b-bf19-c231f9c7625a"
    },
    "eventType": "activity",
    "eventTime": "2014-02-14T01:20:47.932842+00:00",
    "action": "&lt;action&gt;",
    "outcome": "success",
    "id": "openstack:f5352d7b-bee6-4c22-8213-450e7b646e9f",
}</screen>
    <para>Where the following are defined:</para>
    <itemizedlist>
      <listitem>
        <para><literal>&lt;initiator_id&gt;</literal>: ID of the user that performed the operation</para>
      </listitem>
      <listitem>
        <para><literal>&lt;target_uri&gt;</literal>: CADF specific target URI, (i.e.:  data/security/project)</para>
      </listitem>
      <listitem>
        <para><literal>&lt;action&gt;</literal>: The action being performed, typically:
                        <literal>&lt;operation&gt;</literal>. <literal>&lt;resource_type&gt;</literal></para>
      </listitem>
    </itemizedlist>
    <note>
      <para>The <literal>eventType</literal> property of the CADF payload is different from the
                    <literal>event_type</literal> property of a notifications. The former (<literal>eventType</literal>) is a
                    CADF keyword which designates the type of event that is being measured, this
                    can be: <literal>activity</literal>, <literal>monitor</literal> or <literal>control</literal>. Whereas the latter
                    (<literal>event_type</literal>) is described in previous sections as:
                    <literal>identity.&lt;resource_type&gt;.&lt;operation&gt;</literal></para>
    </note>
    <para>Additionally there may be extra keys present depending on the operation being
                performed, these will be discussed below.</para>
    <section>
      <title>Reason</title>
      <para>There is a specific <literal>reason</literal> object that will be present for the following
                    PCI-DSS related events:</para>
      <informaltable>
        <tgroup cols="3">
          <colspec colname="c1" colwidth="45.0*"/>
          <colspec colname="c2" colwidth="10.0*"/>
          <colspec colname="c3" colwidth="45.0*"/>
          <thead>
            <row>
              <entry>
                <para>PCI-DSS Section</para>
              </entry>
              <entry>
                <para>reasonCode</para>
              </entry>
              <entry>
                <para>reasonType</para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para>8.1.6 Limit repeated access attempts by locking out the user after more than X failed attempts.</para>
              </entry>
              <entry>
                <para>401</para>
              </entry>
              <entry>
                <para>Maximum number of &lt;number&gt; login attempts exceeded.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>8.2.3 Passwords must meet the established criteria.</para>
              </entry>
              <entry>
                <para>400</para>
              </entry>
              <entry>
                <para>Password does not meet expected requirements: &lt;regex_description&gt;</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>8.2.4 Password must be changed every X days.</para>
              </entry>
              <entry>
                <para>401</para>
              </entry>
              <entry>
                <para>Password for &lt;user&gt; expired and must be changed</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>8.2.5 Do not let users reuse the last X passwords.</para>
              </entry>
              <entry>
                <para>400</para>
              </entry>
              <entry>
                <para>Changed password cannot be identical to the last &lt;number&gt; passwords.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>Other - Prevent passwords from being changed for a minimum of X days.</para>
              </entry>
              <entry>
                <para>401</para>
              </entry>
              <entry>
                <para>Cannot change password before minimum age &lt;number&gt; days is met</para>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
      <para>The reason object will contain the following keys:</para>
      <itemizedlist>
        <listitem>
          <para><literal>reasonType</literal>: Description of the PCI-DSS event</para>
        </listitem>
        <listitem>
          <para><literal>reasonCode</literal>: HTTP response code for the event</para>
        </listitem>
      </itemizedlist>
      <para>For more information, see
                    
                    for configuring PCI-DSS in keystone.</para>
    </section>
    <section>
      <title>Supported Events</title>
      <para>The following table displays the compatibility between resource types and
                    operations.</para>
      <informaltable>
        <tgroup cols="3">
          <colspec colname="c1" colwidth="27.3*"/>
          <colspec colname="c2" colwidth="36.4*"/>
          <colspec colname="c3" colwidth="36.4*"/>
          <thead>
            <row>
              <entry>
                <para>Resource Type</para>
              </entry>
              <entry>
                <para>Supported Operations</para>
              </entry>
              <entry>
                <para>typeURI</para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para>group</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/group</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>project</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/project</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>role</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/role</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>domain</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/domain</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>user</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/account/user</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>trust</para>
              </entry>
              <entry>
                <para>create,delete</para>
              </entry>
              <entry>
                <para>data/security/trust</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>region</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/region</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>endpoint</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/endpoint</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>service</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/service</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>policy</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
              <entry>
                <para>data/security/policy</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>role assignment</para>
              </entry>
              <entry>
                <para>add,remove</para>
              </entry>
              <entry>
                <para>data/security/account/user</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>None</para>
              </entry>
              <entry>
                <para>authenticate</para>
              </entry>
              <entry>
                <para>data/security/account/user</para>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
    </section>
    <section>
      <title>Example Notification - Project Create</title>
      <para>The following is an example of a notification that is sent when a project is
                    created. This example can be applied for any <literal>create</literal>, <literal>update</literal> or
                    <literal>delete</literal> event that is seen in the table above. The <literal>&lt;action&gt;</literal> and
                    <literal>typeURI</literal> fields will be change.</para>
      <para>The difference to note is the inclusion of the <literal>resource_info</literal> field which
                    contains the <literal>&lt;resource_id&gt;</literal> that is undergoing the operation. Thus creating
                    a common element between the CADF and Basic notification formats.</para>
      <screen language="javascript">{
    "event_type": "identity.project.created",
    "message_id": "0156ee79-b35f-4cef-ac37-d4a85f231c69",
    "payload": {
        "typeURI": "http://schemas.dmtf.org/cloud/audit/1.0/event",
        "initiator": {
            "typeURI": "service/security/account/user",
            "host": {
                "agent": "curl/7.22.0(x86_64-pc-linux-gnu)",
                "address": "127.0.0.1"
            },
            "id": "c9f76d3c31e142af9291de2935bde98a"
        },
        "target": {
            "typeURI": "data/security/project",
            "id": "openstack:1c2fc591-facb-4479-a327-520dade1ea15"
        },
        "observer": {
            "typeURI": "service/security",
            "id": "openstack:3d4a50a9-2b59-438b-bf19-c231f9c7625a"
        },
        "eventType": "activity",
        "eventTime": "2014-02-14T01:20:47.932842+00:00",
        "action": "created.project",
        "outcome": "success",
        "id": "openstack:f5352d7b-bee6-4c22-8213-450e7b646e9f",
        "resource_info": "671da331c47d4e29bb6ea1d270154ec3"
    }
    "priority": "INFO",
    "publisher_id": "identity.host1234",
    "timestamp": "2013-08-29 19:03:45.960280"
}</screen>
    </section>
    <section>
      <title>Example Notification - Authentication</title>
      <para>The following is an example of a notification that is sent when a user
                    authenticates with Keystone.</para>
      <para>Note that this notification will be emitted if a user successfully
                    authenticates, and when a user fails to authenticate.</para>
      <screen language="javascript">{
    "event_type": "identity.authenticate",
    "message_id": "1371a590-d5fd-448f-b3bb-a14dead6f4cb",
    "payload": {
        "typeURI": "http://schemas.dmtf.org/cloud/audit/1.0/event",
        "initiator": {
            "typeURI": "service/security/account/user",
            "host": {
                "agent": "curl/7.22.0(x86_64-pc-linux-gnu)",
                "address": "127.0.0.1"
            },
            "id": "c9f76d3c31e142af9291de2935bde98a"
        },
        "target": {
            "typeURI": "service/security/account/user",
            "id": "openstack:1c2fc591-facb-4479-a327-520dade1ea15"
        },
        "observer": {
            "typeURI": "service/security",
            "id": "openstack:3d4a50a9-2b59-438b-bf19-c231f9c7625a"
        },
        "eventType": "activity",
        "eventTime": "2014-02-14T01:20:47.932842+00:00",
        "action": "authenticate",
        "outcome": "success",
        "id": "openstack:f5352d7b-bee6-4c22-8213-450e7b646e9f"
    },
    "priority": "INFO",
    "publisher_id": "identity.host1234",
    "timestamp": "2014-02-14T01:20:47.932842"
}</screen>
    </section>
    <section>
      <title>Example Notification - Federated Authentication</title>
      <para>The following is an example of a notification that is sent when a user
                    authenticates with Keystone via Federation.</para>
      <para>This example is similar to the one seen above, however the <literal>initiator</literal>
                    portion of the <literal>payload</literal> contains a new <literal>credential</literal> section.</para>
      <screen language="javascript">{
    "event_type": "identity.authenticate",
    "message_id": "1371a590-d5fd-448f-b3bb-a14dead6f4cb",
    "payload": {
        "typeURI": "http://schemas.dmtf.org/cloud/audit/1.0/event",
        "initiator": {
            "credential": {
                "type": "http://docs.oasis-open.org/security/saml/v2.0",
                "token": "671da331c47d4e29bb6ea1d270154ec3",
                "identity_provider": "ACME",
                "user": "c9f76d3c31e142af9291de2935bde98a",
                "groups": [
                    "developers"
                ]
            },
            "typeURI": "service/security/account/user",
            "host": {
                "agent": "curl/7.22.0(x86_64-pc-linux-gnu)",
                "address": "127.0.0.1"
            },
            "id": "c9f76d3c31e142af9291de2935bde98a"
        },
        "target": {
            "typeURI": "service/security/account/user",
            "id": "openstack:1c2fc591-facb-4479-a327-520dade1ea15"
        },
        "observer": {
            "typeURI": "service/security",
            "id": "openstack:3d4a50a9-2b59-438b-bf19-c231f9c7625a"
        },
        "eventType": "activity",
        "eventTime": "2014-02-14T01:20:47.932842+00:00",
        "action": "authenticate",
        "outcome": "success",
        "id": "openstack:f5352d7b-bee6-4c22-8213-450e7b646e9f"
    },
    "priority": "INFO",
    "publisher_id": "identity.host1234",
    "timestamp": "2014-02-14T01:20:47.932842"
}</screen>
    </section>
    <section>
      <title>Example Notification - Role Assignment</title>
      <para>The following is an example of a notification that is sent when a role is
                    granted or revoked to a project or domain, for a user or group.</para>
      <para>It is important to note that this type of notification has many new keys
                    that convey the necessary information. Expect the following in the <literal>payload</literal>:
                    <literal>role</literal>, <literal>inherited_to_project</literal>, <literal>project</literal> or <literal>domain</literal>, <literal>user</literal> or
                    <literal>group</literal>. With the exception of <literal>inherited_to_project</literal>, each will represent
                    the unique identifier of the resource type.</para>
      <screen language="javascript">{
    "event_type": "identity.role_assignment.created",
    "message_id": "a5901371-d5fd-b3bb-448f-a14dead6f4cb",
    "payload": {
        "typeURI": "http://schemas.dmtf.org/cloud/audit/1.0/event",
        "initiator": {
            "typeURI": "service/security/account/user",
            "host": {
                "agent": "curl/7.22.0(x86_64-pc-linux-gnu)",
                "address": "127.0.0.1"
            },
            "id": "c9f76d3c31e142af9291de2935bde98a"
        },
        "target": {
            "typeURI": "service/security/account/user",
            "id": "openstack:1c2fc591-facb-4479-a327-520dade1ea15"
        },
        "observer": {
            "typeURI": "service/security",
            "id": "openstack:3d4a50a9-2b59-438b-bf19-c231f9c7625a"
        },
        "eventType": "activity",
        "eventTime": "2014-08-20T01:20:47.932842+00:00",
        "role": "0e6b990380154a2599ce6b6e91548a68",
        "project": "24bdcff1aab8474895dbaac509793de1",
        "inherited_to_projects": false,
        "group": "c1e22dc67cbd469ea0e33bf428fe597a",
        "action": "created.role_assignment",
        "outcome": "success",
        "id": "openstack:f5352d7b-bee6-4c22-8213-450e7b646e9f"
    },
    "priority": "INFO",
    "publisher_id": "identity.host1234",
    "timestamp": "2014-08-20T01:20:47.932842"
}</screen>
    </section>
    <section>
      <title>Example Notification - Expired Password</title>
      <para>The following is an example of a notification that is sent when a user
                    attempts to authenticate but their password has expired.</para>
      <para>In this example, the <literal>payload</literal> contains a <literal>reason</literal> portion which contains
                    both a <literal>reasonCode</literal> and <literal>reasonType</literal>.</para>
      <screen language="javascript"><?dbsuse-fo font-size="8pt"?>{
    "priority": "INFO",
    "_unique_id": "222441bdc958423d8af6f28f9c558614",
    "event_type": "identity.authenticate",
    "timestamp": "2016-11-11 18:31:11.290821",
    "publisher_id": "identity.host1234",
    "payload": {
        "typeURI": "http://schemas.dmtf.org/cloud/audit/1.0/event",
        "initiator": {
            "typeURI": "service/security/account/user",
            "host": {
                "address": "127.0.0.1"
            },
            "id": "73a19db6-e26b-5313-a6df-58d297fa652e"
            },
            "target": {
                "typeURI": "service/security/account/user",
                "id": "c23e6cb7-abe0-5e42-b7f7-4c4104ea77b0"
            },
            "observer": {
                "typeURI": "service/security",
                "id": "9bdddeda6a0b451e9e0439646e532afd"
            },
            "eventType": "activity",
            "eventTime": "2016-11-11T18:31:11.156356+0000",
            "reason": {
                "reasonCode": 401,
                "reasonType": "The password is expired and needs to be reset for user: ed1ab0b40f284fb48fea9e25d0d157fc"
            },
            "action": "authenticate",
            "outcome": "failure",
            "id": "78cd795f-5850-532f-9ab1-5adb04e30c0f"
    },
    "message_id": "9a97e9d0-fef1-4852-8e82-bb693358bc46"
}</screen>
    </section>
  </section>
  <section>
    <title>Basic Notifications</title>
    <para>All basic notifications contain a limited amount of information, specifically,
                just the resource type, operation, and resource id.</para>
    <para>The <literal>payload</literal> portion of a Basic Notification is a single key-value pair.</para>
    <screen language="javascript">{
    "resource_info": &lt;resource_id&gt;
}</screen>
    <para>Where <literal>&lt;resource_id&gt;</literal> is the unique identifier assigned to the
                <literal>resource_type</literal> that is undergoing the <literal>&lt;operation&gt;</literal>.</para>
    <section>
      <title>Supported Events</title>
      <para>The following table displays the compatibility between resource types and
                    operations.</para>
      <informaltable>
        <tgroup cols="2">
          <colspec colname="c1" colwidth="42.9*"/>
          <colspec colname="c2" colwidth="57.1*"/>
          <thead>
            <row>
              <entry>
                <para>Resource Type</para>
              </entry>
              <entry>
                <para>Supported Operations</para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para>group</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>project</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>role</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>domain</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>user</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>trust</para>
              </entry>
              <entry>
                <para>create,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>region</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>endpoint</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>service</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>policy</para>
              </entry>
              <entry>
                <para>create,update,delete</para>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
      <para>Note, <literal>trusts</literal> are an immutable resource, they do not support <literal>update</literal>
                    operations.</para>
    </section>
    <section>
      <title>Example Notification</title>
      <para>This is an example of a notification sent for a newly created user:</para>
      <screen language="javascript">{
    "event_type": "identity.user.created",
    "message_id": "0156ee79-b35f-4cef-ac37-d4a85f231c69",
    "payload": {
        "resource_info": "671da331c47d4e29bb6ea1d270154ec3"
    },
    "priority": "INFO",
    "publisher_id": "identity.host1234",
    "timestamp": "2013-08-29 19:03:45.960280"
}</screen>
      <para>If the operation fails, the notification won’t be sent, and no special error
                    notification will be sent. Information about the error is handled through
                    normal exception paths.</para>
    </section>
  </section>
  <section>
    <title>Recommendations for consumers</title>
    <para>One of the most important notifications that Keystone emits is for project
                deletions (<literal>event_type</literal> = <literal>identity.project.deleted</literal>). This event should
                indicate to the rest of OpenStack that all resources (such as virtual machines)
                associated with the project should be deleted.</para>
    <para>Projects can also have update events (<literal>event_type</literal> =
                <literal>identity.project.updated</literal>), wherein the project has been disabled. Keystone
                ensures this has an immediate impact on the accessibility of the project’s
                resources by revoking tokens with authorization on the project, but should
                <emphasis role="bold">not</emphasis> have a direct impact on the projects resources (in other words, virtual
                machines should <emphasis role="bold">not</emphasis> be deleted).</para>
  </section>
  <section>
    <title>Opting out of certain notifications</title>
    <para>There are many notifications that Keystone emits and some deployers may only
                care about certain events. In Keystone there is a way to opt-out of certain
                notifications. In <literal>/etc/keystone/keystone.conf</literal> you can set <literal>opt_out</literal> to
                the event you wish to opt-out of. It is possible to opt-out of multiple events.</para>
    <para>Example:</para>
    <screen language="ini">[DEFAULT]
notification_opt_out = identity.user.created
notification_opt_out = identity.role_assignment.created
notification_opt_out = identity.authenticate.pending</screen>
    <para>This will opt-out notifications for user creation, role assignment creation and
                successful authentications. For a list of event types that can be used, refer
                to: <link xlink:href="https://docs.openstack.org/admin-guide/telemetry-measurements.html#openstack-identity">Telemetry Measurements</link>.</para>
    <para>By default, messages for the following authentication events are suppressed
                since they are too noisy: <literal>identity.authenticate.success</literal>,
                <literal>identity.authenticate.pending</literal> and <literal>identity.authenticate.failed</literal>.</para>
  </section>
</section>
