<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Keystone tokens</title>
  <para>Tokens are used to authenticate and authorize your interactions with the
            various OpenStack APIs. Tokens come in many flavors, representing various
            authorization scopes and sources of identity. There are also several different
            “token providers”, each with their own user experience, performance, and
            deployment characteristics.</para>
  <section>
    <title>Authorization scopes</title>
    <para>Tokens can express your authorization in different scopes. You likely have
                different sets of roles, in different projects, and in different domains.
                While tokens always express your identity, they may only ever express one set
                of roles in one authorization scope at a time.</para>
    <para>Each level of authorization scope is useful for certain types of operations in
                certain OpenStack services, and are not interchangeable.</para>
    <section>
      <title>Unscoped tokens</title>
      <para>An unscoped token contains neither a service catalog, any roles, a project
                    scope, nor a domain scope. Their primary use case is simply to prove your
                    identity to keystone at a later time (usually to generate scoped tokens),
                    without repeatedly presenting your original credentials.</para>
      <para>The following conditions must be met to receive an unscoped token:</para>
      <itemizedlist>
        <listitem>
          <para>You must not specify an authorization scope in your authentication request
                            (for example, on the command line with arguments such as
                            <literal>--os-project-name</literal> or <literal>--os-domain-id</literal>),</para>
        </listitem>
        <listitem>
          <para>Your identity must not have a “default project” associated with it that you
                            also have role assignments, and thus authorization, upon.</para>
        </listitem>
      </itemizedlist>
    </section>
    <section>
      <title>Project-scoped tokens</title>
      <para>Project-scoped tokens are the bread and butter of OpenStack. They express your
                    authorization to operate in a specific tenancy of the cloud and are useful to
                    authenticate yourself when working with most other services.</para>
      <para>They contain a service catalog, a set of roles, and details of the project upon
                    which you have authorization.</para>
    </section>
    <section>
      <title>Domain-scoped tokens</title>
      <para>Domain-scoped tokens also have limited use cases in OpenStack. They express
                    your authorization to operate a domain-level, above that of the user and
                    projects contained therein (typically as a domain-level administrator).
                    Depending on Keystone’s configuration, they are useful for working with a
                    single domain in Keystone.</para>
      <para>They contain a limited service catalog (only those services which do not
                    explicitly require per-project endpoints), a set of roles, and details of the
                    project upon which you have authorization.</para>
      <para>They can also be used to work with domain-level concerns in other services,
                    such as to configure domain-wide quotas that apply to all users or projects in
                    a specific domain.</para>
    </section>
  </section>
  <section>
    <title>Token providers</title>
    <para>The token type issued by keystone is configurable through the
                <literal>/etc/keystone/keystone.conf</literal> file. Currently, there are two supported
                token types, <literal>UUID</literal> and <literal>fernet</literal>.</para>
    <section>
      <title>UUID tokens</title>
      <para>UUID was the first token type supported and is currently the default token
                    provider. UUID tokens are 32 bytes in length and must be persisted in a back
                    end. Clients must pass their UUID token to the Identity service in order to
                    validate it.</para>
      <para>As mentioned above, UUID tokens must be persisted. By default, keystone
                    persists UUID tokens using a SQL backend. An unfortunate side-effect is that
                    the size of the database will grow over time regardless of the token’s
                    expiration time. Expired UUID tokens can be pruned from the backend using
                    keystone’s command line utility:</para>
      <screen language="bash">$ keystone-manage token_flush</screen>
      <para>We recommend invoking this command periodically using <literal>cron</literal>.</para>
      <note>
        <para>It is not required to run this command at all if using Fernet tokens. Fernet
                        tokens are not persisted and do not contribute to database bloat.</para>
      </note>
    </section>
    <section>
      <title>Fernet tokens</title>
      <para>The fernet token format was introduced in the OpenStack Kilo release. Unlike
                    the other token types mentioned in this document, fernet tokens do not need to
                    be persisted in a back end. <literal>AES256</literal> encryption is used to protect the
                    information stored in the token and integrity is verified with a <literal>SHA256
HMAC</literal> signature. Only the Identity service should have access to the keys used
                    to encrypt and decrypt fernet tokens. Like UUID tokens, fernet tokens must be
                    passed back to the Identity service in order to validate them. For more
                    information on the fernet token type, see the .</para>
      <informaltable>
        <tgroup cols="4">
          <colspec colname="c1" colwidth="25.0*"/>
          <colspec colname="c2" colwidth="25.0*"/>
          <colspec colname="c3" colwidth="25.0*"/>
          <colspec colname="c4" colwidth="25.0*"/>
          <thead>
            <row>
              <entry>
                <emphasis>Feature</emphasis>
              </entry>
              <entry>
                <emphasis>Status</emphasis>
              </entry>
              <entry>
                <emphasis>Fernet tokens</emphasis>
              </entry>
              <entry>
                <emphasis>UUID tokens</emphasis>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <inline>
                  <reference refid="operation_create_unscoped_token">
                    <info/>
                    <strong>Create unscoped token</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_mandatory">mandatory</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_unscoped_token_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_unscoped_token_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="operation_create_project_scoped_token">
                    <info/>
                    <strong>Create project-scoped token</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_mandatory">mandatory</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_project_scoped_token_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_project_scoped_token_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="operation_create_domain_scoped_token">
                    <info/>
                    <strong>Create domain-scoped token</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_optional">optional</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_domain_scoped_token_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_domain_scoped_token_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="operation_create_trust_scoped_token">
                    <info/>
                    <strong>Create trust-scoped token</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_optional">optional</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_trust_scoped_token_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_trust_scoped_token_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="operation_create_token_using_oauth">
                    <info/>
                    <strong>Create a token given an OAuth access token</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_optional">optional</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_token_using_oauth_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_token_using_oauth_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="operation_create_token_with_bind">
                    <info/>
                    <strong>Create a token with a bind attribute</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_optional">optional</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_token_with_bind_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_missing">✖</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_create_token_with_bind_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="operation_revoke_token">
                    <info/>
                    <strong>Revoke a token</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_optional">optional</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_revoke_token_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="operation_revoke_token_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="feature_online_validation">
                    <info/>
                    <strong>Online validation</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_mandatory">mandatory</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="feature_online_validation_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="feature_online_validation_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="feature_offline_validation">
                    <info/>
                    <strong>Offline validation</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_optional">optional</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="feature_offline_validation_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_missing">✖</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="feature_offline_validation_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_missing">✖</literal>
                  </reference>
                </inline>
              </entry>
            </row>
            <row>
              <entry>
                <inline>
                  <reference refid="feature_non_persistent">
                    <info/>
                    <strong>Non-persistent</strong>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline classes="sp_feature_optional">optional</inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="feature_non_persistent_fernet">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_complete">✔</literal>
                  </reference>
                </inline>
              </entry>
              <entry>
                <inline>
                  <reference refid="feature_non_persistent_uuid">
                    <info/>
                    <literal classes="sp_impl_summary sp_impl_missing">✖</literal>
                  </reference>
                </inline>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
      <itemizedlist>
        <listitem>
          <emphasis role="bold">Create unscoped token</emphasis>
          <para><emphasis role="bold">Status: mandatory. </emphasis>All token providers must be capable of issuing tokens without an explicit
                                scope of authorization.</para>
          <para>
            <emphasis role="bold">CLI commands:</emphasis>
            <itemizedlist>
              <listitem>
                <literal>openstack --os-username=&lt;username&gt; --os-user-domain-name=&lt;domain&gt;
--os-password=&lt;password&gt; token issue</literal>
              </listitem>
            </itemizedlist>
          </para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Create project-scoped token</emphasis>
          <para><emphasis role="bold">Status: mandatory. </emphasis>All token providers must be capable of issuing project-scoped tokens.</para>
          <para>
            <emphasis role="bold">CLI commands:</emphasis>
            <itemizedlist>
              <listitem>
                <literal>openstack --os-username=&lt;username&gt; --os-user-domain-name=&lt;domain&gt;
--os-password=&lt;password&gt; --os-project-name=&lt;project&gt;
--os-project-domain-name=&lt;domain&gt; token issue</literal>
              </listitem>
            </itemizedlist>
          </para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Create domain-scoped token</emphasis>
          <para><emphasis role="bold">Status: optional. </emphasis>Domain-scoped tokens are not required for all use cases, and for some use
                                cases, projects can be used instead.</para>
          <para>
            <emphasis role="bold">CLI commands:</emphasis>
            <itemizedlist>
              <listitem>
                <literal>openstack --os-username=&lt;username&gt; --os-user-domain-name=&lt;domain&gt;
--os-password=&lt;password&gt; --os-domain-name=&lt;domain&gt; token issue</literal>
              </listitem>
            </itemizedlist>
          </para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Create trust-scoped token</emphasis>
          <para><emphasis role="bold">Status: optional. </emphasis>Tokens scoped to a trust convey only the user impersonation and
                                project-based authorization attributes included in the delegation.</para>
          <para>
            <emphasis role="bold">CLI commands:</emphasis>
            <itemizedlist>
              <listitem>
                <literal>openstack --os-username=&lt;username&gt; --os-user-domain-name=&lt;domain&gt;
--os-password=&lt;password&gt; --os-trust-id=&lt;trust&gt; token issue</literal>
              </listitem>
            </itemizedlist>
          </para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Create a token given an OAuth access token</emphasis>
          <para><emphasis role="bold">Status: optional. </emphasis>OAuth access tokens can be exchanged for keystone tokens.</para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Create a token with a bind attribute</emphasis>
          <para><emphasis role="bold">Status: optional. </emphasis>Tokens can express a binding to an additional authentication method, such
                                as kerberos or x509.</para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>missing</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Revoke a token</emphasis>
          <para><emphasis role="bold">Status: optional. </emphasis>Tokens may be individually revoked, such as when a user logs out of
                                Horizon. Under certain circumstances, it’s acceptable for more than just a
                                single token may be revoked as a result of this operation (such as when the
                                revoked token was previously used to create additional tokens).</para>
          <para>
            <emphasis role="bold">CLI commands:</emphasis>
            <itemizedlist>
              <listitem>
                <literal>openstack token revoke</literal>
              </listitem>
            </itemizedlist>
          </para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Online validation</emphasis>
          <para><emphasis role="bold">Status: mandatory. </emphasis>Keystone must be able to validate the tokens that it issues when
                                presented with a token that it previously issued.</para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Offline validation</emphasis>
          <para><emphasis role="bold">Status: optional. </emphasis>Services using Keystone for authentication may want to validate tokens
                                themselves, rather than calling back to keystone, in order to improve
                                performance and scalability.</para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>missing</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>missing</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
        <listitem>
          <emphasis role="bold">Non-persistent</emphasis>
          <para><emphasis role="bold">Status: optional. </emphasis>If a token format does not require persistence (such as to a SQL
                                backend), then there is no scalability limit to the number of tokens that
                                keystone can issue at once, and there is no need to perform clean up
                                operations such as `keystone-manage token_flush`.</para>
          <para>
            <emphasis role="bold">drivers:</emphasis>
            <itemizedlist>
              <listitem>
                <emphasis role="bold">UUID tokens: </emphasis>
                <literal>missing</literal>
              </listitem>
              <listitem>
                <emphasis role="bold">Fernet tokens: </emphasis>
                <literal>complete</literal>
              </listitem>
            </itemizedlist>
          </para>
        </listitem>
      </itemizedlist>
    </section>
  </section>
</section>
