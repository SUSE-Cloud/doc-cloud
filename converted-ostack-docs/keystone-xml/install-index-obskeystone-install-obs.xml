<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Install and configure</title>
  <para>This section describes how to install and configure the OpenStack
            Identity service, code-named keystone, on the controller node. For
            scalability purposes, this configuration deploys Fernet tokens and
            the Apache HTTP server to handle requests.</para>
  <section>
    <title>Prerequisites</title>
    <para>Before you install and configure the Identity service, you must
                create a database.</para>
    <note>
      <para>Before you begin, ensure you have the most recent version of
                    <literal>python-pyasn1</literal><link xlink:href="https://pypi.python.org/pypi/pyasn1">installed</link>.</para>
    </note>
    <procedure>
      <step>
        <para>Use the database access client to connect to the database
                        server as the <literal>root</literal> user:</para>
        <screen language="console">$ mysql -u root -p</screen>
      </step>
    </procedure>
    <procedure>
      <step>
        <para>Create the <literal>keystone</literal> database:</para>
        <screen language="console">MariaDB [(none)]&gt; CREATE DATABASE keystone;</screen>
      </step>
      <step>
        <para>Grant proper access to the <literal>keystone</literal> database:</para>
        <screen language="console">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \
IDENTIFIED BY 'KEYSTONE_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \
IDENTIFIED BY 'KEYSTONE_DBPASS';</screen>
        <para>Replace <literal>KEYSTONE_DBPASS</literal> with a suitable password.</para>
      </step>
      <step>
        <para>Exit the database access client.</para>
      </step>
    </procedure>
  </section>
  <section xml:id="keystone-install-configure-obs">
    <title>Install and configure components</title>
    <note>
      <para>Default configuration files vary by distribution. You might need
                    to add these sections and options rather than modifying existing
                    sections and options. Also, an ellipsis (<literal>...</literal>) in the configuration
                    snippets indicates potential default configuration options that you
                    should retain.</para>
    </note>
    <note>
      <para>This guide uses the Apache HTTP server with <literal>mod_wsgi</literal> to serve
                    Identity service requests on ports 5000 and 35357. By default, the
                    keystone service still listens on these ports. Therefore, this guide
                    manually disables the keystone service.</para>
    </note>
    <note>
      <para>Starting with the Newton release, SUSE OpenStack packages are shipping
                    with the upstream default configuration files. For example
                    <literal>/etc/keystone/keystone.conf</literal>, with customizations in
                    <literal>/etc/keystone/keystone.conf.d/010-keystone.conf</literal>. While the
                    following instructions modify the default configuration file, adding a
                    new file in <literal>/etc/keystone/keystone.conf.d</literal> achieves the same
                    result.</para>
    </note>
    <procedure>
      <step>
        <para>Run the following command to install the packages:</para>
        <screen language="console"># zypper install openstack-keystone apache2-mod_wsgi</screen>
      </step>
    </procedure>
    <procedure>
      <step>
        <para>Edit the <literal>/etc/keystone/keystone.conf</literal> file and complete the following
                        actions:</para>
        <itemizedlist>
          <listitem>
            <para>In the <literal>[database]</literal> section, configure database access:</para>
            <screen language="ini">[database]
# ...
connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone</screen>
            <para>Replace <literal>KEYSTONE_DBPASS</literal> with the password you chose for the database.</para>
            <note>
              <para>Comment out or remove any other <literal>connection</literal> options in the
                                    <literal>[database]</literal> section.</para>
            </note>
          </listitem>
          <listitem>
            <para>In the <literal>[token]</literal> section, configure the Fernet token provider:</para>
            <screen language="ini">[token]
# ...
provider = fernet</screen>
          </listitem>
        </itemizedlist>
      </step>
      <step>
        <para>Populate the Identity service database:</para>
        <screen language="console"># su -s /bin/sh -c "keystone-manage db_sync" keystone</screen>
      </step>
      <step>
        <para>Initialize Fernet key repositories:</para>
        <screen language="console"><?dbsuse-fo font-size="8pt"?># keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
# keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</screen>
      </step>
      <step>
        <para>Bootstrap the Identity service:</para>
        <screen language="console"># keystone-manage bootstrap --bootstrap-password ADMIN_PASS \
  --bootstrap-admin-url http://controller:35357/v3/ \
  --bootstrap-internal-url http://controller:5000/v3/ \
  --bootstrap-public-url http://controller:5000/v3/ \
  --bootstrap-region-id RegionOne</screen>
        <para>Replace <literal>ADMIN_PASS</literal> with a suitable password for an administrative user.</para>
      </step>
    </procedure>
  </section>
  <section>
    <title>Configure the Apache HTTP server</title>
    <procedure>
      <step>
        <para>Edit the <literal>/etc/sysconfig/apache2</literal> file and configure the
                        <literal>APACHE_SERVERNAME</literal> option to reference the controller node:</para>
        <screen language="shell">APACHE_SERVERNAME="controller"</screen>
      </step>
      <step>
        <para>Create the <literal>/etc/apache2/conf.d/wsgi-keystone.conf</literal> file
                        with the following content:</para>
        <screen language="apache"><?dbsuse-fo font-size="8pt"?>Listen 5000
Listen 35357

&lt;VirtualHost *:5000&gt;
    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
    WSGIProcessGroup keystone-public
    WSGIScriptAlias / /usr/bin/keystone-wsgi-public
    WSGIApplicationGroup %{GLOBAL}
    WSGIPassAuthorization On
    ErrorLogFormat "%{cu}t %M"
    ErrorLog /var/log/apache2/keystone.log
    CustomLog /var/log/apache2/keystone_access.log combined

    &lt;Directory /usr/bin&gt;
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;

&lt;VirtualHost *:35357&gt;
    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
    WSGIProcessGroup keystone-admin
    WSGIScriptAlias / /usr/bin/keystone-wsgi-admin
    WSGIApplicationGroup %{GLOBAL}
    WSGIPassAuthorization On
    ErrorLogFormat "%{cu}t %M"
    ErrorLog /var/log/apache2/keystone.log
    CustomLog /var/log/apache2/keystone_access.log combined

    &lt;Directory /usr/bin&gt;
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</screen>
      </step>
      <step>
        <para>Recursively change the ownership of the <literal>/etc/keystone</literal> directory:</para>
        <screen language="console"># chown -R keystone:keystone /etc/keystone</screen>
      </step>
    </procedure>
  </section>
  <section>
    <title>Finalize the installation</title>
    <procedure>
      <step>
        <para>Start the Apache HTTP service and configure it to start when the system
                        boots:</para>
        <screen language="console"># systemctl enable apache2.service
# systemctl start apache2.service</screen>
      </step>
    </procedure>
    <procedure>
      <step>
        <para>Configure the administrative account</para>
        <screen language="console">$ export OS_USERNAME=admin
$ export OS_PASSWORD=ADMIN_PASS
$ export OS_PROJECT_NAME=admin
$ export OS_USER_DOMAIN_NAME=Default
$ export OS_PROJECT_DOMAIN_NAME=Default
$ export OS_AUTH_URL=http://controller:35357/v3
$ export OS_IDENTITY_API_VERSION=3</screen>
        <para>Replace <literal>ADMIN_PASS</literal> with the password used in the
                        <literal>keystone-manage bootstrap</literal> command in <xref linkend="keystone-install-configure-obs"/>.</para>
      </step>
    </procedure>
  </section>
</section>
